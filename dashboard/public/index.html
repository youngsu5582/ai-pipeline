<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI Pipeline Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AI Pipeline">
  <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
  <link rel="apple-touch-icon" href="/icons/icon.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- vis-network for graph visualization -->
  <link href="https://unpkg.com/vis-network@9.1.9/styles/vis-network.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
  <!-- Chart.js for statistics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .job-card { transition: all 0.2s ease; }
    .job-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .modal { display: none; }
    .modal.active { display: flex; }
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    /* Line clamp */
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    /* Markdown content styles */
    .markdown-content h1 { font-size: 1.5em; font-weight: bold; margin: 1em 0 0.5em; color: #f3f4f6; border-bottom: 1px solid #374151; padding-bottom: 0.3em; }
    .markdown-content h2 { font-size: 1.25em; font-weight: bold; margin: 1em 0 0.5em; color: #e5e7eb; }
    .markdown-content h3 { font-size: 1.1em; font-weight: bold; margin: 0.8em 0 0.4em; color: #d1d5db; }
    .markdown-content p { margin: 0.5em 0; line-height: 1.6; }
    .markdown-content ul, .markdown-content ol { margin-left: 1.5em; margin-bottom: 0.5em; padding-left: 0.5em; }
    .markdown-content ul { list-style-type: disc; }
    .markdown-content ol { list-style-type: decimal; }
    .markdown-content li { margin-bottom: 0.25em; }
    .markdown-content code { background: #374151; padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.9em; color: #fbbf24; }
    .markdown-content pre { background: #1f2937; padding: 1em; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
    .markdown-content pre code { background: transparent; padding: 0; color: #e5e7eb; }
    .markdown-content blockquote { border-left: 3px solid #6366f1; padding-left: 1em; margin: 0.5em 0; color: #9ca3af; }
    .markdown-content table { border-collapse: collapse; width: 100%; margin: 0.5em 0; }
    .markdown-content th, .markdown-content td { border: 1px solid #4b5563; padding: 0.5em 0.75em; text-align: left; }
    .markdown-content th { background: #374151; font-weight: 600; }
    .markdown-content hr { border: none; border-top: 1px solid #4b5563; margin: 1em 0; }
    .markdown-content a { color: #60a5fa; text-decoration: underline; }
    .markdown-content strong { color: #f3f4f6; }
    /* Morning preview compact styles */
    .morning-preview h1 { font-size: 1.2em; font-weight: bold; margin: 0 0 0.5em; color: #f3f4f6; }
    .morning-preview h2 { font-size: 1em; font-weight: bold; margin: 0.7em 0 0.3em; color: #e5e7eb; }
    .morning-preview ul, .morning-preview ol { margin: 0.2em 0 0.2em 1.2em; padding: 0; }
    .morning-preview li { margin-bottom: 0.1em; line-height: 1.5; }
    .morning-preview p { margin: 0.2em 0; line-height: 1.5; }
    .morning-preview hr { border: none; border-top: 1px solid #4b5563; margin: 0.5em 0; }
    .morning-preview strong { color: #f3f4f6; }
    .morning-preview input[type="checkbox"] { margin-right: 0.3em; }
    /* 인터랙티브 체크박스 아이템 */
    #morningMarkdownPreview li { padding: 0.3em 0.5em; border-radius: 0.375em; transition: background-color 0.15s; }
    #morningMarkdownPreview li:hover { background-color: rgba(251, 191, 36, 0.08); }
    #morningMarkdownPreview li label { display: inline-flex; align-items: flex-start; gap: 0.5em; cursor: pointer; width: 100%; }
    #morningMarkdownPreview li input[type="checkbox"] { accent-color: #f59e0b; width: 1.1em; height: 1.1em; margin-top: 0.15em; cursor: pointer; }
    /* Graph view styles */
    #graphView { display: none; }
    #graphView.active { display: block; }
    .view-btn.active { background-color: #3b82f6; }
    /* Context menu */
    .context-menu {
      position: absolute;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 4px 0;
      min-width: 150px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .context-menu-item:hover { background: #374151; }
    .context-menu-divider { border-top: 1px solid #374151; margin: 4px 0; }
    /* vis-network manipulation toolbar dark theme */
    div.vis-network div.vis-manipulation {
      background: #1f2937 !important;
      border-bottom: 1px solid #374151 !important;
      padding: 8px !important;
    }
    div.vis-network div.vis-manipulation div.vis-button,
    div.vis-network div.vis-edit-mode div.vis-button {
      color: #e5e7eb !important;
      background: #374151 !important;
      border: 1px solid #4b5563 !important;
      border-radius: 6px !important;
      padding: 6px 12px !important;
      margin: 0 4px !important;
    }
    div.vis-network div.vis-manipulation div.vis-button:hover,
    div.vis-network div.vis-edit-mode div.vis-button:hover {
      background: #4b5563 !important;
      box-shadow: none !important;
    }
    div.vis-network div.vis-manipulation div.vis-separator-line {
      background-color: #4b5563 !important;
    }
    /* Date input 다크 테마 */
    input[type="date"] {
      color-scheme: dark;
    }
    /* 페이지네이션 버튼 비활성화 */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Graph controls */
    .graph-controls {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .graph-control-btn {
      background: #374151;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }
    .graph-control-btn:hover {
      background: #4b5563;
    }
    /* Zoom controls */
    .zoom-controls {
      position: absolute;
      bottom: 12px;
      left: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
    }
    .zoom-btn {
      background: #374151;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      width: 36px;
      height: 36px;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .zoom-btn:hover {
      background: #4b5563;
    }
    /* Legend */
    .graph-legend {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 12px;
      font-size: 12px;
      z-index: 10;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .legend-item:last-child {
      margin-bottom: 0;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .legend-line {
      width: 24px;
      height: 2px;
    }
    /* Side panel */
    .graph-side-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: #1f2937;
      border-left: 1px solid #374151;
      padding: 16px;
      transform: translateX(100%);
      transition: transform 0.2s ease;
      z-index: 20;
      overflow-y: auto;
    }
    .graph-side-panel.open {
      transform: translateX(0);
    }
    .side-panel-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
    }
    .side-panel-close:hover {
      color: #fff;
    }
    /* Array input tags */
    .array-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px;
      background: #374151;
      border: 1px solid #4b5563;
      border-radius: 6px;
      min-height: 42px;
      align-items: center;
    }
    .array-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #4b5563;
      border: 1px solid #6b7280;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      max-width: 100%;
    }
    .array-tag span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .array-tag-remove {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }
    .array-tag-remove:hover {
      color: #ef4444;
    }
    .array-input {
      flex: 1;
      min-width: 120px;
      background: transparent;
      border: none;
      outline: none;
      color: #e5e7eb;
      font-size: 13px;
    }
    .array-input::placeholder {
      color: #6b7280;
    }
    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      pointer-events: auto;
      animation: toast-in 0.3s ease;
      max-width: 350px;
    }
    .toast.toast-out {
      animation: toast-out 0.3s ease forwards;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    .toast-success { background: #065f46; border: 1px solid #10b981; }
    .toast-error { background: #7f1d1d; border: 1px solid #ef4444; }
    .toast-info { background: #1e3a5f; border: 1px solid #3b82f6; }
    .toast-warning { background: #78350f; border: 1px solid #f59e0b; }
    .toast-icon { font-size: 18px; }
    .toast-message { flex: 1; font-size: 14px; }
    .toast-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      line-height: 1;
    }
    .toast-close:hover { color: #fff; }

    /* ============ Mobile Responsive ============ */

    /* Bottom Tab Bar */
    @media (max-width: 768px) {
      header .flex { flex-wrap: wrap; gap: 8px; }
      header button { display: none; }

      .main-tabs {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-around;
        background: #1f2937;
        border-top: 1px solid #374151;
        padding: 6px 0 env(safe-area-inset-bottom, 6px);
        z-index: 50;
        margin: 0;
        border-bottom: none;
        gap: 0;
      }
      .main-tabs .tab-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.6rem;
        padding: 4px 2px;
        gap: 1px;
        border-bottom: none !important;
        border-top: 2px solid transparent;
        flex: 1;
      }
      .main-tabs .tab-btn.border-blue-500 {
        border-top-color: #3b82f6;
        border-bottom-color: transparent !important;
      }
      main {
        padding-bottom: 72px !important;
        padding-left: 12px !important;
        padding-right: 12px !important;
      }
    }

    /* Grid Responsive */
    @media (max-width: 768px) {
      .grid.grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }
    }
    @media (max-width: 480px) {
      .grid.grid-cols-4 { grid-template-columns: 1fr !important; }
    }

    /* Modal Fullscreen */
    @media (max-width: 768px) {
      .modal > div {
        max-width: 100vw !important;
        max-height: 100vh !important;
        width: 100vw !important;
        height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
      }
      .modal > div > div { max-height: calc(100vh - 60px); overflow-y: auto; }
    }

    /* Widget Grid Responsive */
    @media (max-width: 1024px) {
      #widgetGrid { grid-template-columns: repeat(2, 1fr) !important; }
      #widgetGrid > div { grid-column: span 1 !important; }
    }
    @media (max-width: 768px) {
      #widgetGrid { grid-template-columns: 1fr !important; }
      #widgetGrid > div { grid-column: span 1 !important; grid-row: span 1 !important; }
    }

    /* Widget Drag & Drop */
    .widget-container { transition: transform 0.15s, box-shadow 0.15s; }
    .widget-container.drag-over {
      border-color: #3b82f6 !important;
      box-shadow: 0 0 16px rgba(59,130,246,0.3);
    }
    #widgetGrid.edit-mode .widget-container {
      cursor: grab;
      border-style: dashed !important;
    }
    #widgetGrid.edit-mode .widget-container:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(59,130,246,0.2);
    }
    #widgetGrid.edit-mode .widget-container:active { cursor: grabbing; }
    .widget-container.dragging { opacity: 0.5; }

    /* Pull-to-refresh indicator */
    #pullRefreshIndicator {
      position: fixed; top: 0; left: 50%; transform: translateX(-50%) translateY(-100%);
      background: #1f2937; border: 1px solid #374151; border-radius: 0 0 12px 12px;
      padding: 8px 16px; z-index: 60; font-size: 12px; color: #9ca3af;
      transition: transform 0.2s;
    }
    #pullRefreshIndicator.visible { transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>
  <!-- Pull-to-refresh indicator -->
  <div id="pullRefreshIndicator">&#8635; 새로고침</div>
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <span class="text-2xl">🤖</span>
        <h1 class="text-xl font-bold">AI Pipeline Dashboard</h1>
      </div>
      <div class="flex items-center gap-4">
        <span id="statusIndicator" class="flex items-center gap-2 text-sm text-gray-400">
          <span class="status-dot bg-green-500"></span>
          <span id="jobCount">0</span> jobs scheduled
        </span>
        <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
          + 작업 추가
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <!-- Tabs -->
    <div class="main-tabs flex gap-4 mb-6 border-b border-gray-700">
      <button onclick="showTab('home')" id="tab-home" class="tab-btn px-4 py-2 border-b-2 border-blue-500 text-blue-400 font-medium">
        🏠 홈
      </button>
      <button onclick="showTab('jobs')" id="tab-jobs" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        📦 작업
      </button>
      <button onclick="showTab('settings')" id="tab-settings" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        ⚙️ 설정
      </button>
      <button onclick="showTab('sessions')" id="tab-sessions" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        🤖 세션
      </button>
      <button onclick="showTab('notes')" id="tab-notes" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        📋 노트
      </button>
      <button onclick="showTab('analysis')" id="tab-analysis" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        📊 분석
      </button>
    </div>

    <!-- Home Dashboard -->
    <div id="panel-home">
      <!-- 날짜 네비게이션 + 위젯 편집 -->
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-lg font-bold text-gray-200">대시보드</h2>
        <div class="flex items-center gap-3">
          <button id="widgetEditBtn" onclick="toggleWidgetEditMode()" class="px-3 py-1.5 text-xs bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 transition-colors text-gray-400 hover:text-gray-200">편집</button>
          <button id="widgetResetBtn" onclick="resetWidgetLayout()" class="px-3 py-1.5 text-xs bg-gray-800 hover:bg-gray-700 rounded-lg border border-gray-700 transition-colors text-gray-400 hover:text-gray-200 hidden">초기화</button>
          <div class="flex items-center gap-1 bg-gray-800 rounded-lg px-1 py-1">
            <button onclick="shiftHomeDate(-1)" class="px-2 py-1 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-sm">&lsaquo;</button>
            <button id="homeDateLabel" onclick="document.getElementById('homeDateInput').showPicker()" class="px-3 py-1 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition-colors cursor-pointer font-medium">오늘</button>
            <input type="date" id="homeDateInput" class="sr-only" onchange="setHomeDate(this.value)">
            <button onclick="shiftHomeDate(1)" id="homeDateNext" class="px-2 py-1 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-sm">&rsaquo;</button>
            <button onclick="setHomeToday()" class="px-2.5 py-1 text-xs text-blue-400 hover:text-blue-300 hover:bg-gray-700 rounded transition-colors ml-1">오늘</button>
          </div>
        </div>
      </div>

      <!-- 위젯 그리드 -->
      <div id="widgetGrid" class="grid gap-4" style="grid-template-columns: repeat(4, 1fr); grid-auto-rows: minmax(100px, auto);">
        <!-- Widgets rendered dynamically by initWidgetSystem() -->
      </div>
    </div>

    <!-- Jobs Tab -->
    <div id="panel-jobs" class="hidden">
      <!-- Sub Tabs -->
      <div class="flex gap-2 mb-4 border-b border-gray-700/50 pb-2">
        <button onclick="showJobSubTab('list')" id="jobSub-list" class="job-sub-btn px-3 py-1.5 border-b-2 border-blue-500 text-blue-400 text-sm font-medium">
          작업 목록
        </button>
        <button onclick="showJobSubTab('history')" id="jobSub-history" class="job-sub-btn px-3 py-1.5 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm font-medium">
          실행 이력
        </button>
        <button onclick="showJobSubTab('stats')" id="jobSub-stats" class="job-sub-btn px-3 py-1.5 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm font-medium">
          📊 통계
        </button>
      </div>

      <!-- Job List Sub Panel -->
      <div id="jobSubPanel-list">
      <!-- Today's Summary Widget -->
      <div id="todaySummaryWidget" class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold flex items-center gap-2">
            🤖 <span>오늘의 요약</span>
          </h3>
          <button onclick="refreshTodaySummary()" class="text-sm text-gray-400 hover:text-white">🔄</button>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-sm text-gray-400 mb-1">Claude 세션</div>
            <div id="todaySessionsCount" class="text-2xl font-bold">-</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-sm text-gray-400 mb-1">작업 실행</div>
            <div id="todayJobsCount" class="text-2xl font-bold">-</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-sm text-gray-400 mb-1">성공률</div>
            <div id="todaySuccessRate" class="text-2xl font-bold">-</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <button onclick="openQuickInput()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium transition-colors">
            📝 빠른 메모
          </button>
          <button id="morningStartBtn" onclick="openMorningStart()" class="px-3 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-lg text-sm font-medium transition-all">
            ☀️ 하루 시작
          </button>
          <button onclick="generateTodayFullReport()" class="px-3 py-2 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-400 hover:to-pink-400 rounded-lg text-sm font-medium transition-all">
            📊 오늘 보고서
          </button>
        </div>
      </div>

      <!-- View Toggle & Category Filter -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex gap-2" id="categoryFilter"></div>
        <div class="flex gap-1 bg-gray-800 rounded-lg p-1">
          <button onclick="setView('card')" id="viewBtn-card" class="view-btn active px-3 py-1.5 rounded text-sm font-medium">
            📋 카드
          </button>
          <button onclick="setView('graph')" id="viewBtn-graph" class="view-btn px-3 py-1.5 rounded text-sm font-medium text-gray-400 hover:text-white">
            🔗 그래프
          </button>
        </div>
      </div>

      <!-- Jobs Grid (Card View) -->
      <div id="jobsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Jobs will be loaded here -->
      </div>

      <!-- Graph View -->
      <div id="graphView" class="rounded-lg overflow-hidden relative" style="height: calc(100vh - 250px); background: #111827;">
        <!-- Graph Controls -->
        <div class="graph-controls">
          <button class="graph-control-btn" onclick="autoLayoutGraph()">
            📐 자동 정렬
          </button>
          <button class="graph-control-btn" onclick="saveAllPositions()">
            💾 위치 저장
          </button>
        </div>

        <!-- Zoom Controls -->
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomGraph(1.2)" title="확대">+</button>
          <button class="zoom-btn" onclick="zoomGraph(0.8)" title="축소">−</button>
          <button class="zoom-btn" onclick="fitGraph()" title="전체 보기">⊡</button>
        </div>

        <!-- Legend -->
        <div class="graph-legend">
          <div class="text-gray-400 text-xs mb-2 font-medium">범례</div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #10b981;"></div>
            <span>활성화</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #6b7280;"></div>
            <span>비활성화</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #fbbf24;"></div>
            <span>실행 중</span>
          </div>
          <div class="legend-item mt-2 pt-2 border-t border-gray-700">
            <div class="legend-line" style="background: #10b981;"></div>
            <span>트리거 연결</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #6b7280; border-top: 2px dashed #6b7280; height: 0;"></div>
            <span>시각적 연결</span>
          </div>
        </div>

        <!-- Graph Canvas -->
        <div id="graphCanvas" style="width: 100%; height: 100%;"></div>

        <!-- Side Panel -->
        <div id="graphSidePanel" class="graph-side-panel">
          <button class="side-panel-close" onclick="closeSidePanel()">&times;</button>
          <div id="sidePanelContent">
            <!-- 선택된 노드 정보가 여기에 표시됨 -->
          </div>
        </div>
      </div>
    </div> <!-- /jobSubPanel-list -->

      <!-- History Sub Panel -->
      <div id="jobSubPanel-history" class="hidden">
        <!-- 필터 영역 -->
        <div class="bg-gray-800 rounded-lg p-4 mb-4">
          <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm text-gray-400 mb-1">검색</label>
              <input type="text" id="historySearch" placeholder="작업명 검색..."
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onkeyup="debounceHistorySearch()">
            </div>
            <div class="w-32">
              <label class="block text-sm text-gray-400 mb-1">상태</label>
              <select id="historyStatus"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onchange="loadHistoryFiltered()">
                <option value="">전체</option>
                <option value="success">성공</option>
                <option value="failed">실패</option>
                <option value="running">실행중</option>
              </select>
            </div>
            <div class="w-40">
              <label class="block text-sm text-gray-400 mb-1">시작일</label>
              <input type="date" id="historyStartDate"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onchange="loadHistoryFiltered()">
            </div>
            <div class="w-40">
              <label class="block text-sm text-gray-400 mb-1">종료일</label>
              <input type="date" id="historyEndDate"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onchange="loadHistoryFiltered()">
            </div>
            <button onclick="resetHistoryFilters()"
              class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
              초기화
            </button>
          </div>
        </div>

        <div class="bg-gray-800 rounded-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-700">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium">작업</th>
                <th class="px-4 py-3 text-left text-sm font-medium">트리거</th>
                <th class="px-4 py-3 text-left text-sm font-medium">시작 시간</th>
                <th class="px-4 py-3 text-left text-sm font-medium">소요 시간</th>
                <th class="px-4 py-3 text-left text-sm font-medium">상태</th>
                <th class="px-4 py-3 text-left text-sm font-medium">상세</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-gray-700"></tbody>
          </table>
        </div>

        <div id="historyPagination" class="flex items-center justify-between mt-4">
          <div id="historyInfo" class="text-sm text-gray-400"></div>
          <div class="flex gap-2">
            <button id="historyPrevBtn" onclick="loadHistoryPage('prev')"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              ← 이전
            </button>
            <div id="historyPageNumbers" class="flex gap-1"></div>
            <button id="historyNextBtn" onclick="loadHistoryPage('next')"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              다음 →
            </button>
          </div>
        </div>
      </div> <!-- /jobSubPanel-history -->

      <!-- Stats Sub Panel -->
      <div id="jobSubPanel-stats" class="hidden">
      <!-- 기간 선택 -->
      <div class="flex items-center gap-4 mb-6">
        <span class="text-sm text-gray-400">기간:</span>
        <div class="flex gap-1 bg-gray-800 rounded-lg p-1">
          <button onclick="setStatsPeriod(7)" id="statsBtn-7" class="stats-period-btn px-3 py-1.5 rounded text-sm font-medium bg-blue-600 text-white">
            7일
          </button>
          <button onclick="setStatsPeriod(14)" id="statsBtn-14" class="stats-period-btn px-3 py-1.5 rounded text-sm font-medium text-gray-400 hover:text-white">
            14일
          </button>
          <button onclick="setStatsPeriod(30)" id="statsBtn-30" class="stats-period-btn px-3 py-1.5 rounded text-sm font-medium text-gray-400 hover:text-white">
            30일
          </button>
        </div>
        <button onclick="loadStats()" class="ml-auto px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
          🔄 새로고침
        </button>
      </div>

      <!-- 요약 카드 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">총 실행</div>
          <div id="statsTotalRuns" class="text-3xl font-bold mt-1">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">성공률</div>
          <div id="statsSuccessRate" class="text-3xl font-bold mt-1 text-green-400">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">실패</div>
          <div id="statsFailedCount" class="text-3xl font-bold mt-1 text-red-400">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">평균 소요 시간</div>
          <div id="statsAvgDuration" class="text-3xl font-bold mt-1">-</div>
        </div>
      </div>

      <!-- 차트 영역 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- 일별 트렌드 차트 -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">📈 일별 실행 트렌드</h3>
          <div style="height: 250px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <!-- 성공/실패 파이 차트 -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">🎯 실행 결과 분포</h3>
          <div style="height: 250px;">
            <canvas id="resultChart"></canvas>
          </div>
        </div>
      </div>

      <!-- 작업별 통계 테이블 -->
      <div class="bg-gray-800 rounded-lg overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-700">
          <h3 class="text-lg font-semibold">📋 작업별 통계</h3>
        </div>
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium">작업</th>
              <th class="px-4 py-3 text-right text-sm font-medium">실행</th>
              <th class="px-4 py-3 text-right text-sm font-medium">성공</th>
              <th class="px-4 py-3 text-right text-sm font-medium">실패</th>
              <th class="px-4 py-3 text-right text-sm font-medium">성공률</th>
              <th class="px-4 py-3 text-right text-sm font-medium">평균 시간</th>
            </tr>
          </thead>
          <tbody id="statsJobsTable" class="divide-y divide-gray-700">
            <!-- 작업별 통계 로드됨 -->
          </tbody>
        </table>
      </div>

      <!-- 실패 TOP 5 -->
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-700">
          <h3 class="text-lg font-semibold">⚠️ 가장 실패 많은 작업</h3>
        </div>
        <div id="statsFailuresContainer" class="p-4">
          <!-- 실패 목록 로드됨 -->
        </div>
      </div>
      </div> <!-- /jobSubPanel-stats -->
    </div> <!-- /panel-jobs -->

    <!-- Context Menu (for graph nodes) -->
    <div id="contextMenu" class="context-menu hidden">
      <div class="context-menu-item" onclick="contextMenuAction('run')">▶️ 실행</div>
      <div class="context-menu-item" onclick="contextMenuAction('schedule')">⏰ 예약 실행</div>
      <div class="context-menu-item" onclick="contextMenuAction('toggle')">⏸️ 활성화/비활성화</div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="contextMenuAction('duplicate')">📋 복제</div>
      <div class="context-menu-item" onclick="contextMenuAction('edit')">✏️ 편집</div>
      <div class="context-menu-item" onclick="contextMenuAction('delete')">🗑️ 삭제</div>
    </div>

    <!-- Settings Tab -->
    <div id="panel-settings" class="hidden">
      <div class="max-w-2xl">
        <!-- 알림 채널 관리 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-2">🔔 알림 채널</h3>
          <p class="text-xs text-gray-500 mb-3">Slack, Discord, 브라우저 알림을 채널별로 관리합니다.</p>
          <div class="flex items-center justify-between mb-4 p-3 bg-gray-700/30 rounded-lg">
            <div class="flex items-center gap-3">
              <input type="checkbox" id="settingsBrowserNotifications" class="w-4 h-4 rounded bg-gray-600 border-gray-500"
                onchange="onBrowserNotificationChange(this)">
              <label for="settingsBrowserNotifications" class="text-sm">브라우저 푸시 알림</label>
            </div>
            <span id="notificationStatus" class="text-xs text-gray-500"></span>
          </div>
          <div id="notificationChannelsList" class="space-y-3"></div>
          <button onclick="addNotificationChannel()" class="mt-3 text-sm text-blue-400 hover:text-blue-300">+ 채널 추가</button>
        </div>

        <!-- 알림 규칙 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-2">📋 알림 규칙</h3>
          <p class="text-xs text-gray-500 mb-4">이벤트별로 어떤 채널에 알림을 보낼지 설정합니다.</p>
          <div id="notificationRulesList" class="space-y-3"></div>
          <button onclick="addNotificationRule()" class="mt-3 text-sm text-blue-400 hover:text-blue-300">+ 규칙 추가</button>
        </div>

        <!-- 대시보드 설정 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">🖥️ 대시보드 설정</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">대시보드 URL</label>
              <input type="text" id="settingsDashboardUrl" placeholder="http://localhost:3030"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">Slack 알림에 포함될 대시보드 링크 주소</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">자동 새로고침 간격 (초)</label>
              <input type="number" id="settingsRefreshInterval" min="1" max="60" value="5"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">작업 목록 자동 새로고침 간격 (1~60초)</p>
            </div>
          </div>
        </div>

        <!-- Obsidian 경로 설정 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">📓 Obsidian Vault</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Vault 경로</label>
              <input type="text" id="settingsObsidianVaultPath" placeholder="/Users/.../obsidian"
                oninput="updateObsidianPreview()"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
              <p class="text-xs text-gray-500 mt-1">Obsidian vault 루트 경로. 세션/보고서 내보내기, 메모 동기화에 사용됩니다.</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Daily Note 폴더</label>
              <input type="text" id="settingsObsidianDailyFolder" placeholder="DAILY"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
              <p class="text-xs text-gray-500 mt-1">일일 노트 폴더명 (vault 기준 상대 경로)</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">하루 시작 폴더</label>
              <input type="text" id="settingsObsidianMorningFolder" placeholder="Morning Plans"
                oninput="updateObsidianPreview()"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
              <p class="text-xs text-gray-500 mt-1">하루 시작 계획 내보내기 폴더 (vault 기준 상대 경로)</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">일일 보고서 폴더</label>
              <input type="text" id="settingsObsidianReportFolder" placeholder="Daily Reports"
                oninput="updateObsidianPreview()"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
              <p class="text-xs text-gray-500 mt-1">오늘 보고서 내보내기 폴더 (vault 기준 상대 경로)</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">주간 다이제스트 폴더</label>
              <input type="text" id="settingsObsidianWeeklyFolder" placeholder="WEEKLY"
                oninput="updateObsidianPreview()"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm">
              <p class="text-xs text-gray-500 mt-1">주간 분석 내보내기 폴더 (vault 기준 상대 경로)</p>
            </div>
            <div class="p-3 bg-gray-700/30 rounded-lg space-y-1">
              <p class="text-xs text-gray-400">📂 세션 내보내기: <code class="text-gray-300" id="obsidianExportPreview">-</code></p>
              <p class="text-xs text-gray-400">📂 하루 시작: <code class="text-gray-300" id="obsidianMorningPreview">-</code></p>
              <p class="text-xs text-gray-400">📂 일일 보고서: <code class="text-gray-300" id="obsidianReportPreview">-</code></p>
              <p class="text-xs text-gray-400">📂 주간 다이제스트: <code class="text-gray-300" id="obsidianWeeklyPreview">-</code></p>
            </div>
          </div>
        </div>

        <!-- 실행 설정 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">⚡ 실행 설정</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">기본 Timeout (분)</label>
              <input type="number" id="settingsDefaultTimeout" min="1" max="60" value="10"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">작업 실행 제한 시간 (개별 작업에서 재정의 가능)</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">기본 재시도 횟수</label>
              <input type="number" id="settingsDefaultRetry" min="0" max="10" value="0"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">실패 시 자동 재시도 횟수 (0 = 재시도 안함)</p>
            </div>
          </div>
        </div>

        <!-- 자동 복구 설정 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">🔧 자동 복구 (Auto-Fix)</h3>
          <p class="text-sm text-gray-400 mb-4">
            작업 실패 시 특정 에러 패턴을 감지하면 자동으로 수정 명령을 실행하고 재시도합니다.
          </p>
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
              <div>
                <div class="font-medium text-sm">🐍 Python 패키지 누락</div>
                <div class="text-xs text-gray-400">ModuleNotFoundError 감지 시 pip install 실행</div>
              </div>
              <input type="checkbox" id="autoFixPip" checked class="w-4 h-4 rounded bg-gray-600 border-gray-500">
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
              <div>
                <div class="font-medium text-sm">📦 NPM 패키지 누락</div>
                <div class="text-xs text-gray-400">Cannot find module 감지 시 npm install 실행</div>
              </div>
              <input type="checkbox" id="autoFixNpm" checked class="w-4 h-4 rounded bg-gray-600 border-gray-500">
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-3">* 자동 복구는 첫 번째 실패 시에만 시도됩니다</p>
        </div>

        <!-- 외부 트리거 (Webhooks) -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-2">🔗 외부 트리거 (Webhooks)</h3>
          <p class="text-xs text-gray-500 mb-4">외부 서비스(GitHub Actions, CI/CD 등)에서 작업을 트리거할 수 있는 토큰입니다.</p>
          <div id="webhookTokensList" class="space-y-3"></div>
          <button onclick="createWebhookToken()" class="mt-3 text-sm text-blue-400 hover:text-blue-300">+ 토큰 생성</button>
        </div>

        <!-- 데이터 관리 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">💾 데이터 관리</h3>
          <div class="flex gap-4">
            <button onclick="exportJobs()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium">
              📤 내보내기
            </button>
            <label class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-medium cursor-pointer">
              📥 가져오기
              <input type="file" accept=".json" onchange="importJobs(event)" class="hidden">
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-3">모든 작업, 엣지, 카테고리, 설정을 JSON 파일로 백업/복원</p>
        </div>

        <!-- 저장 버튼 -->
        <div class="flex justify-end gap-3">
          <button onclick="loadSettings()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-medium">
            🔄 되돌리기
          </button>
          <button onclick="saveSettings()" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium">
            💾 저장
          </button>
        </div>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div id="panel-sessions" class="hidden">
      <!-- 세션 서브탭 네비게이션 -->
      <div class="flex gap-2 mb-4">
        <button id="sessionsSub-list" onclick="showSessionsSubTab('list')"
          class="sessions-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">🤖 세션 목록</button>
        <button id="sessionsSub-graph" onclick="showSessionsSubTab('graph')"
          class="sessions-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">🔗 지식 그래프</button>
        <button id="sessionsSub-review" onclick="showSessionsSubTab('review')"
          class="sessions-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">📝 리뷰 분석</button>
      </div>

      <!-- 세션 목록 서브패널 -->
      <div id="sessionsSubPanel-list">
        <!-- Sessions Filter -->
        <div class="flex items-center gap-4 mb-6 bg-gray-800 rounded-lg p-4">
          <div class="flex items-center gap-1">
            <label class="text-sm text-gray-400 mr-1">날짜:</label>
            <button onclick="shiftSessionsDate(-1)"
              class="px-2 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-sm">‹</button>
            <input type="date" id="sessionsDate"
              class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
              onchange="loadSessions()">
            <button onclick="shiftSessionsDate(1)" id="sessionsDateNext"
              class="px-2 py-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-sm">›</button>
          </div>
          <div>
            <label class="text-sm text-gray-400 mr-2">프로젝트:</label>
            <select id="sessionsProject"
              class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
              onchange="loadSessions()">
              <option value="">전체</option>
            </select>
          </div>
          <div class="ml-auto flex gap-2">
            <button onclick="generateDailyReport()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg text-sm font-medium transition-all" title="Claude가 오늘 세션을 분석하여 보고서 생성">
              ✨ 일일 보고서
            </button>
            <button onclick="exportAllSessionsToObsidian()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium transition-colors" title="선택된 날짜의 모든 세션을 옵시디언으로 내보내기">
              📝 전체 내보내기
            </button>
            <button onclick="loadSessions()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium">
              🔄 새로고침
            </button>
          </div>
        </div>

        <!-- Sessions List -->
        <div id="sessionsList" class="grid gap-4">
          <div class="text-center text-gray-500 py-8">세션을 로드하려면 날짜를 선택하세요</div>
        </div>
      </div>

      <!-- 지식 그래프 서브패널 -->
      <div id="sessionsSubPanel-graph" class="hidden">
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-bold">🔗 지식 그래프</h3>
              <p class="text-xs text-gray-400 mt-1">세션 인사이트와 메모 태그로 구성된 지식 그래프. 노드 크기 = 언급 횟수.</p>
            </div>
            <div class="flex items-center gap-2">
              <select id="graphMinMentions" onchange="loadKnowledgeGraphUI()" class="px-2 py-1.5 bg-gray-700 border border-gray-600 rounded text-xs">
                <option value="1">모든 주제</option>
                <option value="2" selected>2회 이상</option>
                <option value="3">3회 이상</option>
                <option value="5">5회 이상</option>
              </select>
              <button onclick="rebuildKnowledgeGraphUI()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 rounded text-xs font-medium">
                🔄 재구성
              </button>
            </div>
          </div>
          <div id="knowledgeGraphStats" class="flex gap-4 mb-3 text-xs text-gray-500"></div>
          <div id="knowledgeGraphContainer" style="height: 550px; border: 1px solid #374151; border-radius: 8px; background: #111827;">
            <div class="flex items-center justify-center h-full text-gray-500">그래프 로딩 중...</div>
          </div>
        </div>
      </div>

      <!-- 리뷰 분석 서브패널 -->
      <div id="sessionsSubPanel-review" class="hidden">
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-bold">📝 코드 리뷰 분석</h3>
              <p class="text-xs text-gray-400 mt-1">GitHub PR 리뷰 활동을 AI가 분석하여 패턴과 체크리스트를 제공합니다.</p>
            </div>
            <div class="flex items-center gap-2">
              <select id="reviewDays" class="px-2 py-1.5 bg-gray-700 border border-gray-600 rounded text-xs">
                <option value="14">최근 14일</option>
                <option value="30" selected>최근 30일</option>
                <option value="60">최근 60일</option>
              </select>
              <button onclick="generateReviewAnalysis()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium">
                ✨ 분석 생성
              </button>
            </div>
          </div>
          <div id="reviewAnalysisContent">
            <div class="text-center text-gray-500 py-12">리뷰 분석을 시작하려면 "분석 생성" 버튼을 클릭하세요.</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Session Detail Modal (탭 밖에 위치 - 홈/분석 등 어디서든 접근 가능) -->
    <div id="sessionDetailModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
      <div id="sessionDetailContent" class="bg-gray-800 rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[85vh] overflow-auto">
        <!-- 동적으로 채워짐 -->
      </div>
    </div>

    <!-- Notes Tab -->
    <div id="panel-notes" class="hidden">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <h2 class="text-xl font-bold">📋 노트 & 백로그</h2>
          <span id="notesCount" class="text-sm text-gray-400"></span>
        </div>
        <div class="flex items-center gap-3">
          <!-- Date Picker -->
          <div class="flex items-center gap-1 bg-gray-800 rounded-lg px-1 py-1">
            <button onclick="shiftNotesDate(-1)" class="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition-colors" title="이전 날짜">‹</button>
            <button id="notesDateLabel" onclick="document.getElementById('notesDateInput').showPicker()" class="px-2 py-0.5 text-sm font-medium text-gray-300 hover:text-white rounded hover:bg-gray-700 cursor-pointer transition-colors whitespace-nowrap"></button>
            <input type="date" id="notesDateInput" class="sr-only" onchange="setNotesDate(this.value)">
            <button onclick="shiftNotesDate(1)" id="notesDateNext" class="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition-colors" title="다음 날짜">›</button>
            <button onclick="setNotesToday()" class="px-2 py-0.5 text-xs rounded bg-gray-700 hover:bg-gray-600 text-gray-400 hover:text-white transition-colors" title="오늘로 이동">오늘</button>
          </div>
          <div class="flex gap-2">
            <button onclick="openQuickInput('memo')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium">
              📝 메모 추가
            </button>
            <button onclick="openQuickInput('backlog')" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-sm font-medium">
              📋 백로그 추가
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <button onclick="setNotesFilter('all')" id="noteFilter-all"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-600 text-white">전체</button>
        <button onclick="setNotesFilter('backlog')" id="noteFilter-backlog"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">📋 백로그 <span id="backlogOpenCount" class="text-xs"></span></button>
        <button onclick="setNotesFilter('memo')" id="noteFilter-memo"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">📝 메모</button>
        <span class="w-px bg-gray-700 self-stretch"></span>
        <button onclick="setNotesFilter('learning')" id="noteFilter-learning"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">📚 학습</button>
        <button onclick="setNotesFilter('work')" id="noteFilter-work"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">💼 업무</button>
        <button onclick="setNotesFilter('idea')" id="noteFilter-idea"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">💡 아이디어</button>
        <button onclick="setNotesFilter('done')" id="noteFilter-done"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">✅ 완료</button>
      </div>

      <!-- Notes List -->
      <div id="notesList" class="space-y-2">
        <div class="text-center text-gray-500 py-8">로딩 중...</div>
      </div>
    </div>

    <!-- Analysis Tab -->
    <div id="panel-analysis" class="hidden">
      <!-- 서브탭 네비게이션 -->
      <div class="flex gap-2 mb-4">
        <button id="analysisSub-overview" onclick="showAnalysisSubTab('overview')"
          class="analysis-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white">📊 종합</button>
        <button id="analysisSub-morning" onclick="showAnalysisSubTab('morning')"
          class="analysis-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">☀️ 하루 시작</button>
        <button id="analysisSub-report" onclick="showAnalysisSubTab('report')"
          class="analysis-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">📊 오늘 보고서</button>
        <button id="analysisSub-weekly" onclick="showAnalysisSubTab('weekly')"
          class="analysis-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">📈 주간 분석</button>
      </div>

      <!-- 종합 서브패널 -->
      <div id="analysisSubPanel-overview">
        <!-- 스마트 서제스션 -->
        <div id="analysisSuggestions" class="mb-4 space-y-2"></div>

        <!-- 생산성 분석 -->
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-bold text-gray-300">생산성 분석</h3>
            <div class="flex items-center gap-2">
              <button onclick="setAnalysisProdPeriod(7)" id="aProdPeriod7" class="a-prod-period-btn px-2 py-0.5 rounded text-xs border border-blue-600 text-blue-400 bg-blue-900/30">7일</button>
              <button onclick="setAnalysisProdPeriod(14)" id="aProdPeriod14" class="a-prod-period-btn px-2 py-0.5 rounded text-xs border border-gray-600 text-gray-400">14일</button>
              <button onclick="setAnalysisProdPeriod(30)" id="aProdPeriod30" class="a-prod-period-btn px-2 py-0.5 rounded text-xs border border-gray-600 text-gray-400">30일</button>
            </div>
          </div>
          <!-- 4칸 요약 -->
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-500">총 세션</div>
              <div id="aProdTotalSessions" class="text-2xl font-bold mt-0.5">-</div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-500">총 메모</div>
              <div id="aProdTotalMemos" class="text-2xl font-bold mt-0.5">-</div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-500">작업 실행</div>
              <div id="aProdTotalJobs" class="text-2xl font-bold mt-0.5">-</div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <div class="text-xs text-gray-500">일평균 메모</div>
              <div id="aProdAvgMemos" class="text-2xl font-bold mt-0.5">-</div>
            </div>
          </div>
          <!-- 차트 2x2 -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
            <div class="bg-gray-900/50 rounded-lg p-3">
              <h4 class="text-xs text-gray-400 mb-2">시간대별 활동</h4>
              <div id="aHourlyHeatmap" class="grid gap-0.5" style="grid-template-columns: repeat(24, 1fr); height: 80px;"></div>
              <div class="flex justify-between mt-1 px-0.5">
                <span class="text-[9px] text-gray-600">0시</span>
                <span class="text-[9px] text-gray-600">6시</span>
                <span class="text-[9px] text-gray-600">12시</span>
                <span class="text-[9px] text-gray-600">18시</span>
                <span class="text-[9px] text-gray-600">24시</span>
              </div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <h4 class="text-xs text-gray-400 mb-2">프로젝트 분포</h4>
              <div style="position:relative; height:140px;">
                <canvas id="aProjectDistChart"></canvas>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-gray-900/50 rounded-lg p-3">
              <h4 class="text-xs text-gray-400 mb-2">일별 트렌드</h4>
              <div style="position:relative; height:140px;">
                <canvas id="aProdDailyTrendChart"></canvas>
              </div>
            </div>
            <div class="bg-gray-900/50 rounded-lg p-3">
              <h4 class="text-xs text-gray-400 mb-2">기간 비교 (전반 vs 후반)</h4>
              <div style="position:relative; height:140px;">
                <canvas id="aWeekCompChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 하루 시작 서브패널 -->
      <div id="analysisSubPanel-morning" class="hidden">
        <div class="flex gap-4" style="min-height: 600px;">
          <!-- 왼쪽 사이드바: 이전 기록 -->
          <div class="w-64 flex-shrink-0 bg-gray-800/50 rounded-xl border border-gray-700/50 p-4 overflow-y-auto" style="max-height: 700px;">
            <h3 class="text-sm font-bold text-gray-300 mb-3">📋 이전 기록</h3>
            <div id="morningPlanList" class="space-y-1">
              <div class="text-xs text-gray-500 text-center py-4">로딩 중...</div>
            </div>
          </div>
          <!-- 오른쪽 메인: 상세 -->
          <div class="flex-1 bg-gray-800/50 rounded-xl border border-gray-700/50 p-5">
            <!-- 날짜 네비게이션 -->
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">☀️ 하루 시작</h3>
              <div class="flex items-center gap-2">
                <div id="morningActions" class="flex gap-2 hidden">
                  <button onclick="copyMorningToClipboard()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">📋 복사</button>
                  <button onclick="downloadMorningPlan()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">💾 다운로드</button>
                  <button onclick="exportMorningToObsidian()" class="px-3 py-1.5 bg-purple-700 hover:bg-purple-600 rounded text-xs font-medium">📓 옵시디언</button>
                </div>
                <div class="flex items-center gap-1 bg-gray-800 rounded-lg px-1 py-1">
                  <button onclick="shiftAnalysisMorningDate(-1)" class="px-2 py-1 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-sm">&lsaquo;</button>
                  <span id="analysisMorningDateLabel" class="px-3 py-1 text-sm text-gray-300 font-medium"></span>
                  <button onclick="shiftAnalysisMorningDate(1)" class="px-2 py-1 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-sm">&rsaquo;</button>
                  <button onclick="resetAnalysisMorningDate()" class="px-2 py-1 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors text-xs ml-1">오늘</button>
                </div>
              </div>
            </div>
            <div id="morningPlanDetail" class="prose prose-invert max-w-none text-sm">
              <div class="text-center text-gray-500 py-12">날짜를 선택하세요</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 오늘 보고서 서브패널 -->
      <div id="analysisSubPanel-report" class="hidden">
        <div class="flex gap-4" style="min-height: 600px;">
          <!-- 왼쪽 사이드바: 이전 보고서 -->
          <div class="w-64 flex-shrink-0 bg-gray-800/50 rounded-xl border border-gray-700/50 p-4 overflow-y-auto" style="max-height: 700px;">
            <h3 class="text-sm font-bold text-gray-300 mb-3">📋 이전 보고서</h3>
            <div id="reportList" class="space-y-1">
              <div class="text-xs text-gray-500 text-center py-4">로딩 중...</div>
            </div>
          </div>
          <!-- 오른쪽 메인: 상세 -->
          <div class="flex-1 bg-gray-800/50 rounded-xl border border-gray-700/50 p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">📊 오늘 보고서</h3>
              <div id="reportActions" class="flex gap-2 hidden">
                <button onclick="copyReportToClipboard()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">📋 복사</button>
                <button onclick="downloadReport()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">💾 다운로드</button>
                <button onclick="exportReportToObsidian()" class="px-3 py-1.5 bg-purple-700 hover:bg-purple-600 rounded text-xs font-medium">📓 옵시디언</button>
              </div>
            </div>
            <div id="reportDetail" class="prose prose-invert max-w-none text-sm">
              <div class="text-center text-gray-500 py-12">보고서를 선택하세요</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 주간 분석 서브패널 -->
      <div id="analysisSubPanel-weekly" class="hidden">
        <div class="flex gap-4" style="min-height: 600px;">
          <!-- 왼쪽 사이드바: 이전 다이제스트 -->
          <div class="w-64 flex-shrink-0 bg-gray-800/50 rounded-xl border border-gray-700/50 p-4 overflow-y-auto" style="max-height: 700px;">
            <h3 class="text-sm font-bold text-gray-300 mb-3">📋 이전 다이제스트</h3>
            <div id="weeklyDigestList" class="space-y-1">
              <div class="text-xs text-gray-500 text-center py-4">로딩 중...</div>
            </div>
          </div>
          <!-- 오른쪽 메인: 상세 -->
          <div class="flex-1 bg-gray-800/50 rounded-xl border border-gray-700/50 p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-bold">📈 주간 분석</h3>
              <div id="weeklyActions" class="flex gap-2 hidden">
                <button onclick="copyWeeklyToClipboard()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">📋 복사</button>
                <button onclick="downloadWeeklyDigest()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">💾 다운로드</button>
                <button onclick="exportWeeklyToObsidian()" class="px-3 py-1.5 bg-purple-700 hover:bg-purple-600 rounded text-xs font-medium">📓 옵시디언</button>
              </div>
            </div>
            <div id="weeklyDigestStats" class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4" style="display:none">
              <div class="bg-gray-900/50 rounded-lg p-3">
                <div class="text-xs text-gray-500">세션</div>
                <div id="wdStatSessions" class="text-2xl font-bold mt-0.5">-</div>
              </div>
              <div class="bg-gray-900/50 rounded-lg p-3">
                <div class="text-xs text-gray-500">작업 실행</div>
                <div id="wdStatJobs" class="text-2xl font-bold mt-0.5">-</div>
              </div>
              <div class="bg-gray-900/50 rounded-lg p-3">
                <div class="text-xs text-gray-500">메모</div>
                <div id="wdStatMemos" class="text-2xl font-bold mt-0.5">-</div>
              </div>
              <div class="bg-gray-900/50 rounded-lg p-3">
                <div class="text-xs text-gray-500">성공률</div>
                <div id="wdStatSuccess" class="text-2xl font-bold mt-0.5">-</div>
              </div>
            </div>
            <div id="weeklyDigestDetail" class="prose prose-invert max-w-none text-sm">
              <div class="text-center text-gray-500 py-12">다이제스트를 선택하세요</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Job Modal -->
  <div id="jobModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-auto">
      <h2 id="modalTitle" class="text-xl font-bold mb-4">작업 추가</h2>

      <!-- 탭 네비게이션 -->
      <div class="flex gap-2 mb-4 border-b border-gray-700">
        <button type="button" onclick="showEditTab('basic')" id="editTab-basic"
          class="edit-tab-btn px-4 py-2 border-b-2 border-blue-500 text-blue-400 font-medium text-sm">
          기본 정보
        </button>
        <button type="button" onclick="showEditTab('options')" id="editTab-options"
          class="edit-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm">
          실행 옵션
        </button>
        <button type="button" onclick="showEditTab('execution')" id="editTab-execution"
          class="edit-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm">
          실행 제어
        </button>
      </div>

      <form id="jobForm">
        <input type="hidden" id="jobId">

        <!-- 기본 정보 탭 -->
        <div id="editPanel-basic" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">작업 이름 *</label>
            <input type="text" id="jobName" required
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">설명</label>
            <input type="text" id="jobDescription"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">명령어 *</label>
            <textarea id="jobCommand" required rows="2"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">스케줄 설정</label>

            <!-- 모드 토글 -->
            <div class="flex gap-4 mb-3">
              <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input type="radio" name="schedMode" value="simple" onchange="toggleScheduleMode('simple')" class="w-4 h-4"> 간편 설정
              </label>
              <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input type="radio" name="schedMode" value="cron" checked onchange="toggleScheduleMode('cron')" class="w-4 h-4"> Cron 직접 입력
              </label>
              <a href="https://crontab.guru" target="_blank" class="text-blue-400 text-xs ml-auto self-center">crontab.guru ↗</a>
            </div>

            <!-- 간편 설정 모드 -->
            <div id="simpleSchedulePanel" class="hidden space-y-3 mb-3">
              <div>
                <label class="block text-xs text-gray-400 mb-1">반복 주기</label>
                <select id="schedFrequency" onchange="onFrequencyChange()"
                  class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                  <option value="hourly">매시간</option>
                  <option value="daily">매일</option>
                  <option value="weekdays" selected>평일만</option>
                  <option value="weekly">매주 특정 요일</option>
                  <option value="monthly">매월</option>
                </select>
              </div>

              <!-- 요일 선택기 (weekly만) -->
              <div id="schedWeekdayPicker" class="hidden">
                <label class="block text-xs text-gray-400 mb-1">요일 선택</label>
                <div class="flex gap-1">
                  <button type="button" onclick="toggleWeekday(1)" data-day="1" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">월</button>
                  <button type="button" onclick="toggleWeekday(2)" data-day="2" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">화</button>
                  <button type="button" onclick="toggleWeekday(3)" data-day="3" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">수</button>
                  <button type="button" onclick="toggleWeekday(4)" data-day="4" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">목</button>
                  <button type="button" onclick="toggleWeekday(5)" data-day="5" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">금</button>
                  <button type="button" onclick="toggleWeekday(6)" data-day="6" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">토</button>
                  <button type="button" onclick="toggleWeekday(0)" data-day="0" class="weekday-btn px-3 py-1.5 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">일</button>
                </div>
              </div>

              <!-- 매월 날짜 (monthly만) -->
              <div id="schedMonthDayPicker" class="hidden">
                <label class="block text-xs text-gray-400 mb-1">날짜</label>
                <div class="flex items-center gap-1">
                  <input type="number" id="schedMonthDay" min="1" max="28" value="1"
                    class="w-20 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500" onchange="generateCronFromSimple()">
                  <span class="text-sm text-gray-400">일</span>
                </div>
              </div>

              <!-- 시간 선택 (hourly 아닐 때) -->
              <div id="schedTimePicker">
                <label class="block text-xs text-gray-400 mb-1">실행 시간</label>
                <input type="time" id="schedTime" value="09:00"
                  class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500" onchange="generateCronFromSimple()">
              </div>

              <!-- 분 오프셋 (hourly만) -->
              <div id="schedMinutePicker" class="hidden">
                <label class="block text-xs text-gray-400 mb-1">분 (매시 N분)</label>
                <input type="number" id="schedMinute" min="0" max="59" value="0"
                  class="w-20 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500" onchange="generateCronFromSimple()">
              </div>
            </div>

            <!-- Cron 직접 입력 모드 -->
            <div id="cronSchedulePanel">
              <div class="flex gap-3 items-start">
                <input type="text" id="jobSchedule" required placeholder="0 9 * * *"
                  class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono"
                  oninput="updateCronDescription()">
                <div id="cronBubble" class="relative bg-gradient-to-r from-blue-600/30 to-purple-600/30 border border-blue-500/50 text-blue-200 text-xs px-3 py-2 rounded-lg min-w-[140px] hidden">
                  <div class="absolute left-0 top-3 -translate-x-[7px]">
                    <div class="w-0 h-0 border-y-[6px] border-y-transparent border-r-[7px] border-r-blue-500/50"></div>
                  </div>
                  <div id="cronDescription" class="font-medium">-</div>
                  <div id="cronNextRun" class="text-gray-400 mt-1 text-[10px]"></div>
                </div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">카테고리</label>
            <select id="jobCategory"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">메모</label>
            <textarea id="jobNotes" rows="2" placeholder="비활성화 사유, 주의사항 등..."
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 text-sm"></textarea>
            <p class="text-xs text-gray-500 mt-1">작업에 대한 메모나 주의사항을 기록합니다</p>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="jobEnabled" class="w-4 h-4 rounded">
            <label for="jobEnabled" class="text-sm">활성화 (스케줄 자동 실행)</label>
          </div>
        </div>

        <!-- 실행 옵션 탭 -->
        <div id="editPanel-options" class="hidden space-y-4">
          <p class="text-sm text-gray-400 mb-4">
            스케줄 실행 또는 수동 실행 시 적용될 기본 옵션을 설정합니다.
          </p>
          <div id="editOptionsContainer">
            <!-- 옵션들이 여기에 렌더링됨 -->
          </div>
        </div>

        <!-- 실행 제어 탭 -->
        <div id="editPanel-execution" class="hidden space-y-4">
          <p class="text-sm text-gray-400 mb-4">
            실행 시간 제한과 실패 시 재시도 정책을 설정합니다.
          </p>

          <!-- Timeout 설정 -->
          <div class="bg-gray-700/50 p-4 rounded-lg">
            <h4 class="font-medium mb-3">⏱️ 실행 시간 제한</h4>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Timeout (분)</label>
              <input type="number" id="jobTimeout" min="1" max="120" value="5"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
              <p class="text-xs text-gray-500 mt-1">지정된 시간이 지나면 작업을 강제 종료합니다 (1~120분)</p>
            </div>
          </div>

          <!-- 재시도 설정 -->
          <div class="bg-gray-700/50 p-4 rounded-lg">
            <h4 class="font-medium mb-3">🔄 실패 시 재시도</h4>
            <div class="space-y-3">
              <div>
                <label class="block text-sm text-gray-400 mb-1">최대 재시도 횟수</label>
                <input type="number" id="jobMaxRetries" min="0" max="10" value="0"
                  class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">실패 시 자동으로 재시도할 횟수 (0 = 재시도 안함)</p>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">재시도 간격 (초)</label>
                <input type="number" id="jobRetryDelay" min="1" max="300" value="5"
                  class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">재시도 전 대기 시간 (1~300초)</p>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Backoff 전략</label>
                <select id="jobRetryBackoff"
                  class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                  <option value="fixed">고정 (Fixed)</option>
                  <option value="linear">선형 (Linear: delay * attempt)</option>
                  <option value="exponential">지수 (Exponential: delay * 2^attempt)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-3 pt-6 border-t border-gray-700 mt-6">
          <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
            저장
          </button>
          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
            취소
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Run Options Modal -->
  <div id="optionsModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">실행 옵션</h2>
        <button onclick="closeOptionsModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="optionsJobInfo" class="mb-4 pb-4 border-b border-gray-700">
        <h3 id="optionsJobName" class="font-semibold text-lg"></h3>
        <p id="optionsJobDesc" class="text-sm text-gray-400"></p>
      </div>
      <div id="optionsContainer" class="space-y-4 mb-6">
        <!-- Options will be rendered here -->
      </div>
      <div id="optionsCommand" class="mb-4 p-3 bg-gray-900 rounded-lg">
        <p class="text-xs text-gray-400 mb-1">실행될 명령어:</p>
        <code id="optionsCommandPreview" class="text-sm text-green-400 break-all"></code>
      </div>
      <div class="flex gap-3">
        <button onclick="executeWithOptions()" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium">
          ▶ 실행
        </button>
        <button onclick="closeOptionsModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
          취소
        </button>
      </div>
    </div>
  </div>

  <!-- Edge Type Modal -->
  <div id="edgeModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">연결 타입 선택</h2>
      <input type="hidden" id="edgeFrom">
      <input type="hidden" id="edgeTo">

      <div class="space-y-2 mb-4">
        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="visual" checked class="w-4 h-4" onchange="onEdgeTypeChange()">
          <div>
            <div class="font-medium">시각적 연결</div>
            <div class="text-sm text-gray-400">관계 표시만 (자동 실행 안함)</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-success" class="w-4 h-4" onchange="onEdgeTypeChange()">
          <div>
            <div class="font-medium text-green-400">✓ 성공 시 실행</div>
            <div class="text-sm text-gray-400">앞 작업 성공하면 다음 실행</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-failure" class="w-4 h-4" onchange="onEdgeTypeChange()">
          <div>
            <div class="font-medium text-red-400">✗ 실패 시 실행</div>
            <div class="text-sm text-gray-400">앞 작업 실패하면 다음 실행</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-always" class="w-4 h-4" onchange="onEdgeTypeChange()">
          <div>
            <div class="font-medium text-yellow-400">⚡ 항상 실행</div>
            <div class="text-sm text-gray-400">성공/실패 관계없이 다음 실행</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-output" class="w-4 h-4" onchange="onEdgeTypeChange()">
          <div>
            <div class="font-medium text-blue-400">📋 출력값 매칭</div>
            <div class="text-sm text-gray-400">출력에 특정 패턴 포함 시 실행</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-exitcode" class="w-4 h-4" onchange="onEdgeTypeChange()">
          <div>
            <div class="font-medium text-amber-400">🔢 종료 코드 매칭</div>
            <div class="text-sm text-gray-400">특정 exit code일 때 실행</div>
          </div>
        </label>
      </div>

      <!-- 출력값 매칭 추가 옵션 -->
      <div id="edgeConditionExtra" class="hidden mb-4 p-3 bg-gray-900 rounded-lg space-y-2">
        <div>
          <label class="block text-xs text-gray-400 mb-1">패턴</label>
          <input id="edgeConditionPattern" type="text" placeholder="ERROR, CRITICAL 등"
            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
        </div>
        <div class="flex gap-3">
          <label class="flex items-center gap-1 text-sm text-gray-400 cursor-pointer">
            <input type="radio" name="edgeMatchType" value="contains" checked class="w-3 h-3"> 포함
          </label>
          <label class="flex items-center gap-1 text-sm text-gray-400 cursor-pointer">
            <input type="radio" name="edgeMatchType" value="regex" class="w-3 h-3"> 정규식
          </label>
        </div>
      </div>

      <!-- 종료 코드 매칭 추가 옵션 -->
      <div id="edgeExitCodeExtra" class="hidden mb-4 p-3 bg-gray-900 rounded-lg">
        <label class="block text-xs text-gray-400 mb-1">종료 코드</label>
        <input id="edgeExitCode" type="number" min="0" max="255" value="0" placeholder="0"
          class="w-24 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
        <p class="text-xs text-gray-500 mt-1">0 = 성공, 1+ = 에러 코드</p>
      </div>

      <div class="flex gap-3">
        <button onclick="confirmEdgeCreate()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
          연결
        </button>
        <button onclick="closeEdgeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
          취소
        </button>
      </div>
    </div>
  </div>

  <!-- Schedule Run Modal -->
  <div id="scheduleModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">예약 실행</h2>
        <button onclick="closeScheduleModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="scheduleJobInfo" class="text-sm text-gray-400 mb-4"></div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">실행 날짜/시간</label>
          <input type="datetime-local" id="scheduleDateTime"
            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
        </div>
        <p class="text-xs text-gray-500">지정된 시간에 1회만 실행됩니다.</p>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmScheduleRun()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
          예약
        </button>
        <button onclick="closeScheduleModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
          취소
        </button>
      </div>
    </div>
  </div>

  <!-- Log Detail Modal -->
  <div id="logModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">실행 로그</h2>
        <button onclick="closeLogModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="logContent" class="space-y-4">
        <div id="logCommandSection" class="hidden">
          <h3 class="text-sm font-medium text-gray-400 mb-1">실행 명령어</h3>
          <pre id="logCommand" class="bg-gray-900 p-3 rounded-lg text-sm overflow-auto whitespace-pre-wrap text-green-400"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-medium text-gray-400">stdout</h3>
            <button onclick="toggleLogExpand('logStdout')" class="text-xs text-blue-400 hover:text-blue-300">
              확장/축소
            </button>
          </div>
          <pre id="logStdout" class="bg-gray-900 p-3 rounded-lg text-sm overflow-auto max-h-64 whitespace-pre-wrap transition-all"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-medium text-gray-400">stderr</h3>
            <button onclick="toggleLogExpand('logStderr')" class="text-xs text-blue-400 hover:text-blue-300">
              확장/축소
            </button>
          </div>
          <pre id="logStderr" class="bg-gray-900 p-3 rounded-lg text-sm overflow-auto max-h-64 whitespace-pre-wrap text-red-400 transition-all"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Panel (오른쪽 하단 고정) -->
  <div id="taskPanel" class="fixed bottom-4 right-4 w-80 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl hidden z-40 overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 bg-gray-750 border-b border-gray-700">
      <h3 class="text-sm font-medium flex items-center gap-2">
        <span class="status-dot bg-blue-500 pulse w-2 h-2"></span>
        진행 중인 작업
        <span id="taskCount" class="bg-blue-600 px-2 py-0.5 rounded-full text-xs">0</span>
      </h3>
      <div class="flex items-center gap-1">
        <button onclick="clearCompletedTasks()" class="text-gray-400 hover:text-white text-xs px-2 py-1 hover:bg-gray-700 rounded" title="완료된 작업 지우기">
          정리
        </button>
        <button onclick="toggleTaskPanelCollapse()" class="text-gray-400 hover:text-white px-2 py-1 hover:bg-gray-700 rounded">
          <span id="taskPanelToggle">▼</span>
        </button>
      </div>
    </div>
    <div id="taskList" class="max-h-72 overflow-y-auto p-2 space-y-2 custom-scrollbar">
      <!-- 작업 항목들이 동적으로 추가됨 -->
    </div>
  </div>

  <!-- Rename Session Modal -->
  <div id="renameSessionModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-[60]" style="display:none">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm mx-4">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl">✏️</span>
        <span class="text-lg font-medium">세션 이름 변경</span>
        <button onclick="closeRenameSessionModal()" class="ml-auto text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <input id="renameSessionInput" type="text"
        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500"
        placeholder="세션 이름을 입력하세요 (비워두면 초기화)"
        onkeydown="if(event.key === 'Enter') submitSessionRename()">
      <p class="text-xs text-gray-500 mt-2">비워두면 기본 프로젝트 이름으로 표시됩니다.</p>
      <div class="flex gap-2 mt-4">
        <button onclick="submitSessionRename()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
          저장
        </button>
        <button onclick="closeRenameSessionModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
          취소
        </button>
      </div>
    </div>
  </div>

  <!-- Global Search Modal (Cmd+K) -->
  <div id="globalSearchModal" class="modal fixed inset-0 bg-black/60 items-start justify-center pt-[18vh] z-50"
       style="display:none" onclick="if(event.target===this)closeGlobalSearch()">
    <div class="bg-gray-800 rounded-xl w-full max-w-2xl mx-4 shadow-2xl border border-gray-700">
      <div class="flex items-center gap-3 px-4 py-3 border-b border-gray-700">
        <span class="text-gray-500 text-lg">🔍</span>
        <input id="globalSearchInput" type="text" placeholder="검색... (세션, 메모, 작업, 백로그)"
          class="flex-1 bg-transparent text-lg outline-none text-gray-200 placeholder-gray-600"
          oninput="debounceGlobalSearch()" onkeydown="handleSearchKeydown(event)">
        <kbd class="text-xs text-gray-500 bg-gray-700 px-1.5 py-0.5 rounded">ESC</kbd>
      </div>
      <div id="globalSearchResults" class="max-h-[50vh] overflow-y-auto p-2">
        <div class="text-center text-gray-600 text-sm py-8">Cmd+K로 검색을 시작하세요</div>
      </div>
    </div>
  </div>

  <!-- Webhook Token Copy Modal -->
  <div id="tokenCopyModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4">
      <h2 class="text-xl font-bold mb-2">토큰 생성 완료</h2>
      <p class="text-sm text-yellow-400 mb-4">이 토큰은 다시 볼 수 없습니다. 지금 복사하세요.</p>
      <div class="bg-gray-900 rounded-lg p-3 mb-4">
        <code id="tokenCopyValue" class="text-sm text-green-400 break-all select-all"></code>
      </div>
      <div class="mb-4">
        <label class="block text-xs text-gray-400 mb-1">사용 예시 (curl)</label>
        <pre id="tokenCopyCurl" class="bg-gray-900 rounded-lg p-3 text-xs text-gray-300 overflow-x-auto whitespace-pre-wrap"></pre>
      </div>
      <div class="flex gap-3">
        <button onclick="copyTokenToClipboard()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium text-sm">토큰 복사</button>
        <button onclick="document.getElementById('tokenCopyModal').classList.remove('active')" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium text-sm">닫기</button>
      </div>
    </div>
  </div>

  <!-- Simple Input Modal (for token name etc.) -->
  <div id="simpleInputModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm mx-4">
      <h2 id="simpleInputTitle" class="text-lg font-bold mb-3"></h2>
      <input id="simpleInputValue" type="text" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 mb-4"
        onkeydown="if(event.key==='Enter')resolveSimpleInput()">
      <div class="flex gap-3">
        <button onclick="resolveSimpleInput()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium text-sm">확인</button>
        <button onclick="rejectSimpleInput()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium text-sm">취소</button>
      </div>
    </div>
  </div>

  <!-- Ask Claude Modal -->
  <div id="askModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[80vh] overflow-auto">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl" id="askModalEmoji">🤖</span>
        <span class="text-lg font-medium">무엇이든 물어보세요</span>
        <button onclick="closeAskModal()" class="ml-auto text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <textarea id="askInput"
        class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 min-h-[100px] resize-none focus:outline-none focus:border-blue-500"
        placeholder="질문을 입력하세요..."
        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitQuestion(); }"></textarea>

      <div id="askResponse" class="hidden mt-4 bg-gray-700 rounded-lg p-4 max-h-60 overflow-auto custom-scrollbar">
        <div id="askResponseText" class="text-sm markdown-content"></div>
      </div>

      <div id="askLoading" class="hidden mt-4 text-center text-gray-400">
        <div class="inline-block w-6 h-6 border-2 border-gray-600 border-t-blue-500 rounded-full animate-spin mb-2"></div>
        <div>Claude에게 질문 중...</div>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="askSubmitBtn" onclick="submitQuestion()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium transition-colors">
          🤖 질문하기
        </button>
        <button id="askCopyBtn" onclick="copyAskResponse()" class="hidden px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
          📋 복사
        </button>
        <button onclick="closeAskModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Input Modal -->
  <div id="quickInputModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gradient-to-br from-purple-900 to-blue-900 rounded-xl p-6 w-full max-w-xl mx-4">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl" id="quickInputIcon">📝</span>
        <span class="text-lg font-medium" id="quickInputTitle">빠른 메모</span>
        <button onclick="closeQuickInputModal()" class="ml-auto text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- 타입 토글: 메모 / 백로그 -->
      <div class="flex bg-white/10 rounded-lg p-1 mb-4">
        <button onclick="setQuickInputType('memo')" id="qiTypeMemo"
          class="flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white/20 text-white">
          📝 메모
        </button>
        <button onclick="setQuickInputType('backlog')" id="qiTypeBacklog"
          class="flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-white/60">
          📋 백로그
        </button>
      </div>

      <textarea id="quickInputText"
        class="w-full bg-white/10 border border-white/20 rounded-lg p-4 min-h-[160px] resize-y focus:outline-none focus:border-white/40 placeholder-white/50 text-sm leading-relaxed font-mono"
        placeholder="마크다운 형식으로 작성 가능합니다...&#10;&#10;예시:&#10;- 항목 1&#10;- **중요한 내용**&#10;- `코드` 관련 메모"
        oninput="updateQuickInputPreview()"
        onkeydown="if(event.key === 'Enter' && (event.metaKey || event.ctrlKey)) { event.preventDefault(); saveQuickInput(); }"></textarea>

      <!-- 마크다운 미리보기 토글 -->
      <div class="flex items-center gap-2 mt-2 mb-1">
        <button onclick="toggleQuickInputPreview()" id="qiPreviewToggle"
          class="text-xs text-white/40 hover:text-white/70 transition-colors">
          👁 미리보기
        </button>
        <span class="text-xs text-white/30">마크다운 지원 · ⌘+Enter 저장</span>
      </div>
      <div id="qiPreviewArea" class="hidden bg-white/5 border border-white/10 rounded-lg p-4 max-h-[120px] overflow-auto markdown-content text-sm"></div>

      <!-- 메모 카테고리 (메모 모드에서만 표시) -->
      <div id="memoCategoryRow" class="mt-3 flex items-center gap-2">
        <span class="text-xs text-white/60">카테고리:</span>
        <button onclick="setMemoCategory('learning')" data-cat="learning"
          class="memo-cat-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-green-400 hover:text-green-400 transition-colors">📚 학습</button>
        <button onclick="setMemoCategory('work')" data-cat="work"
          class="memo-cat-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-blue-400 hover:text-blue-400 transition-colors">💼 업무</button>
        <button onclick="setMemoCategory('idea')" data-cat="idea"
          class="memo-cat-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-yellow-400 hover:text-yellow-400 transition-colors">💡 아이디어</button>
        <button onclick="setMemoCategory('todo')" data-cat="todo"
          class="memo-cat-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-emerald-400 hover:text-emerald-400 transition-colors">✅ 완료</button>
      </div>

      <!-- 백로그 우선순위 (백로그 모드에서만 표시) -->
      <div id="backlogPriorityRow" class="hidden mt-3 flex items-center gap-2">
        <span class="text-xs text-white/60">우선순위:</span>
        <button onclick="setBacklogPriority('high')" data-pri="high"
          class="backlog-pri-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-red-400 hover:text-red-400 transition-colors">🔴 높음</button>
        <button onclick="setBacklogPriority('normal')" data-pri="normal"
          class="backlog-pri-btn px-2 py-1 rounded text-xs border border-white/30 bg-white/10 text-white transition-colors">🟡 보통</button>
        <button onclick="setBacklogPriority('low')" data-pri="low"
          class="backlog-pri-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-blue-400 hover:text-blue-400 transition-colors">🔵 낮음</button>
      </div>

      <div class="flex gap-2 mt-4">
        <button onclick="saveQuickInput()" id="quickInputSaveBtn" class="flex-1 px-4 py-2.5 bg-white/20 hover:bg-white/30 rounded-lg font-medium transition-colors">
          💾 저장
        </button>
        <button onclick="closeQuickInputModal()" class="px-4 py-2.5 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
          취소
        </button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="taskDetailModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[85vh] flex flex-col">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl" id="taskDetailEmoji">🔄</span>
        <div class="flex-1">
          <h3 class="text-lg font-medium" id="taskDetailTitle">작업 상세</h3>
          <p class="text-sm text-gray-400" id="taskDetailStatus">진행 중</p>
        </div>
        <button onclick="closeTaskDetailModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <div class="flex gap-2 mb-4">
        <button onclick="switchTaskTab('output')" id="taskTabOutput" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600">출력</button>
        <button onclick="switchTaskTab('logs')" id="taskTabLogs" class="px-3 py-1.5 rounded-lg text-sm bg-gray-700 hover:bg-gray-600">로그</button>
      </div>

      <div id="taskDetailContent" class="flex-1 overflow-auto custom-scrollbar">
        <div id="taskOutputTab" class="bg-gray-900/50 rounded-lg p-4 text-sm max-h-[50vh] overflow-auto">
          대기 중...
        </div>
        <div id="taskLogsTab" class="hidden bg-gray-900 rounded-lg p-4 font-mono text-xs max-h-[50vh] overflow-auto">
        </div>
      </div>

      <div class="flex gap-2 mt-4 pt-4 border-t border-gray-700">
        <button onclick="refreshTaskDetail()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
          🔄 새로고침
        </button>
        <button onclick="closeTaskDetailModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm ml-auto">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- Day Wrap-up Wizard Modal -->
  <div id="dayWrapupModal" class="modal fixed inset-0 bg-black/60 items-center justify-center z-50 overflow-auto py-4">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl w-full max-w-3xl mx-4 shadow-2xl border border-gray-700/50">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-3xl">🌙</span>
          <div>
            <h2 class="text-xl font-bold">하루 마무리</h2>
            <p class="text-sm text-gray-400" id="wrapupDate">오늘의 하루를 의미있게 정리해보세요</p>
          </div>
        </div>
        <button onclick="closeDayWrapupModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- Progress Steps -->
      <div class="px-6 py-3 border-b border-gray-700/30 bg-gray-800/30">
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center gap-2" id="step1Indicator">
            <span class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">1</span>
            <span class="text-gray-300">세션 선택</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="step2Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">2</span>
            <span class="text-gray-500">GitHub</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="step3Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">3</span>
            <span class="text-gray-500">메모</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="step4Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">4</span>
            <span class="text-gray-500">회고</span>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="p-6 max-h-[55vh] overflow-auto custom-scrollbar" id="wrapupContent">
        <!-- Step content will be rendered here -->
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-gray-700/50 flex items-center justify-between">
        <button onclick="prevWrapupStep()" id="wrapupPrevBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm hidden">
          ← 이전
        </button>
        <div class="flex-1"></div>
        <button onclick="nextWrapupStep()" id="wrapupNextBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">
          다음 →
        </button>
        <button onclick="submitDayWrapup()" id="wrapupSubmitBtn" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg font-medium hidden">
          🌙 하루 마무리 생성
        </button>
      </div>
    </div>
  </div>

  <!-- Morning Start Wizard Modal -->
  <div id="morningStartModal" class="modal fixed inset-0 bg-black/60 items-center justify-center z-50 overflow-auto py-4">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl w-full max-w-3xl mx-4 shadow-2xl border border-gray-700/50">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-t-2xl">
        <div class="flex items-center gap-3">
          <span class="text-3xl" id="morningHeaderIcon">☀️</span>
          <div>
            <h2 class="text-xl font-bold" id="morningHeaderTitle">하루 시작</h2>
            <p class="text-sm text-gray-400" id="morningDate">오늘 하루를 계획해보세요</p>
          </div>
        </div>
        <button onclick="closeMorningStartModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- Progress Steps (wizard mode only) -->
      <div id="morningStepBar" class="px-6 py-3 border-b border-gray-700/30 bg-gray-800/30">
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center gap-2" id="mStep1Indicator">
            <span class="w-6 h-6 rounded-full bg-amber-600 flex items-center justify-center text-xs font-bold">1</span>
            <span class="text-gray-300">업무</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="mStep2Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">2</span>
            <span class="text-gray-500">추가</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="mStep3Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">3</span>
            <span class="text-gray-500">목표</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="mStep4Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">4</span>
            <span class="text-gray-500">확인</span>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="p-6 max-h-[65vh] overflow-auto custom-scrollbar" id="morningContent">
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-gray-700/50 flex items-center justify-between" id="morningFooter">
        <button onclick="prevMorningStep()" id="morningPrevBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm hidden">
          ← 이전
        </button>
        <div class="flex-1"></div>
        <button onclick="nextMorningStep()" id="morningNextBtn" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">
          다음 →
        </button>
        <button onclick="submitMorningPlan()" id="morningSubmitBtn" class="px-6 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-lg font-medium hidden">
          ☀️ 하루 시작!
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';

    // KST 날짜 헬퍼 (Asia/Seoul)
    function getKSTDateString(date) {
      const d = date || new Date();
      return d.toLocaleDateString('en-CA', { timeZone: 'Asia/Seoul' });
    }

    // ============ 비동기 작업 시스템 ============
    let eventSource = null;
    let clientId = `client-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    const activeTasks = new Map();

    // SSE 연결 초기화
    function initSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`${API_BASE}/api/tasks/events?clientId=${clientId}`);

      eventSource.addEventListener('connected', (e) => {
        const data = JSON.parse(e.data);
        console.log('[SSE] 연결됨:', data.clientId);
      });

      eventSource.addEventListener('task:started', (e) => {
        const data = JSON.parse(e.data);
        activeTasks.set(data.taskId, { type: data.type, status: 'running' });
        addTaskToPanel(data);
      });

      eventSource.addEventListener('task:progress', (e) => {
        const data = JSON.parse(e.data);
        updateTaskProgress(data);
      });

      eventSource.addEventListener('task:completed', (e) => {
        const data = JSON.parse(e.data);
        markTaskCompleted(data);
        handleTaskResult(data);
      });

      eventSource.addEventListener('task:failed', (e) => {
        const data = JSON.parse(e.data);
        markTaskFailed(data);
      });

      eventSource.addEventListener('task:deleted', (e) => {
        const data = JSON.parse(e.data);
        removeTaskFromPanel(data.taskId);
      });

      // Phase 4: 메모 분류 완료 이벤트
      eventSource.addEventListener('memo:classified', (e) => {
        const data = JSON.parse(e.data);
        // 노트 탭이 보이면 메모 데이터 업데이트
        const memo = notesData?.memos?.find(m => m.id === data.memoId);
        if (memo) {
          memo.category = data.category;
          memo.tags = data.tags;
          renderNotesList();
        }
      });

      eventSource.onerror = () => {
        console.log('[SSE] 연결 오류, 5초 후 재연결...');
        setTimeout(initSSE, 5000);
      };
    }

    // 작업 패널에 항목 추가
    function addTaskToPanel(data) {
      const panel = document.getElementById('taskPanel');
      const list = document.getElementById('taskList');

      panel.classList.remove('hidden');

      const taskEl = document.createElement('div');
      taskEl.id = `task-${data.taskId}`;
      taskEl.className = 'bg-gray-700 rounded-lg p-3 border border-gray-600 cursor-pointer hover:bg-gray-650 transition-colors';
      taskEl.setAttribute('data-task-id', data.taskId);
      taskEl.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium task-click-area" onclick="showTaskDetail('${data.taskId}')">${getTaskTypeName(data.type)}</span>
          <button onclick="event.stopPropagation(); cancelTask('${data.taskId}')" class="text-gray-400 hover:text-red-400 text-xs px-2 py-0.5 hover:bg-gray-600 rounded">
            취소
          </button>
        </div>
        <div class="flex items-center gap-2 mb-1 task-click-area" onclick="showTaskDetail('${data.taskId}')">
          <div class="flex-1 bg-gray-600 rounded-full h-1.5">
            <div id="progress-${data.taskId}" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <span id="progress-text-${data.taskId}" class="text-xs text-gray-400 w-8 text-right">0%</span>
        </div>
        <div id="message-${data.taskId}" class="text-xs text-gray-400 truncate task-click-area" onclick="showTaskDetail('${data.taskId}')">시작 중...</div>
      `;

      list.prepend(taskEl);
      updateTaskCount();
    }

    // 진행률 업데이트
    function updateTaskProgress(data) {
      const progressBar = document.getElementById(`progress-${data.taskId}`);
      const progressText = document.getElementById(`progress-text-${data.taskId}`);
      const message = document.getElementById(`message-${data.taskId}`);

      if (progressBar) {
        progressBar.style.width = `${data.progress}%`;
      }
      if (progressText) {
        progressText.textContent = `${data.progress}%`;
      }
      if (message && data.message) {
        message.textContent = data.message;
      }
    }

    // 작업 완료 표시
    function markTaskCompleted(data) {
      const taskEl = document.getElementById(`task-${data.taskId}`);
      if (taskEl) {
        taskEl.className = 'bg-green-900/30 rounded-lg p-3 border border-green-700/50';

        const progressBar = document.getElementById(`progress-${data.taskId}`);
        if (progressBar) {
          progressBar.style.width = '100%';
          progressBar.className = 'bg-green-500 h-1.5 rounded-full';
        }

        const progressText = document.getElementById(`progress-text-${data.taskId}`);
        if (progressText) {
          progressText.textContent = '✓';
          progressText.className = 'text-xs text-green-400 w-8 text-right';
        }

        const message = document.getElementById(`message-${data.taskId}`);
        if (message) {
          message.innerHTML = `<button onclick="viewTaskResult('${data.taskId}')" class="text-green-400 hover:underline">결과 보기</button>`;
        }

        // 취소 버튼 제거
        const cancelBtn = taskEl.querySelector('button');
        if (cancelBtn) cancelBtn.remove();
      }

      activeTasks.set(data.taskId, { type: data.type, status: 'completed', result: data.result });
      showToast(`${getTaskTypeName(data.type)} 완료!`, 'success');

      // 5초 후 자동 제거
      setTimeout(() => {
        removeTaskFromPanel(data.taskId);
      }, 8000);
    }

    // 작업 실패 표시
    function markTaskFailed(data) {
      const taskEl = document.getElementById(`task-${data.taskId}`);
      if (taskEl) {
        taskEl.className = 'bg-red-900/30 rounded-lg p-3 border border-red-700/50';

        const progressBar = document.getElementById(`progress-${data.taskId}`);
        if (progressBar) {
          progressBar.className = 'bg-red-500 h-1.5 rounded-full';
        }

        const progressText = document.getElementById(`progress-text-${data.taskId}`);
        if (progressText) {
          progressText.textContent = '✗';
          progressText.className = 'text-xs text-red-400 w-8 text-right';
        }

        const message = document.getElementById(`message-${data.taskId}`);
        if (message) {
          message.textContent = data.error || '실패';
          message.className = 'text-xs text-red-400 truncate';
        }

        const cancelBtn = taskEl.querySelector('button');
        if (cancelBtn) cancelBtn.remove();
      }

      activeTasks.set(data.taskId, { type: data.type, status: 'failed', error: data.error });
      showToast(`${getTaskTypeName(data.type)} 실패: ${data.error}`, 'error');
    }

    // 패널에서 작업 제거
    function removeTaskFromPanel(taskId) {
      const taskEl = document.getElementById(`task-${taskId}`);
      if (taskEl) {
        taskEl.remove();
      }
      activeTasks.delete(taskId);
      updateTaskCount();

      // 작업이 없으면 패널 숨기기
      if (activeTasks.size === 0) {
        document.getElementById('taskPanel').classList.add('hidden');
      }
    }

    // 작업 개수 업데이트
    function updateTaskCount() {
      const runningCount = Array.from(activeTasks.values()).filter(t => t.status === 'running').length;
      document.getElementById('taskCount').textContent = runningCount;
    }

    // 작업 타입 이름
    function getTaskTypeName(type) {
      const names = {
        'ask': '🤖 Claude 질문',
        'daily-report': '📊 일일 보고서',
        'session-summary': '📋 세션 요약',
        'full-daily-report': '📊 종합 보고서',
        'day-wrapup': '🌙 하루 마무리'
      };
      return names[type] || type;
    }

    // 작업 취소
    async function cancelTask(taskId) {
      try {
        await fetch(`${API_BASE}/api/tasks/${taskId}`, { method: 'DELETE' });
        removeTaskFromPanel(taskId);
        showToast('작업이 취소되었습니다', 'info');
      } catch (err) {
        showToast('취소 실패: ' + err.message, 'error');
      }
    }

    // 완료된 작업 정리
    function clearCompletedTasks() {
      for (const [taskId, task] of activeTasks) {
        if (task.status === 'completed' || task.status === 'failed') {
          removeTaskFromPanel(taskId);
        }
      }
    }

    // 패널 접기/펼치기
    function toggleTaskPanelCollapse() {
      const list = document.getElementById('taskList');
      const toggle = document.getElementById('taskPanelToggle');

      if (list.classList.contains('hidden')) {
        list.classList.remove('hidden');
        toggle.textContent = '▼';
      } else {
        list.classList.add('hidden');
        toggle.textContent = '▲';
      }
    }

    // ============ Task Detail Modal ============
    let currentTaskDetailId = null;
    let taskDetailRefreshInterval = null;

    async function showTaskDetail(taskId) {
      currentTaskDetailId = taskId;
      const modal = document.getElementById('taskDetailModal');
      modal.classList.add('active');
      modal.style.display = 'flex';

      await refreshTaskDetail();

      // 자동 새로고침 (2초마다)
      taskDetailRefreshInterval = setInterval(async () => {
        const task = activeTasks.get(currentTaskDetailId);
        if (task && task.status === 'running') {
          await refreshTaskDetail();
        } else {
          clearInterval(taskDetailRefreshInterval);
        }
      }, 2000);
    }

    async function refreshTaskDetail() {
      if (!currentTaskDetailId) return;

      try {
        const res = await fetch(`${API_BASE}/api/tasks/${currentTaskDetailId}`);
        if (!res.ok) {
          document.getElementById('taskOutputTab').textContent = '작업을 찾을 수 없습니다.';
          return;
        }

        const task = await res.json();
        updateTaskDetailUI(task);
      } catch (err) {
        document.getElementById('taskOutputTab').textContent = '오류: ' + err.message;
      }
    }

    function updateTaskDetailUI(task) {
      document.getElementById('taskDetailTitle').textContent = getTaskTypeName(task.type);

      const statusMap = {
        'pending': '⏳ 대기 중',
        'running': '🔄 진행 중',
        'completed': '✅ 완료',
        'failed': '❌ 실패'
      };
      document.getElementById('taskDetailStatus').textContent = statusMap[task.status] || task.status;

      const emojiMap = {
        'pending': '⏳',
        'running': '🔄',
        'completed': '✅',
        'failed': '❌'
      };
      document.getElementById('taskDetailEmoji').textContent = emojiMap[task.status] || '🔄';

      // 출력 탭 - 상태에 따라 다른 UI 표시
      const outputTab = document.getElementById('taskOutputTab');

      if (task.status === 'pending') {
        outputTab.innerHTML = `
          <div class="flex flex-col items-center justify-center py-8 text-gray-400">
            <div class="text-4xl mb-4">⏳</div>
            <div class="text-lg font-medium">대기 중</div>
            <div class="text-sm mt-2">작업이 곧 시작됩니다...</div>
          </div>
        `;
      } else if (task.status === 'running') {
        const progress = task.progress || 0;
        const message = task.progressMessage || 'Claude 처리 중...';
        const recentLogs = (task.logs || []).slice(-5);
        outputTab.innerHTML = `
          <div class="flex flex-col items-center justify-center py-4">
            <div class="relative w-16 h-16 mb-3">
              <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="16" fill="none" stroke="#374151" stroke-width="3"></circle>
                <circle cx="18" cy="18" r="16" fill="none" stroke="#3b82f6" stroke-width="3"
                        stroke-dasharray="${progress}, 100" stroke-linecap="round"
                        class="transition-all duration-500"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center text-sm font-bold">${progress}%</div>
            </div>
            <div class="text-base font-medium text-gray-200 mb-1">${escapeHtml(message)}</div>
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
              <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
              처리 중...
            </div>
          </div>

          ${task.command ? `
            <div class="bg-gray-950 rounded-lg p-3 mb-3 border border-gray-800">
              <div class="text-xs text-gray-500 mb-1">실행 명령어:</div>
              <div class="text-xs font-mono text-green-400">${escapeHtml(task.command)}</div>
            </div>
          ` : ''}

          <div class="bg-gray-950 rounded-lg p-3 border border-gray-800">
            <div class="text-xs text-gray-500 mb-2">최근 로그:</div>
            <div class="space-y-1 max-h-40 overflow-auto text-xs font-mono">
              ${recentLogs.length > 0 ? recentLogs.map(log => {
                const time = new Date(log.time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const color = log.type === 'stderr' ? 'text-red-400' : log.type === 'cmd' ? 'text-yellow-400' : log.type === 'info' ? 'text-blue-400' : 'text-gray-400';
                return `<div class="${color}"><span class="text-gray-600">[${time}]</span> ${escapeHtml(log.text.substring(0, 200))}</div>`;
              }).join('') : '<div class="text-gray-600">로그 대기 중...</div>'}
            </div>
          </div>

          ${task.stdout ? `
            <div class="mt-3 bg-gray-950 rounded-lg p-3 border border-gray-800">
              <div class="text-xs text-gray-500 mb-2">실시간 출력 (${task.stdout.length}자):</div>
              <div class="text-xs font-mono text-gray-400 max-h-32 overflow-auto whitespace-pre-wrap">${escapeHtml(task.stdout.slice(-500))}</div>
            </div>
          ` : ''}
        `;
      } else if (task.status === 'completed') {
        // 완료 시 마크다운 렌더링된 결과 미리보기
        const preview = task.stdout ? task.stdout.substring(0, 1000) : '결과 없음';
        outputTab.innerHTML = `
          <div class="flex flex-col items-center py-4 mb-4 border-b border-gray-700">
            <div class="text-4xl mb-2">✅</div>
            <div class="text-lg font-medium text-green-400">완료!</div>
          </div>
          <div class="markdown-content text-sm">${renderMarkdown(preview)}${task.stdout?.length > 1000 ? '<div class="text-gray-500 mt-2">...</div>' : ''}</div>
        `;
      } else if (task.status === 'failed') {
        outputTab.innerHTML = `
          <div class="flex flex-col items-center py-4 mb-4 border-b border-gray-700">
            <div class="text-4xl mb-2">❌</div>
            <div class="text-lg font-medium text-red-400">실패</div>
          </div>
          <div class="bg-red-900/20 border border-red-800/30 rounded-lg p-4">
            <div class="text-red-400 font-medium mb-2">오류 메시지:</div>
            <div class="text-sm text-red-300">${escapeHtml(task.error || '알 수 없는 오류')}</div>
          </div>
          ${task.stderr ? `
            <div class="mt-4 bg-gray-950 rounded-lg p-3 text-xs font-mono text-red-400 max-h-40 overflow-auto">
              <div class="text-gray-600 mb-1">stderr:</div>
              ${escapeHtml(task.stderr)}
            </div>
          ` : ''}
        `;
      } else {
        outputTab.innerHTML = '<div class="text-gray-500 text-center py-8">출력 없음</div>';
      }

      // logs 탭
      const logsTab = document.getElementById('taskLogsTab');
      if (task.logs && task.logs.length > 0) {
        logsTab.innerHTML = task.logs.map(log => {
          const time = new Date(log.time).toLocaleTimeString();
          const color = log.type === 'stderr' ? 'text-red-400' : 'text-green-400';
          return `<div class="mb-1"><span class="text-gray-500">[${time}]</span> <span class="${color}">${escapeHtml(log.text)}</span></div>`;
        }).join('');
        logsTab.scrollTop = logsTab.scrollHeight;
      } else {
        logsTab.innerHTML = '<div class="text-gray-500 text-center py-8">로그 없음</div>';
      }
    }

    function switchTaskTab(tab) {
      const outputTab = document.getElementById('taskOutputTab');
      const logsTab = document.getElementById('taskLogsTab');
      const outputBtn = document.getElementById('taskTabOutput');
      const logsBtn = document.getElementById('taskTabLogs');

      if (tab === 'output') {
        outputTab.classList.remove('hidden');
        logsTab.classList.add('hidden');
        outputBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-blue-600';
        logsBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-gray-700 hover:bg-gray-600';
      } else {
        outputTab.classList.add('hidden');
        logsTab.classList.remove('hidden');
        outputBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-gray-700 hover:bg-gray-600';
        logsBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-blue-600';
      }
    }

    function closeTaskDetailModal() {
      const modal = document.getElementById('taskDetailModal');
      modal.classList.remove('active');
      modal.style.display = 'none';
      currentTaskDetailId = null;
      if (taskDetailRefreshInterval) {
        clearInterval(taskDetailRefreshInterval);
        taskDetailRefreshInterval = null;
      }
    }

    // ============ 마크다운 렌더링 ============
    function renderMarkdown(text) {
      if (typeof marked !== 'undefined') {
        // marked.js가 로드되었으면 사용
        marked.setOptions({
          breaks: true,
          gfm: true
        });
        return marked.parse(text);
      }
      // 폴백: 간단한 마크다운 변환
      return text
        .replace(/^### (.+)$/gm, '<h3 class="text-base font-bold mt-4 mb-2 text-gray-200">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 class="text-lg font-bold mt-5 mb-2 text-gray-100">$1</h2>')
        .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold mt-6 mb-3 text-white">$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code class="bg-gray-700 px-1.5 py-0.5 rounded text-sm">$1</code>')
        .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li class="ml-4">$1. $2</li>')
        .replace(/\n/g, '<br>');
    }

    // 작업 결과 보기
    function viewTaskResult(taskId) {
      const task = activeTasks.get(taskId);
      if (task && task.result) {
        handleTaskResult({ taskId, type: task.type, result: task.result });
      }
    }

    // 작업 결과 처리
    function handleTaskResult(data) {
      switch (data.type) {
        case 'ask':
          showAskResultModal(data.result);
          break;
        case 'daily-report':
        case 'full-daily-report':
          showFullReportModal(data.result);
          break;
        case 'session-summary':
          showSessionSummaryModal(data.result);
          break;
        case 'day-wrapup':
          showDayWrapupResult(data.result);
          break;
        case 'weekly-digest':
          showWeeklyDigestModal(data.result);
          break;
      }
    }

    // Claude 질문 결과 모달
    let currentAskResponse = '';

    function showAskResultModal(result) {
      const modal = document.getElementById('askModal');
      const responseDiv = document.getElementById('askResponse');
      const responseText = document.getElementById('askResponseText');
      const loadingDiv = document.getElementById('askLoading');
      const copyBtn = document.getElementById('askCopyBtn');

      loadingDiv.classList.add('hidden');
      currentAskResponse = result.response;
      responseText.innerHTML = renderMarkdown(result.response);
      responseDiv.classList.remove('hidden');
      copyBtn.classList.remove('hidden');
      document.getElementById('askModalEmoji').textContent = '😊';

      modal.style.display = 'flex';
    }

    // 세션 요약 모달
    // 현재 요약 내용 저장 (복사용)
    let currentSummaryContent = '';

    function showSessionSummaryModal(result) {
      currentSummaryContent = result.summary;
      const createdAt = new Date().toLocaleString('ko-KR');

      // 세션 상세 모달 내 요약 탭이 열려있으면 탭 구조 유지하며 업데이트
      const summaryContentDiv = document.getElementById('sessionSummaryContent');
      if (summaryContentDiv) {
        summaryContentDiv.innerHTML = `
          <div class="text-left">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs text-gray-500">생성: ${createdAt}</span>
              <div class="flex gap-2">
                <button onclick="copySummary()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
                  📋 복사
                </button>
                <button onclick="generateSessionSummary()" class="px-3 py-1.5 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 rounded text-xs font-medium">
                  🔄 재생성
                </button>
              </div>
            </div>
            <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[50vh] overflow-auto custom-scrollbar">
              <div class="prose prose-invert prose-sm max-w-none markdown-content">${renderMarkdown(result.summary)}</div>
            </div>
          </div>
        `;
        // 요약 탭으로 전환
        switchSessionTab('summary');
        showToast('세션 요약이 생성되었습니다', 'success');
        return;
      }

      // 폴백: 모달 전체를 요약으로 표시
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');
      content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-lg">📋</div>
            <div>
              <h3 class="text-lg font-bold">세션 요약</h3>
              <p class="text-xs text-gray-400">${result.project}</p>
            </div>
          </div>
          <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>

        <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[65vh] overflow-auto custom-scrollbar">
          <div class="prose prose-invert prose-sm max-w-none markdown-content">${renderMarkdown(result.summary)}</div>
        </div>

        <div class="flex gap-2 mt-4">
          <button onclick="copySummary()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
            📋 복사
          </button>
          <button onclick="generateSessionSummary()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 rounded-lg text-sm">
            🔄 재생성
          </button>
        </div>
      `;

      modal.style.display = 'flex';
    }

    function copySummary() {
      if (currentSummaryContent) {
        copyToClipboard(currentSummaryContent, '요약이 복사되었습니다');
      }
    }

    // 비동기 작업 제출 헬퍼
    async function submitTask(type, payload) {
      try {
        const res = await fetch(`${API_BASE}/api/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, payload, clientId })
        });

        const data = await res.json();

        if (data.success) {
          return data.taskId;
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        showToast('작업 제출 실패: ' + err.message, 'error');
        throw err;
      }
    }

    // ============ 기존 전역 변수 ============
    let categories = {};
    let currentFilter = 'all';
    let historyData = [];  // 전역 변수로 이력 저장
    let currentView = 'card';  // 현재 뷰 (card/graph)
    let graphNetwork = null;  // vis.Network 인스턴스
    let graphNodes = null;    // vis.DataSet for nodes
    let graphEdges = null;    // vis.DataSet for edges
    let allJobsData = [];     // 전체 작업 데이터 캐시
    let allEdgesData = [];    // 연결선 데이터 캐시
    let contextMenuNodeId = null;  // 컨텍스트 메뉴 대상 노드
    let historyPagination = { page: 1, totalPages: 1 };  // 이력 페이지네이션
    let historySearchTimeout = null;  // 검색 디바운스

    // Cron 표현식 프리셋 (빠른 참조용)
    const cronPresets = {
      '0 * * * *': { desc: '매시 정각', icon: '🕐' },
      '0 9 * * *': { desc: '매일 오전 9시', icon: '🌅' },
      '0 9 * * 1-5': { desc: '평일 오전 9시', icon: '💼' },
      '0 18 * * *': { desc: '매일 오후 6시', icon: '🌆' },
      '0 18 * * 1-5': { desc: '평일 오후 6시', icon: '💼' },
      '0 20 * * 1-5': { desc: '평일 오후 8시', icon: '🌙' },
      '0 0 * * *': { desc: '매일 자정', icon: '🌙' },
      '0 8 * * 1-5': { desc: '평일 오전 8시', icon: '☀️' },
      '*/5 * * * *': { desc: '5분마다', icon: '⚡' },
      '*/30 * * * *': { desc: '30분마다', icon: '⏱️' },
      '0 */2 * * *': { desc: '2시간마다', icon: '🔄' },
      '0 0 * * 0': { desc: '매주 일요일 자정', icon: '📅' },
      '0 0 1 * *': { desc: '매월 1일 자정', icon: '📆' },
    };

    // Load data
    async function loadJobs() {
      const res = await fetch(`${API_BASE}/api/jobs`);
      const data = await res.json();
      categories = data.categories;
      allJobsData = data.jobs;
      allEdgesData = data.edges || [];
      renderCategoryFilter();
      renderJobs(data.jobs);
      document.getElementById('jobCount').textContent = data.jobs.filter(j => j.enabled).length;

      // 브라우저 알림 체크 (작업 완료 감지)
      checkJobCompletion(data.jobs);

      // 그래프 뷰가 활성화되어 있으면 그래프도 업데이트
      if (currentView === 'graph') {
        updateGraphNodes(data.jobs);
      }
    }

    // 검색 디바운스
    function debounceHistorySearch() {
      clearTimeout(historySearchTimeout);
      historySearchTimeout = setTimeout(() => {
        loadHistoryFiltered();
      }, 300);
    }

    // 필터 적용하여 이력 로드
    async function loadHistoryFiltered(page = 1) {
      const search = document.getElementById('historySearch').value;
      const status = document.getElementById('historyStatus').value;
      const startDate = document.getElementById('historyStartDate').value;
      const endDate = document.getElementById('historyEndDate').value;

      const params = new URLSearchParams();
      params.set('page', page);
      params.set('limit', 10);
      if (search) params.set('search', search);
      if (status) params.set('status', status);
      if (startDate) params.set('startDate', startDate);
      if (endDate) params.set('endDate', endDate);

      const res = await fetch(`${API_BASE}/api/history?${params}`);
      const data = await res.json();

      historyData = data.items;
      historyPagination = data.pagination;

      renderHistory(historyData);
      renderHistoryPagination(data.pagination);
    }

    // 기존 loadHistory는 loadHistoryFiltered 호출
    async function loadHistory() {
      return loadHistoryFiltered(1);
    }

    // 페이지네이션 렌더링
    function renderHistoryPagination(pagination) {
      const { page, totalPages, total, limit } = pagination;

      // 정보 텍스트
      const start = total > 0 ? (page - 1) * limit + 1 : 0;
      const end = Math.min(page * limit, total);
      document.getElementById('historyInfo').textContent =
        total > 0 ? `${start}-${end} / 총 ${total}건` : '결과 없음';

      // 이전/다음 버튼
      document.getElementById('historyPrevBtn').disabled = !pagination.hasPrev;
      document.getElementById('historyNextBtn').disabled = !pagination.hasNext;

      // 페이지 번호
      const pageNumbers = document.getElementById('historyPageNumbers');
      pageNumbers.innerHTML = '';

      if (totalPages <= 1) return;

      // 최대 5개 페이지 번호 표시
      let startPage = Math.max(1, page - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded text-sm ${
          i === page
            ? 'bg-blue-600 text-white'
            : 'bg-gray-700 hover:bg-gray-600 text-gray-300'
        }`;
        btn.onclick = () => loadHistoryFiltered(i);
        pageNumbers.appendChild(btn);
      }
    }

    // 페이지 이동
    function loadHistoryPage(direction) {
      const newPage = direction === 'next'
        ? historyPagination.page + 1
        : historyPagination.page - 1;
      loadHistoryFiltered(newPage);
    }

    // 필터 초기화
    function resetHistoryFilters() {
      document.getElementById('historySearch').value = '';
      document.getElementById('historyStatus').value = '';
      document.getElementById('historyStartDate').value = '';
      document.getElementById('historyEndDate').value = '';
      loadHistoryFiltered(1);
    }

    // Render functions
    function renderCategoryFilter() {
      const container = document.getElementById('categoryFilter');
      container.innerHTML = `
        <button onclick="filterByCategory('all')" class="filter-btn px-3 py-1 rounded-full text-sm ${currentFilter === 'all' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
          전체
        </button>
        ${Object.entries(categories).map(([key, cat]) => `
          <button onclick="filterByCategory('${key}')" class="filter-btn px-3 py-1 rounded-full text-sm ${currentFilter === key ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
            ${cat.name}
          </button>
        `).join('')}
      `;
    }

    function renderJobs(jobs) {
      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.category === currentFilter);
      const container = document.getElementById('jobsGrid');

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-400">
            <p class="text-4xl mb-2">📭</p>
            <p>등록된 작업이 없습니다</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(job => {
        const cat = categories[job.category] || { name: '기타', color: '#6b7280' };
        const isRunning = job.isRunning;
        return `
          <div class="job-card bg-gray-800 rounded-xl p-4 border ${isRunning ? 'border-yellow-500' : 'border-gray-700'}">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="status-dot ${isRunning ? 'bg-yellow-500 pulse' : (job.enabled ? 'bg-green-500' : 'bg-gray-500')}"></span>
                <span class="text-sm px-2 py-0.5 rounded" style="background: ${cat.color}20; color: ${cat.color}">
                  ${cat.name}
                </span>
                ${isRunning ? '<span class="text-xs text-yellow-400 ml-1">실행중</span>' : ''}
              </div>
              <div class="flex gap-1">
                <button onclick="duplicateJob('${job.id}')" class="p-1 hover:bg-gray-700 rounded" title="복제">📋</button>
                <button onclick="editJob('${job.id}')" class="p-1 hover:bg-gray-700 rounded" title="편집">✏️</button>
                <button onclick="deleteJob('${job.id}')" class="p-1 hover:bg-gray-700 rounded" title="삭제">🗑️</button>
              </div>
            </div>

            <h3 class="font-semibold text-lg mb-1">${job.name}</h3>
            <p class="text-sm text-gray-400 mb-2">${job.description || '설명 없음'}</p>
            ${job.notes ? `<p class="text-xs text-yellow-500/80 bg-yellow-900/20 px-2 py-1 rounded mb-2">📝 ${job.notes}</p>` : ''}

            <div class="text-xs text-gray-500 mb-3 font-mono bg-gray-900 px-2 py-1 rounded">
              ${job.schedule} ${cronPresets[job.schedule] ? `(${cronPresets[job.schedule].desc})` : ''}
            </div>

            <div class="flex gap-2">
              ${isRunning ? `
                <button onclick="showLiveLog('${job.id}')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg text-sm font-medium">
                  📋 로그 보기
                </button>
              ` : `
                <button onclick="runJob('${job.id}')" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm font-medium">
                  ▶ 실행
                </button>
              `}
              <button onclick="toggleJob('${job.id}')" class="flex-1 ${job.enabled ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 hover:bg-gray-500'} py-2 rounded-lg text-sm font-medium" ${isRunning ? 'disabled' : ''}>
                ${job.enabled ? '⏸ 비활성화' : '▶ 활성화'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderHistory(history) {
      const container = document.getElementById('historyTable');

      if (history.length === 0) {
        container.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-400">검색 결과가 없습니다</td>
          </tr>
        `;
        return;
      }

      const triggerText = {
        manual: '수동',
        scheduled: '스케줄',
        chained: '⛓️ 체인',
        'auto-fix': '🔧 자동복구',
        'scheduled-once': '⏰ 예약',
        retry: '🔄 재시도',
        webhook: '🔗 웹훅'
      };

      const statusColors = {
        success: 'bg-green-500',
        failed: 'bg-red-500',
        running: 'bg-yellow-500 pulse'
      };
      const statusText = {
        success: '성공',
        failed: '실패',
        running: '실행중'
      };

      container.innerHTML = history.map((h) => {
        return `
          <tr class="hover:bg-gray-700/50">
            <td class="px-4 py-3 font-medium">${h.jobName}</td>
            <td class="px-4 py-3 text-sm text-gray-400">${triggerText[h.trigger] || h.trigger}</td>
            <td class="px-4 py-3 text-sm">${new Date(h.startTime).toLocaleString('ko-KR')}</td>
            <td class="px-4 py-3 text-sm">${h.duration ? `${(h.duration / 1000).toFixed(1)}초` : '-'}</td>
            <td class="px-4 py-3">
              <span class="flex items-center gap-2">
                <span class="status-dot ${statusColors[h.status]}"></span>
                ${statusText[h.status]}
              </span>
            </td>
            <td class="px-4 py-3">
              <button onclick="showLogById(${h.id})" class="text-blue-400 hover:underline text-sm">
                상세
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ID로 로그 표시
    function showLogById(logId) {
      const entry = historyData.find(h => h.id === logId);
      if (!entry) return;

      stopLiveLogPolling();

      // 명령어 표시
      const cmdSection = document.getElementById('logCommandSection');
      const cmdEl = document.getElementById('logCommand');
      if (entry.command) {
        cmdEl.textContent = entry.command;
        cmdSection.classList.remove('hidden');
      } else {
        cmdSection.classList.add('hidden');
      }

      document.getElementById('logStdout').textContent = entry.stdout || '(없음)';
      document.getElementById('logStderr').textContent = entry.stderr || entry.error || '(없음)';
      document.getElementById('logModal').classList.add('active');

      // 스크롤을 맨 위로 (완료된 로그는 처음부터 보기)
      setTimeout(() => {
        scrollLogToTop('logStdout');
        scrollLogToTop('logStderr');
      }, 50);
    }

    // Options Modal
    let currentJobForOptions = null;
    let allJobs = [];  // 전체 작업 목록 캐시

    async function runJob(id) {
      // 작업 정보 조회
      const res = await fetch(`${API_BASE}/api/jobs/${id}`);
      const job = await res.json();

      // interactive 작업은 빠른 메모 모달로 연결
      if (job.interactive) {
        openQuickInput('memo');
        return;
      }

      // 옵션이 있으면 옵션 모달 표시
      if (job.options && job.options.length > 0) {
        showOptionsModal(job);
      } else {
        // 옵션이 없으면 바로 실행
        executeJob(id, {});
      }
    }

    function showOptionsModal(job) {
      currentJobForOptions = job;

      document.getElementById('optionsJobName').textContent = job.name;
      document.getElementById('optionsJobDesc').textContent = job.description || '';

      const container = document.getElementById('optionsContainer');

      const renderOption = (opt, idx, isSystem = false) => {
        const inputId = `opt-${idx}`;
        const bgClass = isSystem ? 'bg-blue-900/30 border border-blue-800/50' : 'bg-gray-700/50';

        if (opt.type === 'boolean') {
          return `
            <div class="flex items-start gap-3 p-3 ${bgClass} rounded-lg mb-2">
              <input type="checkbox" id="${inputId}"
                class="w-5 h-5 mt-0.5 rounded bg-gray-600 border-gray-500"
                data-flag="${opt.flag || ''}"
                data-type="boolean"
                data-system="${opt.system || false}"
                ${opt.default ? 'checked' : ''}
                onchange="updateCommandPreview()">
              <div>
                <label for="${inputId}" class="font-medium cursor-pointer">${opt.label}</label>
                <p class="text-sm text-gray-400">${opt.description}</p>
                ${!isSystem ? `<code class="text-xs text-blue-400">${opt.flag}</code>` : ''}
              </div>
            </div>
          `;
        } else if (opt.type === 'select') {
          const choices = opt.choices || [];
          const optionsHtml = choices.map(c =>
            `<option value="${c}" ${c === opt.default ? 'selected' : ''}>${c}</option>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <select id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="select"
                data-system="${opt.system || false}"
                onchange="updateCommandPreview()">
                ${optionsHtml}
              </select>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'string') {
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <input type="text" id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="string"
                data-system="${opt.system || false}"
                placeholder="${opt.placeholder || ''}"
                onkeyup="updateCommandPreview()">
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'array') {
          const defaultItems = opt.default || [];
          const tagsHtml = defaultItems.map(item =>
            `<div class="array-tag"><span title="${item}">${item}</span><button type="button" class="array-tag-remove" onclick="removeArrayTag(this, '${inputId}')">&times;</button></div>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <div id="${inputId}-container" class="array-input-container"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="array"
                data-system="${opt.system || false}">
                ${tagsHtml}
                <input type="text" class="array-input" placeholder="${opt.placeholder || 'Enter 키로 추가'}"
                  onkeydown="handleArrayInput(event, '${inputId}')">
              </div>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        }
        return '';
      };

      if (!job.options || job.options.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">설정 가능한 옵션이 없습니다.</p>';
      } else {
        // 일반 옵션과 시스템 옵션 분리
        const normalOpts = job.options.filter(o => !o.system);
        const systemOpts = job.options.filter(o => o.system);

        let html = '';

        // 일반 옵션
        if (normalOpts.length > 0) {
          html += normalOpts.map((opt, idx) => renderOption(opt, idx)).join('');
        }

        // 시스템 옵션 (구분선 + 다른 스타일)
        if (systemOpts.length > 0) {
          html += `<div class="border-t border-gray-600 pt-4 mt-4">
            <p class="text-xs text-gray-500 mb-3 uppercase tracking-wider">🔔 알림 설정</p>`;
          html += systemOpts.map((opt, idx) => renderOption(opt, normalOpts.length + idx, true)).join('');
          html += `</div>`;
        }

        container.innerHTML = html;
      }

      updateCommandPreview();
      document.getElementById('optionsModal').classList.add('active');
    }

    function updateCommandPreview() {
      if (!currentJobForOptions) return;

      let command = currentJobForOptions.command;
      const options = getSelectedOptions(false);  // system 옵션 제외
      const flags = [];
      const args = [];

      for (const [key, value] of Object.entries(options)) {
        if (typeof value === 'boolean' && value) {
          flags.push(key);
        } else if (typeof value === 'string' && value) {
          // key가 --로 시작하면 flag=value 형식, 아니면 그냥 값
          if (key.startsWith('--')) {
            flags.push(`${key} "${value}"`);
          } else {
            args.push(value);
          }
        }
      }

      // 명령어에 && 가 있으면 각각에 플래그 적용
      if (command.includes(' && ') && flags.length > 0) {
        const commands = command.split(' && ');
        const flagStr = flags.join(' ');
        command = commands.map(cmd => `${cmd} ${flagStr}`).join(' && ');
      } else {
        if (flags.length > 0) command += ' ' + flags.join(' ');
        if (args.length > 0) command += ' ' + args.join(' ');
      }

      document.getElementById('optionsCommandPreview').textContent = command;
    }

    function getSelectedOptions(includeSystem = true) {
      const options = {};
      const inputs = document.querySelectorAll('#optionsContainer input, #optionsContainer select');

      inputs.forEach(input => {
        const flag = input.dataset.flag;
        const arg = input.dataset.arg;
        const type = input.dataset.type;
        const isSystem = input.dataset.system === 'true';

        // system 옵션 제외 옵션
        if (!includeSystem && isSystem) return;

        if (type === 'boolean') {
          if (flag) options[flag] = input.checked;
        } else if (type === 'string' || type === 'select') {
          const value = input.value.trim();
          if (value) {
            if (flag) options[flag] = value;
            else if (arg) options[arg] = value;
          }
        }
      });

      // array 타입 처리
      const arrayContainers = document.querySelectorAll('#optionsContainer .array-input-container');
      arrayContainers.forEach(container => {
        const flag = container.dataset.flag;
        const arg = container.dataset.arg;
        const isSystem = container.dataset.system === 'true';

        if (!includeSystem && isSystem) return;

        const tags = container.querySelectorAll('.array-tag span');
        const values = Array.from(tags).map(span => span.textContent);
        if (values.length > 0) {
          const joinedValue = values.join(',');
          if (flag) options[flag] = joinedValue;
          else if (arg) options[arg] = joinedValue;
        }
      });

      return options;
    }

    function closeOptionsModal() {
      document.getElementById('optionsModal').classList.remove('active');
      currentJobForOptions = null;
    }

    // Schedule Modal
    let currentScheduleJobId = null;

    async function showScheduleModal(jobId) {
      const res = await fetch(`${API_BASE}/api/jobs/${jobId}`);
      const job = await res.json();
      currentScheduleJobId = jobId;

      document.getElementById('scheduleJobInfo').textContent = job.name;

      // 기본값: 현재 시간 + 5분
      const now = new Date();
      now.setMinutes(now.getMinutes() + 5);
      const defaultDateTime = now.toISOString().slice(0, 16);
      document.getElementById('scheduleDateTime').value = defaultDateTime;
      document.getElementById('scheduleDateTime').min = new Date().toISOString().slice(0, 16);

      document.getElementById('scheduleModal').classList.add('active');
    }

    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.remove('active');
      currentScheduleJobId = null;
    }

    async function confirmScheduleRun() {
      if (!currentScheduleJobId) return;

      const dateTimeStr = document.getElementById('scheduleDateTime').value;
      if (!dateTimeStr) {
        showToast('실행 시간을 선택해주세요.', 'error');
        return;
      }

      const scheduledTime = new Date(dateTimeStr);
      if (scheduledTime <= new Date()) {
        showToast('현재 시간 이후로 선택해주세요.', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/jobs/${currentScheduleJobId}/schedule-once`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scheduledTime: scheduledTime.toISOString() })
        });

        const result = await res.json();
        if (result.success) {
          showToast(`${scheduledTime.toLocaleString()}에 실행 예약됨`, 'success');
          closeScheduleModal();
        } else {
          showToast(result.error || '예약 실패', 'error');
        }
      } catch (err) {
        console.error('Schedule error:', err);
        showToast('예약 중 오류 발생', 'error');
      }
    }

    // Array input 핸들러
    function handleArrayInput(event, inputId) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = event.target;
        const value = input.value.trim();
        if (!value) return;

        const container = document.getElementById(`${inputId}-container`);
        const tag = document.createElement('div');
        tag.className = 'array-tag';
        tag.innerHTML = `<span title="${value}">${value}</span><button type="button" class="array-tag-remove" onclick="removeArrayTag(this, '${inputId}')">&times;</button>`;
        container.insertBefore(tag, input);
        input.value = '';
        updateCommandPreview();
      }
    }

    function removeArrayTag(button, inputId) {
      const tag = button.parentElement;
      tag.remove();
      updateCommandPreview();
    }

    async function executeWithOptions() {
      if (!currentJobForOptions) return;

      const options = getSelectedOptions();
      const jobId = currentJobForOptions.id;

      closeOptionsModal();
      executeJob(jobId, options);
    }

    async function executeJob(id, options = {}) {
      // 즉시 실행 시작 (비동기로 실행됨)
      fetch(`${API_BASE}/api/jobs/${id}/run`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ options })
      })
        .then(res => res.json())
        .then(result => {
          loadJobs();
          loadHistory();
          if (!result.success) {
            console.error('Job failed:', result.error);
          }
        })
        .catch(err => console.error('Run error:', err));

      // 약간의 지연 후 상태 갱신 & 로그 모달 표시
      setTimeout(() => {
        loadJobs();
        showLiveLog(id);
      }, 300);
    }

    async function toggleJob(id) {
      await fetch(`${API_BASE}/api/jobs/${id}/toggle`, { method: 'POST' });
      loadJobs();
    }

    async function duplicateJob(id) {
      try {
        const res = await fetch(`${API_BASE}/api/jobs/${id}/duplicate`, { method: 'POST' });
        const result = await res.json();
        if (result.success) {
          showToast('작업이 복제되었습니다.', 'success');
          loadJobs();
          // 복제된 작업 편집 모달 열기
          editJob(result.newId);
        } else {
          showToast('작업 복제에 실패했습니다.', 'error');
        }
      } catch (err) {
        console.error('Duplicate error:', err);
        showToast('작업 복제 중 오류가 발생했습니다.', 'error');
      }
    }

    async function deleteJob(id) {
      if (!confirm('이 작업을 삭제하시겠습니까?')) return;
      await fetch(`${API_BASE}/api/jobs/${id}`, { method: 'DELETE' });
      loadJobs();
    }

    let currentEditingJob = null;

    async function editJob(id) {
      const res = await fetch(`${API_BASE}/api/jobs/${id}`);
      const job = await res.json();
      currentEditingJob = job;

      document.getElementById('modalTitle').textContent = '작업 편집';
      document.getElementById('jobId').value = job.id;
      document.getElementById('jobName').value = job.name;
      document.getElementById('jobDescription').value = job.description || '';
      document.getElementById('jobCommand').value = job.command;
      document.getElementById('jobSchedule').value = job.schedule;
      populateCategorySelect();  // 카테고리 옵션 채우기
      document.getElementById('jobCategory').value = job.category || '';
      document.getElementById('jobNotes').value = job.notes || '';
      document.getElementById('jobEnabled').checked = job.enabled;

      // 옵션 탭 렌더링
      renderEditOptions(job);

      // 실행 제어 탭 렌더링
      const exec = job.execution || {};
      document.getElementById('jobTimeout').value = Math.floor((exec.timeout || 300000) / 60000);  // ms to min
      document.getElementById('jobMaxRetries').value = exec.maxRetries || 0;
      document.getElementById('jobRetryDelay').value = Math.floor((exec.retryDelay || 5000) / 1000);  // ms to sec
      document.getElementById('jobRetryBackoff').value = exec.backoff || 'fixed';

      // 스케줄 모드 감지 및 설정
      selectedWeekdays = new Set();
      document.querySelectorAll('.weekday-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-700');
      });
      const detected = detectSimpleSchedule(job.schedule);
      if (detected) {
        applySimpleSchedule(detected);
      } else {
        document.querySelector('input[name="schedMode"][value="cron"]').checked = true;
        toggleScheduleMode('cron');
      }
      updateCronDescription();

      // 기본 탭으로 시작
      showEditTab('basic');

      document.getElementById('jobModal').classList.add('active');
    }

    function showEditTab(tab) {
      // 탭 버튼 스타일
      document.querySelectorAll('.edit-tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      document.getElementById(`editTab-${tab}`).classList.add('border-blue-500', 'text-blue-400');
      document.getElementById(`editTab-${tab}`).classList.remove('border-transparent', 'text-gray-400');

      // 패널 표시
      document.getElementById('editPanel-basic').classList.toggle('hidden', tab !== 'basic');
      document.getElementById('editPanel-options').classList.toggle('hidden', tab !== 'options');
      document.getElementById('editPanel-execution').classList.toggle('hidden', tab !== 'execution');
    }

    function renderEditOptions(job) {
      const container = document.getElementById('editOptionsContainer');

      if (!job.options || job.options.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">이 작업에는 설정 가능한 옵션이 없습니다.</p>';
        return;
      }

      const renderEditOption = (opt, idx, isSystem = false) => {
        const inputId = `edit-opt-${idx}`;
        const bgClass = isSystem ? 'bg-blue-900/30 border border-blue-800/50' : 'bg-gray-700/50';

        if (opt.type === 'boolean') {
          return `
            <div class="flex items-start gap-3 p-3 ${bgClass} rounded-lg mb-2">
              <input type="checkbox" id="${inputId}"
                class="w-5 h-5 mt-0.5 rounded bg-gray-600 border-gray-500 edit-option-input"
                data-flag="${opt.flag || ''}"
                data-type="boolean"
                data-system="${opt.system || false}"
                ${opt.default ? 'checked' : ''}>
              <div>
                <label for="${inputId}" class="font-medium cursor-pointer">${opt.label}</label>
                <p class="text-sm text-gray-400">${opt.description}</p>
                ${!isSystem ? `<code class="text-xs text-blue-400">${opt.flag}</code>` : ''}
              </div>
            </div>
          `;
        } else if (opt.type === 'select') {
          const choices = opt.choices || [];
          const optionsHtml = choices.map(c =>
            `<option value="${c}" ${c === opt.default ? 'selected' : ''}>${c}</option>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <select id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm edit-option-input"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="select"
                data-system="${opt.system || false}">
                ${optionsHtml}
              </select>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'string') {
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <input type="text" id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm edit-option-input"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="string"
                data-system="${opt.system || false}"
                placeholder="${opt.placeholder || ''}"
                value="${opt.default || ''}">
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'array') {
          const defaultItems = opt.default || [];
          const tagsHtml = defaultItems.map(item =>
            `<div class="array-tag"><span title="${item}">${item}</span><button type="button" class="array-tag-remove" onclick="removeArrayTag(this, '${inputId}')">&times;</button></div>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <div id="${inputId}-container" class="array-input-container edit-option-input"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="array"
                data-system="${opt.system || false}">
                ${tagsHtml}
                <input type="text" class="array-input" placeholder="${opt.placeholder || 'Enter 키로 추가'}"
                  onkeydown="handleArrayInput(event, '${inputId}')">
              </div>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        }
        return '';
      };

      // 일반 옵션과 시스템 옵션 분리
      const normalOpts = job.options.filter(o => !o.system);
      const systemOpts = job.options.filter(o => o.system);

      let html = '';

      // 일반 옵션
      if (normalOpts.length > 0) {
        html += '<p class="text-xs text-gray-500 mb-2 uppercase tracking-wider">📋 실행 옵션</p>';
        html += normalOpts.map((opt, idx) => renderEditOption(opt, idx)).join('');
      }

      // 시스템 옵션
      if (systemOpts.length > 0) {
        html += `<div class="border-t border-gray-600 pt-4 mt-4">
          <p class="text-xs text-gray-500 mb-2 uppercase tracking-wider">🔔 알림 설정</p>`;
        html += systemOpts.map((opt, idx) => renderEditOption(opt, normalOpts.length + idx, true)).join('');
        html += `</div>`;
      }

      container.innerHTML = html;
    }

    function getEditOptions() {
      const options = [];
      if (!currentEditingJob || !currentEditingJob.options) return options;

      const inputs = document.querySelectorAll('.edit-option-input');
      const jobOpts = currentEditingJob.options;

      inputs.forEach((input, idx) => {
        if (idx >= jobOpts.length) return;

        const opt = { ...jobOpts[idx] };
        if (opt.type === 'boolean') {
          opt.default = input.checked;
        } else if (opt.type === 'string' || opt.type === 'select') {
          opt.default = input.value.trim();
        } else if (opt.type === 'array') {
          // array 타입: 태그에서 값 추출
          const tags = input.querySelectorAll('.array-tag span');
          opt.default = Array.from(tags).map(span => span.textContent);
        }
        options.push(opt);
      });

      return options;
    }

    function openAddModal() {
      document.getElementById('modalTitle').textContent = '작업 추가';
      document.getElementById('jobForm').reset();
      document.getElementById('jobId').value = '';
      currentEditingJob = null;
      populateCategorySelect();

      // 옵션 탭 비우기 (새 작업은 옵션 없음)
      document.getElementById('editOptionsContainer').innerHTML =
        '<p class="text-gray-500 text-sm">작업을 저장한 후 옵션을 설정할 수 있습니다.</p>';

      // 실행 제어 기본값 설정
      document.getElementById('jobTimeout').value = 5;
      document.getElementById('jobMaxRetries').value = 0;
      document.getElementById('jobRetryDelay').value = 5;
      document.getElementById('jobRetryBackoff').value = 'fixed';

      // 스케줄 모드 초기화 (Cron 직접 입력)
      selectedWeekdays = new Set();
      document.querySelectorAll('.weekday-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-700');
      });
      document.querySelector('input[name="schedMode"][value="cron"]').checked = true;
      toggleScheduleMode('cron');

      // 기본 탭으로 시작
      showEditTab('basic');

      document.getElementById('jobModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('jobModal').classList.remove('active');
      currentEditingJob = null;
    }

    function populateCategorySelect() {
      const select = document.getElementById('jobCategory');
      select.innerHTML = Object.entries(categories).map(([key, cat]) =>
        `<option value="${key}">${cat.name}</option>`
      ).join('');
    }

    // Form submit
    document.getElementById('jobForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('jobId').value;
      const data = {
        name: document.getElementById('jobName').value,
        description: document.getElementById('jobDescription').value,
        command: document.getElementById('jobCommand').value,
        schedule: document.getElementById('jobSchedule').value,
        category: document.getElementById('jobCategory').value,
        notes: document.getElementById('jobNotes').value,
        enabled: document.getElementById('jobEnabled').checked,
        execution: {
          timeout: parseInt(document.getElementById('jobTimeout').value || 5) * 60000,  // min to ms
          maxRetries: parseInt(document.getElementById('jobMaxRetries').value || 0),
          retryDelay: parseInt(document.getElementById('jobRetryDelay').value || 5) * 1000,  // sec to ms
          backoff: document.getElementById('jobRetryBackoff').value || 'fixed'
        }
      };

      // 편집 모드에서 옵션 포함
      if (id && currentEditingJob) {
        data.options = getEditOptions();
      }

      const method = id ? 'PUT' : 'POST';
      const url = id ? `${API_BASE}/api/jobs/${id}` : `${API_BASE}/api/jobs`;

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closeModal();
        loadJobs();
      } else {
        const error = await res.json();
        alert('오류: ' + error.error);
      }
    });

    // Tab & Filter
    let currentJobSubTab = 'list';

    // 홈 카드 클릭 시 선택된 날짜를 해당 탭에 전달
    function navigateWithDate(tab, subTab) {
      const date = homeDate;
      if (tab === 'sessions') {
        sessionsInitialized = false; // 날짜를 직접 설정하기 위해 리셋
      }
      showTab(tab);
      if (tab === 'sessions') {
        document.getElementById('sessionsDate').value = date;
        loadSessions();
      } else if (tab === 'notes') {
        setNotesDate(date);
      } else if (tab === 'jobs' && subTab === 'history') {
        setTimeout(() => showJobSubTab('history'), 50);
      }
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-400');
      document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-400');

      ['home', 'jobs', 'settings', 'sessions', 'notes', 'analysis'].forEach(p => {
        document.getElementById(`panel-${p}`).classList.toggle('hidden', tab !== p);
      });

      if (tab === 'home') loadHomeDashboard();
      if (tab === 'jobs') showJobSubTab(currentJobSubTab);
      if (tab === 'settings') loadSettings();
      if (tab === 'sessions') initSessionsTab();
      if (tab === 'notes') { initNotesDate(); loadNotes(); }
      if (tab === 'analysis') showAnalysisSubTab(currentAnalysisSubTab);
    }

    function showJobSubTab(sub) {
      currentJobSubTab = sub;
      document.querySelectorAll('.job-sub-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      const activeBtn = document.getElementById(`jobSub-${sub}`);
      if (activeBtn) {
        activeBtn.classList.add('border-blue-500', 'text-blue-400');
        activeBtn.classList.remove('border-transparent', 'text-gray-400');
      }

      document.getElementById('jobSubPanel-list').classList.toggle('hidden', sub !== 'list');
      document.getElementById('jobSubPanel-history').classList.toggle('hidden', sub !== 'history');
      document.getElementById('jobSubPanel-stats').classList.toggle('hidden', sub !== 'stats');

      if (sub === 'history') loadHistory();
      if (sub === 'stats') loadStats();
    }

    function filterByCategory(cat) {
      currentFilter = cat;
      loadJobs();
      // 그래프 뷰에서도 필터 적용
      if (currentView === 'graph' && graphNetwork) {
        updateGraphNodes(allJobsData);
      }
    }

    // ============ Graph View Functions ============

    // 뷰 전환
    function setView(view) {
      currentView = view;

      // 버튼 스타일 업데이트
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-400');
      });
      const activeBtn = document.getElementById(`viewBtn-${view}`);
      activeBtn.classList.add('active');
      activeBtn.classList.remove('text-gray-400');

      // 뷰 컨테이너 전환
      const jobsGrid = document.getElementById('jobsGrid');
      const graphView = document.getElementById('graphView');

      if (view === 'card') {
        jobsGrid.style.display = 'grid';
        graphView.classList.remove('active');
      } else {
        jobsGrid.style.display = 'none';
        graphView.classList.add('active');
        // 그래프 초기화 (아직 안됐으면)
        if (!graphNetwork) {
          initGraph(allJobsData, allEdgesData);
        } else {
          updateGraphNodes(allJobsData);
        }
      }
    }

    // 엣지 스타일 결정 (조건별)
    function getEdgeStyle(edge) {
      const condType = edge.condition?.type;
      // condition이 없고 trigger도 아닌 경우: 시각적 연결
      if (!condType && !edge.trigger) {
        return { color: '#6b7280', highlight: '#9ca3af', dashes: true, width: 1, label: edge.label || '', fontColor: '#9ca3af' };
      }
      switch (condType) {
        case 'onSuccess':
          return { color: '#10b981', highlight: '#34d399', dashes: false, width: 2, label: '✓', fontColor: '#10b981' };
        case 'onFailure':
          return { color: '#ef4444', highlight: '#f87171', dashes: [5, 5], width: 2, label: '✗', fontColor: '#ef4444' };
        case 'always':
          return { color: '#9ca3af', highlight: '#d1d5db', dashes: false, width: 2, label: '⚡', fontColor: '#9ca3af' };
        case 'onOutput': {
          const pat = edge.condition.pattern || '';
          return { color: '#3b82f6', highlight: '#60a5fa', dashes: [3, 3], width: 2, label: `📋 ${pat.substring(0, 10)}`, fontColor: '#3b82f6' };
        }
        case 'onExitCode':
          return { color: '#f59e0b', highlight: '#fbbf24', dashes: [3, 3], width: 2, label: `exit:${edge.condition.code}`, fontColor: '#f59e0b' };
        default:
          // 하위 호환: legacy trigger/onSuccess
          if (edge.trigger) {
            const isSuccess = edge.onSuccess !== false;
            return isSuccess
              ? { color: '#10b981', highlight: '#34d399', dashes: false, width: 2, label: '✓', fontColor: '#10b981' }
              : { color: '#9ca3af', highlight: '#d1d5db', dashes: false, width: 2, label: '⚡', fontColor: '#9ca3af' };
          }
          return { color: '#6b7280', highlight: '#9ca3af', dashes: true, width: 1, label: '', fontColor: '#9ca3af' };
      }
    }

    // 노드 색상 결정 (상태별)
    // 노드 색상 결정 (상태 + 카테고리)
    function getNodeColor(job) {
      // 카테고리 색상 가져오기
      const cat = categories[job.category] || { color: '#6b7280' };
      const catColor = cat.color;

      if (job.isRunning) {
        // 실행 중: 노란색 배경, 카테고리 색상 테두리
        return {
          background: '#fbbf24',
          border: catColor,
          highlight: { background: '#fcd34d', border: catColor }
        };
      } else if (job.enabled) {
        // 활성화: 녹색 배경, 카테고리 색상 테두리
        return {
          background: '#10b981',
          border: catColor,
          highlight: { background: '#34d399', border: catColor }
        };
      } else {
        // 비활성화: 회색 배경, 카테고리 색상 테두리
        return {
          background: '#4b5563',
          border: catColor,
          highlight: { background: '#6b7280', border: catColor }
        };
      }
    }

    // 그래프 초기화
    function initGraph(jobs, edges = []) {
      const container = document.getElementById('graphCanvas');

      // 필터 적용
      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.category === currentFilter);

      // 노드 데이터 생성
      const nodeData = filtered.map((job, index) => {
        const cat = categories[job.category] || { name: '기타', color: '#6b7280' };
        const position = job.position || { x: (index % 5) * 200 - 400, y: Math.floor(index / 5) * 150 - 200 };

        return {
          id: job.id,
          label: job.name,
          title: `${job.description || ''}\n📅 ${job.schedule}${job.notes ? '\n📝 ' + job.notes : ''}`,
          color: getNodeColor(job),
          font: { color: '#f3f4f6', size: 14 },
          shape: 'box',
          borderWidth: 4,
          borderWidthSelected: 5,
          x: position.x,
          y: position.y,
          shadow: true
        };
      });

      graphNodes = new vis.DataSet(nodeData);

      // Edge 데이터 (필터된 노드에 연결된 것만)
      const filteredNodeIds = new Set(filtered.map(j => j.id));
      const edgeData = edges.filter(e => filteredNodeIds.has(e.from) && filteredNodeIds.has(e.to)).map(e => {
        const style = getEdgeStyle(e);
        return {
          id: e.id,
          from: e.from,
          to: e.to,
          label: style.label,
          arrows: 'to',
          color: { color: style.color, highlight: style.highlight || style.color },
          dashes: style.dashes,
          width: style.width,
          font: { color: style.fontColor, size: 12 },
          smooth: { type: 'curvedCW', roundness: 0.2 }
        };
      });

      graphEdges = new vis.DataSet(edgeData);

      const data = { nodes: graphNodes, edges: graphEdges };

      const options = {
        physics: {
          enabled: false  // 물리 시뮬레이션 비활성화 (위치 고정)
        },
        interaction: {
          hover: true,
          selectConnectedEdges: true,
          multiselect: true
        },
        manipulation: {
          enabled: true,
          addEdge: function(data, callback) {
            if (data.from !== data.to) {
              createEdge(data.from, data.to);
            }
            callback(null);  // vis.js에서 추가하지 않음 (서버에서 처리)
          }
        },
        edges: {
          smooth: { type: 'curvedCW', roundness: 0.2 }
        },
        nodes: {
          margin: 10,
          shape: 'box',
          borderWidth: 2
        }
      };

      graphNetwork = new vis.Network(container, data, options);

      // 이벤트 핸들러
      graphNetwork.on('click', handleGraphClick);
      graphNetwork.on('doubleClick', handleGraphDoubleClick);
      graphNetwork.on('oncontext', handleGraphContext);
      graphNetwork.on('dragEnd', handleNodeDragEnd);

      // 전역 클릭으로 컨텍스트 메뉴 닫기
      document.addEventListener('click', () => hideContextMenu());
    }

    // 그래프 노드 업데이트 (실시간)
    function updateGraphNodes(jobs) {
      if (!graphNodes) return;

      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.category === currentFilter);
      const filteredIds = new Set(filtered.map(j => j.id));

      // 기존 노드 업데이트 또는 제거
      graphNodes.forEach(node => {
        if (!filteredIds.has(node.id)) {
          graphNodes.remove(node.id);
        }
      });

      // 노드 업데이트 또는 추가
      filtered.forEach((job, index) => {
        const existingNode = graphNodes.get(job.id);
        const color = getNodeColor(job);

        if (existingNode) {
          graphNodes.update({ id: job.id, color: color });
        } else {
          const position = job.position || { x: (index % 5) * 200 - 400, y: Math.floor(index / 5) * 150 - 200 };
          graphNodes.add({
            id: job.id,
            label: job.name,
            title: `${job.description || ''}\n📅 ${job.schedule}${job.notes ? '\n📝 ' + job.notes : ''}`,
            color: color,
            font: { color: '#f3f4f6', size: 14 },
            shape: 'box',
            borderWidth: 4,
            borderWidthSelected: 5,
            x: position.x,
            y: position.y,
            shadow: true
          });
        }
      });

      // Edge 업데이트
      if (allEdgesData && allEdgesData.length > 0) {
        const filteredEdges = allEdgesData.filter(e => filteredIds.has(e.from) && filteredIds.has(e.to));
        graphEdges.clear();
        graphEdges.add(filteredEdges.map(e => {
          const isTrigger = e.trigger === true;
          const label = isTrigger ? (e.onSuccess ? '✓' : '⚡') : (e.label || '');

          return {
            id: e.id,
            from: e.from,
            to: e.to,
            label: label,
            arrows: 'to',
            color: isTrigger
              ? { color: '#10b981', highlight: '#34d399' }
              : { color: '#6b7280', highlight: '#9ca3af' },
            dashes: !isTrigger,
            width: isTrigger ? 2 : 1,
            font: { color: isTrigger ? '#10b981' : '#9ca3af', size: 12 },
            smooth: { type: 'curvedCW', roundness: 0.2 }
          };
        }));
      }
    }

    // 그래프 클릭 핸들러
    function handleGraphClick(params) {
      hideContextMenu();
      if (params.nodes.length > 0) {
        // 노드 클릭 - 사이드 패널 열기
        const nodeId = params.nodes[0];
        openSidePanel(nodeId);
      } else if (params.edges.length > 0) {
        // Edge 클릭 - 삭제 확인
        closeSidePanel();
        const edgeId = params.edges[0];
        if (confirm('이 연결을 삭제하시겠습니까?')) {
          deleteEdge(edgeId);
        }
      } else {
        // 빈 공간 클릭 - 사이드 패널 닫기
        closeSidePanel();
      }
    }

    // 더블클릭 - 편집 모달
    function handleGraphDoubleClick(params) {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        editJob(nodeId);
      }
    }

    // 우클릭 - 컨텍스트 메뉴
    function handleGraphContext(params) {
      params.event.preventDefault();
      const nodeId = graphNetwork.getNodeAt(params.pointer.DOM);

      if (nodeId) {
        contextMenuNodeId = nodeId;
        const job = allJobsData.find(j => j.id === nodeId);

        // 컨텍스트 메뉴 내용 업데이트
        const menu = document.getElementById('contextMenu');
        const toggleItem = menu.querySelector('[onclick*="toggle"]');
        if (job) {
          if (job.isRunning) {
            toggleItem.innerHTML = '📋 로그 보기';
            toggleItem.onclick = () => contextMenuAction('log');
          } else {
            toggleItem.innerHTML = job.enabled ? '⏸️ 비활성화' : '▶️ 활성화';
            toggleItem.onclick = () => contextMenuAction('toggle');
          }
        }

        showContextMenu(params.event.pageX || params.pointer.DOM.x, params.event.pageY || params.pointer.DOM.y);
      }
    }

    // 노드 드래그 종료 - 위치 저장
    function handleNodeDragEnd(params) {
      if (params.nodes.length > 0) {
        const positions = graphNetwork.getPositions(params.nodes);
        const updates = params.nodes.map(id => ({
          id: id,
          position: { x: Math.round(positions[id].x), y: Math.round(positions[id].y) }
        }));
        saveNodePositions(updates);
      }
    }

    // 컨텍스트 메뉴 표시
    function showContextMenu(x, y) {
      const menu = document.getElementById('contextMenu');
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.remove('hidden');
    }

    // 컨텍스트 메뉴 숨기기
    function hideContextMenu() {
      document.getElementById('contextMenu').classList.add('hidden');
      contextMenuNodeId = null;
    }

    // 컨텍스트 메뉴 액션
    function contextMenuAction(action) {
      if (!contextMenuNodeId) return;
      hideContextMenu();

      switch (action) {
        case 'run':
          runJob(contextMenuNodeId);
          break;
        case 'schedule':
          showScheduleModal(contextMenuNodeId);
          break;
        case 'toggle':
          toggleJob(contextMenuNodeId);
          break;
        case 'duplicate':
          duplicateJob(contextMenuNodeId);
          break;
        case 'edit':
          editJob(contextMenuNodeId);
          break;
        case 'delete':
          deleteJob(contextMenuNodeId);
          break;
        case 'log':
          showLiveLog(contextMenuNodeId);
          break;
      }
    }

    // 노드 위치 저장
    async function saveNodePositions(updates) {
      try {
        await fetch(`${API_BASE}/api/jobs/positions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ positions: updates })
        });
      } catch (error) {
        console.error('Failed to save positions:', error);
      }
    }

    // Edge 타입 선택 모달 열기
    function showEdgeTypeModal(fromId, toId) {
      document.getElementById('edgeFrom').value = fromId;
      document.getElementById('edgeTo').value = toId;
      // 기본값으로 리셋
      document.querySelector('input[name="edgeType"][value="visual"]').checked = true;
      document.getElementById('edgeConditionExtra').classList.add('hidden');
      document.getElementById('edgeExitCodeExtra').classList.add('hidden');
      document.getElementById('edgeConditionPattern').value = '';
      document.getElementById('edgeExitCode').value = '0';
      document.getElementById('edgeModal').classList.add('active');
    }

    function closeEdgeModal() {
      document.getElementById('edgeModal').classList.remove('active');
    }

    function onEdgeTypeChange() {
      const type = document.querySelector('input[name="edgeType"]:checked').value;
      document.getElementById('edgeConditionExtra').classList.toggle('hidden', type !== 'trigger-output');
      document.getElementById('edgeExitCodeExtra').classList.toggle('hidden', type !== 'trigger-exitcode');
    }

    async function confirmEdgeCreate() {
      const from = document.getElementById('edgeFrom').value;
      const to = document.getElementById('edgeTo').value;
      const type = document.querySelector('input[name="edgeType"]:checked').value;

      let trigger = false;
      let onSuccess = true;
      let condition = null;

      switch (type) {
        case 'trigger-success':
          trigger = true; onSuccess = true;
          condition = { type: 'onSuccess' };
          break;
        case 'trigger-failure':
          trigger = true; onSuccess = false;
          condition = { type: 'onFailure' };
          break;
        case 'trigger-always':
          trigger = true; onSuccess = false;
          condition = { type: 'always' };
          break;
        case 'trigger-output':
          trigger = true; onSuccess = false;
          const pattern = document.getElementById('edgeConditionPattern').value.trim();
          const matchType = document.querySelector('input[name="edgeMatchType"]:checked').value;
          if (!pattern) { showToast('패턴을 입력하세요', 'error'); return; }
          condition = { type: 'onOutput', pattern, matchType };
          break;
        case 'trigger-exitcode':
          trigger = true; onSuccess = false;
          const exitCode = parseInt(document.getElementById('edgeExitCode').value);
          if (isNaN(exitCode) || exitCode < 0 || exitCode > 255) { showToast('유효한 종료 코드를 입력하세요 (0-255)', 'error'); return; }
          condition = { type: 'onExitCode', code: exitCode };
          break;
      }

      closeEdgeModal();

      try {
        const res = await fetch(`${API_BASE}/api/edges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from, to, trigger, onSuccess, condition })
        });
        if (res.ok) {
          loadJobs();
        }
      } catch (error) {
        console.error('Failed to create edge:', error);
      }
    }

    // Edge 생성 (모달 열기)
    function createEdge(fromId, toId) {
      showEdgeTypeModal(fromId, toId);
    }

    // Edge 삭제
    async function deleteEdge(edgeId) {
      try {
        const res = await fetch(`${API_BASE}/api/edges/${edgeId}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          graphEdges.remove(edgeId);
          allEdgesData = allEdgesData.filter(e => e.id !== edgeId);
        }
      } catch (error) {
        console.error('Failed to delete edge:', error);
      }
    }

    // ============ Graph Controls ============

    // 자동 정렬 (계층형 레이아웃)
    function autoLayoutGraph() {
      if (!graphNetwork) return;

      // 계층형 레이아웃 옵션으로 재설정
      const options = {
        layout: {
          hierarchical: {
            enabled: true,
            direction: 'UD',  // Up-Down (위에서 아래로)
            sortMethod: 'directed',
            levelSeparation: 120,
            nodeSpacing: 150,
            treeSpacing: 200
          }
        },
        physics: {
          enabled: false
        }
      };

      graphNetwork.setOptions(options);

      // 레이아웃 적용 후 위치 저장을 위해 약간 대기
      setTimeout(() => {
        // 계층형 레이아웃 비활성화 (수동 이동 가능하게)
        graphNetwork.setOptions({
          layout: { hierarchical: { enabled: false } }
        });
      }, 500);
    }

    // 모든 노드 위치 저장
    async function saveAllPositions() {
      if (!graphNetwork || !graphNodes) return;

      const positions = graphNetwork.getPositions();
      const updates = Object.entries(positions).map(([id, pos]) => ({
        id: id,
        position: { x: Math.round(pos.x), y: Math.round(pos.y) }
      }));

      try {
        await fetch(`${API_BASE}/api/jobs/positions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ positions: updates })
        });
        // 성공 피드백 (간단한 알림)
        const btn = document.querySelector('.graph-control-btn:nth-child(2)');
        const originalText = btn.innerHTML;
        btn.innerHTML = '✓ 저장됨';
        setTimeout(() => { btn.innerHTML = originalText; }, 1500);
      } catch (error) {
        console.error('Failed to save positions:', error);
      }
    }

    // 줌 조절
    function zoomGraph(scale) {
      if (!graphNetwork) return;
      const currentScale = graphNetwork.getScale();
      graphNetwork.moveTo({
        scale: currentScale * scale,
        animation: { duration: 200, easingFunction: 'easeInOutQuad' }
      });
    }

    // 전체 보기
    function fitGraph() {
      if (!graphNetwork) return;
      graphNetwork.fit({
        animation: { duration: 300, easingFunction: 'easeInOutQuad' }
      });
    }

    // ============ Side Panel ============

    let selectedNodeId = null;

    function openSidePanel(jobId) {
      const job = allJobsData.find(j => j.id === jobId);
      if (!job) return;

      selectedNodeId = jobId;
      const cat = categories[job.category] || { name: '기타', color: '#6b7280' };

      // 연결된 edge 정보
      const incomingEdges = allEdgesData.filter(e => e.to === jobId);
      const outgoingEdges = allEdgesData.filter(e => e.from === jobId);

      const statusText = job.isRunning ? '🟡 실행 중' : (job.enabled ? '🟢 활성화' : '⚪ 비활성화');

      document.getElementById('sidePanelContent').innerHTML = `
        <div class="mb-4">
          <span class="text-xs px-2 py-1 rounded" style="background: ${cat.color}30; color: ${cat.color}; border: 1px solid ${cat.color}50;">
            ${cat.name}
          </span>
        </div>
        <h3 class="text-lg font-bold mb-2">${job.name}</h3>
        <p class="text-sm text-gray-400 mb-2">${job.description || '설명 없음'}</p>
        ${job.notes ? `<p class="text-xs text-yellow-500/80 bg-yellow-900/20 px-2 py-1 rounded mb-4">📝 ${job.notes}</p>` : '<div class="mb-4"></div>'}

        <div class="space-y-3 mb-6">
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">상태</span>
            <span>${statusText}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">스케줄</span>
            <span class="font-mono text-xs">${job.schedule}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">입력 연결</span>
            <span>${incomingEdges.length}개</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">출력 연결</span>
            <span>${outgoingEdges.length}개</span>
          </div>
        </div>

        <div class="space-y-2">
          ${job.isRunning ? `
            <button onclick="showLiveLog('${job.id}'); closeSidePanel();"
              class="w-full bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg text-sm font-medium">
              📋 로그 보기
            </button>
          ` : `
            <button onclick="runJob('${job.id}'); closeSidePanel();"
              class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm font-medium">
              ▶ 실행
            </button>
          `}
          <button onclick="editJob('${job.id}'); closeSidePanel();"
            class="w-full bg-gray-600 hover:bg-gray-500 py-2 rounded-lg text-sm font-medium">
            ✏️ 편집
          </button>
          <button onclick="toggleJob('${job.id}'); closeSidePanel();"
            class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-medium">
            ${job.enabled ? '⏸ 비활성화' : '▶ 활성화'}
          </button>
        </div>

        ${outgoingEdges.length > 0 ? `
          <div class="mt-6 pt-4 border-t border-gray-700">
            <h4 class="text-sm font-medium text-gray-400 mb-2">연결된 다음 작업</h4>
            <div class="space-y-2">
              ${outgoingEdges.map(e => {
                const targetJob = allJobsData.find(j => j.id === e.to);
                const edgeType = e.trigger ? (e.onSuccess ? '✓ 성공 시' : '⚡ 항상') : '시각적';
                return targetJob ? `
                  <div class="flex items-center justify-between text-sm bg-gray-800 p-2 rounded">
                    <span>${targetJob.name}</span>
                    <span class="text-xs text-gray-500">${edgeType}</span>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
        ` : ''}
      `;

      document.getElementById('graphSidePanel').classList.add('open');
    }

    function closeSidePanel() {
      document.getElementById('graphSidePanel').classList.remove('open');
      selectedNodeId = null;
    }

    // Log modal
    let liveLogInterval = null;
    let currentLiveJobId = null;

    function showLog(index) {
      const entry = historyData[index];
      if (!entry) return;
      stopLiveLogPolling();

      // 명령어 표시
      const cmdSection = document.getElementById('logCommandSection');
      const cmdEl = document.getElementById('logCommand');
      if (entry.command) {
        cmdEl.textContent = entry.command;
        cmdSection.classList.remove('hidden');
      } else {
        cmdSection.classList.add('hidden');
      }

      document.getElementById('logStdout').textContent = entry.stdout || '(없음)';
      document.getElementById('logStderr').textContent = entry.stderr || entry.error || '(없음)';
      document.getElementById('logModal').classList.add('active');

      // 스크롤을 맨 위로
      setTimeout(() => {
        scrollLogToTop('logStdout');
        scrollLogToTop('logStderr');
      }, 50);
    }

    // 실행 중인 작업의 실시간 로그 보기
    async function showLiveLog(jobId) {
      currentLiveJobId = jobId;
      document.getElementById('logStdout').textContent = '로딩 중...';
      document.getElementById('logStderr').textContent = '';
      document.getElementById('logModal').classList.add('active');

      // 즉시 한번 조회
      await fetchLiveLog(jobId);

      // 1초마다 폴링
      liveLogInterval = setInterval(() => fetchLiveLog(jobId), 1000);
    }

    async function fetchLiveLog(jobId) {
      try {
        const res = await fetch(`${API_BASE}/api/jobs/${jobId}/live-log`);
        const data = await res.json();

        // 명령어 표시
        const cmdSection = document.getElementById('logCommandSection');
        const cmdEl = document.getElementById('logCommand');
        if (data.command) {
          cmdEl.textContent = data.command;
          cmdSection.classList.remove('hidden');
        } else {
          cmdSection.classList.add('hidden');
        }

        if (!data.running) {
          // 실행 완료됨
          stopLiveLogPolling();

          // 상태에 따라 다르게 표시
          if (data.status === 'failed') {
            const duration = data.duration ? `${(data.duration / 1000).toFixed(1)}초` : '';
            document.getElementById('logStdout').textContent =
              `❌ 실패 ${duration ? `(${duration})` : ''}\n\n${data.stdout || '(출력 없음)'}`;
            document.getElementById('logStderr').textContent =
              data.stderr || data.error || '(에러 정보 없음)';
          } else if (data.status === 'success') {
            const duration = data.duration ? `${(data.duration / 1000).toFixed(1)}초` : '';
            document.getElementById('logStdout').textContent =
              `✅ 완료 ${duration ? `(${duration})` : ''}\n\n${data.stdout || '(출력 없음)'}`;
            document.getElementById('logStderr').textContent = data.stderr || '';
          } else {
            document.getElementById('logStdout').textContent = data.stdout || '(로그 없음)';
            document.getElementById('logStderr').textContent = data.stderr || '';
          }

          // 완료 시 스크롤을 맨 위로
          setTimeout(() => {
            scrollLogToTop('logStdout');
            scrollLogToTop('logStderr');
          }, 50);

          loadJobs();  // 상태 갱신
          loadHistory();  // 이력 갱신
          return;
        }

        const elapsed = Math.round(data.elapsed / 1000);
        document.getElementById('logStdout').textContent =
          `⏱️ 실행 중... (${elapsed}초 경과)\n\n${data.stdout || '(출력 대기 중...)'}`;
        document.getElementById('logStderr').textContent = data.stderr || '';

        // 실시간 로그는 맨 아래로 스크롤 (최신 출력 보기)
        scrollLogToBottom('logStdout');
        if (data.stderr) scrollLogToBottom('logStderr');
      } catch (error) {
        console.error('Live log error:', error);
      }
    }

    function stopLiveLogPolling() {
      if (liveLogInterval) {
        clearInterval(liveLogInterval);
        liveLogInterval = null;
      }
      currentLiveJobId = null;
    }

    // 로그 확장/축소 토글
    function toggleLogExpand(elementId) {
      const el = document.getElementById(elementId);
      if (el.classList.contains('max-h-64')) {
        el.classList.remove('max-h-64');
        el.classList.add('max-h-[70vh]');
      } else {
        el.classList.remove('max-h-[70vh]');
        el.classList.add('max-h-64');
      }
    }

    // 로그 스크롤 제어
    function scrollLogToTop(elementId) {
      const el = document.getElementById(elementId);
      if (el) el.scrollTop = 0;
    }

    function scrollLogToBottom(elementId) {
      const el = document.getElementById(elementId);
      if (el) el.scrollTop = el.scrollHeight;
    }

    function closeLogModal() {
      stopLiveLogPolling();
      document.getElementById('logModal').classList.remove('active');
    }

    // Cron 표현식 파싱 및 설명 생성
    function parseCronExpression(cron) {
      if (!cron || cron.trim() === '') return null;

      // 프리셋 확인 (다음 실행 시간도 계산)
      const preset = cronPresets[cron.trim()];
      if (preset) {
        // 프리셋도 다음 실행 시간 계산을 위해 계속 진행
      }

      const parts = cron.trim().split(/\s+/);
      if (parts.length !== 5) return null;

      const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;

      // 요일 이름
      const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
      const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];

      let description = '';
      let timeDesc = '';

      // 시간 설명
      if (minute !== '*' && hour !== '*') {
        const h = parseInt(hour);
        const m = parseInt(minute);
        const period = h < 12 ? '오전' : '오후';
        const displayHour = h === 0 ? 12 : (h > 12 ? h - 12 : h);
        timeDesc = `${period} ${displayHour}시${m > 0 ? ` ${m}분` : ''}`;
      } else if (hour !== '*') {
        timeDesc = `${hour}시`;
      } else if (minute.startsWith('*/')) {
        timeDesc = `${minute.slice(2)}분마다`;
      } else if (hour === '*' && minute !== '*') {
        timeDesc = `매시 ${minute}분`;
      } else {
        timeDesc = '매분';
      }

      // 요일 설명
      if (dayOfWeek !== '*') {
        if (dayOfWeek === '1-5') {
          description = `평일 ${timeDesc}`;
        } else if (dayOfWeek === '0,6') {
          description = `주말 ${timeDesc}`;
        } else if (dayOfWeek.includes(',')) {
          const days = dayOfWeek.split(',').map(d => dayNames[parseInt(d)] || d).join(', ');
          description = `${days}요일 ${timeDesc}`;
        } else if (dayOfWeek.includes('-')) {
          const [start, end] = dayOfWeek.split('-').map(d => parseInt(d));
          description = `${dayNames[start]}~${dayNames[end]}요일 ${timeDesc}`;
        } else {
          const dayNum = parseInt(dayOfWeek);
          if (!isNaN(dayNum) && dayNum >= 0 && dayNum <= 6) {
            description = `${dayNames[dayNum]}요일 ${timeDesc}`;
          }
        }
      } else if (dayOfMonth !== '*') {
        if (dayOfMonth.includes(',')) {
          description = `매월 ${dayOfMonth}일 ${timeDesc}`;
        } else {
          description = `매월 ${dayOfMonth}일 ${timeDesc}`;
        }
      } else if (month !== '*') {
        description = `${monthNames[parseInt(month) - 1] || month} ${timeDesc}`;
      } else {
        description = `매일 ${timeDesc}`;
      }

      // 다음 실행 시간 계산 (간단한 버전)
      let nextRun = '';
      try {
        const now = new Date();
        let next = new Date(now);

        if (minute !== '*' && hour !== '*') {
          next.setHours(parseInt(hour), parseInt(minute), 0, 0);
          if (next <= now) {
            next.setDate(next.getDate() + 1);
          }

          // 요일 체크
          if (dayOfWeek === '1-5') {
            while (next.getDay() === 0 || next.getDay() === 6) {
              next.setDate(next.getDate() + 1);
            }
          }

          const diffMs = next - now;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

          if (diffHours > 24) {
            const days = Math.floor(diffHours / 24);
            nextRun = `${days}일 후`;
          } else if (diffHours > 0) {
            nextRun = `${diffHours}시간 ${diffMins}분 후`;
          } else {
            nextRun = `${diffMins}분 후`;
          }
        }
      } catch (e) {
        nextRun = '';
      }

      // 프리셋 설명 사용 (있으면)
      if (preset) {
        return { description: `${preset.icon} ${preset.desc}`, nextRun };
      }

      return { description, nextRun };
    }

    function updateCronDescription() {
      const input = document.getElementById('jobSchedule');
      const bubble = document.getElementById('cronBubble');
      const descEl = document.getElementById('cronDescription');
      const nextEl = document.getElementById('cronNextRun');

      const result = parseCronExpression(input.value);

      if (result && result.description) {
        descEl.textContent = result.description;
        nextEl.textContent = result.nextRun ? `⏰ ${result.nextRun}` : '';
        bubble.classList.remove('hidden');
      } else {
        bubble.classList.add('hidden');
      }
    }

    // === 스마트 스케줄링 ===
    let selectedWeekdays = new Set();

    function toggleScheduleMode(mode) {
      document.getElementById('simpleSchedulePanel').classList.toggle('hidden', mode !== 'simple');
      document.getElementById('cronSchedulePanel').classList.toggle('hidden', mode !== 'cron');
      if (mode === 'simple') generateCronFromSimple();
    }

    function onFrequencyChange() {
      const freq = document.getElementById('schedFrequency').value;
      document.getElementById('schedWeekdayPicker').classList.toggle('hidden', freq !== 'weekly');
      document.getElementById('schedMonthDayPicker').classList.toggle('hidden', freq !== 'monthly');
      document.getElementById('schedTimePicker').classList.toggle('hidden', freq === 'hourly');
      document.getElementById('schedMinutePicker').classList.toggle('hidden', freq !== 'hourly');
      generateCronFromSimple();
    }

    function toggleWeekday(day) {
      const btn = document.querySelector(`.weekday-btn[data-day="${day}"]`);
      if (selectedWeekdays.has(day)) {
        selectedWeekdays.delete(day);
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-700');
      } else {
        selectedWeekdays.add(day);
        btn.classList.add('bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-700');
      }
      generateCronFromSimple();
    }

    function generateCronFromSimple() {
      const freq = document.getElementById('schedFrequency').value;
      const time = document.getElementById('schedTime').value || '09:00';
      const [hour, minute] = time.split(':').map(Number);
      const minuteOffset = parseInt(document.getElementById('schedMinute').value) || 0;
      const monthDay = parseInt(document.getElementById('schedMonthDay').value) || 1;

      let cron = '';
      switch (freq) {
        case 'hourly':
          cron = `${minuteOffset} * * * *`;
          break;
        case 'daily':
          cron = `${minute} ${hour} * * *`;
          break;
        case 'weekdays':
          cron = `${minute} ${hour} * * 1-5`;
          break;
        case 'weekly': {
          const days = selectedWeekdays.size > 0 ? [...selectedWeekdays].sort().join(',') : '1';
          cron = `${minute} ${hour} * * ${days}`;
          break;
        }
        case 'monthly':
          cron = `${minute} ${hour} ${monthDay} * *`;
          break;
      }

      document.getElementById('jobSchedule').value = cron;
      updateCronDescription();
    }

    function detectSimpleSchedule(cronStr) {
      if (!cronStr) return null;
      const parts = cronStr.trim().split(/\s+/);
      if (parts.length !== 5) return null;
      const [min, hour, dom, month, dow] = parts;
      if (month !== '*') return null;

      if (hour === '*' && dom === '*' && dow === '*') {
        return { freq: 'hourly', minute: parseInt(min) || 0 };
      }
      if (/^\d+$/.test(min) && /^\d+$/.test(hour) && dom === '*' && dow === '*') {
        return { freq: 'daily', hour: parseInt(hour), minute: parseInt(min) };
      }
      if (/^\d+$/.test(min) && /^\d+$/.test(hour) && dom === '*' && dow === '1-5') {
        return { freq: 'weekdays', hour: parseInt(hour), minute: parseInt(min) };
      }
      if (/^\d+$/.test(min) && /^\d+$/.test(hour) && dom === '*' && /^[\d,]+$/.test(dow)) {
        return { freq: 'weekly', hour: parseInt(hour), minute: parseInt(min), days: dow.split(',').map(Number) };
      }
      if (/^\d+$/.test(min) && /^\d+$/.test(hour) && /^\d+$/.test(dom) && dow === '*') {
        return { freq: 'monthly', hour: parseInt(hour), minute: parseInt(min), day: parseInt(dom) };
      }
      return null;
    }

    function applySimpleSchedule(detected) {
      document.querySelector('input[name="schedMode"][value="simple"]').checked = true;
      toggleScheduleMode('simple');
      document.getElementById('schedFrequency').value = detected.freq;
      onFrequencyChange();

      if (detected.freq === 'hourly') {
        document.getElementById('schedMinute').value = detected.minute || 0;
      } else {
        const h = String(detected.hour || 9).padStart(2, '0');
        const m = String(detected.minute || 0).padStart(2, '0');
        document.getElementById('schedTime').value = `${h}:${m}`;
      }

      if (detected.freq === 'weekly' && detected.days) {
        selectedWeekdays = new Set(detected.days);
        document.querySelectorAll('.weekday-btn').forEach(btn => {
          const d = parseInt(btn.dataset.day);
          if (selectedWeekdays.has(d)) {
            btn.classList.add('bg-blue-600', 'text-white');
            btn.classList.remove('bg-gray-700');
          }
        });
      }

      if (detected.freq === 'monthly' && detected.day) {
        document.getElementById('schedMonthDay').value = detected.day;
      }
    }

    // Auto refresh (5초마다 jobs 상태 갱신)
    setInterval(() => {
      loadJobs();
    }, 5000);

    // URL 파라미터 처리 (Slack 링크 등)
    async function handleUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get('tab');
      const logId = params.get('logId');

      if (tab === 'history') {
        showTab('jobs');
        showJobSubTab('history');

        if (logId) {
          // 이력 로드 후 해당 로그 찾아서 모달 열기
          await loadHistoryFiltered(1);

          // 해당 logId를 포함하는 페이지를 찾아야 할 수도 있음
          // 일단 현재 페이지에서 찾기 시도
          const entry = historyData.find(h => h.id === parseInt(logId));
          if (entry) {
            showLogById(parseInt(logId));
          } else {
            // 전체에서 검색 (limit 없이)
            const res = await fetch(`${API_BASE}/api/history?limit=100`);
            const data = await res.json();
            const found = data.items.find(h => h.id === parseInt(logId));
            if (found) {
              historyData = [found];  // 임시로 설정
              showLogById(parseInt(logId));
            }
          }
        }
        return true;
      }
      return false;
    }

    // ============ Statistics Functions ============

    let statsPeriod = 7;  // 기본 7일
    let trendChart = null;
    let resultChart = null;

    function setStatsPeriod(days) {
      statsPeriod = days;
      // 버튼 스타일 업데이트
      document.querySelectorAll('.stats-period-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('text-gray-400');
      });
      document.getElementById(`statsBtn-${days}`).classList.add('bg-blue-600', 'text-white');
      document.getElementById(`statsBtn-${days}`).classList.remove('text-gray-400');
      loadStats();
    }

    async function loadStats() {
      try {
        // 병렬로 모든 통계 API 호출
        const [summary, jobStats, trend, failures] = await Promise.all([
          fetch(`${API_BASE}/api/stats/summary?days=${statsPeriod}`).then(r => r.json()),
          fetch(`${API_BASE}/api/stats/jobs?days=${statsPeriod}`).then(r => r.json()),
          fetch(`${API_BASE}/api/stats/trend?days=${statsPeriod}`).then(r => r.json()),
          fetch(`${API_BASE}/api/stats/failures?days=${statsPeriod}`).then(r => r.json())
        ]);

        renderStatsSummary(summary);
        renderStatsJobsTable(jobStats);
        renderTrendChart(trend);
        renderResultChart(summary);
        renderFailures(failures);
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    function renderStatsSummary(summary) {
      document.getElementById('statsTotalRuns').textContent = summary.total;
      document.getElementById('statsSuccessRate').textContent = `${summary.successRate}%`;
      document.getElementById('statsFailedCount').textContent = summary.failed;
      document.getElementById('statsAvgDuration').textContent = summary.avgDurationFormatted;
    }

    function renderStatsJobsTable(jobStats) {
      const tbody = document.getElementById('statsJobsTable');

      if (jobStats.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-400">
              해당 기간에 실행된 작업이 없습니다
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = jobStats.map(stat => {
        const successRateColor = stat.successRate >= 90 ? 'text-green-400' :
                                  stat.successRate >= 70 ? 'text-yellow-400' : 'text-red-400';
        const avgDuration = stat.avgDuration ? `${(stat.avgDuration / 1000).toFixed(1)}s` : '-';

        return `
          <tr class="hover:bg-gray-700/50">
            <td class="px-4 py-3">
              <div class="font-medium">${stat.jobName}</div>
              <div class="text-xs text-gray-400">${stat.jobId}</div>
            </td>
            <td class="px-4 py-3 text-right">${stat.total}</td>
            <td class="px-4 py-3 text-right text-green-400">${stat.success}</td>
            <td class="px-4 py-3 text-right text-red-400">${stat.failed}</td>
            <td class="px-4 py-3 text-right ${successRateColor} font-semibold">${stat.successRate}%</td>
            <td class="px-4 py-3 text-right text-gray-300">${avgDuration}</td>
          </tr>
        `;
      }).join('');
    }

    function renderTrendChart(trend) {
      const ctx = document.getElementById('trendChart').getContext('2d');

      // 기존 차트 제거
      if (trendChart) {
        trendChart.destroy();
      }

      trendChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: trend.map(d => d.date.slice(5)),  // MM-DD 형식
          datasets: [
            {
              label: '성공',
              data: trend.map(d => d.success),
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderRadius: 4
            },
            {
              label: '실패',
              data: trend.map(d => d.failed),
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#9ca3af' }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { color: 'rgba(75, 85, 99, 0.3)' },
              ticks: { color: '#9ca3af' }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: { color: 'rgba(75, 85, 99, 0.3)' },
              ticks: { color: '#9ca3af', stepSize: 1 }
            }
          }
        }
      });
    }

    function renderResultChart(summary) {
      const ctx = document.getElementById('resultChart').getContext('2d');

      // 기존 차트 제거
      if (resultChart) {
        resultChart.destroy();
      }

      resultChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['성공', '실패', '실행중'],
          datasets: [{
            data: [summary.success, summary.failed, summary.running],
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',
              'rgba(239, 68, 68, 0.8)',
              'rgba(59, 130, 246, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#9ca3af', padding: 20 }
            }
          },
          cutout: '60%'
        }
      });
    }

    function renderFailures(failures) {
      const container = document.getElementById('statsFailuresContainer');

      if (failures.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-4">
            🎉 해당 기간에 실패한 작업이 없습니다!
          </div>
        `;
        return;
      }

      container.innerHTML = failures.map((f, i) => {
        const timeAgo = f.lastFailure ? formatTimeAgo(new Date(f.lastFailure)) : '-';
        return `
          <div class="flex items-center justify-between py-3 ${i > 0 ? 'border-t border-gray-700' : ''}">
            <div class="flex items-center gap-3">
              <div class="text-2xl font-bold text-red-400">${i + 1}</div>
              <div>
                <div class="font-medium">${f.jobName}</div>
                <div class="text-xs text-gray-400">마지막 실패: ${timeAgo}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-xl font-bold text-red-400">${f.count}회</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function formatTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}일 전`;
      if (hours > 0) return `${hours}시간 전`;
      return '방금 전';
    }

    // ============ Export Functions ============

    function toggleExportMenu() {
      const menu = document.getElementById('exportMenu');
      if (menu) menu.classList.toggle('hidden');
    }

    function exportData(type, format) {
      const url = `${API_BASE}/api/export/${type}?days=${statsPeriod}&format=${format}`;
      window.open(url, '_blank');
      const menu = document.getElementById('exportMenu');
      if (menu) menu.classList.add('hidden');
    }

    // 외부 클릭 시 드롭다운 닫기
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('exportDropdown');
      const menu = document.getElementById('exportMenu');
      if (dropdown && menu && !dropdown.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });

    // ============ Browser Notifications ============

    let previousRunningJobs = new Set();

    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('이 브라우저는 알림을 지원하지 않습니다.');
        return false;
      }

      if (Notification.permission === 'granted') {
        return true;
      }

      if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
      }

      return false;
    }

    function sendBrowserNotification(title, options = {}) {
      if (Notification.permission !== 'granted') return;

      const notification = new Notification(title, {
        icon: options.icon || '/favicon.ico',
        body: options.body || '',
        tag: options.tag || 'ai-pipeline',
        requireInteraction: false
      });

      notification.onclick = () => {
        window.focus();
        if (options.onClick) options.onClick();
        notification.close();
      };

      // 5초 후 자동으로 닫기
      setTimeout(() => notification.close(), 5000);
    }

    function checkJobCompletion(jobs) {
      if (!currentSettings.browserNotifications) return;

      const currentRunning = new Set(jobs.filter(j => j.isRunning).map(j => j.id));

      // 이전에 실행 중이었지만 지금은 아닌 작업 찾기
      previousRunningJobs.forEach(jobId => {
        if (!currentRunning.has(jobId)) {
          // 작업이 완료됨 - 히스토리에서 결과 확인
          const job = jobs.find(j => j.id === jobId);
          if (job) {
            // 최근 실행 결과 가져오기 (비동기)
            fetch(`${API_BASE}/api/history?limit=1&search=${encodeURIComponent(job.name)}`)
              .then(res => res.json())
              .then(data => {
                if (data.items && data.items.length > 0) {
                  const latest = data.items[0];
                  const isSuccess = latest.status === 'success';
                  sendBrowserNotification(
                    `${isSuccess ? '✅' : '❌'} ${job.name}`,
                    {
                      body: isSuccess ? '작업이 완료되었습니다.' : '작업이 실패했습니다.',
                      tag: `job-${jobId}`,
                      onClick: () => { showTab('jobs'); showJobSubTab('history'); }
                    }
                  );
                }
              });
          }
        }
      });

      previousRunningJobs = currentRunning;
    }

    // ============ Settings Functions ============

    let currentSettings = {};

    async function loadSettings() {
      try {
        const res = await fetch(`${API_BASE}/api/settings`);
        currentSettings = await res.json();

        // localStorage에서 브라우저 알림 설정 읽기 (로컬 설정)
        currentSettings.browserNotifications = localStorage.getItem('browserNotifications') === 'true';

        // 기존 slackWebhookUrl → 채널 자동 마이그레이션
        if (currentSettings.slackWebhookUrl && (!currentSettings.notifications?.channels?.length)) {
          const migrated = {
            channels: [{
              id: 'slack-main', type: 'slack', name: '기본 Slack',
              webhookUrl: currentSettings.slackWebhookUrl, enabled: currentSettings.slackEnabled !== false
            }],
            rules: [
              { id: 'rule-migrated-1', event: 'job.failed', channels: ['slack-main'], filter: {} },
              { id: 'rule-migrated-2', event: 'job.success', channels: ['slack-main'], filter: {} }
            ]
          };
          currentSettings.notifications = migrated;
        }

        // 폼에 값 채우기
        document.getElementById('settingsDashboardUrl').value = currentSettings.dashboardUrl || 'http://localhost:3030';
        document.getElementById('settingsRefreshInterval').value = currentSettings.refreshInterval || 5;
        document.getElementById('settingsDefaultTimeout').value = currentSettings.defaultTimeout || 10;
        document.getElementById('settingsDefaultRetry').value = currentSettings.defaultRetry || 0;
        document.getElementById('settingsBrowserNotifications').checked = currentSettings.browserNotifications;

        // Obsidian 경로
        document.getElementById('settingsObsidianVaultPath').value = currentSettings.obsidianVaultPath || '';
        document.getElementById('settingsObsidianDailyFolder').value = currentSettings.obsidianDailyFolder || 'DAILY';
        document.getElementById('settingsObsidianMorningFolder').value = currentSettings.obsidianMorningFolder || 'Morning Plans';
        document.getElementById('settingsObsidianReportFolder').value = currentSettings.obsidianReportFolder || 'Daily Reports';
        document.getElementById('settingsObsidianWeeklyFolder').value = currentSettings.obsidianWeeklyFolder || 'WEEKLY';
        updateObsidianPreview();

        // 알림 권한 상태 표시
        updateNotificationStatus();

        // 알림 채널 & 규칙 렌더링
        renderNotificationChannels(currentSettings.notifications?.channels || []);
        renderNotificationRules(currentSettings.notifications?.rules || [], currentSettings.notifications?.channels || []);

        // 웹훅 토큰 로드
        loadWebhookTokens();
      } catch (err) {
        console.error('Settings load error:', err);
      }
    }

    function updateNotificationStatus() {
      const statusEl = document.getElementById('notificationStatus');
      if (!('Notification' in window)) {
        statusEl.textContent = '지원 안함';
        statusEl.className = 'text-xs text-red-400';
      } else if (Notification.permission === 'granted') {
        statusEl.textContent = '허용됨';
        statusEl.className = 'text-xs text-green-400';
      } else if (Notification.permission === 'denied') {
        statusEl.textContent = '차단됨';
        statusEl.className = 'text-xs text-red-400';
      } else {
        statusEl.textContent = '권한 필요';
        statusEl.className = 'text-xs text-yellow-400';
      }
    }

    async function onBrowserNotificationChange(checkbox) {
      if (checkbox.checked) {
        const granted = await requestNotificationPermission();
        if (!granted) {
          checkbox.checked = false;
          showToast('브라우저 알림 권한이 필요합니다.', 'error');
        }
      }
      updateNotificationStatus();
    }

    async function saveSettings() {
      // Slack URL은 채널에서 관리 - 채널에서 첫 번째 slack 타입의 URL을 legacy 필드에도 동기화
      const slackChannel = notifChannels.find(c => c.type === 'slack' && c.enabled);
      const settings = {
        slackWebhookUrl: slackChannel?.webhookUrl || '',
        slackEnabled: !!slackChannel,
        dashboardUrl: document.getElementById('settingsDashboardUrl').value.trim() || 'http://localhost:3030',
        refreshInterval: parseInt(document.getElementById('settingsRefreshInterval').value) || 5,
        defaultTimeout: parseInt(document.getElementById('settingsDefaultTimeout').value) || 10,
        defaultRetry: parseInt(document.getElementById('settingsDefaultRetry').value) || 0,
        notifications: collectNotificationSettings(),
        obsidianVaultPath: document.getElementById('settingsObsidianVaultPath').value.trim() || undefined,
        obsidianDailyFolder: document.getElementById('settingsObsidianDailyFolder').value.trim() || undefined,
        obsidianMorningFolder: document.getElementById('settingsObsidianMorningFolder').value.trim() || undefined,
        obsidianReportFolder: document.getElementById('settingsObsidianReportFolder').value.trim() || undefined,
        obsidianWeeklyFolder: document.getElementById('settingsObsidianWeeklyFolder').value.trim() || undefined
      };

      // 브라우저 알림 설정은 localStorage에 저장 (브라우저별 설정)
      const browserNotifications = document.getElementById('settingsBrowserNotifications').checked;
      localStorage.setItem('browserNotifications', browserNotifications);
      currentSettings.browserNotifications = browserNotifications;

      try {
        const res = await fetch(`${API_BASE}/api/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (res.ok) {
          currentSettings = { ...currentSettings, ...settings };
          showToast('설정이 저장되었습니다.', 'success');
        } else {
          showToast('설정 저장에 실패했습니다.', 'error');
        }
      } catch (err) {
        console.error('Settings save error:', err);
        showToast('설정 저장 중 오류가 발생했습니다.', 'error');
      }
    }

    // === 알림 채널 & 규칙 관리 ===
    let notifChannels = [];
    let notifRules = [];

    function renderNotificationChannels(channels) {
      notifChannels = channels;
      const container = document.getElementById('notificationChannelsList');
      if (!channels.length) {
        container.innerHTML = '<p class="text-sm text-gray-500">등록된 채널이 없습니다.</p>';
        return;
      }
      const typeIcons = { slack: '💬', discord: '🎮', native: '🔔' };
      container.innerHTML = channels.map((ch, i) => `
        <div class="p-3 bg-gray-700/50 rounded-lg space-y-2">
          <div class="flex items-center gap-2">
            <span class="text-lg">${typeIcons[ch.type] || '📡'}</span>
            <select onchange="updateChannelField(${i}, 'type', this.value)"
              class="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm">
              <option value="slack" ${ch.type === 'slack' ? 'selected' : ''}>Slack</option>
              <option value="discord" ${ch.type === 'discord' ? 'selected' : ''}>Discord</option>
              <option value="native" ${ch.type === 'native' ? 'selected' : ''}>브라우저</option>
            </select>
            <input value="${ch.name || ''}" placeholder="채널 이름" onchange="updateChannelField(${i}, 'name', this.value)"
              class="flex-1 bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm min-w-0">
            <label class="flex items-center gap-1 shrink-0 cursor-pointer">
              <input type="checkbox" ${ch.enabled ? 'checked' : ''} onchange="updateChannelField(${i}, 'enabled', this.checked)" class="w-4 h-4 rounded">
            </label>
            <button onclick="testNotificationChannel(${i})" class="px-2 py-1 text-xs bg-green-600/30 text-green-400 hover:bg-green-600/50 rounded shrink-0">테스트</button>
            <button onclick="removeNotificationChannel(${i})" class="px-2 py-1 text-xs text-red-400 hover:bg-red-600/20 rounded shrink-0">삭제</button>
          </div>
          ${ch.type !== 'native' ? `
          <input value="${ch.webhookUrl || ''}" placeholder="Webhook URL (https://hooks.slack.com/... 또는 https://discord.com/api/webhooks/...)"
            onchange="updateChannelField(${i}, 'webhookUrl', this.value)"
            class="w-full bg-gray-600 border border-gray-500 rounded px-2 py-1.5 text-xs font-mono min-w-0" type="password">
          ` : ''}
        </div>
      `).join('');
    }

    function addNotificationChannel() {
      notifChannels.push({ id: `ch-${Date.now()}`, type: 'slack', name: '', webhookUrl: '', enabled: true });
      renderNotificationChannels(notifChannels);
    }

    function removeNotificationChannel(idx) {
      notifChannels.splice(idx, 1);
      renderNotificationChannels(notifChannels);
      renderNotificationRules(notifRules, notifChannels);
    }

    function updateChannelField(idx, field, value) {
      notifChannels[idx][field] = value;
      if (field === 'type') renderNotificationChannels(notifChannels);
    }

    async function testNotificationChannel(idx) {
      const ch = notifChannels[idx];
      if (!ch.webhookUrl && ch.type !== 'native') {
        showToast('Webhook URL을 입력하세요', 'error');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/notifications/test`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel: ch })
        });
        const text = await res.text();
        if (res.ok) {
          showToast('테스트 알림 전송 완료', 'success');
        } else {
          try { const d = JSON.parse(text); showToast(d.error || '전송 실패', 'error'); }
          catch { showToast(`전송 실패 (${res.status})`, 'error'); }
        }
      } catch (err) {
        showToast('테스트 실패: ' + err.message, 'error');
      }
    }

    const notifEventTypes = [
      { value: 'job.failed', label: '실패', icon: '❌', color: 'red' },
      { value: 'job.success', label: '성공', icon: '✅', color: 'green' },
      { value: 'job.started', label: '시작', icon: '▶️', color: 'blue' }
    ];

    function renderNotificationRules(rules, channels) {
      notifRules = rules;
      const container = document.getElementById('notificationRulesList');
      if (!rules.length) {
        container.innerHTML = '<p class="text-sm text-gray-500">등록된 규칙이 없습니다.</p>';
        return;
      }
      const typeIcons = { slack: '💬', discord: '🎮', native: '🔔' };
      const jobList = (allJobsData || []);

      container.innerHTML = rules.map((rule, i) => {
        const evt = notifEventTypes.find(e => e.value === rule.event) || notifEventTypes[0];
        const filterJobId = rule.filter?.jobId || '';

        return `
        <div class="p-3 bg-gray-700/50 rounded-lg space-y-2">
          <div class="flex items-center gap-2">
            <!-- 이벤트 선택 -->
            <select onchange="notifRules[${i}].event = this.value; renderNotificationRules(notifRules, notifChannels)"
              class="bg-gray-600 border border-gray-500 rounded px-2 py-1 text-sm font-medium">
              ${notifEventTypes.map(e => `<option value="${e.value}" ${rule.event === e.value ? 'selected' : ''}>${e.icon} ${e.label}</option>`).join('')}
            </select>

            <span class="text-gray-500">일 때</span>
            <span class="text-gray-500 mx-1">→</span>

            <!-- 채널 체크박스 칩 -->
            <div class="flex gap-1.5 flex-wrap flex-1">
              ${channels.map(c => {
                const checked = (rule.channels || []).includes(c.id);
                return `<label class="flex items-center gap-1 px-2 py-0.5 rounded-full text-xs cursor-pointer transition-colors ${checked ? 'bg-blue-600/40 text-blue-300 border border-blue-500/50' : 'bg-gray-600/50 text-gray-400 border border-gray-600'}"
                  ><input type="checkbox" ${checked ? 'checked' : ''} onchange="toggleRuleChannel(${i}, '${c.id}')" class="hidden"
                  >${typeIcons[c.type] || ''} ${c.name || c.type}</label>`;
              }).join('')}
            </div>

            <button onclick="removeNotificationRule(${i})" class="px-2 py-1 text-xs text-red-400 hover:bg-red-600/20 rounded shrink-0">삭제</button>
          </div>

          <!-- 작업 필터 -->
          <div class="flex items-center gap-2 text-xs">
            <span class="text-gray-500">대상:</span>
            <select onchange="setRuleJobFilter(${i}, this.value)"
              class="bg-gray-600/50 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">
              <option value="" ${!filterJobId ? 'selected' : ''}>모든 작업</option>
              ${jobList.map(j => `<option value="${j.id}" ${filterJobId === j.id ? 'selected' : ''}>${j.name}</option>`).join('')}
            </select>
          </div>
        </div>`;
      }).join('');
    }

    function toggleRuleChannel(ruleIdx, channelId) {
      const rule = notifRules[ruleIdx];
      if (!rule.channels) rule.channels = [];
      const idx = rule.channels.indexOf(channelId);
      if (idx >= 0) rule.channels.splice(idx, 1);
      else rule.channels.push(channelId);
      renderNotificationRules(notifRules, notifChannels);
    }

    function setRuleJobFilter(ruleIdx, jobId) {
      if (!notifRules[ruleIdx].filter) notifRules[ruleIdx].filter = {};
      if (jobId) notifRules[ruleIdx].filter.jobId = jobId;
      else delete notifRules[ruleIdx].filter.jobId;
    }

    function addNotificationRule() {
      notifRules.push({ id: `rule-${Date.now()}`, event: 'job.failed', channels: [], filter: {} });
      renderNotificationRules(notifRules, notifChannels);
    }

    function removeNotificationRule(idx) {
      notifRules.splice(idx, 1);
      renderNotificationRules(notifRules, notifChannels);
    }

    function collectNotificationSettings() {
      return { channels: notifChannels, rules: notifRules };
    }

    // === Simple Input Modal ===
    let simpleInputResolve = null;

    function showInputModal(title, placeholder) {
      return new Promise((resolve) => {
        simpleInputResolve = resolve;
        document.getElementById('simpleInputTitle').textContent = title;
        const input = document.getElementById('simpleInputValue');
        input.value = '';
        input.placeholder = placeholder || '';
        document.getElementById('simpleInputModal').classList.add('active');
        setTimeout(() => input.focus(), 100);
      });
    }

    function resolveSimpleInput() {
      const val = document.getElementById('simpleInputValue').value.trim();
      document.getElementById('simpleInputModal').classList.remove('active');
      if (simpleInputResolve) { simpleInputResolve(val || null); simpleInputResolve = null; }
    }

    function rejectSimpleInput() {
      document.getElementById('simpleInputModal').classList.remove('active');
      if (simpleInputResolve) { simpleInputResolve(null); simpleInputResolve = null; }
    }

    // === Webhook Token 관리 ===
    async function loadWebhookTokens() {
      try {
        const res = await fetch(`${API_BASE}/api/webhook-tokens`);
        const tokens = await res.json();
        renderWebhookTokens(tokens);
      } catch (err) {
        console.error('Webhook tokens load error:', err);
      }
    }

    function renderWebhookTokens(tokens) {
      const container = document.getElementById('webhookTokensList');
      if (!tokens.length) {
        container.innerHTML = '<p class="text-sm text-gray-500">생성된 토큰이 없습니다.</p>';
        return;
      }
      container.innerHTML = tokens.map(t => `
        <div class="p-3 bg-gray-700/50 rounded-lg">
          <div class="flex items-center justify-between mb-1">
            <span class="font-medium text-sm">${t.name}</span>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500">${t.usageCount || 0}회 사용</span>
              <button onclick="toggleWebhookToken('${t.id}', ${!t.enabled})" class="text-xs ${t.enabled ? 'text-green-400' : 'text-gray-500'}">${t.enabled ? '활성' : '비활성'}</button>
              <button onclick="deleteWebhookToken('${t.id}')" class="text-xs text-red-400 hover:text-red-300">삭제</button>
            </div>
          </div>
          <div class="flex items-center gap-2 text-xs text-gray-400">
            <code>${t.token}</code>
            ${t.lastUsedAt ? `<span>| 마지막: ${new Date(t.lastUsedAt).toLocaleString('ko')}</span>` : ''}
          </div>
          ${t.allowedJobs?.length ? `<div class="text-xs text-gray-500 mt-1">허용: ${t.allowedJobs.join(', ')}</div>` : '<div class="text-xs text-gray-500 mt-1">모든 작업 허용</div>'}
        </div>
      `).join('');
    }

    async function createWebhookToken() {
      const name = await showInputModal('토큰 이름', 'GitHub Actions 배포');
      if (!name) return;

      try {
        const res = await fetch(`${API_BASE}/api/webhook-tokens`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const token = await res.json();
        showTokenCopyModal(token.token);
        loadWebhookTokens();
      } catch (err) {
        showToast('토큰 생성 실패', 'error');
      }
    }

    function showTokenCopyModal(token) {
      const dashUrl = currentSettings.dashboardUrl || 'http://localhost:3030';
      document.getElementById('tokenCopyValue').textContent = token;
      document.getElementById('tokenCopyCurl').textContent =
        `curl -X POST ${dashUrl}/api/webhook/${token} \\\n  -H "Content-Type: application/json" \\\n  -d '{"jobId": "YOUR_JOB_ID"}'`;
      document.getElementById('tokenCopyModal').classList.add('active');
    }

    function copyTokenToClipboard() {
      const token = document.getElementById('tokenCopyValue').textContent;
      navigator.clipboard.writeText(token).then(() => showToast('토큰이 복사되었습니다', 'success'));
    }

    async function toggleWebhookToken(id, enabled) {
      await fetch(`${API_BASE}/api/webhook-tokens/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled })
      });
      loadWebhookTokens();
    }

    async function deleteWebhookToken(id) {
      await fetch(`${API_BASE}/api/webhook-tokens/${id}`, { method: 'DELETE' });
      loadWebhookTokens();
    }

    // Export/Import
    async function exportJobs() {
      try {
        const res = await fetch(`${API_BASE}/api/export`);
        const data = await res.json();

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai-pipeline-backup-${getKSTDateString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('백업 파일이 다운로드되었습니다.', 'success');
      } catch (err) {
        console.error('Export error:', err);
        showToast('내보내기에 실패했습니다.', 'error');
      }
    }

    async function importJobs(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);

          if (confirm('기존 데이터를 가져온 데이터로 덮어쓰시겠습니까?\n(현재 데이터는 사라집니다)')) {
            const res = await fetch(`${API_BASE}/api/import`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            if (res.ok) {
              showToast('데이터를 가져왔습니다. 새로고침합니다...', 'success');
              setTimeout(() => location.reload(), 1000);
            } else {
              showToast('데이터 가져오기에 실패했습니다.', 'error');
            }
          }
        } catch (err) {
          console.error('Import error:', err);
          showToast('잘못된 JSON 파일입니다.', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';  // Reset input
    }

    // Toast 알림
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');

      const icons = {
        success: '✅',
        error: '❌',
        info: 'ℹ️',
        warning: '⚠️'
      };

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
      `;

      container.appendChild(toast);

      // 자동 제거
      setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ============ Keyboard Shortcuts ============

    document.addEventListener('keydown', (e) => {
      // Cmd+K / Ctrl+K: 글로벌 검색 (어디서든 동작)
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openGlobalSearch();
        return;
      }

      // 입력 필드에서는 단축키 비활성화
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        // Esc는 예외적으로 처리
        if (e.key === 'Escape') {
          if (document.getElementById('globalSearchModal').style.display === 'flex') {
            closeGlobalSearch();
          } else {
            e.target.blur();
          }
        }
        return;
      }

      // 모달이 열려있을 때 Esc로 닫기
      if (e.key === 'Escape') {
        if (document.getElementById('globalSearchModal').style.display === 'flex') {
          closeGlobalSearch();
          return;
        }
        const modals = document.querySelectorAll('.modal.active');
        if (modals.length > 0) {
          modals.forEach(m => m.classList.remove('active'));
          currentEditingJob = null;
          currentJobForOptions = null;
          return;
        }
        // 사이드 패널 닫기
        closeSidePanel();
        hideContextMenu();
        return;
      }

      // 단축키 처리
      switch (e.key.toLowerCase()) {
        case 'n':  // 새 작업 추가
          e.preventDefault();
          openAddModal();
          break;
        case '/':  // 글로벌 검색
          e.preventDefault();
          openGlobalSearch();
          break;
        case '1':  // 홈 탭
          e.preventDefault();
          showTab('home');
          break;
        case '2':  // 작업 탭
          e.preventDefault();
          showTab('jobs');
          break;
        case '3':  // 설정 탭
          e.preventDefault();
          showTab('settings');
          break;
        case '4':  // 세션 탭
          e.preventDefault();
          showTab('sessions');
          break;
        case '5':  // 노트 탭
          e.preventDefault();
          showTab('notes');
          break;
        case '6':  // 분석 탭
          e.preventDefault();
          showTab('analysis');
          break;
        case 'g':  // 그래프 뷰 토글
          e.preventDefault();
          if (document.getElementById('panel-jobs').classList.contains('hidden')) return;
          setView(currentView === 'card' ? 'graph' : 'card');
          break;
        case 'r':  // 새로고침
          e.preventDefault();
          loadJobs();
          loadHistory();
          showToast('새로고침됨', 'info');
          break;
        case '?':  // 단축키 도움말
          e.preventDefault();
          showShortcutsHelp();
          break;
      }
    });

    function showShortcutsHelp() {
      const shortcuts = [
        { key: 'N', desc: '새 작업 추가' },
        { key: '/', desc: '검색' },
        { key: '1', desc: '작업 목록 탭' },
        { key: '2', desc: '실행 이력 탭' },
        { key: '3', desc: '통계 탭' },
        { key: '4', desc: '설정 탭' },
        { key: 'G', desc: '그래프 뷰 토글' },
        { key: 'R', desc: '새로고침' },
        { key: 'Esc', desc: '모달/패널 닫기' },
        { key: '?', desc: '단축키 도움말' }
      ];

      const html = shortcuts.map(s =>
        `<div class="flex justify-between py-1">
          <kbd class="px-2 py-0.5 bg-gray-600 rounded text-sm font-mono">${s.key}</kbd>
          <span class="text-gray-400">${s.desc}</span>
        </div>`
      ).join('');

      showToast('⌨️ 단축키: N(새작업) G(그래프) 1-6(탭) /(검색) R(새로고침)', 'info', 6000);
    }

    // ============ Sessions Tab Functions ============

    let sessionsInitialized = false;

    function initSessionsTab() {
      if (!sessionsInitialized) {
        // 오늘 날짜로 초기화
        const today = getKSTDateString();
        document.getElementById('sessionsDate').value = today;

        // 프로젝트 목록 로드
        loadProjectsList();
        sessionsInitialized = true;
      }
      loadSessions();
    }

    async function loadProjectsList() {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/projects`);
        const data = await res.json();

        const select = document.getElementById('sessionsProject');
        select.innerHTML = '<option value="">전체</option>';
        for (const project of data.projects) {
          select.innerHTML += `<option value="${project}">${project}</option>`;
        }
      } catch (err) {
        console.error('프로젝트 목록 로드 실패:', err);
      }
    }

    async function loadSessions() {
      const date = document.getElementById('sessionsDate').value ||
        getKSTDateString();
      const project = document.getElementById('sessionsProject').value;

      const params = new URLSearchParams({ date });
      if (project) params.append('project', project);

      try {
        const res = await fetch(`${API_BASE}/api/sessions?${params}`);
        const data = await res.json();
        renderSessions(data.sessions, data.date);
      } catch (err) {
        console.error('세션 로드 실패:', err);
        document.getElementById('sessionsList').innerHTML =
          '<div class="text-center text-red-400 py-8">세션 로드 실패</div>';
      }
      // next 버튼 상태 동기화
      const nextBtn = document.getElementById('sessionsDateNext');
      if (nextBtn) {
        const today = getKSTDateString();
        nextBtn.style.opacity = (document.getElementById('sessionsDate').value || today) >= today ? '0.3' : '1';
      }
    }

    function shiftSessionsDate(delta) {
      const input = document.getElementById('sessionsDate');
      const current = input.value || getKSTDateString();
      const d = new Date(current + 'T00:00:00');
      d.setDate(d.getDate() + delta);
      const newDate = getKSTDateString(d);
      const today = getKSTDateString();
      if (newDate > today) return;
      input.value = newDate;
      const nextBtn = document.getElementById('sessionsDateNext');
      if (nextBtn) nextBtn.style.opacity = newDate >= today ? '0.3' : '1';
      loadSessions();
    }

    function renderSessions(sessions, date) {
      const container = document.getElementById('sessionsList');

      if (!sessions || sessions.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            ${date} 날짜의 세션이 없습니다.
          </div>
        `;
        return;
      }

      container.innerHTML = sessions.map(s => `
        <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition-colors border border-gray-700/50 hover:border-gray-600 group">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2 cursor-pointer flex-1" onclick="showSessionDetail('${s.id}', '${s.projectPath}')">
              ${s.alias ? `
                <span class="font-medium text-blue-400">📌 ${escapeHtml(s.alias)}</span>
                <span class="text-xs text-gray-500">(${s.project})</span>
              ` : `
                <span class="font-medium">${s.project}</span>
              `}
              <span class="text-xs text-gray-500">🆔 ${s.id.substring(0, 8)}...</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-400">
                ${new Date(s.modifiedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
              </span>
              ${s.hasSummary ? '<span class="text-green-400 text-sm" title="요약 생성됨">📋</span>' : ''}
              ${s.hasInsights ? '<span class="text-purple-400 text-sm" title="인사이트 생성됨">🔍</span>' : ''}
              <button data-session-id="${s.id}" data-alias="${escapeHtml(s.alias || '').replace(/'/g, '&#39;')}"
                      onclick="event.stopPropagation(); editSessionAliasFromData(this)"
                      class="text-gray-600 hover:text-blue-400 p-1 rounded transition-all hover:bg-blue-400/10"
                      title="이름 편집">
                ✏️
              </button>
              <button onclick="event.stopPropagation(); deleteSession('${s.id}', '${s.projectPath}', '${escapeHtml(s.project)}')"
                      class="text-gray-600 hover:text-red-400 p-1 rounded transition-all hover:bg-red-400/10"
                      title="세션 삭제">
                🗑️
              </button>
            </div>
          </div>
          <div class="cursor-pointer" onclick="showSessionDetail('${s.id}', '${s.projectPath}')">
            ${s.firstMessage ? `
              <div class="text-sm text-gray-300 mb-2 line-clamp-2 leading-relaxed">
                💬 ${escapeHtml(s.firstMessage)}${s.firstMessage.length >= 100 ? '...' : ''}
              </div>
            ` : ''}
            <div class="flex items-center gap-3 text-xs text-gray-500">
              <span>📁 ${formatFileSize(s.size)}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // 현재 세션 데이터 저장 (내보내기용)
    let currentSessionData = null;
    let currentSessionForInsights = null;
    let insightsLoadedFor = null;

    // 세션 별명 편집 (data-* 속성에서 읽기)
    function editSessionAliasFromData(btn) {
      const sessionId = btn.dataset.sessionId;
      const currentAlias = btn.dataset.alias || '';
      editSessionAlias(sessionId, currentAlias);
    }

    // 세션 별명 편집 (인라인 모달)
    let _renameSessionId = null;
    async function editSessionAlias(sessionId, currentAlias) {
      _renameSessionId = sessionId;
      const modal = document.getElementById('renameSessionModal');
      const input = document.getElementById('renameSessionInput');
      input.value = currentAlias || '';
      modal.style.display = 'flex';
      setTimeout(() => { input.focus(); input.select(); }, 100);
    }

    async function submitSessionRename() {
      const newAlias = document.getElementById('renameSessionInput').value.trim();
      const sessionId = _renameSessionId;
      closeRenameSessionModal();
      if (!sessionId) return;

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}/alias`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ alias: newAlias })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || '저장 실패');
        }

        showToast(newAlias ? `세션 이름이 "${newAlias}"으로 변경되었습니다` : '세션 이름이 초기화되었습니다', 'success');
        loadSessions();
        // 모달이 열려있으면 제목도 업데이트
        const modalTitle = document.querySelector('#sessionDetailModal .session-alias-display');
        if (modalTitle) {
          modalTitle.textContent = newAlias || '';
        }
      } catch (err) {
        showToast('이름 변경 실패: ' + err.message, 'error');
      }
    }

    function closeRenameSessionModal() {
      document.getElementById('renameSessionModal').style.display = 'none';
      _renameSessionId = null;
    }

    // 모달에서 세션 별명 편집 (data-* 속성에서 읽기)
    function editSessionAliasFromModalData(btn) {
      const sessionId = btn.dataset.sessionId;
      const currentAlias = btn.dataset.alias || '';
      editSessionAliasFromModal(sessionId, currentAlias);
    }

    // 모달에서 세션 별명 편집
    async function editSessionAliasFromModal(sessionId, currentAlias) {
      editSessionAlias(sessionId, currentAlias);
    }

    // 세션 삭제
    async function deleteSession(sessionId, projectPath, projectName) {
      if (!confirm(`정말 이 세션을 삭제하시겠습니까?\n\n프로젝트: ${projectName}\n세션 ID: ${sessionId.substring(0, 8)}...\n\n(삭제된 세션은 백업됩니다)`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}?project=${encodeURIComponent(projectPath)}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || '삭제 실패');
        }

        showToast('세션이 삭제되었습니다', 'success');

        // 목록 새로고침
        const dateInput = document.getElementById('sessionsDate');
        if (dateInput) {
          loadSessions(dateInput.value);
        }
      } catch (err) {
        showToast('세션 삭제 실패: ' + err.message, 'error');
      }
    }

    // 모달에서 세션 삭제
    async function deleteSessionFromModal(sessionId, projectPath, projectName) {
      if (!confirm(`정말 이 세션을 삭제하시겠습니까?\n\n프로젝트: ${projectName}\n세션 ID: ${sessionId.substring(0, 8)}...\n\n(삭제된 세션은 백업됩니다)`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}?project=${encodeURIComponent(projectPath)}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || '삭제 실패');
        }

        showToast('세션이 삭제되었습니다', 'success');
        closeSessionModal();

        // 목록 새로고침
        const dateInput = document.getElementById('sessionsDate');
        if (dateInput) {
          loadSessions(dateInput.value);
        }
      } catch (err) {
        showToast('세션 삭제 실패: ' + err.message, 'error');
      }
    }

    async function showSessionDetail(sessionId, projectPath) {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}?project=${encodeURIComponent(projectPath)}`);
        const data = await res.json();
        currentSessionData = { ...data, sessionId, projectPath };
        currentSessionForInsights = { id: sessionId, projectPath };

        const modal = document.getElementById('sessionDetailModal');
        const content = document.getElementById('sessionDetailContent');

        // 대화 내용 렌더링 (개선된 UI)
        // 연속된 도구 전용 메시지 그룹화
        const groupedConversation = groupToolOnlyMessages(data.conversation || []);

        const conversationHtml = groupedConversation.map((msg, idx) => {
          const isUser = msg.role === 'user';
          const time = msg.timestamp ?
            new Date(msg.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';

          // 그룹화된 도구 메시지
          if (msg.isToolGroup) {
            const allTools = msg.groupedTools.flat();
            const uniqueTools = [...new Set(allTools)];
            return `
              <div class="pl-8 pr-0">
                <div class="tool-group-collapsed bg-gray-700/30 rounded-lg px-3 py-2 border border-gray-600/30 cursor-pointer hover:bg-gray-700/50 transition-colors"
                     onclick="toggleToolGroup(this)">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400">🔧</span>
                    <span class="text-xs text-gray-400">${msg.groupCount}개 도구 호출</span>
                    <span class="text-xs text-gray-500">(${uniqueTools.slice(0, 3).join(', ')}${uniqueTools.length > 3 ? '...' : ''})</span>
                    <span class="tool-group-toggle text-xs text-gray-500 ml-auto">▼</span>
                  </div>
                  <div class="tool-group-details hidden mt-2 pt-2 border-t border-gray-600/50">
                    <div class="flex flex-wrap gap-1">
                      ${allTools.map(t => `<span class="px-2 py-0.5 bg-blue-900/30 text-blue-300 rounded text-xs font-mono">${t}</span>`).join('')}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          // 일반 메시지 (도구 정보는 텍스트가 있는 경우에만 표시)
          const hasContent = msg.content && msg.content.trim();
          const toolsInfo = (msg.tools?.length && hasContent) ?
            `<div class="flex flex-wrap gap-1 mt-2 pt-2 border-t border-gray-600/50">
              ${msg.tools.map(t => `<span class="px-2 py-0.5 bg-blue-900/30 text-blue-300 rounded text-xs font-mono">${t}</span>`).join('')}
            </div>` : '';

          // 도구만 사용한 단일 메시지 (그룹화 안된 경우)
          if (!isUser && !hasContent && msg.tools?.length) {
            return `
              <div class="pl-8 pr-0">
                <div class="flex items-center gap-2 text-xs text-gray-500 py-1">
                  <span>🔧</span>
                  <span>${msg.tools.join(', ')}</span>
                </div>
              </div>
            `;
          }

          return `
            <div class="group ${isUser ? 'pl-0 pr-8' : 'pl-8 pr-0'}">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${isUser ? 'bg-gradient-to-br from-purple-500 to-pink-500' : 'bg-gradient-to-br from-green-500 to-teal-500'}">
                  ${isUser ? 'U' : 'C'}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-semibold ${isUser ? 'text-purple-400' : 'text-green-400'}">${isUser ? '사용자' : 'Claude'}</span>
                    ${time ? `<span class="text-xs text-gray-500">${time}</span>` : ''}
                  </div>
                  <div class="rounded-lg p-3 ${isUser ? 'bg-purple-900/20 border border-purple-800/30' : 'bg-gray-700/70 border border-gray-600/30'}">
                    <div class="text-sm break-words leading-relaxed ${isUser ? 'whitespace-pre-wrap' : 'markdown-content'}">${hasContent ? (isUser ? escapeHtml(msg.content) : renderMarkdown(msg.content)) : '<span class="text-gray-500 italic">(응답 없음)</span>'}</div>
                    ${toolsInfo}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        content.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-lg">🤖</div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-lg font-bold">${data.alias ? `<span class="text-blue-400">📌 ${escapeHtml(data.alias)}</span>` : data.project}</h3>
                  <button id="editAliasBtn" data-session-id="${sessionId}" data-alias="${escapeHtml(data.alias || '').replace(/'/g, '&#39;')}"
                          onclick="editSessionAliasFromModalData(this)"
                          class="text-gray-500 hover:text-blue-400 p-1 rounded hover:bg-gray-700 transition-colors"
                          title="이름 편집">
                    ✏️
                  </button>
                </div>
                <p class="text-xs text-gray-400">${data.alias ? data.project + ' · ' : ''}${data.id.substring(0, 8)}... · ${data.messageCount} 메시지</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="deleteSessionFromModal('${sessionId}', '${projectPath}', '${data.project}')"
                      class="text-gray-500 hover:text-red-400 p-2 rounded-lg hover:bg-gray-700 transition-colors"
                      title="세션 삭제">
                🗑️
              </button>
              <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
          </div>

          <!-- 탭 네비게이션 -->
          <div class="flex items-center justify-between mb-4 border-b border-gray-700">
            <div class="flex gap-1">
              <button onclick="switchSessionTab('overview')" id="sessionTabOverview" class="px-4 py-2.5 text-sm font-medium border-b-2 border-blue-500 text-blue-400 -mb-px">
                📊 개요
              </button>
              <button onclick="switchSessionTab('conversation')" id="sessionTabConversation" class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white -mb-px">
                💬 대화 (${data.conversation?.length || 0})
              </button>
              <button onclick="switchSessionTab('summary')" id="sessionTabSummary" class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white -mb-px">
                📋 요약
              </button>
              <button onclick="switchSessionTab('insights')" id="sessionTabInsights" class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white -mb-px">
                🔍 인사이트
              </button>
            </div>
            <!-- 내보내기 버튼 -->
            <div class="flex gap-2">
              <button onclick="downloadSessionMd()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium transition-colors" title="마크다운 다운로드">
                📄 MD
              </button>
              <button onclick="exportToObsidian()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium transition-colors" title="옵시디언으로 내보내기">
                📝 옵시디언
              </button>
            </div>
          </div>

          <!-- 개요 탭 -->
          <div id="sessionOverviewPane" class="space-y-4">
            ${data.firstMessage ? `
              <div>
                <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">첫 메시지</h4>
                <p class="bg-gray-700/50 rounded-lg p-3 text-sm border border-gray-600/30">${escapeHtml(data.firstMessage)}</p>
              </div>
            ` : ''}

            <div class="grid grid-cols-2 gap-3">
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600/30">
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">메시지</div>
                <div class="text-2xl font-bold">${data.messageCount}</div>
              </div>
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600/30">
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">도구 사용</div>
                <div class="text-2xl font-bold">${data.toolsUsed.length}</div>
              </div>
            </div>

            ${data.toolsUsed.length ? `
              <div>
                <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">사용된 도구</h4>
                <div class="flex flex-wrap gap-1.5">
                  ${data.toolsUsed.map(t => `
                    <span class="px-2.5 py-1 bg-blue-900/30 text-blue-300 rounded-full text-xs font-medium border border-blue-800/30">${t}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${data.filesChanged.length ? `
              <div>
                <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">변경된 파일 (${data.filesChanged.length})</h4>
                <div class="bg-gray-800/50 rounded-lg p-2 max-h-32 overflow-auto border border-gray-600/30">
                  ${data.filesChanged.map(f => `
                    <div class="text-xs font-mono py-1.5 px-2 hover:bg-gray-700/50 rounded">${f}</div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <!-- 대화 탭 -->
          <div id="sessionConversationPane" class="hidden">
            ${conversationHtml ? `
              <div class="space-y-3 max-h-[55vh] overflow-auto pr-1 custom-scrollbar">
                ${conversationHtml}
              </div>
              ${data.conversation?.length >= 200 ? `
                <div class="text-center text-gray-500 text-xs mt-3 p-2 bg-gray-700/50 rounded border border-gray-600/30">
                  최근 200개 메시지만 표시됩니다
                </div>
              ` : ''}
            ` : '<div class="text-center text-gray-500 py-8">대화 내용이 없습니다</div>'}
          </div>

          <!-- 요약 탭 -->
          <div id="sessionSummaryPane" class="hidden">
            <div id="sessionSummaryContent">
              <div class="flex items-center justify-center gap-2 text-gray-500 py-8">
                <div class="w-4 h-4 border-2 border-gray-600 border-t-gray-400 rounded-full animate-spin"></div>
                <span>요약 확인 중...</span>
              </div>
            </div>
          </div>

          <!-- 인사이트 탭 (Phase 4.2) -->
          <div id="sessionInsightsPane" class="hidden">
            <div id="sessionInsightsContent">
              <div class="text-center py-8 text-gray-500">🔍 인사이트 탭을 클릭하면 AI 분석이 시작됩니다.</div>
            </div>
          </div>
        `;

        modal.style.display = 'flex';

        // 캐시된 요약 확인
        checkSessionSummaryCache(sessionId, projectPath);
      } catch (err) {
        console.error('세션 상세 로드 실패:', err);
        showToast('세션 상세 로드 실패', 'error');
      }
    }

    function switchSessionTab(tab) {
      const tabs = ['overview', 'conversation', 'summary', 'insights'];
      const tabElements = {
        overview: document.getElementById('sessionTabOverview'),
        conversation: document.getElementById('sessionTabConversation'),
        summary: document.getElementById('sessionTabSummary'),
        insights: document.getElementById('sessionTabInsights')
      };
      const paneElements = {
        overview: document.getElementById('sessionOverviewPane'),
        conversation: document.getElementById('sessionConversationPane'),
        summary: document.getElementById('sessionSummaryPane'),
        insights: document.getElementById('sessionInsightsPane')
      };

      // 모든 탭 비활성화
      for (const t of tabs) {
        if (tabElements[t]) {
          tabElements[t].classList.remove('border-blue-500', 'text-blue-400');
          tabElements[t].classList.add('border-transparent', 'text-gray-400');
        }
        if (paneElements[t]) {
          paneElements[t].classList.add('hidden');
        }
      }

      // 선택된 탭 활성화
      if (tabElements[tab]) {
        tabElements[tab].classList.add('border-blue-500', 'text-blue-400');
        tabElements[tab].classList.remove('border-transparent', 'text-gray-400');
      }
      if (paneElements[tab]) {
        paneElements[tab].classList.remove('hidden');
      }

      // 인사이트 탭 클릭 시 로딩
      if (tab === 'insights' && currentSessionForInsights) {
        loadSessionInsightsTab(currentSessionForInsights.id, currentSessionForInsights.projectPath);
      }
    }

    // 세션 요약 캐시 확인
    async function checkSessionSummaryCache(sessionId, projectPath) {
      const contentDiv = document.getElementById('sessionSummaryContent');
      if (!contentDiv) return;

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}/summary?project=${encodeURIComponent(projectPath)}`);
        const data = await res.json();

        if (data.summary) {
          currentSummaryContent = data.summary.summary;
          const createdAt = new Date(data.summary.createdAt).toLocaleString('ko-KR');
          contentDiv.innerHTML = `
            <div class="text-left">
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs text-gray-500">생성: ${createdAt}</span>
                <div class="flex gap-2">
                  <button onclick="copySummary()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
                    📋 복사
                  </button>
                  <button onclick="generateSessionSummary()" class="px-3 py-1.5 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 rounded text-xs font-medium">
                    🔄 재생성
                  </button>
                </div>
              </div>
              <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[50vh] overflow-auto custom-scrollbar">
                <div class="prose prose-invert prose-sm max-w-none markdown-content">${renderMarkdown(data.summary.summary)}</div>
              </div>
            </div>
          `;
        } else {
          contentDiv.innerHTML = `
            <div class="text-center py-8">
              <p class="text-gray-400 mb-4">Claude가 이 세션의 대화를 분석하여 요약을 생성합니다.</p>
              <button onclick="generateSessionSummary()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 rounded-lg text-sm font-medium transition-all">
                ✨ 요약 생성하기
              </button>
            </div>
          `;
        }
      } catch (err) {
        console.error('요약 캐시 확인 실패:', err);
        contentDiv.innerHTML = `
          <div class="text-center py-8">
            <p class="text-gray-400 mb-4">Claude가 이 세션의 대화를 분석하여 요약을 생성합니다.</p>
            <button onclick="generateSessionSummary()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 rounded-lg text-sm font-medium transition-all">
              ✨ 요약 생성하기
            </button>
          </div>
        `;
      }
    }

    // 세션 요약 생성
    async function generateSessionSummary() {
      if (!currentSessionData) return;

      const contentDiv = document.getElementById('sessionSummaryContent');
      contentDiv.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-gray-400">
          <div class="w-5 h-5 border-2 border-gray-600 border-t-blue-500 rounded-full animate-spin"></div>
          <span>요약 생성 중... 작업 패널에서 진행 상황을 확인하세요.</span>
        </div>
      `;

      try {
        await submitTask('session-summary', {
          sessionId: currentSessionData.sessionId,
          projectPath: currentSessionData.projectPath
        });
      } catch (err) {
        contentDiv.innerHTML = `
          <p class="text-red-400 mb-4">요약 생성 실패: ${err.message}</p>
          <button onclick="generateSessionSummary()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
            다시 시도
          </button>
        `;
      }
    }

    function closeSessionModal() {
      document.getElementById('sessionDetailModal').style.display = 'none';
      currentSessionData = null;
      insightsLoadedFor = null;
    }

    // 마크다운 다운로드
    async function downloadSessionMd() {
      if (!currentSessionData) return;
      try {
        const url = `${API_BASE}/api/sessions/${currentSessionData.sessionId}/markdown?project=${encodeURIComponent(currentSessionData.projectPath)}&download=true`;
        window.open(url, '_blank');
        showToast('마크다운 다운로드 시작', 'success');
      } catch (err) {
        showToast('다운로드 실패: ' + err.message, 'error');
      }
    }

    // 옵시디언으로 내보내기
    async function exportToObsidian() {
      if (!currentSessionData) return;
      try {
        const res = await fetch(
          `${API_BASE}/api/sessions/${currentSessionData.sessionId}/export-obsidian?project=${encodeURIComponent(currentSessionData.projectPath)}`,
          { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) }
        );
        const data = await res.json();
        if (data.success) {
          showToast(`옵시디언으로 내보냄: ${data.relativePath}`, 'success');
        } else {
          showToast('내보내기 실패: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('내보내기 실패: ' + err.message, 'error');
      }
    }

    // 일일 보고서 생성 (Claude Code로 분석)
    async function generateDailyReport() {
      const date = document.getElementById('sessionsDate').value;
      if (!date) {
        showToast('날짜를 선택해주세요', 'error');
        return;
      }

      try {
        // 비동기 작업 제출
        await submitTask('daily-report', { date });
        showToast('일일 보고서 생성 중... 완료되면 알려드릴게요!', 'info');
      } catch (err) {
        showToast('보고서 생성 실패: ' + err.message, 'error');
      }
    }

    // 캐시된 보고서 확인 프롬프트
    function showCachedReportPrompt(report) {
      return new Promise((resolve) => {
        const modal = document.getElementById('sessionDetailModal');
        const content = document.getElementById('sessionDetailContent');
        const typeLabel = {
          'day-wrapup': '🌙 하루 마무리',
          'full-daily-report': '📊 종합 보고서',
          'daily-report': '📊 일일 보고서',
          'weekly-digest': '📊 주간 다이제스트'
        }[report.type] || '보고서';

        content.innerHTML = `
          <div class="text-center py-8">
            <div class="text-4xl mb-4">📄</div>
            <h3 class="text-lg font-bold mb-2">기존 보고서가 있습니다</h3>
            <p class="text-gray-400 text-sm mb-1">${typeLabel} · ${report.date}</p>
            <p class="text-gray-500 text-xs mb-6">생성: ${new Date(report.createdAt).toLocaleString('ko-KR')}</p>
            <div class="flex gap-3 justify-center">
              <button id="viewCachedBtn" class="px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 rounded-lg text-sm font-medium transition-all">
                📖 기존 보고서 보기
              </button>
              <button id="regenerateBtn" class="px-5 py-2.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium transition-all">
                🔄 새로 생성하기
              </button>
            </div>
          </div>
        `;

        modal.style.display = 'flex';

        document.getElementById('viewCachedBtn').onclick = () => {
          modal.style.display = 'none';
          resolve(true);
        };
        document.getElementById('regenerateBtn').onclick = () => {
          modal.style.display = 'none';
          resolve(false);
        };
      });
    }

    // ============ Day Wrap-up Wizard ============
    let wrapupStep = 1;
    let wrapupData = {
      date: getKSTDateString(),
      sessions: [],
      selectedSessions: [],
      githubActivity: null,
      memos: [],
      reflection: {
        learned: '',
        proud: '',
        improve: '',
        tomorrow: '',
        grateful: '',
        oneline: ''
      }
    };

    // 오늘 보고서 버튼 클릭 → Day Wrap-up 위저드 열기
    async function generateTodayFullReport() {
      const today = homeDate || getKSTDateString();

      // 캐시된 보고서 확인
      try {
        const cacheRes = await fetch(`${API_BASE}/api/reports/daily?date=${today}`);
        const cacheData = await cacheRes.json();
        const cachedReports = (cacheData.reports || []).filter(r => r.date === today);

        if (cachedReports.length > 0) {
          const priority = ['day-wrapup', 'full-daily-report', 'daily-report'];
          let bestReport = null;
          for (const type of priority) {
            const found = cachedReports.find(r => r.type === type);
            if (found) { bestReport = found; break; }
          }

          if (bestReport) {
            const useCache = await showCachedReportPrompt(bestReport);
            if (useCache) {
              if (bestReport.type === 'day-wrapup') {
                showDayWrapupResult(bestReport);
              } else {
                showFullReportModal(bestReport);
              }
              return;
            }
          }
        }
      } catch (e) {
        console.error('캐시 보고서 확인 실패:', e);
      }

      wrapupStep = 1;
      wrapupData = {
        date: today,
        sessions: [],
        selectedSessions: [],
        githubActivity: null,
        ghSelected: null,
        memos: [],
        morningPlan: null,
        reflection: {
          learned: '',
          proud: '',
          improve: '',
          tomorrow: '',
          grateful: '',
          oneline: ''
        }
      };

      const isToday = wrapupData.date === getKSTDateString();
      document.getElementById('wrapupDate').textContent = isToday
        ? '오늘의 하루를 의미있게 정리해보세요'
        : `${wrapupData.date} 하루를 정리해보세요`;
      document.getElementById('dayWrapupModal').style.display = 'flex';

      // 데이터 로드
      await loadWrapupData();
      renderWrapupStep();
    }

    async function loadWrapupData() {
      const today = wrapupData.date;

      // 1. 세션 로드
      try {
        const res = await fetch(`${API_BASE}/api/sessions?date=${today}`);
        const data = await res.json();
        wrapupData.sessions = data.sessions || [];
      } catch (e) {
        console.error('세션 로드 실패:', e);
      }

      // 2. GitHub 활동 로드
      try {
        const res = await fetch(`${API_BASE}/api/github/activity?date=${today}`);
        wrapupData.githubActivity = await res.json();
      } catch (e) {
        console.error('GitHub 로드 실패:', e);
      }

      // 3. 메모 로드 (대시보드 + Obsidian)
      const allMemos = [];

      // 3-1. 대시보드 메모
      try {
        const res = await fetch(`${API_BASE}/api/quick-memos?date=${today}`);
        const data = await res.json();
        allMemos.push(...(data.memos || []).map(m => ({ ...m, source: 'dashboard' })));
      } catch (e) {
        console.error('대시보드 메모 로드 실패:', e);
      }

      // 3-2. Obsidian Daily Note 메모
      try {
        const res = await fetch(`${API_BASE}/api/obsidian/daily-memos?date=${today}`);
        const data = await res.json();
        allMemos.push(...(data.memos || []));
      } catch (e) {
        console.error('Obsidian 메모 로드 실패:', e);
      }

      // 시간순 정렬
      wrapupData.memos = allMemos.sort((a, b) => {
        const timeA = a.timestamp || a.time || '';
        const timeB = b.timestamp || b.time || '';
        return timeB.localeCompare(timeA);
      });

      // 4. 모닝 플랜 로드
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${today}`);
        const data = await res.json();
        wrapupData.morningPlan = data.plan || null;
      } catch (e) {
        console.error('모닝 플랜 로드 실패:', e);
        wrapupData.morningPlan = null;
      }
    }

    function renderWrapupStep() {
      const content = document.getElementById('wrapupContent');
      const prevBtn = document.getElementById('wrapupPrevBtn');
      const nextBtn = document.getElementById('wrapupNextBtn');
      const submitBtn = document.getElementById('wrapupSubmitBtn');

      // 버튼 상태
      prevBtn.classList.toggle('hidden', wrapupStep === 1);
      nextBtn.classList.toggle('hidden', wrapupStep === 4);
      submitBtn.classList.toggle('hidden', wrapupStep !== 4);

      // 스텝 인디케이터 업데이트
      for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step${i}Indicator`);
        const circle = indicator.querySelector('span');
        const label = indicator.querySelectorAll('span')[1];

        if (i < wrapupStep) {
          circle.className = 'w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = '✓';
          label.className = 'text-green-400';
        } else if (i === wrapupStep) {
          circle.className = 'w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = i;
          label.className = 'text-gray-300';
        } else {
          circle.className = 'w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs';
          circle.textContent = i;
          label.className = 'text-gray-500';
        }
      }

      // 컨텐츠 렌더링
      switch (wrapupStep) {
        case 1: renderStep1Sessions(content); break;
        case 2: renderStep2Github(content); break;
        case 3: renderStep3Memos(content); break;
        case 4: renderStep4Reflection(content); break;
      }
    }

    function renderStep1Sessions(content) {
      const sessions = wrapupData.sessions;
      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">💻 오늘의 세션 선택</h3>
          <p class="text-sm text-gray-400 mb-4">보고서에 포함할 세션을 선택하세요. 선택하지 않으면 전체 세션이 포함됩니다.</p>
        </div>
        ${sessions.length === 0 ? `
          <div class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-4 block">📭</span>
            오늘 진행한 Claude 세션이 없습니다.
          </div>
        ` : `
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-800 border border-gray-700/50">
              <input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions(this.checked)" class="w-4 h-4 rounded bg-gray-700 border-gray-600">
              <span class="text-sm font-medium">전체 선택 (${sessions.length}개)</span>
            </label>
            <div class="space-y-2 max-h-64 overflow-auto custom-scrollbar">
              ${sessions.map((s, i) => `
                <label class="flex items-start gap-3 p-3 bg-gray-800/30 rounded-lg cursor-pointer hover:bg-gray-800/50 border border-gray-700/30">
                  <input type="checkbox" class="session-checkbox w-4 h-4 rounded bg-gray-700 border-gray-600 mt-1"
                         data-index="${i}" ${wrapupData.selectedSessions.find(ss => ss.id === s.id) ? 'checked' : ''}>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      ${s.alias
                        ? `<span class="font-medium text-sm text-blue-400">📌 ${escapeHtml(s.alias)}</span><span class="text-xs text-gray-500">(${s.project})</span>`
                        : `<span class="font-medium text-sm">${s.project}</span>`
                      }
                      <span class="text-xs text-gray-500">${new Date(s.modifiedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    ${s.firstMessage ? `<div class="text-xs text-gray-400 mt-1 truncate">${escapeHtml(s.firstMessage)}</div>` : ''}
                  </div>
                </label>
              `).join('')}
            </div>
          </div>
        `}
      `;
    }

    function toggleAllSessions(checked) {
      document.querySelectorAll('.session-checkbox').forEach(cb => cb.checked = checked);
    }

    // 레포별 고유 색상 매핑
    const _ghRepoColors = {};
    const _ghColorPalette = [
      { bg: 'rgba(59,130,246,0.15)', border: '#3b82f6', text: '#93c5fd' },   // blue
      { bg: 'rgba(168,85,247,0.15)', border: '#a855f7', text: '#d8b4fe' },   // purple
      { bg: 'rgba(236,72,153,0.15)', border: '#ec4899', text: '#f9a8d4' },   // pink
      { bg: 'rgba(20,184,166,0.15)', border: '#14b8a6', text: '#5eead4' },   // teal
      { bg: 'rgba(245,158,11,0.15)', border: '#f59e0b', text: '#fcd34d' },   // amber
      { bg: 'rgba(34,197,94,0.15)',  border: '#22c55e', text: '#86efac' },   // green
      { bg: 'rgba(239,68,68,0.15)',  border: '#ef4444', text: '#fca5a5' },   // red
      { bg: 'rgba(99,102,241,0.15)', border: '#6366f1', text: '#a5b4fc' },   // indigo
    ];
    function ghRepoColor(repo) {
      if (!_ghRepoColors[repo]) {
        const idx = Object.keys(_ghRepoColors).length % _ghColorPalette.length;
        _ghRepoColors[repo] = _ghColorPalette[idx];
      }
      return _ghRepoColors[repo];
    }
    function ghRepoBadge(repoShort, repo) {
      const c = ghRepoColor(repo || repoShort);
      return `<span style="background:${c.bg};border:1px solid ${c.border};color:${c.text}" class="px-1.5 py-0.5 rounded text-xs whitespace-nowrap flex-shrink-0">${repoShort}</span>`;
    }

    function renderStep2Github(content) {
      const gh = wrapupData.githubActivity;
      // 체크 상태 초기화
      if (!wrapupData.ghSelected) {
        wrapupData.ghSelected = { commits: {}, prs: {}, reviews: {}, comments: {} };
        // 기본: 전체 선택
        (gh?.commits || []).forEach((_, i) => wrapupData.ghSelected.commits[i] = true);
        (gh?.prs || []).forEach((_, i) => wrapupData.ghSelected.prs[i] = true);
        (gh?.reviews || []).forEach((_, i) => wrapupData.ghSelected.reviews[i] = true);
        (gh?.comments || []).forEach((_, i) => wrapupData.ghSelected.comments[i] = true);
      }

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">🐙 GitHub 활동</h3>
          <p class="text-sm text-gray-400 mb-2">보고서에 포함할 항목을 선택하세요.</p>
          ${gh?.accounts?.length > 0 ? `
            <div class="flex flex-wrap gap-2 text-xs mb-3">
              ${gh.accounts.map(a => `<span class="px-2 py-1 rounded-full bg-gray-700/50 text-gray-300">👤 ${a}</span>`).join('')}
              ${(gh.repos || []).map(r => {
                const short = r.split('/').pop();
                return ghRepoBadge(short, r);
              }).join('')}
            </div>
          ` : ''}
        </div>
        ${!gh ? `
          <div class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-4 block">🔗</span>
            GitHub 데이터를 로드할 수 없습니다.<br>
            <span class="text-xs">gh CLI가 설치되어 있고 인증되어 있는지 확인하세요.</span>
          </div>
        ` : `
          <div class="space-y-3 max-h-[55vh] overflow-auto custom-scrollbar pr-1">
            ${renderGhSection('📝', '커밋', gh.commits || [], 'commits', (c, i) => {
              const msg = c.message || (c.messages || [])[0] || c.branch || '';
              const lines = msg.split('\n');
              const title = lines[0];
              const body = lines.slice(1).filter(l => l.trim()).join('\n');
              const sha7 = (c.sha || (c.shas || [])[0] || '').substring(0, 7);
              const commitUrl = c.url || (sha7 ? `https://github.com/${c.repo}/commit/${c.sha || (c.shas || [])[0]}` : '');
              return `
              <div data-commit>
                <div class="flex items-start gap-2">
                  ${ghRepoBadge(c.repoShort, c.repo)}
                  ${commitUrl && sha7 ? `<a href="${commitUrl}" target="_blank" onclick="event.stopPropagation()" class="text-xs font-mono bg-gray-700/50 px-1 py-0.5 rounded text-blue-400 hover:text-blue-300 hover:underline flex-shrink-0 mt-px">${sha7}</a>` : ''}
                  <span class="text-gray-300 text-sm flex-1 min-w-0 truncate">${escapeHtml(title)}</span>
                  ${body ? `<button onclick="event.preventDefault(); event.stopPropagation(); const b=this.closest('[data-commit]').querySelector('.commit-body'); b.classList.toggle('hidden'); this.textContent=b.classList.contains('hidden')?'▸':'▾'" class="text-gray-500 hover:text-gray-300 hover:bg-gray-700/50 text-sm flex-shrink-0 px-2 py-0.5 rounded transition-colors">▸</button>` : ''}
                </div>
                ${body ? `<pre class="commit-body hidden text-xs text-gray-400 mt-1.5 pl-3 border-l-2 border-gray-700 whitespace-pre-wrap font-sans leading-relaxed">${escapeHtml(body)}</pre>` : ''}
              </div>`;
            })}

            ${renderGhSection('🔀', 'Pull Requests', gh.prs || [], 'prs', (pr, i) => `
              <div class="flex items-start gap-2">
                <span class="px-1.5 py-0.5 rounded text-xs flex-shrink-0 font-medium ${
                  pr.action === 'opened' ? 'bg-green-900/50 text-green-400' :
                  pr.action === 'merged' ? 'bg-purple-900/50 text-purple-400' :
                  'bg-gray-700 text-gray-400'
                }">${pr.action || pr.state}</span>
                ${ghRepoBadge(pr.repoShort, pr.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${pr.account}</span>
                <a href="${pr.url || '#'}" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline text-sm truncate" title="${escapeHtml(pr.title)}">#${pr.number} ${escapeHtml(pr.title)}</a>
              </div>
            `)}

            ${renderGhSection('👀', '리뷰', gh.reviews || [], 'reviews', (r, i) => `
              <div class="flex items-start gap-2">
                <span class="px-1.5 py-0.5 rounded text-xs flex-shrink-0 ${
                  r.state === 'approved' ? 'bg-green-900/50 text-green-400' :
                  r.state === 'changes_requested' ? 'bg-red-900/50 text-red-400' :
                  'bg-blue-900/50 text-blue-400'
                }">${r.state === 'approved' ? '✅' : r.state === 'changes_requested' ? '🔄' : '💬'}</span>
                ${ghRepoBadge(r.repoShort, r.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${r.account}</span>
                <a href="${r.url || '#'}" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline text-sm truncate" title="${escapeHtml(r.prTitle)}">#${r.prNumber} ${escapeHtml(r.prTitle)}</a>
              </div>
            `)}

            ${renderGhSection('💬', '코멘트', gh.comments || [], 'comments', (c, i) => `
              <div class="flex items-start gap-2 flex-wrap">
                ${ghRepoBadge(c.repoShort, c.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${c.account}</span>
                ${c.url ? `<a href="${c.url}" target="_blank" class="text-blue-400 hover:underline text-xs flex-shrink-0 mt-0.5">#${c.prNumber || c.issueNumber}</a>` : ''}
                <span class="text-gray-400 text-sm basis-full mt-0.5 pl-1 border-l-2 border-gray-700">${escapeHtml(c.body || '(내용 없음)')}</span>
              </div>
            `)}
          </div>
        `}
      `;
    }

    function renderGhSection(icon, title, items, category, renderItem) {
      if (items.length === 0) {
        return `<div class="bg-gray-800/50 rounded-lg p-3 border border-gray-700/50">
          <div class="flex items-center gap-2">
            <span class="text-lg">${icon}</span>
            <span class="font-medium text-sm">${title}</span>
            <span class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">0개</span>
          </div>
          <div class="text-sm text-gray-600 mt-2">없음</div>
        </div>`;
      }
      const allChecked = items.every((_, i) => wrapupData.ghSelected[category][i]);
      return `<div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
        <div class="flex items-center gap-2 mb-3">
          <input type="checkbox" ${allChecked ? 'checked' : ''} onchange="toggleGhAll('${category}', this.checked)"
            class="w-3.5 h-3.5 rounded accent-blue-500 cursor-pointer">
          <span class="text-lg">${icon}</span>
          <span class="font-medium text-sm">${title}</span>
          <span class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">${items.length}개</span>
        </div>
        <div class="space-y-2">
          ${items.slice(0, 10).map((item, i) => `
            <label class="flex items-start gap-2 cursor-pointer rounded-md p-1.5 -mx-1.5 hover:bg-white/5 transition-colors gh-item-${category}">
              <input type="checkbox" ${wrapupData.ghSelected[category][i] ? 'checked' : ''}
                onchange="wrapupData.ghSelected['${category}'][${i}] = this.checked"
                class="w-3.5 h-3.5 rounded accent-blue-500 cursor-pointer mt-1 flex-shrink-0">
              <div class="flex-1 min-w-0">${renderItem(item, i)}</div>
            </label>
          `).join('')}
        </div>
      </div>`;
    }

    function toggleGhAll(category, checked) {
      const gh = wrapupData.githubActivity;
      const items = gh?.[category] || [];
      items.forEach((_, i) => wrapupData.ghSelected[category][i] = checked);
      document.querySelectorAll(`.gh-item-${category} input[type="checkbox"]`).forEach(cb => cb.checked = checked);
    }

    function filterSelectedGithub() {
      const gh = wrapupData.githubActivity;
      if (!gh || !wrapupData.ghSelected) return gh;
      const sel = wrapupData.ghSelected;
      return {
        ...gh,
        commits: (gh.commits || []).filter((_, i) => sel.commits[i]),
        prs: (gh.prs || []).filter((_, i) => sel.prs[i]),
        reviews: (gh.reviews || []).filter((_, i) => sel.reviews[i]),
        comments: (gh.comments || []).filter((_, i) => sel.comments[i])
      };
    }

    function renderStep3Memos(content) {
      const memos = wrapupData.memos;
      const obsidianMemos = memos.filter(m => m.source === 'obsidian');
      const dashboardMemos = memos.filter(m => m.source === 'dashboard');

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">📝 오늘의 메모</h3>
          <p class="text-sm text-gray-400 mb-4">대시보드와 Obsidian Daily Note의 메모가 포함됩니다.</p>
        </div>
        ${memos.length === 0 ? `
          <div class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-4 block">📝</span>
            오늘 작성한 메모가 없습니다.
          </div>
        ` : `
          <div class="flex gap-2 mb-3 text-xs">
            <span class="px-2 py-1 rounded-full bg-purple-900/50 text-purple-300">📱 대시보드 ${dashboardMemos.length}개</span>
            <span class="px-2 py-1 rounded-full bg-green-900/50 text-green-300">📓 Obsidian ${obsidianMemos.length}개</span>
          </div>
          <div class="space-y-2 max-h-64 overflow-auto custom-scrollbar">
            ${memos.map((m, i) => `
              <div class="p-3 bg-gray-800/30 rounded-lg border border-gray-700/30 ${m.source === 'obsidian' ? 'border-l-2 border-l-green-500' : 'border-l-2 border-l-purple-500'}">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs ${m.source === 'obsidian' ? 'text-green-400' : 'text-purple-400'}">${m.source === 'obsidian' ? '📓' : '📱'}</span>
                  <span class="text-xs text-gray-500">${m.time || new Date(m.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <div class="text-sm">${escapeHtml(m.content || m.text || '')}</div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    function renderStep4Reflection(content) {
      const r = wrapupData.reflection;
      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">🪞 하루 회고</h3>
          <p class="text-sm text-gray-400 mb-4">오늘 하루를 돌아보며 간단히 적어보세요. (선택사항)</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">💡 오늘 배운 것</label>
            <input type="text" id="reflectLearned" value="${escapeHtml(r.learned)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="오늘 새롭게 알게 된 것이 있나요?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">🌟 잘한 점</label>
            <input type="text" id="reflectProud" value="${escapeHtml(r.proud)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="오늘 스스로 칭찬하고 싶은 점은?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">🔧 개선할 점</label>
            <input type="text" id="reflectImprove" value="${escapeHtml(r.improve)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="내일 더 나아질 수 있는 부분은?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">🎯 내일 목표</label>
            <input type="text" id="reflectTomorrow" value="${escapeHtml(r.tomorrow)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="내일 꼭 하고 싶은 일은?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">🙏 감사한 것</label>
            <input type="text" id="reflectGrateful" value="${escapeHtml(r.grateful)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="오늘 감사했던 순간이 있나요?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">✨ 오늘의 한 줄</label>
            <input type="text" id="reflectOneline" value="${escapeHtml(r.oneline)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="오늘 하루를 한 문장으로 표현한다면?">
          </div>
        </div>
      `;
    }

    function prevWrapupStep() {
      saveCurrentStepData();
      if (wrapupStep > 1) {
        wrapupStep--;
        renderWrapupStep();
      }
    }

    function nextWrapupStep() {
      saveCurrentStepData();
      if (wrapupStep < 4) {
        wrapupStep++;
        renderWrapupStep();
      }
    }

    function saveCurrentStepData() {
      if (wrapupStep === 1) {
        // 선택된 세션 저장
        const checkboxes = document.querySelectorAll('.session-checkbox:checked');
        wrapupData.selectedSessions = Array.from(checkboxes).map(cb => {
          const idx = parseInt(cb.dataset.index);
          return wrapupData.sessions[idx];
        });
      } else if (wrapupStep === 4) {
        // 회고 데이터 저장
        wrapupData.reflection = {
          learned: document.getElementById('reflectLearned')?.value || '',
          proud: document.getElementById('reflectProud')?.value || '',
          improve: document.getElementById('reflectImprove')?.value || '',
          tomorrow: document.getElementById('reflectTomorrow')?.value || '',
          grateful: document.getElementById('reflectGrateful')?.value || '',
          oneline: document.getElementById('reflectOneline')?.value || ''
        };
      }
    }

    async function submitDayWrapup() {
      saveCurrentStepData();

      // 선택된 세션이 없으면 전체 세션 사용
      const sessionsToUse = wrapupData.selectedSessions.length > 0
        ? wrapupData.selectedSessions
        : wrapupData.sessions;

      try {
        await submitTask('day-wrapup', {
          date: wrapupData.date,
          selectedSessions: sessionsToUse.map(s => ({ id: s.id, projectPath: s.projectPath, project: s.project, alias: s.alias || null })),
          githubActivity: filterSelectedGithub(),
          memos: wrapupData.memos,
          morningPlan: wrapupData.morningPlan,
          reflection: wrapupData.reflection
        });

        closeDayWrapupModal();
        showToast('🌙 하루 마무리 생성 중... 완료되면 알려드릴게요!', 'info');
      } catch (err) {
        showToast('하루 마무리 생성 실패: ' + err.message, 'error');
      }
    }

    function closeDayWrapupModal() {
      document.getElementById('dayWrapupModal').style.display = 'none';
    }

    // Day Wrap-up 결과 표시
    function showDayWrapupResult(result) {
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');
      currentReportContent = result.report;

      content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-lg">🌙</div>
            <div>
              <h3 class="text-lg font-bold">하루 마무리</h3>
              <p class="text-xs text-gray-400">${result.date} · ${result.sessionsCount}개 세션 · ${result.memosCount}개 메모</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="copyCurrentReport()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              📋 복사
            </button>
            <button onclick="downloadFullReport('${result.date}')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              📄 다운로드
            </button>
            <button onclick="saveFullReportToObsidian('${result.date}')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium">
              📝 옵시디언
            </button>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none ml-2">&times;</button>
          </div>
        </div>

        <div class="prose prose-invert max-w-none">
          <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[65vh] overflow-auto custom-scrollbar">
            <div class="markdown-content text-sm leading-relaxed">${renderMarkdown(result.report)}</div>
          </div>
        </div>
      `;

      modal.style.display = 'flex';
    }

    // 종합 보고서 모달
    let currentReportContent = '';

    function showFullReportModal(reportData) {
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');
      currentReportContent = reportData.report;

      const stats = [];
      if (reportData.sessionsCount !== undefined) stats.push(`${reportData.sessionsCount}개 세션`);
      if (reportData.jobsCount !== undefined) stats.push(`${reportData.jobsCount}개 작업`);
      if (reportData.memosCount !== undefined) stats.push(`${reportData.memosCount}개 메모`);

      content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-pink-600 flex items-center justify-center text-lg">📊</div>
            <div>
              <h3 class="text-lg font-bold">종합 일일 보고서</h3>
              <p class="text-xs text-gray-400">${reportData.date} · ${stats.join(' · ')}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="copyCurrentReport()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              📋 복사
            </button>
            <button onclick="downloadFullReport('${reportData.date}')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              📄 다운로드
            </button>
            <button onclick="saveFullReportToObsidian('${reportData.date}')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium">
              📝 옵시디언
            </button>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none ml-2">&times;</button>
          </div>
        </div>

        <div class="prose prose-invert max-w-none">
          <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[65vh] overflow-auto custom-scrollbar">
            <div class="markdown-content text-sm leading-relaxed">${renderMarkdown(reportData.report)}</div>
          </div>
        </div>
      `;

      modal.style.display = 'flex';
    }

    function copyCurrentReport() {
      if (currentReportContent) {
        copyToClipboard(currentReportContent, '보고서가 복사되었습니다');
      }
    }

    function downloadFullReport(date) {
      const blob = new Blob([currentReportContent], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `daily-report-${date}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('보고서 다운로드 완료', 'success');
    }

    async function saveFullReportToObsidian(date) {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/daily-report/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, content: currentReportContent })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`보고서 저장됨: ${data.relativePath}`, 'success');
        } else {
          showToast('저장 실패: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('저장 실패: ' + err.message, 'error');
      }
    }

    function showReportModal(reportData) {
      // 기존 일일 보고서도 종합 보고서 모달로 표시
      showFullReportModal(reportData);
    }

    // 보고서 다운로드
    async function downloadReport(date) {
      window.open(`${API_BASE}/api/sessions/daily-report/download?date=${date}`, '_blank');
    }

    // 보고서 옵시디언 저장
    async function saveReportToObsidian(date) {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/daily-report/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`보고서 저장됨: ${data.relativePath}`, 'success');
        } else {
          showToast('저장 실패: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('저장 실패: ' + err.message, 'error');
      }
    }

    // 전체 세션 옵시디언으로 내보내기
    async function exportAllSessionsToObsidian() {
      const date = document.getElementById('sessionsDate').value;
      if (!date) {
        showToast('날짜를 선택해주세요', 'error');
        return;
      }

      showToast('전체 세션 내보내기 중...', 'info');

      try {
        const res = await fetch(`${API_BASE}/api/sessions/export-all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date })
        });

        const data = await res.json();
        if (data.success) {
          showToast(`${data.exported}개 세션 내보냄`, 'success');
        } else {
          showToast('내보내기 실패: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('내보내기 실패: ' + err.message, 'error');
      }
    }

    // 연속된 도구 전용 메시지를 그룹화
    function groupToolOnlyMessages(conversation) {
      const result = [];
      let toolGroup = null;

      for (const msg of conversation) {
        const hasContent = msg.content && msg.content.trim();
        const isToolOnly = msg.role === 'assistant' && !hasContent && msg.tools?.length > 0;

        if (isToolOnly) {
          if (!toolGroup) {
            toolGroup = {
              isToolGroup: true,
              role: 'assistant',
              groupCount: 0,
              groupedTools: [],
              timestamp: msg.timestamp
            };
          }
          toolGroup.groupCount++;
          toolGroup.groupedTools.push(msg.tools);
        } else {
          // 현재 그룹 저장 (2개 이상일 때만 그룹화)
          if (toolGroup) {
            if (toolGroup.groupCount >= 2) {
              result.push(toolGroup);
            } else {
              // 1개면 그냥 일반 메시지로 표시
              result.push({
                role: 'assistant',
                content: '',
                tools: toolGroup.groupedTools[0],
                timestamp: toolGroup.timestamp
              });
            }
            toolGroup = null;
          }
          result.push(msg);
        }
      }

      // 마지막 그룹 처리
      if (toolGroup) {
        if (toolGroup.groupCount >= 2) {
          result.push(toolGroup);
        } else {
          result.push({
            role: 'assistant',
            content: '',
            tools: toolGroup.groupedTools[0],
            timestamp: toolGroup.timestamp
          });
        }
      }

      return result;
    }

    // 도구 그룹 펼치기/접기
    function toggleToolGroup(element) {
      const details = element.querySelector('.tool-group-details');
      const toggle = element.querySelector('.tool-group-toggle');

      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        toggle.textContent = '▲';
      } else {
        details.classList.add('hidden');
        toggle.textContent = '▼';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 클립보드 복사
    function copyToClipboard(text, message = '복사되었습니다') {
      navigator.clipboard.writeText(text).then(() => {
        showToast(message, 'success');
      }).catch(err => {
        showToast('복사 실패: ' + err.message, 'error');
      });
    }

    // ============ Widget System ============

    const WIDGET_TYPES = {
      'suggestions': {
        label: '스마트 서제스션', icon: '💡', defaultPos: { x: 0, y: 0, w: 4, h: 1 },
        render: () => `<div id="homeSuggestions" class="space-y-2"></div>`
      },
      'summary-cards': {
        label: '요약 카드', icon: '📊', defaultPos: { x: 0, y: 1, w: 4, h: 1 },
        render: () => `
          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <div onclick="showTab('jobs')" class="cursor-pointer bg-gradient-to-br from-blue-900/40 to-blue-800/20 border border-blue-800/30 rounded-xl p-5 hover:border-blue-600/50 hover:scale-[1.02] transition-all">
              <div class="flex items-center justify-between mb-2"><span class="text-sm text-gray-400">작업</span><span class="text-blue-400 text-lg">📦</span></div>
              <div id="homeJobsActive" class="text-3xl font-bold">-</div>
              <div id="homeJobsDesc" class="text-xs text-gray-500 mt-1">활성 작업</div>
            </div>
            <div onclick="navigateWithDate('jobs', 'history')" class="cursor-pointer bg-gradient-to-br from-green-900/40 to-green-800/20 border border-green-800/30 rounded-xl p-5 hover:border-green-600/50 hover:scale-[1.02] transition-all">
              <div class="flex items-center justify-between mb-2"><span id="homeRunsLabel" class="text-sm text-gray-400">오늘 실행</span><span class="text-green-400 text-lg">▶️</span></div>
              <div id="homeTodayRuns" class="text-3xl font-bold">-</div>
              <div id="homeTodayRate" class="text-xs text-gray-500 mt-1">성공률 -</div>
            </div>
            <div onclick="navigateWithDate('sessions')" class="cursor-pointer bg-gradient-to-br from-purple-900/40 to-purple-800/20 border border-purple-800/30 rounded-xl p-5 hover:border-purple-600/50 hover:scale-[1.02] transition-all">
              <div class="flex items-center justify-between mb-2"><span class="text-sm text-gray-400">Claude 세션</span><span class="text-purple-400 text-lg">🤖</span></div>
              <div id="homeSessionsCount" class="text-3xl font-bold">-</div>
              <div id="homeSessionsLabel" class="text-xs text-gray-500 mt-1">오늘</div>
            </div>
            <div onclick="navigateWithDate('notes')" class="cursor-pointer bg-gradient-to-br from-amber-900/40 to-amber-800/20 border border-amber-800/30 rounded-xl p-5 hover:border-amber-600/50 hover:scale-[1.02] transition-all">
              <div class="flex items-center justify-between mb-2"><span class="text-sm text-gray-400">메모 & 백로그</span><span class="text-amber-400 text-lg">📋</span></div>
              <div id="homeNotesCount" class="text-3xl font-bold">-</div>
              <div id="homeBacklogCount" class="text-xs text-gray-500 mt-1">미완료 백로그 -</div>
            </div>
          </div>`
      },
      'quick-actions': {
        label: '빠른 액션', icon: '⚡', defaultPos: { x: 0, y: 2, w: 4, h: 1 },
        render: () => `
          <div class="grid grid-cols-4 gap-3">
            <button onclick="openQuickInput()" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-xl text-sm font-medium transition-colors">📝 빠른 메모</button>
            <button onclick="openMorningStart()" class="px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-xl text-sm font-medium transition-all">☀️ 하루 시작</button>
            <button onclick="generateTodayFullReport()" class="px-4 py-3 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-400 hover:to-pink-400 rounded-xl text-sm font-medium transition-all">📊 오늘 보고서</button>
            <button onclick="generateWeeklyDigest()" class="px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-400 hover:to-purple-400 rounded-xl text-sm font-medium transition-all">📈 주간 분석</button>
          </div>`
      },
      'timeline': {
        label: '통합 타임라인', icon: '📅', defaultPos: { x: 0, y: 3, w: 4, h: 2 },
        render: () => `
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
              <button onclick="toggleTimelineCollapse()" class="flex items-center gap-1.5 group">
                <span id="timelineCollapseIcon" class="text-gray-500 text-xs transition-transform duration-200 inline-block">&#9660;</span>
                <h3 class="text-sm font-bold text-gray-300 group-hover:text-gray-100 transition-colors">오늘의 타임라인</h3>
              </button>
              <span id="homeTimelineCount" class="text-xs text-gray-500"></span>
            </div>
            <div class="flex items-center gap-1.5 flex-wrap" id="timelineFilters">
              <button onclick="toggleTimelineFilter('job')" data-filter="job" class="tl-filter-btn px-2 py-0.5 rounded-full text-xs border transition-colors border-green-700/50 text-green-400 bg-green-900/20">작업</button>
              <button onclick="toggleTimelineFilter('session')" data-filter="session" class="tl-filter-btn px-2 py-0.5 rounded-full text-xs border transition-colors border-purple-700/50 text-purple-400 bg-purple-900/20">세션</button>
              <button onclick="toggleTimelineFilter('memo')" data-filter="memo" class="tl-filter-btn px-2 py-0.5 rounded-full text-xs border transition-colors border-yellow-700/50 text-yellow-400 bg-yellow-900/20">메모</button>
              <button onclick="toggleTimelineFilter('github')" data-filter="github" class="tl-filter-btn px-2 py-0.5 rounded-full text-xs border transition-colors border-blue-700/50 text-blue-400 bg-blue-900/20">GitHub</button>
              <button onclick="toggleTimelineFilter('plan')" data-filter="plan" class="tl-filter-btn px-2 py-0.5 rounded-full text-xs border transition-colors border-orange-700/50 text-orange-400 bg-orange-900/20">플랜</button>
            </div>
          </div>
          <div id="timelineBody" style="transition: max-height 0.3s ease, opacity 0.2s ease">
            <div class="mb-3 px-1">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-gray-500">시간 범위</span>
                <span id="timeRangeLabel" class="text-xs text-gray-400 font-mono">00:00 ~ 24:00</span>
              </div>
              <div id="timeRangeSlider" class="relative h-8 select-none" style="touch-action:none">
                <div class="absolute top-3 left-0 right-0 h-1.5 bg-gray-700 rounded-full"></div>
                <div id="timeRangeActive" class="absolute top-3 h-1.5 bg-blue-500/60 rounded-full"></div>
                <div class="absolute top-6 left-0 right-0 flex justify-between px-0.5">
                  <span class="text-[9px] text-gray-600">0</span><span class="text-[9px] text-gray-600">6</span><span class="text-[9px] text-gray-600">12</span><span class="text-[9px] text-gray-600">18</span><span class="text-[9px] text-gray-600">24</span>
                </div>
                <div id="timeHandleLeft" class="absolute top-1.5 w-4 h-4 bg-blue-400 border-2 border-gray-900 rounded-full cursor-grab hover:bg-blue-300 hover:scale-110 transition-transform z-10" style="left:0%"></div>
                <div id="timeHandleRight" class="absolute top-1.5 w-4 h-4 bg-blue-400 border-2 border-gray-900 rounded-full cursor-grab hover:bg-blue-300 hover:scale-110 transition-transform z-10" style="left:100%"></div>
              </div>
            </div>
            <div id="homeTimeline" class="text-sm">
              <div class="text-gray-500 text-center py-6">로딩중...</div>
            </div>
          </div>`
      },
      'productivity': {
        label: '생산성 분석', icon: '📈', defaultPos: { x: 0, y: 5, w: 4, h: 2 },
        render: () => `
          <div class="flex items-center justify-between mb-3">
            <button onclick="toggleProductivityCollapse()" class="flex items-center gap-1.5 group">
              <span id="prodCollapseIcon" class="text-gray-500 text-xs transition-transform duration-200 inline-block">&#9660;</span>
              <h3 class="text-sm font-bold text-gray-300 group-hover:text-gray-100 transition-colors">생산성 분석</h3>
            </button>
            <div class="flex items-center gap-2">
              <button onclick="setProductivityPeriod(7)" id="prodPeriod7" class="prod-period-btn px-2 py-0.5 rounded text-xs border border-blue-600 text-blue-400 bg-blue-900/30">7일</button>
              <button onclick="setProductivityPeriod(14)" id="prodPeriod14" class="prod-period-btn px-2 py-0.5 rounded text-xs border border-gray-600 text-gray-400">14일</button>
              <button onclick="setProductivityPeriod(30)" id="prodPeriod30" class="prod-period-btn px-2 py-0.5 rounded text-xs border border-gray-600 text-gray-400">30일</button>
            </div>
          </div>
          <div id="productivityBody" style="transition: max-height 0.3s ease, opacity 0.2s ease">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
              <div class="bg-gray-900/50 rounded-lg p-3"><div class="text-xs text-gray-500">총 세션</div><div id="prodTotalSessions" class="text-2xl font-bold mt-0.5">-</div></div>
              <div class="bg-gray-900/50 rounded-lg p-3"><div class="text-xs text-gray-500">총 메모</div><div id="prodTotalMemos" class="text-2xl font-bold mt-0.5">-</div></div>
              <div class="bg-gray-900/50 rounded-lg p-3"><div class="text-xs text-gray-500">작업 실행</div><div id="prodTotalJobs" class="text-2xl font-bold mt-0.5">-</div></div>
              <div class="bg-gray-900/50 rounded-lg p-3"><div class="text-xs text-gray-500">일평균 메모</div><div id="prodAvgMemos" class="text-2xl font-bold mt-0.5">-</div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <div class="bg-gray-900/50 rounded-lg p-3">
                <h4 class="text-xs text-gray-400 mb-2">시간대별 활동</h4>
                <div id="hourlyHeatmap" class="grid gap-0.5" style="grid-template-columns: repeat(24, 1fr); height: 80px;"></div>
                <div class="flex justify-between mt-1 px-0.5"><span class="text-[9px] text-gray-600">0시</span><span class="text-[9px] text-gray-600">6시</span><span class="text-[9px] text-gray-600">12시</span><span class="text-[9px] text-gray-600">18시</span><span class="text-[9px] text-gray-600">24시</span></div>
              </div>
              <div class="bg-gray-900/50 rounded-lg p-3">
                <h4 class="text-xs text-gray-400 mb-2">프로젝트 분포</h4>
                <div style="position:relative; height:140px;"><canvas id="projectDistChart"></canvas></div>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="bg-gray-900/50 rounded-lg p-3">
                <h4 class="text-xs text-gray-400 mb-2">일별 트렌드</h4>
                <div style="position:relative; height:140px;"><canvas id="prodDailyTrendChart"></canvas></div>
              </div>
              <div class="bg-gray-900/50 rounded-lg p-3">
                <h4 class="text-xs text-gray-400 mb-2">기간 비교 (전반 vs 후반)</h4>
                <div style="position:relative; height:140px;"><canvas id="weekCompChart"></canvas></div>
              </div>
            </div>
          </div>`
      },
      'today-tasks': {
        label: '오늘의 할일', icon: '☑️', defaultPos: { x: 0, y: 7, w: 4, h: 1 },
        render: () => `
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <h3 class="text-sm font-bold text-gray-300">☑️ 오늘의 할일</h3>
              <span id="todayTasksProgress" class="text-xs text-gray-500"></span>
            </div>
            <button onclick="showTab('analysis'); setTimeout(()=>showAnalysisSubTab('morning'),50)" class="text-xs text-blue-400 hover:text-blue-300">하루 시작 →</button>
          </div>
          <div id="todayTasksList" class="space-y-1.5">
            <div class="text-gray-500 text-center py-4 text-sm">로딩중...</div>
          </div>`
      },
      'recent-runs': {
        label: '최근 실행', icon: '▶️', defaultPos: { x: 0, y: 8, w: 2, h: 2 },
        render: () => `
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-gray-300">▶️ 최근 실행</h3>
            <button onclick="showTab('jobs'); setTimeout(()=>showJobSubTab('history'),50)" class="text-xs text-blue-400 hover:text-blue-300">전체 보기 →</button>
          </div>
          <div id="homeRecentRuns" class="space-y-2 text-sm">
            <div class="text-gray-500 text-center py-4">로딩중...</div>
          </div>`
      },
      'recent-memos': {
        label: '최근 메모', icon: '📝', defaultPos: { x: 2, y: 8, w: 2, h: 2 },
        render: () => `
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-gray-300">📝 최근 메모</h3>
            <button onclick="showTab('notes')" class="text-xs text-blue-400 hover:text-blue-300">전체 보기 →</button>
          </div>
          <div id="homeRecentMemos" class="space-y-2 text-sm">
            <div class="text-gray-500 text-center py-4">로딩중...</div>
          </div>`
      }
    };

    const DEFAULT_WIDGET_LAYOUT = [
      { id: 'w1', type: 'suggestions', position: { x: 0, y: 0, w: 4, h: 1 } },
      { id: 'w2', type: 'summary-cards', position: { x: 0, y: 1, w: 4, h: 1 } },
      { id: 'w3', type: 'quick-actions', position: { x: 0, y: 2, w: 4, h: 1 } },
      { id: 'w8', type: 'today-tasks', position: { x: 0, y: 3, w: 4, h: 1 } },
      { id: 'w6', type: 'recent-runs', position: { x: 0, y: 4, w: 2, h: 2 } },
      { id: 'w7', type: 'recent-memos', position: { x: 2, y: 4, w: 2, h: 2 } },
      { id: 'w4', type: 'timeline', position: { x: 0, y: 6, w: 4, h: 2 } },
      { id: 'w5', type: 'productivity', position: { x: 0, y: 8, w: 4, h: 2 } }
    ];

    let currentWidgetLayout = null;
    let widgetEditMode = false;

    async function loadWidgetLayout() {
      try {
        const res = await fetch(`${API_BASE}/api/settings/widget-layout`);
        if (res.ok) {
          const data = await res.json();
          if (data.layout && Array.isArray(data.layout) && data.layout.length > 0) {
            return data.layout;
          }
        }
      } catch (e) {
        console.error('위젯 레이아웃 로드 실패:', e);
      }
      return [...DEFAULT_WIDGET_LAYOUT];
    }

    async function saveWidgetLayout(layout) {
      try {
        await fetch(`${API_BASE}/api/settings/widget-layout`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ layout })
        });
      } catch (e) {
        console.error('위젯 레이아웃 저장 실패:', e);
      }
    }

    function renderWidgetGrid(layout) {
      const grid = document.getElementById('widgetGrid');
      if (!grid) return;

      // Destroy existing Chart.js instances before clearing DOM
      if (typeof prodDailyTrendChart !== 'undefined' && prodDailyTrendChart) { prodDailyTrendChart.destroy(); prodDailyTrendChart = null; }
      if (typeof projectDistChart !== 'undefined' && projectDistChart) { projectDistChart.destroy(); projectDistChart = null; }
      if (typeof weekCompChart !== 'undefined' && weekCompChart) { weekCompChart.destroy(); weekCompChart = null; }

      grid.innerHTML = '';

      for (const widget of layout) {
        const wType = WIDGET_TYPES[widget.type];
        if (!wType) continue;

        const el = document.createElement('div');
        el.id = `widget-${widget.id}`;
        el.className = 'widget-container bg-gray-800/50 rounded-xl p-5 border border-gray-700/50';
        el.setAttribute('data-widget-id', widget.id);
        el.setAttribute('data-widget-type', widget.type);

        // No border/padding for suggestions (it's just a list)
        if (widget.type === 'suggestions') {
          el.className = 'widget-container';
          el.style.cssText = '';
        }
        // No container style for summary-cards and quick-actions (they have their own)
        if (widget.type === 'summary-cards' || widget.type === 'quick-actions') {
          el.className = 'widget-container';
        }

        // Apply grid positioning (desktop only, overridden by responsive CSS)
        el.style.gridColumn = `${widget.position.x + 1} / span ${widget.position.w}`;
        el.style.gridRow = `${widget.position.y + 1} / span ${widget.position.h}`;

        el.innerHTML = wType.render();
        grid.appendChild(el);
      }
    }

    async function initWidgetSystem() {
      currentWidgetLayout = await loadWidgetLayout();
      renderWidgetGrid(currentWidgetLayout);
    }

    // Drag & Drop
    let dragSrcWidget = null;

    function initWidgetDragDrop() {
      document.querySelectorAll('#widgetGrid .widget-container').forEach(el => {
        el.draggable = true;

        el.addEventListener('dragstart', e => {
          dragSrcWidget = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.getAttribute('data-widget-id'));
        });

        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          document.querySelectorAll('.widget-container.drag-over').forEach(d => d.classList.remove('drag-over'));
          dragSrcWidget = null;
        });

        el.addEventListener('dragover', e => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          if (el !== dragSrcWidget) el.classList.add('drag-over');
        });

        el.addEventListener('dragleave', () => {
          el.classList.remove('drag-over');
        });

        el.addEventListener('drop', e => {
          e.preventDefault();
          el.classList.remove('drag-over');
          if (!dragSrcWidget || dragSrcWidget === el) return;

          const srcId = dragSrcWidget.getAttribute('data-widget-id');
          const dstId = el.getAttribute('data-widget-id');
          const srcIdx = currentWidgetLayout.findIndex(w => w.id === srcId);
          const dstIdx = currentWidgetLayout.findIndex(w => w.id === dstId);

          if (srcIdx === -1 || dstIdx === -1) return;

          // Swap positions in layout
          const tmpPos = { ...currentWidgetLayout[srcIdx].position };
          currentWidgetLayout[srcIdx].position = { ...currentWidgetLayout[dstIdx].position };
          currentWidgetLayout[dstIdx].position = tmpPos;

          // Also swap array order for consistent rendering
          [currentWidgetLayout[srcIdx], currentWidgetLayout[dstIdx]] =
            [currentWidgetLayout[dstIdx], currentWidgetLayout[srcIdx]];

          // Re-render and re-init drag
          renderWidgetGrid(currentWidgetLayout);
          loadWidgetData();
          if (widgetEditMode) initWidgetDragDrop();
        });
      });
    }

    function toggleWidgetEditMode() {
      widgetEditMode = !widgetEditMode;
      const grid = document.getElementById('widgetGrid');
      const btn = document.getElementById('widgetEditBtn');
      const resetBtn = document.getElementById('widgetResetBtn');

      if (widgetEditMode) {
        grid.classList.add('edit-mode');
        btn.textContent = '완료';
        btn.classList.add('bg-blue-600', 'text-white');
        btn.classList.remove('bg-gray-800', 'text-gray-400');
        resetBtn.classList.remove('hidden');
        initWidgetDragDrop();
      } else {
        grid.classList.remove('edit-mode');
        btn.textContent = '편집';
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-800', 'text-gray-400');
        resetBtn.classList.add('hidden');
        // Disable dragging
        document.querySelectorAll('#widgetGrid .widget-container').forEach(el => el.draggable = false);
        // Save layout
        saveWidgetLayout(currentWidgetLayout);
        showToast('레이아웃 저장됨', 'success');
      }
    }

    async function resetWidgetLayout() {
      currentWidgetLayout = [...DEFAULT_WIDGET_LAYOUT];
      renderWidgetGrid(currentWidgetLayout);
      await loadWidgetData();
      if (widgetEditMode) initWidgetDragDrop();
      saveWidgetLayout(currentWidgetLayout);
      showToast('기본 레이아웃으로 초기화됨', 'success');
    }

    // ============ Today's Summary & Ask Modal Functions ============

    async function refreshTodaySummary() {
      try {
        const res = await fetch(`${API_BASE}/api/today/summary`);
        const data = await res.json();

        document.getElementById('todaySessionsCount').textContent = data.sessionsCount;
        document.getElementById('todayJobsCount').textContent = data.jobsCount;

        const successRate = data.jobsCount > 0
          ? Math.round((data.successCount / data.jobsCount) * 100) + '%'
          : '-';
        document.getElementById('todaySuccessRate').textContent = successRate;
      } catch (err) {
        console.error('오늘 요약 로드 실패:', err);
      }

      // 모닝 플랜 버튼 상태 업데이트
      checkMorningPlanExists();
    }

    let homeDate = getKSTDateString();

    function initHomeDate() {
      updateHomeDateUI();
    }

    function updateHomeDateUI() {
      const today = getKSTDateString();
      const d = new Date(homeDate + 'T00:00:00');
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      const isToday = homeDate === today;
      const label = document.getElementById('homeDateLabel');
      const input = document.getElementById('homeDateInput');
      const nextBtn = document.getElementById('homeDateNext');

      if (label) {
        const m = d.getMonth() + 1;
        const day = d.getDate();
        const wd = weekdays[d.getDay()];
        label.textContent = isToday ? `오늘 (${m}/${day} ${wd})` : `${m}/${day} (${wd})`;
        label.title = homeDate;
      }
      if (input) input.value = homeDate;
      if (nextBtn) {
        nextBtn.disabled = homeDate >= today;
        nextBtn.style.opacity = homeDate >= today ? '0.3' : '1';
      }
    }

    function setHomeDate(dateStr) {
      const today = getKSTDateString();
      if (dateStr > today) dateStr = today;
      homeDate = dateStr;
      updateHomeDateUI();
      loadHomeDashboard();
    }

    function shiftHomeDate(delta) {
      const d = new Date(homeDate + 'T00:00:00');
      d.setDate(d.getDate() + delta);
      setHomeDate(getKSTDateString(d));
    }

    function setHomeToday() {
      setHomeDate(getKSTDateString());
    }

    async function loadHomeDashboard() {
      // 1) Render widget grid (first time or re-render)
      if (!currentWidgetLayout) {
        await initWidgetSystem();
      }

      // 2) Load data into widgets
      await loadWidgetData();
    }

    async function loadWidgetData() {
      try {
        const dateParam = homeDate;
        const today = getKSTDateString();
        const isToday = dateParam === today;
        updateHomeDateUI();

        // 날짜에 따른 라벨 업데이트
        const runsLabel = document.getElementById('homeRunsLabel');
        const sessionsLabel = document.getElementById('homeSessionsLabel');
        if (runsLabel) runsLabel.textContent = isToday ? '오늘 실행' : `${dateParam.slice(5)} 실행`;
        if (sessionsLabel) sessionsLabel.textContent = isToday ? '오늘' : dateParam.slice(5);

        const [summaryRes, jobsRes, historyRes, memosRes, backlogsRes, obsidianRes] = await Promise.all([
          fetch(`${API_BASE}/api/today/summary?date=${dateParam}`).catch(() => null),
          fetch(`${API_BASE}/api/jobs`).catch(() => null),
          fetch(`${API_BASE}/api/history?limit=5&startDate=${dateParam}&endDate=${dateParam}`).catch(() => null),
          fetch(`${API_BASE}/api/quick-memos?date=${dateParam}`).catch(() => null),
          fetch(`${API_BASE}/api/backlogs`).catch(() => null),
          fetch(`${API_BASE}/api/obsidian/daily-memos?date=${dateParam}`).catch(() => null)
        ]);

        // 요약 카드
        if (summaryRes) {
          const summary = await summaryRes.json();
          const el = id => document.getElementById(id);
          if (el('homeSessionsCount')) el('homeSessionsCount').textContent = summary.sessionsCount || 0;
          if (el('homeTodayRuns')) el('homeTodayRuns').textContent = summary.jobsCount || 0;
          const rate = summary.jobsCount > 0
            ? Math.round((summary.successCount / summary.jobsCount) * 100) + '%'
            : '-';
          if (el('homeTodayRate')) el('homeTodayRate').textContent = `성공률 ${rate}`;
        }

        // 활성 작업 수
        if (jobsRes) {
          const jobsData = await jobsRes.json();
          const jobs = jobsData.jobs || jobsData || [];
          const enabledCount = jobs.filter(j => j.enabled !== false).length;
          const el = id => document.getElementById(id);
          if (el('homeJobsActive')) el('homeJobsActive').textContent = enabledCount;
          if (el('homeJobsDesc')) el('homeJobsDesc').textContent = `${jobs.length}개 중 ${enabledCount}개 활성`;
        }

        // 메모 + 백로그 수
        if (memosRes || backlogsRes) {
          const memos = memosRes ? await memosRes.json() : { memos: [] };
          const backlogs = backlogsRes ? await backlogsRes.json() : { backlogs: [] };
          const obsidian = obsidianRes ? await obsidianRes.json() : { memos: [] };
          const totalMemos = (memos.memos || []).length + (obsidian.memos || []).filter(m => m.content?.trim()).length;
          const openBacklogs = (backlogs.backlogs || []).filter(b => !b.done).length;
          const el = id => document.getElementById(id);
          if (el('homeNotesCount')) el('homeNotesCount').textContent = totalMemos;
          if (el('homeBacklogCount')) el('homeBacklogCount').textContent = `미완료 백로그 ${openBacklogs}개`;

          // 최근 메모 렌더링
          const allMemos = [
            ...(memos.memos || []).map(m => ({ ...m, _source: 'dashboard' })),
            ...(obsidian.memos || []).filter(m => m.content?.trim()).map(m => ({ ...m, _source: 'obsidian' }))
          ].slice(0, 5);
          const memosContainer = document.getElementById('homeRecentMemos');
          if (memosContainer) {
            if (allMemos.length === 0) {
              memosContainer.innerHTML = '<div class="text-gray-500 text-center py-4">오늘 메모가 없습니다</div>';
            } else {
              memosContainer.innerHTML = allMemos.map(m => {
                const content = (m.content || m.text || '').substring(0, 80);
                const timeStr = (m.timestamp || m.createdAt)
                  ? new Date(m.timestamp || m.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                  : (m.time || '');
                const icon = m._source === 'obsidian' ? '📓' : '📝';
                return `<div class="flex items-center gap-2 p-2 rounded-lg bg-gray-800/50 hover:bg-gray-700/50 transition-colors">
                  <span class="flex-shrink-0">${icon}</span>
                  <span class="flex-1 truncate text-gray-300">${escapeHtml(content)}</span>
                  <span class="text-xs text-gray-600 flex-shrink-0">${timeStr}</span>
                </div>`;
              }).join('');
            }
          }
        }

        // 최근 실행 이력
        if (historyRes) {
          const historyData = await historyRes.json();
          const runs = historyData.items || historyData.history || [];
          const container = document.getElementById('homeRecentRuns');
          if (container) {
            if (runs.length === 0) {
              container.innerHTML = '<div class="text-gray-500 text-center py-4">실행 이력이 없습니다</div>';
            } else {
              container.innerHTML = runs.slice(0, 5).map(r => {
                const statusIcon = r.status === 'success' ? '✅' : r.status === 'failed' ? '❌' : '⏳';
                const statusColor = r.status === 'success' ? 'text-green-400' : r.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
                const timeStr = r.startedAt
                  ? new Date(r.startedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                  : '';
                const duration = r.duration ? `${(r.duration / 1000).toFixed(1)}s` : '';
                return `<div class="flex items-center gap-2 p-2 rounded-lg bg-gray-800/50 hover:bg-gray-700/50 transition-colors">
                  <span class="flex-shrink-0">${statusIcon}</span>
                  <span class="flex-1 truncate ${statusColor}">${escapeHtml(r.jobName || r.jobId || '')}</span>
                  <span class="text-xs text-gray-600 flex-shrink-0">${duration}</span>
                  <span class="text-xs text-gray-600 flex-shrink-0">${timeStr}</span>
                </div>`;
              }).join('');
            }
          }
        }
      } catch (err) {
        console.error('홈 대시보드 로드 실패:', err);
      }

      // 타임라인 로드
      loadTimeline();
      // 서제스션 & 생산성 분석 로드
      loadSuggestions();
      loadProductivity();
      // 오늘의 할일
      loadTodayTasks();
    }

    // ============ 오늘의 할일 체크리스트 ============

    let todayPlanId = null;

    async function loadTodayTasks() {
      const container = document.getElementById('todayTasksList');
      const progress = document.getElementById('todayTasksProgress');
      if (!container) return;

      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${homeDate}`);
        const data = await res.json();
        if (!data.plan || !data.plan.markdown) {
          todayPlanId = null;
          container.innerHTML = `
            <div class="text-center py-4">
              <span class="text-gray-500 text-sm">오늘의 플랜이 없습니다</span>
              <button onclick="openMorningStart()" class="ml-2 text-xs text-blue-400 hover:text-blue-300">☀️ 하루 시작하기</button>
            </div>`;
          if (progress) progress.textContent = '';
          return;
        }

        todayPlanId = data.plan.id;
        const lines = data.plan.markdown.split('\n');
        const tasks = [];
        for (let i = 0; i < lines.length; i++) {
          const unchecked = lines[i].match(/^(\s*)- \[ \] (.+)/);
          const checked = lines[i].match(/^(\s*)- \[x\] (.+)/);
          if (unchecked) tasks.push({ text: unchecked[2].trim(), done: false });
          else if (checked) tasks.push({ text: checked[2].trim(), done: true });
        }

        if (tasks.length === 0) {
          container.innerHTML = '<div class="text-gray-500 text-center py-4 text-sm">체크리스트 항목이 없습니다</div>';
          if (progress) progress.textContent = '';
          return;
        }

        const doneCount = tasks.filter(t => t.done).length;
        if (progress) progress.textContent = `${doneCount}/${tasks.length}`;

        container.innerHTML = tasks.map((t, i) => `
          <label class="flex items-center gap-3 px-3 py-2 rounded-lg cursor-pointer transition-colors ${t.done ? 'bg-green-900/10 hover:bg-green-900/20' : 'bg-gray-800/50 hover:bg-gray-700/50'}" onclick="toggleTodayTask(${i}, event)">
            <input type="checkbox" ${t.done ? 'checked' : ''} class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-green-500 focus:ring-green-500 focus:ring-offset-0 cursor-pointer" onclick="toggleTodayTask(${i}, event)">
            <span class="flex-1 text-sm ${t.done ? 'line-through text-gray-500' : 'text-gray-300'}">${escapeHtml(t.text)}</span>
          </label>
        `).join('');
      } catch (err) {
        console.error('오늘의 할일 로드 실패:', err);
        container.innerHTML = '<div class="text-gray-500 text-center py-4 text-sm">로드 실패</div>';
      }
    }

    async function toggleTodayTask(index, event) {
      event.preventDefault();
      event.stopPropagation();
      if (!todayPlanId) return;
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan/${todayPlanId}/toggle`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ index })
        });
        if (res.ok) {
          loadTodayTasks();
        } else {
          showToast('업데이트 실패', 'error');
        }
      } catch (err) {
        showToast('업데이트 실패: ' + err.message, 'error');
      }
    }

    // ============ 스마트 서제스션 ============

    function getDismissedSuggestions() {
      try {
        const raw = localStorage.getItem('dismissedSuggestions');
        if (!raw) return {};
        const data = JSON.parse(raw);
        const now = Date.now();
        // 24시간 TTL
        for (const [k, v] of Object.entries(data)) {
          if (now - v > 24 * 60 * 60 * 1000) delete data[k];
        }
        return data;
      } catch { return {}; }
    }

    function dismissSuggestion(id) {
      const data = getDismissedSuggestions();
      data[id] = Date.now();
      localStorage.setItem('dismissedSuggestions', JSON.stringify(data));
      const el = document.getElementById(`suggestion-${id}`);
      if (el) {
        el.style.transition = 'opacity 0.3s, transform 0.3s';
        el.style.opacity = '0';
        el.style.transform = 'translateX(20px)';
        setTimeout(() => el.remove(), 300);
      }
    }

    async function loadSuggestions() {
      const today = getKSTDateString();
      if (homeDate !== today) {
        document.getElementById('homeSuggestions').innerHTML = '';
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/api/insights/suggestions`);
        const data = await res.json();
        const dismissed = getDismissedSuggestions();
        const suggestions = (data.suggestions || []).filter(s => !dismissed[s.id]);

        const container = document.getElementById('homeSuggestions');
        if (suggestions.length === 0) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = suggestions.map(s => {
          const actionHandler = s.action
            ? (s.action.type === 'showTab' ? `showTab('${s.action.tab}')` : `${s.action.type}()`)
            : '';
          const clickAttr = actionHandler ? `onclick="${actionHandler}"` : '';
          const cursorClass = actionHandler ? 'cursor-pointer' : '';
          const borderColor = s.type === 'achievement' ? 'border-green-700/50' : s.type === 'reminder' && s.priority === 'high' ? 'border-red-700/50' : 'border-gray-700/50';
          return `<div id="suggestion-${s.id}" ${clickAttr}
            class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/60 border ${borderColor} hover:bg-gray-800 transition-colors ${cursorClass}">
            <span class="text-lg flex-shrink-0">${s.icon}</span>
            <span class="text-sm text-gray-300 flex-1">${s.message}</span>
            <button onclick="event.stopPropagation(); dismissSuggestion('${s.id}')"
              class="ml-auto text-gray-600 hover:text-gray-400 text-xs flex-shrink-0 px-1">✕</button>
          </div>`;
        }).join('');
      } catch (err) {
        console.error('서제스션 로드 실패:', err);
      }
    }

    // ============ 생산성 분석 ============

    let productivityPeriod = 7;
    let productivityCollapsed = false;
    let prodDailyTrendChart = null;
    let projectDistChart = null;
    let weekCompChart = null;

    function setProductivityPeriod(days) {
      productivityPeriod = days;
      document.querySelectorAll('.prod-period-btn').forEach(btn => {
        btn.classList.remove('border-blue-600', 'text-blue-400', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'text-gray-400');
      });
      const active = document.getElementById(`prodPeriod${days}`);
      if (active) {
        active.classList.remove('border-gray-600', 'text-gray-400');
        active.classList.add('border-blue-600', 'text-blue-400', 'bg-blue-900/30');
      }
      loadProductivity();
    }

    function toggleProductivityCollapse() {
      productivityCollapsed = !productivityCollapsed;
      const body = document.getElementById('productivityBody');
      const icon = document.getElementById('prodCollapseIcon');
      if (productivityCollapsed) {
        body.style.maxHeight = '0';
        body.style.opacity = '0';
        body.style.overflow = 'hidden';
        icon.style.transform = 'rotate(-90deg)';
      } else {
        body.style.maxHeight = '';
        body.style.opacity = '1';
        body.style.overflow = '';
        icon.style.transform = '';
      }
    }

    async function loadProductivity() {
      try {
        const res = await fetch(`${API_BASE}/api/insights/productivity?days=${productivityPeriod}`);
        const data = await res.json();

        // 요약 카드
        document.getElementById('prodTotalSessions').textContent = data.overview.totalSessions;
        document.getElementById('prodTotalMemos').textContent = data.overview.totalMemos;
        document.getElementById('prodTotalJobs').textContent = data.overview.totalJobRuns;
        document.getElementById('prodAvgMemos').textContent = data.overview.avgDailyMemos;

        // 차트 렌더링
        renderHourlyHeatmap(data.hourlyActivity);
        renderProjectDistribution(data.topProjects);
        renderProdDailyTrend(data.dailyTrend);
        renderWeekComparison(data.weekComparison);
      } catch (err) {
        console.error('생산성 분석 로드 실패:', err);
      }
    }

    function renderHourlyHeatmap(hourly) {
      const container = document.getElementById('hourlyHeatmap');
      const maxVal = Math.max(1, ...hourly.map(h => h.sessions + h.memos + h.jobs));

      container.innerHTML = hourly.map(h => {
        const total = h.sessions + h.memos + h.jobs;
        const intensity = total / maxVal;
        const bg = total === 0
          ? 'bg-gray-800'
          : intensity < 0.25 ? 'bg-blue-900/40' : intensity < 0.5 ? 'bg-blue-700/50' : intensity < 0.75 ? 'bg-blue-500/60' : 'bg-blue-400/70';
        const title = `${h.hour}시: 세션 ${h.sessions}, 메모 ${h.memos}, 작업 ${h.jobs}`;
        return `<div class="${bg} rounded-sm flex flex-col justify-end items-center" title="${title}" style="min-height: 100%">
          ${total > 0 ? `<span class="text-[9px] text-gray-300">${total}</span>` : ''}
        </div>`;
      }).join('');
    }

    function renderProjectDistribution(projects) {
      const ctx = document.getElementById('projectDistChart')?.getContext('2d');
      if (!ctx) return;
      if (projectDistChart) projectDistChart.destroy();

      if (!projects || projects.length === 0) {
        projectDistChart = null;
        return;
      }

      const colors = ['#6366f1', '#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe'];
      projectDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: projects.map(p => p.project),
          datasets: [{
            data: projects.map(p => p.sessions),
            backgroundColor: colors.slice(0, projects.length),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 12 } }
          }
        }
      });
    }

    function renderProdDailyTrend(trend) {
      const ctx = document.getElementById('prodDailyTrendChart')?.getContext('2d');
      if (!ctx) return;
      if (prodDailyTrendChart) prodDailyTrendChart.destroy();

      prodDailyTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trend.map(d => d.date.slice(5)), // MM-DD
          datasets: [
            { label: '세션', data: trend.map(d => d.sessions), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', tension: 0.3, fill: true },
            { label: '메모', data: trend.map(d => d.memos), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.3, fill: true },
            { label: '작업', data: trend.map(d => d.jobs), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.3, fill: true }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { color: 'rgba(55,65,81,0.3)' } },
            y: { beginAtZero: true, ticks: { color: '#6b7280', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(55,65,81,0.3)' } }
          },
          plugins: { legend: { labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 12 } } }
        }
      });
    }

    function renderWeekComparison(comp) {
      const ctx = document.getElementById('weekCompChart')?.getContext('2d');
      if (!ctx) return;
      if (weekCompChart) weekCompChart.destroy();

      weekCompChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['세션', '메모', '작업'],
          datasets: [
            { label: '전반', data: [comp.firstHalf.sessions, comp.firstHalf.memos, comp.firstHalf.jobs], backgroundColor: 'rgba(99,102,241,0.6)' },
            { label: '후반', data: [comp.secondHalf.sessions, comp.secondHalf.memos, comp.secondHalf.jobs], backgroundColor: 'rgba(139,92,246,0.6)' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { display: false } },
            y: { beginAtZero: true, ticks: { color: '#6b7280', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(55,65,81,0.3)' } }
          },
          plugins: { legend: { labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 12 } } }
        }
      });
    }

    // ============ 주간 다이제스트 ============

    async function generateWeeklyDigest() {
      // 현재 주 weekStart 계산
      const today = getKSTDateString();
      const d = new Date(today + 'T00:00:00');
      const day = d.getDay();
      const diff = day === 0 ? 6 : day - 1;
      d.setDate(d.getDate() - diff);
      const weekStart = getKSTDateString(d);

      // 캐시 확인
      try {
        const cacheRes = await fetch(`${API_BASE}/api/insights/weekly-digest?week=${weekStart}`);
        const cacheData = await cacheRes.json();

        if (cacheData.digest) {
          const useCache = await showCachedReportPrompt({
            type: 'weekly-digest',
            date: `${cacheData.digest.weekStart} ~ ${cacheData.digest.weekEnd}`,
            createdAt: cacheData.digest.createdAt
          });

          if (useCache) {
            showWeeklyDigestModal({
              markdown: cacheData.digest.markdown,
              weekStart: cacheData.digest.weekStart,
              weekEnd: cacheData.digest.weekEnd,
              stats: cacheData.digest.stats
            });
            return;
          }
        }
      } catch (e) {
        console.error('주간 다이제스트 캐시 확인 실패:', e);
      }

      // 새로 생성
      try {
        const res = await fetch(`${API_BASE}/api/insights/weekly-digest`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientId })
        });
        const data = await res.json();
        if (data.taskId) {
          showToast('주간 다이제스트 생성 시작... Claude가 분석 중입니다', 'info');
        }
      } catch (err) {
        showToast('주간 다이제스트 생성 실패: ' + err.message, 'error');
      }
    }

    function showWeeklyDigestModal(result) {
      const modal = document.getElementById('sessionDetailModal');
      if (!modal) return;

      modal.style.display = 'flex';

      const md = result.markdown || '(내용 없음)';
      const stats = result.stats || {};
      const weekRange = `${result.weekStart || '?'} ~ ${result.weekEnd || '?'}`;

      const contentDiv = document.getElementById('sessionDetailContent');
      contentDiv.innerHTML = `
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-bold text-gray-200">📊 주간 다이제스트 (${weekRange})</h2>
          <div class="flex gap-2">
            <button onclick="copyDigest()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs text-gray-300">📋 복사</button>
            <button onclick="document.getElementById('sessionDetailModal').style.display='none'" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded-lg text-xs text-gray-300">닫기</button>
          </div>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-4">
          <div class="bg-gray-900/50 rounded-lg p-2 text-center">
            <div class="text-xs text-gray-500">세션</div>
            <div class="text-lg font-bold text-purple-400">${stats.sessions || 0}</div>
          </div>
          <div class="bg-gray-900/50 rounded-lg p-2 text-center">
            <div class="text-xs text-gray-500">작업</div>
            <div class="text-lg font-bold text-green-400">${stats.jobRuns || 0}</div>
          </div>
          <div class="bg-gray-900/50 rounded-lg p-2 text-center">
            <div class="text-xs text-gray-500">메모</div>
            <div class="text-lg font-bold text-yellow-400">${stats.memos || 0}</div>
          </div>
          <div class="bg-gray-900/50 rounded-lg p-2 text-center">
            <div class="text-xs text-gray-500">성공률</div>
            <div class="text-lg font-bold text-blue-400">${stats.successRate || 0}%</div>
          </div>
        </div>
        <div class="markdown-content text-sm text-gray-300">
          ${typeof marked !== 'undefined' ? marked.parse(md) : md.replace(/\n/g, '<br>')}
        </div>
      `;

      // Store for copy
      modal._digestMarkdown = md;
    }

    function copyDigest() {
      const modal = document.getElementById('sessionDetailModal');
      const md = modal?._digestMarkdown || '';
      navigator.clipboard.writeText(md).then(() => showToast('클립보드에 복사됨', 'success'));
    }

    // ============ 분석 탭 ============

    let currentAnalysisSubTab = 'overview';
    let analysisMorningDate = getKSTDateString();
    let analysisProdPeriod = 7;
    let aProjectDistChart = null;
    let aProdDailyTrendChart = null;
    let aWeekCompChart = null;
    let selectedMorningData = null;
    let selectedReportData = null;
    let selectedWeeklyData = null;

    function showAnalysisSubTab(sub) {
      currentAnalysisSubTab = sub;
      document.querySelectorAll('.analysis-sub-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-700', 'text-gray-400');
      });
      const activeBtn = document.getElementById(`analysisSub-${sub}`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-gray-700', 'text-gray-400');
        activeBtn.classList.add('bg-blue-600', 'text-white');
      }

      ['overview', 'morning', 'report', 'weekly'].forEach(s => {
        const panel = document.getElementById(`analysisSubPanel-${s}`);
        if (panel) panel.classList.toggle('hidden', s !== sub);
      });

      if (sub === 'overview') loadAnalysisOverview();
      if (sub === 'morning') loadAnalysisMorning();
      if (sub === 'report') loadAnalysisReport();
      if (sub === 'weekly') loadAnalysisWeekly();
    }

    // --- 종합 ---
    async function loadAnalysisOverview() {
      // 서제스션
      try {
        const res = await fetch(`${API_BASE}/api/insights/suggestions`);
        const data = await res.json();
        const dismissed = getDismissedSuggestions();
        const suggestions = (data.suggestions || []).filter(s => !dismissed[s.id]);
        const container = document.getElementById('analysisSuggestions');
        if (suggestions.length === 0) { container.innerHTML = ''; }
        else {
          container.innerHTML = suggestions.map(s => {
            const actionHandler = s.action
              ? (s.action.type === 'showTab' ? `showTab('${s.action.tab}')` : `${s.action.type}()`)
              : '';
            const clickAttr = actionHandler ? `onclick="${actionHandler}"` : '';
            const cursorClass = actionHandler ? 'cursor-pointer' : '';
            const borderColor = s.type === 'achievement' ? 'border-green-700/50' : s.type === 'reminder' && s.priority === 'high' ? 'border-red-700/50' : 'border-gray-700/50';
            return `<div id="a-suggestion-${s.id}" ${clickAttr}
              class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/60 border ${borderColor} hover:bg-gray-800 transition-colors ${cursorClass}">
              <span class="text-lg flex-shrink-0">${s.icon}</span>
              <span class="text-sm text-gray-300 flex-1">${s.message}</span>
              <button onclick="event.stopPropagation(); dismissSuggestion('${s.id}')"
                class="ml-auto text-gray-600 hover:text-gray-400 text-xs flex-shrink-0 px-1">✕</button>
            </div>`;
          }).join('');
        }
      } catch (err) { console.error('분석탭 서제스션 로드 실패:', err); }

      // 생산성
      loadAnalysisProductivity();
    }

    function setAnalysisProdPeriod(days) {
      analysisProdPeriod = days;
      document.querySelectorAll('.a-prod-period-btn').forEach(btn => {
        btn.classList.remove('border-blue-600', 'text-blue-400', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'text-gray-400');
      });
      const active = document.getElementById(`aProdPeriod${days}`);
      if (active) {
        active.classList.remove('border-gray-600', 'text-gray-400');
        active.classList.add('border-blue-600', 'text-blue-400', 'bg-blue-900/30');
      }
      loadAnalysisProductivity();
    }

    async function loadAnalysisProductivity() {
      try {
        const res = await fetch(`${API_BASE}/api/insights/productivity?days=${analysisProdPeriod}`);
        const data = await res.json();

        document.getElementById('aProdTotalSessions').textContent = data.overview.totalSessions;
        document.getElementById('aProdTotalMemos').textContent = data.overview.totalMemos;
        document.getElementById('aProdTotalJobs').textContent = data.overview.totalJobRuns;
        document.getElementById('aProdAvgMemos').textContent = data.overview.avgDailyMemos;

        renderAnalysisHourlyHeatmap(data.hourlyActivity);
        renderAnalysisProjectDist(data.topProjects);
        renderAnalysisDailyTrend(data.dailyTrend);
        renderAnalysisWeekComp(data.weekComparison);
      } catch (err) { console.error('분석탭 생산성 로드 실패:', err); }
    }

    function renderAnalysisHourlyHeatmap(hourly) {
      const container = document.getElementById('aHourlyHeatmap');
      const maxVal = Math.max(1, ...hourly.map(h => h.sessions + h.memos + h.jobs));
      container.innerHTML = hourly.map(h => {
        const total = h.sessions + h.memos + h.jobs;
        const intensity = total / maxVal;
        const bg = total === 0 ? 'bg-gray-800'
          : intensity < 0.25 ? 'bg-blue-900/40' : intensity < 0.5 ? 'bg-blue-700/50' : intensity < 0.75 ? 'bg-blue-500/60' : 'bg-blue-400/70';
        const title = `${h.hour}시: 세션 ${h.sessions}, 메모 ${h.memos}, 작업 ${h.jobs}`;
        return `<div class="${bg} rounded-sm flex flex-col justify-end items-center" title="${title}" style="min-height: 100%">
          ${total > 0 ? `<span class="text-[9px] text-gray-300">${total}</span>` : ''}
        </div>`;
      }).join('');
    }

    function renderAnalysisProjectDist(projects) {
      const ctx = document.getElementById('aProjectDistChart')?.getContext('2d');
      if (!ctx) return;
      if (aProjectDistChart) aProjectDistChart.destroy();
      if (!projects || projects.length === 0) { aProjectDistChart = null; return; }
      const colors = ['#6366f1', '#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe'];
      aProjectDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: projects.map(p => p.project), datasets: [{ data: projects.map(p => p.sessions), backgroundColor: colors.slice(0, projects.length), borderWidth: 0 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 12 } } } }
      });
    }

    function renderAnalysisDailyTrend(trend) {
      const ctx = document.getElementById('aProdDailyTrendChart')?.getContext('2d');
      if (!ctx) return;
      if (aProdDailyTrendChart) aProdDailyTrendChart.destroy();
      aProdDailyTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trend.map(d => d.date.slice(5)),
          datasets: [
            { label: '세션', data: trend.map(d => d.sessions), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', tension: 0.3, fill: true },
            { label: '메모', data: trend.map(d => d.memos), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.3, fill: true },
            { label: '작업', data: trend.map(d => d.jobs), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.3, fill: true }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
          scales: {
            x: { ticks: { color: '#6b7280', font: { size: 9 } }, grid: { color: 'rgba(55,65,81,0.3)' } },
            y: { beginAtZero: true, ticks: { color: '#6b7280', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(55,65,81,0.3)' } }
          },
          plugins: { legend: { labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 12 } } }
        }
      });
    }

    function renderAnalysisWeekComp(comp) {
      const ctx = document.getElementById('aWeekCompChart')?.getContext('2d');
      if (!ctx) return;
      if (aWeekCompChart) aWeekCompChart.destroy();
      aWeekCompChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['세션', '메모', '작업'],
          datasets: [
            { label: '전반', data: [comp.firstHalf.sessions, comp.firstHalf.memos, comp.firstHalf.jobs], backgroundColor: 'rgba(99,102,241,0.6)' },
            { label: '후반', data: [comp.secondHalf.sessions, comp.secondHalf.memos, comp.secondHalf.jobs], backgroundColor: 'rgba(139,92,246,0.6)' }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { display: false } },
            y: { beginAtZero: true, ticks: { color: '#6b7280', font: { size: 9 }, stepSize: 1 }, grid: { color: 'rgba(55,65,81,0.3)' } }
          },
          plugins: { legend: { labels: { color: '#9ca3af', font: { size: 10 }, boxWidth: 12 } } }
        }
      });
    }

    // --- 하루 시작 ---
    function formatDateLabel(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const days = ['일', '월', '화', '수', '목', '금', '토'];
      return `${d.getMonth()+1}/${d.getDate()} (${days[d.getDay()]})`;
    }

    function shiftAnalysisMorningDate(delta) {
      const d = new Date(analysisMorningDate + 'T00:00:00');
      d.setDate(d.getDate() + delta);
      analysisMorningDate = getKSTDateString(d);
      loadMorningPlanDetail(analysisMorningDate);
    }

    function resetAnalysisMorningDate() {
      analysisMorningDate = getKSTDateString();
      loadMorningPlanDetail(analysisMorningDate);
    }

    async function loadAnalysisMorning() {
      // 목록
      try {
        const res = await fetch(`${API_BASE}/api/morning-plans?limit=50`);
        const data = await res.json();
        const plans = data.plans || [];
        const listEl = document.getElementById('morningPlanList');
        if (plans.length === 0) {
          listEl.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">기록 없음</div>';
        } else {
          listEl.innerHTML = plans.map(p => `
            <button onclick="selectMorningPlan('${p.date}')"
              class="morning-plan-item w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-gray-700/50 transition-colors ${p.date === analysisMorningDate ? 'bg-blue-900/30 text-blue-400 border border-blue-700/50' : 'text-gray-400'}">
              ${formatDateLabel(p.date)} <span class="text-green-500 text-xs">●</span>
            </button>
          `).join('');
        }
      } catch (err) { console.error('모닝 플랜 목록 로드 실패:', err); }

      // 상세
      loadMorningPlanDetail(analysisMorningDate);
    }

    function selectMorningPlan(date) {
      analysisMorningDate = date;
      // 하이라이트 업데이트
      document.querySelectorAll('.morning-plan-item').forEach(btn => {
        const isActive = btn.getAttribute('onclick').includes(`'${date}'`);
        btn.classList.toggle('bg-blue-900/30', isActive);
        btn.classList.toggle('text-blue-400', isActive);
        btn.classList.toggle('border', isActive);
        btn.classList.toggle('border-blue-700/50', isActive);
        btn.classList.toggle('text-gray-400', !isActive);
      });
      loadMorningPlanDetail(date);
    }

    async function loadMorningPlanDetail(date) {
      document.getElementById('analysisMorningDateLabel').textContent = formatDateLabel(date);
      const detailEl = document.getElementById('morningPlanDetail');
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${date}`);
        const data = await res.json();
        if (data.plan && data.plan.markdown) {
          selectedMorningData = { date, markdown: data.plan.markdown };
          const html = typeof marked !== 'undefined' ? marked.parse(data.plan.markdown) : data.plan.markdown.replace(/\n/g, '<br>');
          detailEl.innerHTML = `
            <div class="markdown-content">${html}</div>
            <div class="mt-4 flex gap-2">
              <button onclick="openMorningStart('${date}')" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">✏️ 수정</button>
            </div>
          `;
          document.getElementById('morningActions').classList.remove('hidden');
        } else {
          selectedMorningData = null;
          detailEl.innerHTML = `
            <div class="text-center py-16">
              <div class="text-4xl mb-3">☀️</div>
              <div class="text-gray-500 mb-4">${formatDateLabel(date)}의 플랜이 없습니다</div>
              <button onclick="openMorningStart('${date}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium">☀️ 하루 시작하기</button>
            </div>
          `;
          document.getElementById('morningActions').classList.add('hidden');
        }
      } catch (err) {
        detailEl.innerHTML = '<div class="text-center text-red-400 py-8">로드 실패</div>';
        document.getElementById('morningActions').classList.add('hidden');
      }
    }

    function copyMorningToClipboard() {
      if (selectedMorningData?.markdown) {
        navigator.clipboard.writeText(selectedMorningData.markdown).then(() => showToast('클립보드에 복사됨', 'success'));
      }
    }

    function downloadMorningPlan() {
      if (!selectedMorningData?.markdown) return;
      const blob = new Blob([selectedMorningData.markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `morning-plan-${selectedMorningData.date}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function exportMorningToObsidian() {
      if (!selectedMorningData?.markdown) return;
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: selectedMorningData.date, markdown: selectedMorningData.markdown })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`옵시디언에 저장됨: ${data.relativePath}`, 'success');
        } else {
          showToast(data.error || '옵시디언 내보내기 실패', 'error');
        }
      } catch (err) {
        showToast('옵시디언 내보내기 실패: ' + err.message, 'error');
      }
    }

    // --- 오늘 보고서 ---
    async function loadAnalysisReport() {
      try {
        const res = await fetch(`${API_BASE}/api/reports/daily?limit=100`);
        const data = await res.json();
        const reports = data.reports || [];
        const listEl = document.getElementById('reportList');
        if (reports.length === 0) {
          listEl.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">기록 없음</div>';
        } else {
          const typeIcons = { 'day-wrapup': '🌙', 'daily-report': '📊', 'full-daily-report': '📊' };
          const typeLabels = { 'day-wrapup': '하루마무리', 'daily-report': '일일보고서', 'full-daily-report': '종합보고서' };
          listEl.innerHTML = reports.map(r => `
            <button onclick="selectReport('${r.date}', '${r.type}')" data-date="${r.date}" data-type="${r.type}"
              class="report-list-item w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-gray-700/50 transition-colors text-gray-400">
              <div>${formatDateLabel(r.date)}</div>
              <div class="text-xs text-gray-500">${typeIcons[r.type] || '📝'} ${typeLabels[r.type] || r.type}</div>
            </button>
          `).join('');
        }
      } catch (err) { console.error('보고서 목록 로드 실패:', err); }

      // 초기 상태
      document.getElementById('reportDetail').innerHTML = `
        <div class="text-center py-16">
          <div class="text-4xl mb-3">📊</div>
          <div class="text-gray-500 mb-4">보고서를 선택하거나 새로 생성하세요</div>
          <button onclick="generateTodayFullReport()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium">✨ 오늘 보고서 생성</button>
        </div>`;
      document.getElementById('reportActions').classList.add('hidden');
    }

    async function selectReport(date, type) {
      // 하이라이트
      document.querySelectorAll('.report-list-item').forEach(btn => {
        const isActive = btn.dataset.date === date && btn.dataset.type === type;
        btn.classList.toggle('bg-blue-900/30', isActive);
        btn.classList.toggle('text-blue-400', isActive);
        btn.classList.toggle('border', isActive);
        btn.classList.toggle('border-blue-700/50', isActive);
        btn.classList.toggle('text-gray-400', !isActive);
      });

      const detailEl = document.getElementById('reportDetail');
      try {
        const res = await fetch(`${API_BASE}/api/reports/daily?date=${date}&type=${type}`);
        const data = await res.json();
        const reportMd = data.report?.markdown || data.report?.report;
        if (data.report && reportMd) {
          selectedReportData = { ...data.report, markdown: reportMd };
          const html = typeof marked !== 'undefined' ? marked.parse(reportMd) : reportMd.replace(/\n/g, '<br>');
          const typeIcons = { 'day-wrapup': '🌙', 'daily-report': '📊', 'full-daily-report': '📊' };
          const typeLabels = { 'day-wrapup': '하루마무리', 'daily-report': '일일보고서', 'full-daily-report': '종합보고서' };
          detailEl.innerHTML = `
            <div class="flex items-center gap-2 mb-4">
              <span class="px-2 py-0.5 bg-gray-700 rounded text-xs">${typeIcons[type] || '📝'} ${typeLabels[type] || type}</span>
              <span class="text-xs text-gray-500">${formatDateLabel(date)}</span>
            </div>
            <div class="markdown-content">${html}</div>
          `;
          document.getElementById('reportActions').classList.remove('hidden');
        } else {
          selectedReportData = null;
          detailEl.innerHTML = '<div class="text-center text-gray-500 py-12">보고서 내용이 없습니다</div>';
          document.getElementById('reportActions').classList.add('hidden');
        }
      } catch (err) {
        detailEl.innerHTML = '<div class="text-center text-red-400 py-8">로드 실패</div>';
      }
    }

    function copyReportToClipboard() {
      if (selectedReportData?.markdown) {
        navigator.clipboard.writeText(selectedReportData.markdown).then(() => showToast('클립보드에 복사됨', 'success'));
      }
    }

    function downloadReport() {
      if (!selectedReportData?.markdown) return;
      const blob = new Blob([selectedReportData.markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `report-${selectedReportData.date}-${selectedReportData.type}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function exportReportToObsidian() {
      if (!selectedReportData?.markdown) return;
      try {
        const res = await fetch(`${API_BASE}/api/reports/daily/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: selectedReportData.date, type: selectedReportData.type, markdown: selectedReportData.markdown })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`옵시디언에 저장됨: ${data.relativePath}`, 'success');
        } else {
          showToast(data.error || '옵시디언 내보내기 실패', 'error');
        }
      } catch (err) {
        showToast('옵시디언 내보내기 실패: ' + err.message, 'error');
      }
    }

    // --- 주간 분석 ---
    async function loadAnalysisWeekly() {
      try {
        const res = await fetch(`${API_BASE}/api/insights/weekly-digest?limit=50`);
        const data = await res.json();
        const digests = data.digests || [];
        const listEl = document.getElementById('weeklyDigestList');
        if (digests.length === 0) {
          listEl.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">기록 없음</div>';
        } else {
          listEl.innerHTML = digests.map(d => `
            <button onclick="selectWeeklyDigest('${d.weekStart}')" data-week="${d.weekStart}"
              class="weekly-list-item w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-gray-700/50 transition-colors text-gray-400">
              <div>${d.weekStart} ~ ${d.weekEnd}</div>
              <div class="text-xs text-gray-500">✓ 생성됨</div>
            </button>
          `).join('');
        }
      } catch (err) { console.error('주간 다이제스트 목록 로드 실패:', err); }

      // 빈 상태
      document.getElementById('weeklyDigestStats').style.display = 'none';
      document.getElementById('weeklyDigestDetail').innerHTML = `
        <div class="text-center py-16">
          <div class="text-4xl mb-3">📈</div>
          <div class="text-gray-500 mb-4">다이제스트를 선택하거나 새로 생성하세요</div>
          <button onclick="generateWeeklyDigest()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium">✨ 이번 주 다이제스트 생성</button>
        </div>
      `;
      document.getElementById('weeklyActions').classList.add('hidden');
    }

    async function selectWeeklyDigest(weekStart) {
      // 하이라이트
      document.querySelectorAll('.weekly-list-item').forEach(btn => {
        const isActive = btn.dataset.week === weekStart;
        btn.classList.toggle('bg-blue-900/30', isActive);
        btn.classList.toggle('text-blue-400', isActive);
        btn.classList.toggle('border', isActive);
        btn.classList.toggle('border-blue-700/50', isActive);
        btn.classList.toggle('text-gray-400', !isActive);
      });

      try {
        const res = await fetch(`${API_BASE}/api/insights/weekly-digest?week=${weekStart}`);
        const data = await res.json();
        if (data.digest) {
          selectedWeeklyData = data.digest;
          const stats = data.digest.stats || {};
          document.getElementById('wdStatSessions').textContent = stats.sessions || 0;
          document.getElementById('wdStatJobs').textContent = stats.jobRuns || 0;
          document.getElementById('wdStatMemos').textContent = stats.memos || 0;
          document.getElementById('wdStatSuccess').textContent = (stats.successRate || 0) + '%';
          document.getElementById('weeklyDigestStats').style.display = '';

          const md = data.digest.markdown || '(내용 없음)';
          const html = typeof marked !== 'undefined' ? marked.parse(md) : md.replace(/\n/g, '<br>');
          document.getElementById('weeklyDigestDetail').innerHTML = `<div class="markdown-content">${html}</div>`;
          document.getElementById('weeklyActions').classList.remove('hidden');
        } else {
          selectedWeeklyData = null;
          document.getElementById('weeklyDigestStats').style.display = 'none';
          document.getElementById('weeklyDigestDetail').innerHTML = '<div class="text-center text-gray-500 py-12">다이제스트가 없습니다</div>';
          document.getElementById('weeklyActions').classList.add('hidden');
        }
      } catch (err) {
        document.getElementById('weeklyDigestDetail').innerHTML = '<div class="text-center text-red-400 py-8">로드 실패</div>';
      }
    }

    function copyWeeklyToClipboard() {
      if (selectedWeeklyData?.markdown) {
        navigator.clipboard.writeText(selectedWeeklyData.markdown).then(() => showToast('클립보드에 복사됨', 'success'));
      }
    }

    function downloadWeeklyDigest() {
      if (!selectedWeeklyData?.markdown) return;
      const blob = new Blob([selectedWeeklyData.markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `weekly-digest-${selectedWeeklyData.weekStart}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function exportWeeklyToObsidian() {
      if (!selectedWeeklyData?.markdown) return;
      try {
        const res = await fetch(`${API_BASE}/api/weekly-digest/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ weekStart: selectedWeeklyData.weekStart, markdown: selectedWeeklyData.markdown })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`옵시디언에 저장됨: ${data.relativePath}`, 'success');
        } else {
          showToast(data.error || '옵시디언 내보내기 실패', 'error');
        }
      } catch (err) {
        showToast('옵시디언 내보내기 실패: ' + err.message, 'error');
      }
    }

    // ============ 통합 타임라인 ============

    let timelineData = [];
    let timelineCollapsed = false;
    const timelineFilters = { job: true, session: true, memo: true, github: true, plan: true };
    let timeRangeStart = 0;   // 0~24 (시간)
    let timeRangeEnd = 24;

    async function loadTimeline() {
      try {
        const res = await fetch(`${API_BASE}/api/timeline?date=${homeDate}`);
        const data = await res.json();
        timelineData = data.items || [];

        const total = timelineData.length;
        document.getElementById('homeTimelineCount').textContent = total > 0 ? `${total}개 항목` : '';

        // 데이터 기반으로 시간 범위 자동 설정
        if (timelineData.length > 0) {
          const hours = timelineData.map(i => i.time ? new Date(i.time).getHours() : 12);
          const minH = Math.max(0, Math.min(...hours));
          const maxH = Math.min(24, Math.max(...hours) + 1);
          timeRangeStart = minH;
          timeRangeEnd = maxH;
        }

        updateTimeRangeUI();
        renderTimeline();
        initTimeRangeSlider();
      } catch (err) {
        console.error('타임라인 로드 실패:', err);
        document.getElementById('homeTimeline').innerHTML =
          '<div class="text-gray-500 text-center py-6">타임라인을 불러올 수 없습니다</div>';
      }
    }

    function toggleTimelineCollapse() {
      timelineCollapsed = !timelineCollapsed;
      const body = document.getElementById('timelineBody');
      const icon = document.getElementById('timelineCollapseIcon');
      if (timelineCollapsed) {
        body.style.maxHeight = '0';
        body.style.overflow = 'hidden';
        body.style.opacity = '0';
        icon.style.transform = 'rotate(-90deg)';
      } else {
        body.style.maxHeight = '';
        body.style.overflow = '';
        body.style.opacity = '1';
        icon.style.transform = '';
      }
    }

    function updateTimeRangeUI() {
      const label = document.getElementById('timeRangeLabel');
      const fmtH = h => `${String(Math.floor(h)).padStart(2,'0')}:${String(Math.round((h % 1) * 60)).padStart(2,'0')}`;
      label.textContent = `${fmtH(timeRangeStart)} ~ ${fmtH(timeRangeEnd)}`;

      const pctL = (timeRangeStart / 24) * 100;
      const pctR = (timeRangeEnd / 24) * 100;
      const active = document.getElementById('timeRangeActive');
      const handleL = document.getElementById('timeHandleLeft');
      const handleR = document.getElementById('timeHandleRight');
      if (active) {
        active.style.left = pctL + '%';
        active.style.width = (pctR - pctL) + '%';
      }
      if (handleL) handleL.style.left = `calc(${pctL}% - 8px)`;
      if (handleR) handleR.style.left = `calc(${pctR}% - 8px)`;
    }

    function initTimeRangeSlider() {
      const slider = document.getElementById('timeRangeSlider');
      if (!slider || slider._initialized) return;
      slider._initialized = true;

      const handleL = document.getElementById('timeHandleLeft');
      const handleR = document.getElementById('timeHandleRight');
      let dragging = null; // 'left' | 'right' | 'range'
      let dragStartX = 0;
      let dragStartValL = 0;
      let dragStartValR = 0;

      function pxToHour(clientX) {
        const rect = slider.getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        return Math.round(pct * 48) / 2; // 0.5시간 단위
      }

      function onPointerDown(e, which) {
        e.preventDefault();
        e.stopPropagation();
        dragging = which;
        dragStartX = e.clientX;
        dragStartValL = timeRangeStart;
        dragStartValR = timeRangeEnd;
        document.body.style.cursor = 'grabbing';
        document.addEventListener('pointermove', onPointerMove);
        document.addEventListener('pointerup', onPointerUp);
      }

      handleL.addEventListener('pointerdown', e => onPointerDown(e, 'left'));
      handleR.addEventListener('pointerdown', e => onPointerDown(e, 'right'));

      // 트랙 클릭으로 범위 드래그
      slider.addEventListener('pointerdown', (e) => {
        if (e.target === handleL || e.target === handleR) return;
        const h = pxToHour(e.clientX);
        // 가까운 핸들 이동
        if (Math.abs(h - timeRangeStart) < Math.abs(h - timeRangeEnd)) {
          dragging = 'left';
        } else {
          dragging = 'right';
        }
        dragStartX = e.clientX;
        dragStartValL = timeRangeStart;
        dragStartValR = timeRangeEnd;
        applyDrag(e.clientX);
        document.body.style.cursor = 'grabbing';
        document.addEventListener('pointermove', onPointerMove);
        document.addEventListener('pointerup', onPointerUp);
      });

      function onPointerMove(e) {
        if (!dragging) return;
        applyDrag(e.clientX);
      }

      function applyDrag(clientX) {
        const h = pxToHour(clientX);
        if (dragging === 'left') {
          timeRangeStart = Math.min(h, timeRangeEnd - 0.5);
          timeRangeStart = Math.max(0, timeRangeStart);
        } else if (dragging === 'right') {
          timeRangeEnd = Math.max(h, timeRangeStart + 0.5);
          timeRangeEnd = Math.min(24, timeRangeEnd);
        }
        updateTimeRangeUI();
        renderTimeline();
      }

      function onPointerUp() {
        dragging = null;
        document.body.style.cursor = '';
        document.removeEventListener('pointermove', onPointerMove);
        document.removeEventListener('pointerup', onPointerUp);
      }
    }

    function renderTimeline() {
      const container = document.getElementById('homeTimeline');
      const filtered = timelineData.filter(item => {
        if (timelineFilters[item.type] === false) return false;
        // 시간 범위 필터
        if (item.time) {
          const d = new Date(item.time);
          const h = d.getHours() + d.getMinutes() / 60;
          if (h < timeRangeStart || h >= timeRangeEnd) return false;
        }
        return true;
      });

      // 필터된 개수 업데이트
      const countEl = document.getElementById('homeTimelineCount');
      if (timeRangeStart > 0 || timeRangeEnd < 24 ||
          Object.values(timelineFilters).some(v => !v)) {
        countEl.textContent = `${filtered.length} / ${timelineData.length}개`;
      } else {
        countEl.textContent = timelineData.length > 0 ? `${timelineData.length}개 항목` : '';
      }

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-6">해당 범위에 활동이 없습니다</div>';
        return;
      }

      // 시간대별 그룹핑
      const groups = { morning: [], afternoon: [], evening: [] };
      filtered.forEach(item => {
        const hour = item.time ? new Date(item.time).getHours() : 12;
        if (hour < 12) groups.morning.push(item);
        else if (hour < 18) groups.afternoon.push(item);
        else groups.evening.push(item);
      });

      const labels = { morning: '오전', afternoon: '오후', evening: '저녁' };
      let html = '';
      for (const [key, items] of Object.entries(groups)) {
        if (items.length === 0) continue;
        html += `<div class="mb-4">
          <div class="text-xs font-medium text-gray-500 mb-2 pl-8">${labels[key]} (${items.length})</div>
          <div class="relative pl-6 border-l-2 border-gray-700 space-y-1">
            ${items.map(renderTimelineItem).join('')}
          </div>
        </div>`;
      }

      container.innerHTML = html;
    }

    function renderTimelineItem(item) {
      const colors = {
        green: 'bg-green-500', red: 'bg-red-500', purple: 'bg-purple-500',
        yellow: 'bg-yellow-500', blue: 'bg-blue-500', orange: 'bg-orange-500'
      };
      const icons = {
        session: '🤖', memo: '📝', 'memo-obsidian': '📓',
        'job-success': '✅', 'job-failed': '❌',
        'github-pr': '🔀', 'github-commit': '📦', 'github-review': '👀',
        plan: '☀️'
      };
      const time = item.time
        ? new Date(item.time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
        : '';

      const metaStr = JSON.stringify(item.meta || {}).replace(/"/g, '&quot;');

      return `<div class="relative flex items-start gap-3 group cursor-pointer hover:bg-gray-800/30 p-2 -ml-2 rounded-lg transition-colors"
           onclick="handleTimelineClick('${item.type}', JSON.parse(this.dataset.meta))" data-meta="${metaStr}">
        <div class="absolute -left-[25px] w-3 h-3 rounded-full ${colors[item.color] || 'bg-gray-500'} border-2 border-gray-900 mt-1.5"></div>
        <span class="text-xs text-gray-600 w-14 flex-shrink-0 mt-0.5">${time}</span>
        <span class="flex-shrink-0">${icons[item.icon] || '📌'}</span>
        <div class="flex-1 min-w-0">
          <div class="text-sm text-gray-300 truncate">${escapeHtml(item.title || '')}${item.meta?.hasSummary ? ' <span class="text-green-400" title="요약 생성됨">📋</span>' : ''}</div>
          ${item.subtitle ? `<div class="text-xs text-gray-600 truncate">${escapeHtml(item.subtitle)}</div>` : ''}
        </div>
      </div>`;
    }

    function handleTimelineClick(type, meta) {
      switch (type) {
        case 'session':
          showTab('sessions');
          if (meta.sessionId) setTimeout(() => showSessionDetail(meta.sessionId, meta.projectPath), 100);
          break;
        case 'job':
          showTab('jobs');
          showJobSubTab('history');
          if (meta.logId) setTimeout(() => showLogById(meta.logId), 200);
          break;
        case 'memo':
          showTab('notes');
          break;
        case 'plan':
          openMorningStart();
          break;
        case 'github':
          if (meta.url) window.open(meta.url, '_blank');
          break;
      }
    }

    function toggleTimelineFilter(type) {
      timelineFilters[type] = !timelineFilters[type];

      const btn = document.querySelector(`.tl-filter-btn[data-filter="${type}"]`);
      if (btn) {
        if (timelineFilters[type]) {
          btn.classList.remove('opacity-30');
        } else {
          btn.classList.add('opacity-30');
        }
      }

      renderTimeline();
    }

    // ============ 통합 검색 (Cmd+K) ============

    let searchDebounceTimer = null;
    let searchSelectedIdx = -1;

    function openGlobalSearch() {
      const modal = document.getElementById('globalSearchModal');
      modal.style.display = 'flex';
      const input = document.getElementById('globalSearchInput');
      input.value = '';
      searchSelectedIdx = -1;
      document.getElementById('globalSearchResults').innerHTML =
        '<div class="text-center text-gray-600 text-sm py-8">검색어를 입력하세요 (2글자 이상)</div>';
      setTimeout(() => input.focus(), 50);
    }

    function closeGlobalSearch() {
      document.getElementById('globalSearchModal').style.display = 'none';
    }

    function debounceGlobalSearch() {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(executeGlobalSearch, 250);
    }

    function highlightQuery(text, query) {
      if (!query) return text;
      const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark class="bg-yellow-500/30 text-yellow-300 rounded px-0.5">$1</mark>');
    }

    function selectSearchResult(idx) {
      const items = document.querySelectorAll('.search-result');
      items.forEach((el, i) => {
        el.classList.toggle('bg-gray-700/30', i === idx);
      });
      searchSelectedIdx = idx;
    }

    function handleSearchKeydown(e) {
      const items = document.querySelectorAll('.search-result');
      if (e.key === 'Escape') {
        closeGlobalSearch();
        return;
      }
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectSearchResult(Math.min(searchSelectedIdx + 1, items.length - 1));
        items[searchSelectedIdx]?.scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectSearchResult(Math.max(searchSelectedIdx - 1, 0));
        items[searchSelectedIdx]?.scrollIntoView({ block: 'nearest' });
      } else if (e.key === 'Enter' && searchSelectedIdx >= 0) {
        e.preventDefault();
        handleSearchResultClick(searchSelectedIdx);
      }
    }

    function handleSearchResultClick(idx) {
      const container = document.getElementById('globalSearchResults');
      const items = container.querySelectorAll('.search-result');
      if (!items[idx]) return;

      // 결과 데이터를 다시 API에서 가져오지 않고, DOM에서 type 추출
      const typeEl = items[idx].querySelector('.flex-col .text-\\[10px\\]:last-child');
      const type = typeEl?.textContent?.trim() || '';

      closeGlobalSearch();

      // onclick에서 호출되므로 data attribute로 meta를 전달하기 어려움
      // 대신 마지막 검색 결과를 저장해서 사용
      navigateSearchResult(type, idx);
    }

    let lastSearchResults = [];

    async function executeGlobalSearch() {
      const q = document.getElementById('globalSearchInput').value.trim();
      const container = document.getElementById('globalSearchResults');
      if (q.length < 2) {
        container.innerHTML = '<div class="text-center text-gray-600 text-sm py-8">검색어를 입력하세요 (2글자 이상)</div>';
        lastSearchResults = [];
        return;
      }

      container.innerHTML = '<div class="text-center text-gray-500 text-sm py-6">검색중...</div>';

      try {
        const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        lastSearchResults = data.results || [];
        searchSelectedIdx = -1;

        if (lastSearchResults.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">검색 결과가 없습니다</div>';
          return;
        }

        container.innerHTML = lastSearchResults.map((r, idx) => {
          const dateStr = r.date || '';
          const highlighted = highlightQuery(escapeHtml(r.title || ''), q);
          const previewHighlighted = r.preview ? highlightQuery(escapeHtml(r.preview), q) : '';
          return `<div class="search-result flex items-start gap-3 px-3 py-2.5 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors ${idx === 0 ? 'bg-gray-700/30' : ''}"
                       data-idx="${idx}" onclick="handleSearchResultClick(${idx})"
                       onmouseenter="selectSearchResult(${idx})">
            <span class="flex-shrink-0 mt-0.5">${r.icon || '📄'}</span>
            <div class="flex-1 min-w-0">
              <div class="text-sm text-gray-200 truncate">${highlighted}</div>
              ${previewHighlighted ? `<div class="text-xs text-gray-500 truncate mt-0.5">${previewHighlighted}</div>` : ''}
            </div>
            <div class="flex flex-col items-end flex-shrink-0">
              <span class="text-[10px] text-gray-600">${dateStr}</span>
              <span class="text-[10px] text-gray-600 mt-0.5">${r.type}</span>
            </div>
          </div>`;
        }).join('');

        if (data.total > lastSearchResults.length) {
          container.innerHTML += `<div class="text-center text-gray-600 text-xs py-2">${data.total}개 중 ${lastSearchResults.length}개 표시</div>`;
        }

        searchSelectedIdx = 0;
      } catch (err) {
        container.innerHTML = '<div class="text-center text-red-400 text-sm py-6">검색 오류</div>';
      }
    }

    function navigateSearchResult(type, idx) {
      const r = lastSearchResults[idx];
      if (!r) return;

      switch (r.type) {
        case 'session':
          showTab('sessions');
          if (r.meta?.sessionId) setTimeout(() => showSessionDetail(r.meta.sessionId, r.meta.projectPath), 100);
          break;
        case 'job':
          showTab('jobs');
          showJobSubTab('history');
          if (r.meta?.logId) setTimeout(() => showLogById(r.meta.logId), 200);
          break;
        case 'memo':
          showTab('notes');
          break;
        case 'backlog':
          showTab('notes');
          break;
      }
    }

    function openAskModal() {
      const modal = document.getElementById('askModal');
      modal.style.display = 'flex';

      // 입력 초기화
      document.getElementById('askInput').value = '';
      document.getElementById('askResponse').classList.add('hidden');
      document.getElementById('askLoading').classList.add('hidden');
      document.getElementById('askSubmitBtn').classList.remove('hidden');
      document.getElementById('askCopyBtn').classList.add('hidden');
      document.getElementById('askModalEmoji').textContent = '🤖';

      setTimeout(() => document.getElementById('askInput').focus(), 100);
    }

    function closeAskModal() {
      document.getElementById('askModal').style.display = 'none';
    }

    async function submitQuestion() {
      const input = document.getElementById('askInput');
      const prompt = input.value.trim();
      if (!prompt) return;

      try {
        // 비동기 작업 제출
        await submitTask('ask', { prompt });

        // 모달 닫기 (결과는 작업 패널에서 확인)
        closeAskModal();
        showToast('질문이 접수되었습니다. 완료되면 알려드릴게요!', 'info');

      } catch (err) {
        showToast('질문 제출 실패: ' + err.message, 'error');
      }
    }

    function copyAskResponse() {
      if (currentAskResponse) {
        navigator.clipboard.writeText(currentAskResponse).then(() => {
          showToast('클립보드에 복사되었습니다', 'success');
        });
      }
    }

    let quickInputType = 'memo'; // 'memo' | 'backlog'
    let backlogPriority = 'normal';
    let memoCategory = null;

    function openQuickInput(type) {
      quickInputType = type || 'memo';
      backlogPriority = 'normal';
      memoCategory = null;
      const modal = document.getElementById('quickInputModal');
      modal.style.display = 'flex';

      document.getElementById('quickInputText').value = '';
      setQuickInputType(quickInputType);
      setTimeout(() => document.getElementById('quickInputText').focus(), 100);
    }

    function setQuickInputType(type) {
      quickInputType = type;
      const memoBtn = document.getElementById('qiTypeMemo');
      const backlogBtn = document.getElementById('qiTypeBacklog');
      const priRow = document.getElementById('backlogPriorityRow');
      const catRow = document.getElementById('memoCategoryRow');
      const textarea = document.getElementById('quickInputText');
      const icon = document.getElementById('quickInputIcon');
      const title = document.getElementById('quickInputTitle');
      const saveBtn = document.getElementById('quickInputSaveBtn');

      if (type === 'memo') {
        memoBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white/20 text-white';
        backlogBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-white/60';
        priRow.classList.add('hidden');
        catRow.classList.remove('hidden');
        textarea.placeholder = '지금 하고 있는 일, 생각, 메모...';
        icon.textContent = '📝';
        title.textContent = '빠른 메모';
        saveBtn.innerHTML = '💾 저장';
        setMemoCategory(null);
      } else {
        backlogBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white/20 text-white';
        memoBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-white/60';
        priRow.classList.remove('hidden');
        catRow.classList.add('hidden');
        textarea.placeholder = '나중에 할 일, 아이디어, TODO...';
        icon.textContent = '📋';
        title.textContent = '백로그 추가';
        saveBtn.innerHTML = '📋 추가';
        setBacklogPriority('normal');
      }
    }

    function setBacklogPriority(pri) {
      backlogPriority = pri;
      document.querySelectorAll('.backlog-pri-btn').forEach(btn => {
        if (btn.dataset.pri === pri) {
          btn.className = 'backlog-pri-btn px-2 py-1 rounded text-xs border border-white/30 bg-white/10 text-white transition-colors';
        } else {
          btn.className = 'backlog-pri-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 transition-colors';
        }
      });
    }

    function setMemoCategory(cat) {
      memoCategory = (memoCategory === cat) ? null : cat;
      document.querySelectorAll('.memo-cat-btn').forEach(btn => {
        if (btn.dataset.cat === memoCategory) {
          btn.className = 'memo-cat-btn px-2 py-1 rounded text-xs border border-white/30 bg-white/10 text-white transition-colors';
        } else {
          btn.className = 'memo-cat-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 transition-colors';
        }
      });
    }

    function toggleQuickInputPreview() {
      const preview = document.getElementById('qiPreviewArea');
      const btn = document.getElementById('qiPreviewToggle');
      if (preview.classList.contains('hidden')) {
        const text = document.getElementById('quickInputText').value;
        preview.innerHTML = text ? marked.parse(text) : '<span class="text-gray-500">내용을 입력하면 미리보기가 표시됩니다</span>';
        preview.classList.remove('hidden');
        btn.textContent = '👁 미리보기 닫기';
      } else {
        preview.classList.add('hidden');
        btn.textContent = '👁 미리보기';
      }
    }

    function updateQuickInputPreview() {
      const preview = document.getElementById('qiPreviewArea');
      if (!preview.classList.contains('hidden')) {
        const text = document.getElementById('quickInputText').value;
        preview.innerHTML = text ? marked.parse(text) : '<span class="text-gray-500">내용을 입력하면 미리보기가 표시됩니다</span>';
      }
    }

    function closeQuickInputModal() {
      document.getElementById('quickInputModal').style.display = 'none';
      document.getElementById('qiPreviewArea').classList.add('hidden');
      document.getElementById('qiPreviewToggle').textContent = '👁 미리보기';
    }

    async function saveQuickInput() {
      const text = document.getElementById('quickInputText').value.trim();
      if (!text) return;

      try {
        if (quickInputType === 'backlog') {
          const res = await fetch(`${API_BASE}/api/backlogs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: text, priority: backlogPriority })
          });
          if (!res.ok) throw new Error('저장 실패');
          showToast('백로그가 추가되었습니다 📋', 'success');
        } else {
          const payload = { content: text };
          if (memoCategory) payload.category = memoCategory;
          const res = await fetch(`${API_BASE}/api/quick-memos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error('저장 실패');
          showToast('메모가 저장되었습니다 📝', 'success');
        }

        document.getElementById('quickInputText').value = '';
        closeQuickInputModal();
        refreshTodaySummary();

        // 노트 탭이 열려있으면 새로고침
        if (!document.getElementById('panel-notes').classList.contains('hidden')) {
          loadNotes();
        }
      } catch (err) {
        showToast('저장 실패: ' + err.message, 'error');
      }
    }

    // 하위 호환 - 기존 saveQuickMemo 호출 지원
    async function saveQuickMemo() { return saveQuickInput(); }

    // ============ 노트 & 백로그 탭 ============
    let notesFilter = 'all';
    let notesData = { memos: [], backlogs: [] };
    let notesDate = getKSTDateString(); // 오늘

    function initNotesDate() {
      if (!notesDate) notesDate = getKSTDateString();
      updateNotesDateUI();
    }

    function updateNotesDateUI() {
      const today = getKSTDateString();
      const d = new Date(notesDate + 'T00:00:00');
      const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
      const isToday = notesDate === today;
      const label = document.getElementById('notesDateLabel');
      const input = document.getElementById('notesDateInput');
      const nextBtn = document.getElementById('notesDateNext');

      if (label) {
        const m = d.getMonth() + 1;
        const day = d.getDate();
        const wd = weekdays[d.getDay()];
        label.textContent = isToday ? `📅 오늘 (${m}/${day} ${wd})` : `📅 ${m}/${day} (${wd})`;
        label.title = notesDate;
      }
      if (input) input.value = notesDate;
      // 미래 날짜 비활성화
      if (nextBtn) {
        nextBtn.disabled = notesDate >= today;
        nextBtn.style.opacity = notesDate >= today ? '0.3' : '1';
      }
    }

    function setNotesDate(dateStr) {
      const today = getKSTDateString();
      if (dateStr > today) dateStr = today;
      notesDate = dateStr;
      updateNotesDateUI();
      loadNotes();
    }

    function shiftNotesDate(delta) {
      const d = new Date(notesDate + 'T00:00:00');
      d.setDate(d.getDate() + delta);
      setNotesDate(getKSTDateString(d));
    }

    function setNotesToday() {
      setNotesDate(getKSTDateString());
    }

    function setNotesFilter(filter) {
      notesFilter = filter;
      document.querySelectorAll('.note-filter-btn').forEach(btn => {
        btn.className = 'note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white';
      });
      const activeBtn = document.getElementById(`noteFilter-${filter}`);
      if (activeBtn) activeBtn.className = 'note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-600 text-white';
      renderNotesList();
    }

    async function loadNotes() {
      try {
        const targetDate = notesDate || getKSTDateString();
        const [memosRes, backlogsRes, obsidianRes] = await Promise.all([
          fetch(`${API_BASE}/api/quick-memos?date=${targetDate}`),
          fetch(`${API_BASE}/api/backlogs`),
          fetch(`${API_BASE}/api/obsidian/daily-memos?date=${targetDate}`).catch(() => ({ json: () => ({ memos: [] }) }))
        ]);
        const memosData = await memosRes.json();
        const backlogsData = await backlogsRes.json();
        const obsidianData = await obsidianRes.json();

        // 대시보드 메모 (날짜 필터링됨)
        const dashMemos = (memosData.memos || []).map(m => ({ ...m, _type: 'memo', _source: 'dashboard' }));

        // Obsidian 시간별 메모 (대시보드 메모와 중복 제거 - 내용으로 비교)
        const dashContents = new Set(dashMemos.map(m => m.content?.trim()));
        const obsidianMemos = (obsidianData.memos || [])
          .filter(m => m.content?.trim() && !dashContents.has(m.content?.trim()))
          .map(m => ({ ...m, _type: 'memo', _source: 'obsidian' }));

        notesData.memos = [...dashMemos, ...obsidianMemos];
        notesData.backlogs = (backlogsData.backlogs || []).map(b => ({ ...b, _type: 'backlog' }));

        // 카운트 업데이트
        const openCount = notesData.backlogs.filter(b => !b.done).length;
        document.getElementById('backlogOpenCount').textContent = openCount > 0 ? `(${openCount})` : '';
        document.getElementById('notesCount').textContent =
          `메모 ${notesData.memos.length}개 · 백로그 ${notesData.backlogs.length}개 (미완료 ${openCount})`;

        renderNotesList();
      } catch (err) {
        console.error('노트 로드 실패:', err);
        document.getElementById('notesList').innerHTML =
          '<div class="text-center text-red-400 py-8">로드 실패: ' + err.message + '</div>';
      }
    }

    function renderNotesList() {
      const container = document.getElementById('notesList');
      let items = [];

      const categoryFilters = ['learning', 'work', 'idea', 'todo', 'issue', 'personal'];

      if (notesFilter === 'all') {
        items = [
          ...notesData.backlogs.filter(b => !b.done).map(b => ({ ...b, _type: 'backlog' })),
          ...notesData.memos.map(m => ({ ...m, _type: 'memo' }))
        ];
      } else if (notesFilter === 'backlog') {
        items = notesData.backlogs.filter(b => !b.done);
      } else if (notesFilter === 'memo') {
        items = notesData.memos;
      } else if (notesFilter === 'done') {
        items = notesData.backlogs.filter(b => b.done);
      } else if (categoryFilters.includes(notesFilter)) {
        items = notesData.memos.filter(m => m.category === notesFilter);
      }

      // 시간순 정렬 (최신 먼저) - 단 "all" 필터에서 백로그는 상단
      if (notesFilter !== 'all') {
        items.sort((a, b) => (b.createdAt || b.timestamp || '').localeCompare(a.createdAt || a.timestamp || ''));
      }

      if (items.length === 0) {
        const emptyMsg = {
          all: '노트가 없습니다. 메모나 백로그를 추가해보세요!',
          backlog: '미완료 백로그가 없습니다.',
          memo: '메모가 없습니다.',
          done: '완료된 백로그가 없습니다.',
          learning: '📚 학습 메모가 없습니다.',
          work: '💼 업무 메모가 없습니다.',
          idea: '💡 아이디어 메모가 없습니다.',
          todo: '✅ 할일 메모가 없습니다.',
          issue: '🐛 이슈 메모가 없습니다.',
          personal: '🏠 개인 메모가 없습니다.'
        };
        container.innerHTML = `<div class="text-center text-gray-500 py-12">${emptyMsg[notesFilter] || '메모가 없습니다.'}</div>`;
        return;
      }

      // "all" 필터: 백로그와 메모를 섹션으로 나눠 표시
      if (notesFilter === 'all') {
        const openBacklogs = notesData.backlogs.filter(b => !b.done);
        const recentMemos = notesData.memos.slice(0, 20);

        let html = '';

        if (openBacklogs.length > 0) {
          html += `<div class="mb-8">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-sm font-bold text-amber-400">📋 백로그</span>
              <span class="text-xs text-gray-500">${openBacklogs.length}개 미완료</span>
            </div>
            <div class="space-y-2">
              ${openBacklogs.map(b => renderBacklogItem(b)).join('')}
            </div>
          </div>`;
        }

        if (recentMemos.length > 0) {
          const today = getKSTDateString();
          const memoLabel = notesDate === today ? '📝 최근 메모' : `📝 ${notesDate} 메모`;
          html += `<div>
            <div class="flex items-center gap-2 mb-3">
              <span class="text-sm font-bold text-purple-400">${memoLabel}</span>
              <span class="text-xs text-gray-500">${notesData.memos.length}개</span>
            </div>
            <div class="space-y-2">
              ${recentMemos.map(m => renderMemoItem(m)).join('')}
            </div>
          </div>`;
        }

        container.innerHTML = html;
        return;
      }

      // 개별 필터
      container.innerHTML = `<div class="space-y-2">
        ${items.map(item => item._type === 'backlog' ? renderBacklogItem(item) : renderMemoItem(item)).join('')}
      </div>`;
    }

    function renderBacklogItem(b) {
      const priColors = {
        high: 'border-l-red-500 bg-red-900/10',
        normal: 'border-l-amber-500 bg-amber-900/10',
        low: 'border-l-blue-500 bg-blue-900/10'
      };
      const priIcons = { high: '🔴', normal: '🟡', low: '🔵' };
      const colorClass = priColors[b.priority] || priColors.normal;
      const timeStr = b.createdAt ? new Date(b.createdAt).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }) : '';
      const rawContent = b.content || '';
      const hasMarkdown = /[*_`#\-\[\]]/.test(rawContent);
      const renderedContent = hasMarkdown && !b.done
        ? `<div class="markdown-content text-sm">${marked.parse(rawContent)}</div>`
        : `<span class="text-sm ${b.done ? 'line-through text-gray-500' : ''}">${escapeHtml(rawContent)}</span>`;

      return `
        <div class="flex items-start gap-3 p-4 rounded-lg border border-gray-700/50 border-l-2 ${colorClass} hover:bg-gray-800/50 transition-colors group ${b.done ? 'opacity-50' : ''}">
          <input type="checkbox" ${b.done ? 'checked' : ''}
            onchange="toggleBacklog('${b.id}', this.checked)"
            class="w-4 h-4 rounded accent-amber-500 cursor-pointer flex-shrink-0 mt-1">
          <div class="flex-1 min-w-0">${renderedContent}</div>
          <div class="flex items-center gap-2 flex-shrink-0 mt-0.5">
            <span class="text-xs text-gray-600">${priIcons[b.priority] || ''}</span>
            <span class="text-xs text-gray-600 whitespace-nowrap">${timeStr}</span>
            <button onclick="deleteBacklog('${b.id}')"
              class="w-7 h-7 flex items-center justify-center rounded-full text-gray-500 hover:text-red-400 hover:bg-red-400/10 transition-all text-lg" title="삭제">&times;</button>
          </div>
        </div>
      `;
    }

    const MEMO_CATEGORY_ICONS = {
      work: '💼', learning: '📚', idea: '💡',
      todo: '✅', issue: '🐛', personal: '🏠'
    };

    function renderMemoItem(m) {
      const timeStr = (m.timestamp || m.createdAt) ?
        new Date(m.timestamp || m.createdAt).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
        : (m.time || '');
      const isObsidian = m._source === 'obsidian';
      const borderColor = isObsidian ? 'border-l-green-500 bg-green-900/10' : 'border-l-purple-500 bg-purple-900/10';
      const icon = m.category ? (MEMO_CATEGORY_ICONS[m.category] || '📝') : (isObsidian ? '📓' : '📝');
      const rawContent = m.content || m.text || '';
      const hasMultiline = rawContent.includes('\n');
      const hasMarkdown = /[*_`#\[\]]/.test(rawContent) || hasMultiline;
      const renderedContent = hasMarkdown
        ? `<div class="markdown-content text-sm">${marked.parse(rawContent)}</div>`
        : `<span class="text-sm">${escapeHtml(rawContent)}</span>`;
      const deleteBtn = m.id && !isObsidian
        ? `<button onclick="deleteMemo('${m.id}')" class="flex-shrink-0 w-7 h-7 flex items-center justify-center rounded-full text-gray-500 hover:text-red-400 hover:bg-red-400/10 transition-all text-lg" title="삭제">&times;</button>`
        : '';

      // 태그 뱃지
      const tagBadges = (m.tags || []).map(tag =>
        `<span class="inline-block text-xs px-1.5 py-0.5 rounded bg-gray-700/70 text-gray-400 border border-gray-600/50">#${escapeHtml(tag)}</span>`
      ).join(' ');

      return `
        <div class="flex items-start gap-3 p-4 rounded-lg border border-gray-700/50 border-l-2 ${borderColor} hover:bg-gray-800/50 transition-colors group">
          <span class="flex-shrink-0 mt-0.5">${icon}</span>
          <div class="flex-1 min-w-0">
            ${renderedContent}
            ${tagBadges ? `<div class="flex flex-wrap gap-1 mt-1.5">${tagBadges}</div>` : ''}
          </div>
          <div class="flex items-center gap-2 flex-shrink-0 mt-0.5">
            ${isObsidian ? '<span class="text-xs text-green-600 whitespace-nowrap">Obsidian</span>' : ''}
            <span class="text-xs text-gray-600 whitespace-nowrap">${timeStr}</span>
            ${deleteBtn}
          </div>
        </div>
      `;
    }

    async function toggleBacklog(id, done) {
      try {
        await fetch(`${API_BASE}/api/backlogs/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ done })
        });
        showToast(done ? '✅ 완료!' : '↩️ 미완료로 변경', 'success');
        loadNotes();
      } catch (err) {
        showToast('업데이트 실패: ' + err.message, 'error');
      }
    }

    async function deleteBacklog(id) {
      try {
        await fetch(`${API_BASE}/api/backlogs/${id}`, { method: 'DELETE' });
        showToast('백로그 삭제됨', 'success');
        loadNotes();
      } catch (err) {
        showToast('삭제 실패: ' + err.message, 'error');
      }
    }

    async function deleteMemo(id) {
      try {
        await fetch(`${API_BASE}/api/quick-memos/${id}`, { method: 'DELETE' });
        showToast('메모 삭제됨', 'success');
        loadNotes();
      } catch (err) {
        showToast('삭제 실패: ' + err.message, 'error');
      }
    }

    // ============ 하루 시작 (Morning Start) ============
    let morningStep = 1;
    let morningEditMode = false; // true = 한 화면 편집, false = 위저드
    let morningData = {
      date: '',
      tasks: [],
      additionalTasks: [],
      goals: [],
      focusTime: '',
      motto: '',
      markdown: ''
    };
    let hasMorningPlan = false; // 오늘 플랜 존재 여부

    // 페이지 로드 시 & 저장 후 버튼 상태 업데이트
    async function checkMorningPlanExists() {
      const today = getKSTDateString();
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${today}`);
        const data = await res.json();
        hasMorningPlan = !!data.plan;
        const btn = document.getElementById('morningStartBtn');
        if (btn) {
          btn.innerHTML = hasMorningPlan ? '✏️ 하루 수정' : '☀️ 하루 시작';
        }
      } catch (e) { /* ignore */ }
    }

    async function openMorningStart(targetDate) {
      const today = targetDate || homeDate || getKSTDateString();
      morningData = {
        date: today,
        tasks: [],
        additionalTasks: [],
        goals: [],
        focusTime: '',
        motto: '',
        markdown: ''
      };

      document.getElementById('morningDate').textContent = today;

      // 기존 플랜이 있으면 로드
      let existingPlan = false;
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${today}`);
        const data = await res.json();
        if (data.plan) {
          morningData = { ...morningData, ...data.plan };
          existingPlan = true;
        }
      } catch (e) {
        console.error('모닝 플랜 로드 실패:', e);
      }

      // 기존 플랜 있으면 → 한 화면 편집 모드, 없으면 → 위저드 모드
      morningEditMode = existingPlan;

      if (morningEditMode) {
        document.getElementById('morningHeaderIcon').textContent = '✏️';
        document.getElementById('morningHeaderTitle').textContent = '하루 계획 수정';
        document.getElementById('morningStepBar').classList.add('hidden');
        document.getElementById('morningPrevBtn').classList.add('hidden');
        document.getElementById('morningNextBtn').classList.add('hidden');
        document.getElementById('morningSubmitBtn').classList.remove('hidden');
        document.getElementById('morningSubmitBtn').innerHTML = '💾 저장';
        renderMorningEditAll();
      } else {
        morningStep = 1;
        document.getElementById('morningHeaderIcon').textContent = '☀️';
        document.getElementById('morningHeaderTitle').textContent = '하루 시작';
        document.getElementById('morningStepBar').classList.remove('hidden');
        document.getElementById('morningSubmitBtn').innerHTML = '☀️ 하루 시작!';
        renderMorningStep();
      }

      document.getElementById('morningStartModal').style.display = 'flex';
    }

    function closeMorningStartModal() {
      document.getElementById('morningStartModal').style.display = 'none';
    }

    // ---- 한 화면 편집 모드 ----
    function renderMorningEditAll() {
      const content = document.getElementById('morningContent');
      const tasksText = morningData.tasks.length > 0 ? morningData.tasks.join('\n') : '';
      const existingItems = morningData.additionalTasks || [];
      const g = morningData.goals || [];
      const focusLabels = { morning: '오전', afternoon: '오후', evening: '저녁', 'all-day': '하루 종일' };
      const focusOptions = [
        { value: 'morning', label: '오전', icon: '🌅' },
        { value: 'afternoon', label: '오후', icon: '☀️' },
        { value: 'evening', label: '저녁', icon: '🌙' },
        { value: 'all-day', label: '하루 종일', icon: '⏰' }
      ];
      const categories = ['회의', '리뷰', '학습', '운동', '개인', '기타'];

      content.innerHTML = `
        <div class="flex gap-2 mb-4">
          <button onclick="switchMorningEditTab('form')" id="morningFormTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300">
            📝 폼 편집
          </button>
          <button onclick="switchMorningEditTab('preview')" id="morningPvTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500">
            👁 마크다운
          </button>
          <button onclick="switchMorningEditTab('markdown')" id="morningMdTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500">
            ✏️ 원본 편집
          </button>
        </div>

        <!-- 폼 편집 탭 -->
        <div id="morningFormArea">
          <!-- 업무 -->
          <div class="mb-5">
            <label class="block text-sm font-medium mb-2">📋 오늘의 업무</label>
            <textarea id="morningTasks"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 min-h-[100px] resize-none focus:outline-none focus:border-amber-500 text-sm leading-relaxed"
              placeholder="한 줄에 하나씩 입력"
            >${escapeHtml(tasksText)}</textarea>
          </div>

          <!-- 추가 할 일 -->
          <div class="mb-5">
            <label class="block text-sm font-medium mb-2">➕ 추가 할 일</label>
            <div class="flex flex-wrap gap-1.5 mb-3" id="additionalCategoryTags">
              ${categories.map(cat => `
                <button onclick="selectAdditionalCategory('${cat}')"
                  class="additional-cat-btn px-2.5 py-1 rounded-full text-xs font-medium border transition-colors
                    ${existingItems.some(i => i.category === cat) ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500 hover:text-amber-300'}"
                  data-category="${cat}">${cat}</button>
              `).join('')}
            </div>
            <div id="additionalTasksList" class="space-y-2">
              ${existingItems.map(item => `
                <div class="flex items-center gap-2 additional-task-row">
                  <span class="px-2 py-1 bg-amber-900/30 text-amber-300 rounded text-xs min-w-[40px] text-center">${escapeHtml(item.category)}</span>
                  <input type="text" value="${escapeHtml(item.content)}"
                    class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
                    data-category="${escapeHtml(item.category)}" placeholder="${escapeHtml(item.category)} 내용 입력...">
                  <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400">×</button>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- 목표 -->
          <div class="mb-5">
            <label class="block text-sm font-medium mb-2">🎯 핵심 목표</label>
            <div class="space-y-2" id="morningGoalsList">
              ${[0, 1, 2].map(i => `
                <input type="text" id="morningGoal${i}" value="${escapeHtml(g[i] || '')}"
                  class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
                  placeholder="${i === 0 ? '가장 중요한 목표' : i === 1 ? '두 번째 목표 (선택)' : '세 번째 목표 (선택)'}">
              `).join('')}
            </div>
          </div>

          <!-- 집중 시간 & 다짐 -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">⏰ 집중 시간</label>
            <div class="grid grid-cols-4 gap-2">
              ${focusOptions.map(opt => `
                <button onclick="selectFocusTime('${opt.value}')"
                  class="focus-time-btn px-2 py-2 rounded-lg text-xs font-medium border transition-all text-center
                    ${morningData.focusTime === opt.value ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500'}"
                  data-value="${opt.value}">
                  ${opt.icon} ${opt.label}
                </button>
              `).join('')}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">💪 오늘의 다짐</label>
            <input type="text" id="morningMotto" value="${escapeHtml(morningData.motto)}"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
              placeholder="오늘 하루를 이끌어갈 한마디!">
          </div>
        </div>

        <!-- 마크다운 뷰 탭 (렌더링 + 인터랙티브 체크박스) -->
        <div id="morningPvArea" class="hidden">
          <div id="morningMarkdownPreview"
            class="morning-preview bg-gray-800/50 border border-gray-700 rounded-lg p-5 min-h-[400px] text-sm markdown-content">
          </div>
        </div>

        <!-- 원본 편집 탭 -->
        <div id="morningMdArea" class="hidden">
          <textarea id="morningMarkdownEditor"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[400px] resize-none focus:outline-none focus:border-amber-500 text-sm font-mono leading-relaxed"
            oninput="morningData.markdown = this.value"
          >${escapeHtml(morningData.markdown || '')}</textarea>
        </div>
      `;
    }

    function switchMorningEditTab(tab) {
      const formArea = document.getElementById('morningFormArea');
      const mdArea = document.getElementById('morningMdArea');
      const pvArea = document.getElementById('morningPvArea');
      const formTab = document.getElementById('morningFormTab');
      const mdTab = document.getElementById('morningMdTab');
      const pvTab = document.getElementById('morningPvTab');

      const activeClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300';
      const inactiveClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500';

      [formArea, mdArea, pvArea].forEach(el => el.classList.add('hidden'));
      [formTab, mdTab, pvTab].forEach(el => el.className = inactiveClass);

      if (tab === 'form') {
        formArea.classList.remove('hidden');
        formTab.className = activeClass;
      } else if (tab === 'preview') {
        // 마크다운 렌더링 뷰 (인터랙티브 체크박스)
        collectFormData();
        const editorVal = document.getElementById('morningMarkdownEditor')?.value;
        if (editorVal) {
          morningData.markdown = editorVal;
        } else if (!morningData.markdown) {
          morningData.markdown = generateMorningMarkdown();
        }
        renderMorningInteractiveView();
        pvArea.classList.remove('hidden');
        pvTab.className = activeClass;
      } else if (tab === 'markdown') {
        // 원본 편집
        collectFormData();
        if (!morningData.markdown || !document.getElementById('morningMarkdownEditor')?.value) {
          morningData.markdown = generateMorningMarkdown();
        }
        const editor = document.getElementById('morningMarkdownEditor');
        if (editor) editor.value = morningData.markdown;
        mdArea.classList.remove('hidden');
        mdTab.className = activeClass;
      }
    }

    // 마크다운 뷰 렌더링 (체크박스 인터랙티브)
    function renderMorningInteractiveView() {
      const preview = document.getElementById('morningMarkdownPreview');
      const md = morningData.markdown || generateMorningMarkdown();

      // 마크다운을 먼저 렌더링 전에 체크박스 마커를 플레이스홀더로 변환
      let checkIdx = 0;
      const processedMd = md.replace(/^(\s*-\s*)\[( |x)\]\s*(.+)$/gim, (match, prefix, checked, text) => {
        const idx = checkIdx++;
        const isChecked = checked.toLowerCase() === 'x';
        return `${prefix}|||CB:${idx}:${isChecked ? '1' : '0'}|||${text}`;
      });

      let html = renderMarkdown(processedMd);

      // 플레이스홀더를 인터랙티브 체크박스 HTML로 변환
      html = html.replace(/\|\|\|CB:(\d+):([01])\|\|\|/g, (match, idx, checked) => {
        const isChecked = checked === '1';
        return `<label class="inline-flex items-start gap-2 cursor-pointer" onclick="event.preventDefault(); toggleMorningCheckbox(${idx})">
          <input type="checkbox" ${isChecked ? 'checked' : ''} class="mt-0.5 w-4 h-4 accent-amber-500 cursor-pointer flex-shrink-0">
          <span class="${isChecked ? 'line-through text-gray-500' : ''}">` ;
      });

      // 체크박스가 있는 li의 닫는 태그에 span 닫기 추가
      const temp = document.createElement('div');
      temp.innerHTML = html;
      temp.querySelectorAll('li').forEach(li => {
        const label = li.querySelector('label[onclick*="toggleMorningCheckbox"]');
        if (label) {
          li.style.listStyle = 'none';
          li.style.marginLeft = '-1em';
          // label 내의 span이 나머지 텍스트를 감싸도록
          const span = label.querySelector('span');
          if (span) {
            // label 뒤의 나머지 텍스트를 span 안으로 이동
            let next = label.nextSibling;
            while (next) {
              const toMove = next;
              next = next.nextSibling;
              span.appendChild(toMove);
            }
          }
        }
      });

      preview.innerHTML = temp.innerHTML;
    }

    // 체크박스 토글
    let morningAutoSaveTimer = null;
    function toggleMorningCheckbox(idx) {
      const lines = morningData.markdown.split('\n');
      let checkCount = 0;
      let toggledText = '';
      let wasChecked = false;
      for (let i = 0; i < lines.length; i++) {
        const match = lines[i].match(/^(\s*-\s*)\[( |x)\](\s*.*)$/i);
        if (match) {
          if (checkCount === idx) {
            wasChecked = match[2].toLowerCase() === 'x';
            lines[i] = `${match[1]}[${wasChecked ? ' ' : 'x'}]${match[3]}`;
            toggledText = match[3].trim();
            break;
          }
          checkCount++;
        }
      }
      morningData.markdown = lines.join('\n');

      // 폼 데이터도 동기화
      syncMarkdownToFormData();

      // 뷰 다시 렌더링
      renderMorningInteractiveView();

      // 원본 편집 에디터도 업데이트
      const editor = document.getElementById('morningMarkdownEditor');
      if (editor) editor.value = morningData.markdown;

      // 자동 저장 (디바운스 1초)
      if (morningAutoSaveTimer) clearTimeout(morningAutoSaveTimer);
      morningAutoSaveTimer = setTimeout(() => autoSaveMorningPlan(), 1000);
    }

    // 체크박스 토글 시 자동 저장
    async function autoSaveMorningPlan() {
      try {
        await fetch(`${API_BASE}/api/morning-plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: morningData.date,
            tasks: morningData.tasks,
            additionalTasks: morningData.additionalTasks,
            goals: morningData.goals,
            focusTime: morningData.focusTime,
            motto: morningData.motto,
            markdown: morningData.markdown
          })
        });
      } catch (err) {
        console.error('자동 저장 실패:', err);
      }
    }

    // 마크다운에서 폼 데이터로 역동기화
    function syncMarkdownToFormData() {
      const lines = morningData.markdown.split('\n');
      const tasks = [];
      let inTasksSection = false;

      for (const line of lines) {
        if (line.startsWith('## 📋')) { inTasksSection = true; continue; }
        if (line.startsWith('## ')) { inTasksSection = false; continue; }
        if (inTasksSection) {
          const m = line.match(/^-\s*\[([ x])\]\s*(.+)$/i);
          if (m) tasks.push(m[2].trim());
        }
      }
      if (tasks.length > 0) morningData.tasks = tasks;
    }

    // 폼에서 morningData로 데이터 수집
    function collectFormData() {
      const tasksEl = document.getElementById('morningTasks');
      if (tasksEl) {
        morningData.tasks = tasksEl.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      }
      const rows = document.querySelectorAll('.additional-task-row');
      if (rows.length > 0) {
        morningData.additionalTasks = Array.from(rows)
          .map(row => ({
            category: row.querySelector('input')?.dataset.category || '기타',
            content: row.querySelector('input')?.value?.trim() || ''
          }))
          .filter(t => t.content.length > 0);
      }
      morningData.goals = [0, 1, 2].map(i =>
        document.getElementById(`morningGoal${i}`)?.value?.trim() || ''
      ).filter(g => g.length > 0);
      const mottoEl = document.getElementById('morningMotto');
      if (mottoEl) morningData.motto = mottoEl.value.trim();
    }

    // ---- 위저드 모드 ----
    function renderMorningStep() {
      const content = document.getElementById('morningContent');
      const prevBtn = document.getElementById('morningPrevBtn');
      const nextBtn = document.getElementById('morningNextBtn');
      const submitBtn = document.getElementById('morningSubmitBtn');

      prevBtn.classList.toggle('hidden', morningStep === 1);
      nextBtn.classList.toggle('hidden', morningStep === 4);
      submitBtn.classList.toggle('hidden', morningStep !== 4);

      for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`mStep${i}Indicator`);
        const circle = indicator.querySelector('span');
        const label = indicator.querySelectorAll('span')[1];

        if (i < morningStep) {
          circle.className = 'w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = '✓';
          label.className = 'text-green-400';
        } else if (i === morningStep) {
          circle.className = 'w-6 h-6 rounded-full bg-amber-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = i;
          label.className = 'text-gray-300';
        } else {
          circle.className = 'w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs';
          circle.textContent = i;
          label.className = 'text-gray-500';
        }
      }

      switch (morningStep) {
        case 1: renderMorningStep1(content); break;
        case 2: renderMorningStep2(content); break;
        case 3: renderMorningStep3(content); break;
        case 4: renderMorningStep4(content); break;
      }
    }

    function renderMorningStep1(content) {
      const tasksText = morningData.tasks.length > 0 ? morningData.tasks.join('\n') : '';
      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">📋 오늘의 업무</h3>
          <p class="text-sm text-gray-400 mb-4">오늘 해야 할 주요 업무를 적어보세요. 한 줄에 하나씩 입력하면 됩니다.</p>
        </div>
        <textarea id="morningTasks"
          class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[200px] resize-none focus:outline-none focus:border-amber-500 text-sm leading-relaxed"
          placeholder="예시:\nPR 리뷰 - frontend 팀\nAPI 엔드포인트 구현\n버그 수정 #234\n문서 업데이트"
        >${escapeHtml(tasksText)}</textarea>
        <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
          <span class="px-2 py-1 bg-gray-800 rounded">💡</span>
          <span>Enter로 줄바꿈하면 각각 별도 업무로 등록됩니다</span>
        </div>
      `;
      setTimeout(() => document.getElementById('morningTasks')?.focus(), 100);
    }

    function renderMorningStep2(content) {
      const categories = ['회의', '리뷰', '학습', '운동', '개인', '기타'];
      const existingItems = morningData.additionalTasks || [];

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">➕ 추가 할 일</h3>
          <p class="text-sm text-gray-400 mb-4">업무 외에 추가로 해야 할 일이 있나요?</p>
        </div>
        <div class="flex flex-wrap gap-1.5 mb-3" id="additionalCategoryTags">
          ${categories.map(cat => `
            <button onclick="selectAdditionalCategory('${cat}')"
              class="additional-cat-btn px-2.5 py-1 rounded-full text-xs font-medium border transition-colors
                ${existingItems.some(i => i.category === cat) ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500 hover:text-amber-300'}"
              data-category="${cat}">${cat}</button>
          `).join('')}
        </div>
        <div id="additionalTasksList" class="space-y-2">
          ${existingItems.map(item => `
            <div class="flex items-center gap-2 additional-task-row">
              <span class="px-2 py-1 bg-amber-900/30 text-amber-300 rounded text-xs min-w-[40px] text-center">${escapeHtml(item.category)}</span>
              <input type="text" value="${escapeHtml(item.content)}"
                class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
                data-category="${escapeHtml(item.category)}" placeholder="${escapeHtml(item.category)} 내용 입력...">
              <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400">×</button>
            </div>
          `).join('')}
        </div>
        <div class="mt-3 text-center">
          <button onclick="addAdditionalTaskRow('기타')" class="text-sm text-gray-500 hover:text-amber-400">+ 직접 추가</button>
        </div>
      `;
    }

    function selectAdditionalCategory(category) {
      addAdditionalTaskRow(category);
      document.querySelectorAll('.additional-cat-btn').forEach(btn => {
        if (btn.dataset.category === category) {
          btn.className = btn.className.replace('bg-gray-800 border-gray-700 text-gray-400', 'bg-amber-600/30 border-amber-500 text-amber-300');
        }
      });
    }

    function addAdditionalTaskRow(category) {
      const list = document.getElementById('additionalTasksList');
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2 additional-task-row';
      row.innerHTML = `
        <span class="px-2 py-1 bg-amber-900/30 text-amber-300 rounded text-xs min-w-[40px] text-center">${escapeHtml(category)}</span>
        <input type="text"
          class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
          data-category="${escapeHtml(category)}" placeholder="${escapeHtml(category)} 내용 입력..." autofocus>
        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400">×</button>
      `;
      list.appendChild(row);
      row.querySelector('input')?.focus();
    }

    function renderMorningStep3(content) {
      const g = morningData.goals || [];
      const focusOptions = [
        { value: 'morning', label: '오전', icon: '🌅' },
        { value: 'afternoon', label: '오후', icon: '☀️' },
        { value: 'evening', label: '저녁', icon: '🌙' },
        { value: 'all-day', label: '하루 종일', icon: '⏰' }
      ];

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">🎯 목표 & 다짐</h3>
          <p class="text-sm text-gray-400 mb-4">오늘의 핵심 목표와 다짐을 정해보세요.</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">🎯 핵심 목표 (최대 3개)</label>
            <div class="space-y-2" id="morningGoalsList">
              ${[0, 1, 2].map(i => `
                <input type="text" id="morningGoal${i}" value="${escapeHtml(g[i] || '')}"
                  class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-amber-500"
                  placeholder="${i === 0 ? '가장 중요한 목표' : i === 1 ? '두 번째 목표 (선택)' : '세 번째 목표 (선택)'}">
              `).join('')}
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">⏰ 집중할 시간대</label>
            <div class="grid grid-cols-4 gap-2">
              ${focusOptions.map(opt => `
                <button onclick="selectFocusTime('${opt.value}')"
                  class="focus-time-btn px-3 py-2.5 rounded-lg text-sm font-medium border transition-all text-center
                    ${morningData.focusTime === opt.value ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500'}"
                  data-value="${opt.value}">
                  <div class="text-lg mb-1">${opt.icon}</div>
                  ${opt.label}
                </button>
              `).join('')}
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">💪 오늘의 한 줄 다짐</label>
            <input type="text" id="morningMotto" value="${escapeHtml(morningData.motto)}"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-amber-500"
              placeholder="오늘 하루를 이끌어갈 한마디!">
          </div>
        </div>
      `;
    }

    function selectFocusTime(value) {
      morningData.focusTime = value;
      document.querySelectorAll('.focus-time-btn').forEach(btn => {
        if (btn.dataset.value === value) {
          btn.className = btn.className
            .replace('bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500', 'bg-amber-600/30 border-amber-500 text-amber-300');
        } else {
          btn.className = btn.className
            .replace('bg-amber-600/30 border-amber-500 text-amber-300', 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500');
        }
      });
    }

    function generateMorningMarkdown() {
      const today = morningData.date;
      const focusLabels = { morning: '오전', afternoon: '오후', evening: '저녁', 'all-day': '하루 종일' };
      let md = `# ☀️ ${today} 하루 시작\n\n`;

      if (morningData.tasks.length > 0) {
        md += `## 📋 오늘의 업무\n`;
        morningData.tasks.forEach(t => { md += `- [ ] ${t}\n`; });
        md += '\n';
      }

      if (morningData.additionalTasks.length > 0) {
        md += `## ➕ 추가 할 일\n`;
        morningData.additionalTasks.forEach(t => {
          md += `- [ ] **${t.category}**: ${t.content}\n`;
        });
        md += '\n';
      }

      const goals = morningData.goals.filter(g => g.trim());
      if (goals.length > 0) {
        md += `## 🎯 오늘의 목표\n`;
        goals.forEach((g, i) => { md += `${i + 1}. ${g}\n`; });
        md += '\n';
      }

      if (morningData.focusTime || morningData.motto) {
        md += `---\n`;
        if (morningData.focusTime) md += `**⏰ 집중 시간**: ${focusLabels[morningData.focusTime] || morningData.focusTime}\n`;
        if (morningData.motto) md += `**💪 오늘의 다짐**: ${morningData.motto}\n`;
      }

      return md;
    }

    function renderMorningStep4(content) {
      morningData.markdown = generateMorningMarkdown();

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">📝 미리보기 & 편집</h3>
          <p class="text-sm text-gray-400 mb-3">체크박스를 클릭하여 완료 표시하거나, 원본을 직접 편집할 수 있습니다.</p>
        </div>
        <div class="flex gap-2 mb-3">
          <button onclick="switchMorningPreviewTab('preview')" id="morningPreviewTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300">
            👁 마크다운
          </button>
          <button onclick="switchMorningPreviewTab('edit')" id="morningEditTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500">
            ✏️ 원본 편집
          </button>
        </div>
        <div id="morningPreviewArea">
          <div id="morningMarkdownPreview"
            class="morning-preview markdown-content bg-gray-800/50 border border-gray-700 rounded-lg p-5 min-h-[300px] text-sm">
          </div>
        </div>
        <div id="morningEditArea" class="hidden">
          <textarea id="morningMarkdownEditor"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[300px] resize-none focus:outline-none focus:border-amber-500 text-sm font-mono leading-relaxed"
            oninput="morningData.markdown = this.value"
          >${escapeHtml(morningData.markdown)}</textarea>
        </div>
      `;
      // 기본적으로 인터랙티브 뷰 표시
      renderMorningInteractiveView();
    }

    function switchMorningPreviewTab(tab) {
      const editArea = document.getElementById('morningEditArea');
      const previewArea = document.getElementById('morningPreviewArea');
      const editTab = document.getElementById('morningEditTab');
      const previewTab = document.getElementById('morningPreviewTab');

      const activeClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300';
      const inactiveClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500';

      if (tab === 'edit') {
        // 원본 편집 (textarea)
        const editor = document.getElementById('morningMarkdownEditor');
        if (editor) editor.value = morningData.markdown;
        editArea.classList.remove('hidden');
        previewArea.classList.add('hidden');
        editTab.className = activeClass;
        previewTab.className = inactiveClass;
      } else {
        // 인터랙티브 마크다운 뷰
        const editor = document.getElementById('morningMarkdownEditor');
        if (editor?.value) morningData.markdown = editor.value;
        editArea.classList.add('hidden');
        previewArea.classList.remove('hidden');
        previewTab.className = activeClass;
        editTab.className = inactiveClass;
        renderMorningInteractiveView();
      }
    }

    function saveMorningStepData() {
      if (morningStep === 1) {
        const text = document.getElementById('morningTasks')?.value || '';
        morningData.tasks = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      } else if (morningStep === 2) {
        const rows = document.querySelectorAll('.additional-task-row');
        morningData.additionalTasks = Array.from(rows)
          .map(row => ({
            category: row.querySelector('input')?.dataset.category || '기타',
            content: row.querySelector('input')?.value?.trim() || ''
          }))
          .filter(t => t.content.length > 0);
      } else if (morningStep === 3) {
        morningData.goals = [0, 1, 2].map(i =>
          document.getElementById(`morningGoal${i}`)?.value?.trim() || ''
        ).filter(g => g.length > 0);
        morningData.motto = document.getElementById('morningMotto')?.value?.trim() || '';
      } else if (morningStep === 4) {
        morningData.markdown = document.getElementById('morningMarkdownEditor')?.value || morningData.markdown;
      }
    }

    function prevMorningStep() {
      saveMorningStepData();
      if (morningStep > 1) {
        morningStep--;
        renderMorningStep();
      }
    }

    function nextMorningStep() {
      saveMorningStepData();
      if (morningStep < 4) {
        morningStep++;
        renderMorningStep();
      }
    }

    async function submitMorningPlan() {
      // 편집 모드면 폼에서 데이터 수집
      if (morningEditMode) {
        collectFormData();
        // 마크다운 에디터가 열려있으면 그 내용 사용
        const mdEditor = document.getElementById('morningMarkdownEditor');
        morningData.markdown = mdEditor?.value || generateMorningMarkdown();
      } else {
        saveMorningStepData();
      }

      try {
        const res = await fetch(`${API_BASE}/api/morning-plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            date: morningData.date,
            tasks: morningData.tasks,
            additionalTasks: morningData.additionalTasks,
            goals: morningData.goals,
            focusTime: morningData.focusTime,
            motto: morningData.motto,
            markdown: morningData.markdown || generateMorningMarkdown()
          })
        });

        const data = await res.json();
        if (data.success) {
          closeMorningStartModal();
          showToast(morningEditMode ? '💾 계획이 수정되었습니다!' : '☀️ 오늘의 계획이 저장되었습니다! 좋은 하루 되세요!', 'success');
          checkMorningPlanExists();
          refreshTodaySummary();
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        showToast('계획 저장 실패: ' + err.message, 'error');
      }
    }

    // 다음 예정된 작업 표시
    async function showNextJobs() {
      try {
        const res = await fetch(`${API_BASE}/api/jobs`);
        const data = await res.json();

        // 스케줄이 있는 작업만 필터링
        const scheduledJobs = data.jobs.filter(j => j.schedule && j.schedule.trim());

        if (scheduledJobs.length === 0) {
          showToast('예정된 작업이 없습니다', 'info');
          return;
        }

        // 다음 실행 시간 계산
        const now = new Date();
        const jobsWithNext = scheduledJobs.map(j => {
          const next = getNextCronTime(j.schedule);
          return { ...j, nextRun: next };
        }).sort((a, b) => (a.nextRun?.getTime() || Infinity) - (b.nextRun?.getTime() || Infinity));

        // 모달 표시
        const modal = document.getElementById('sessionDetailModal');
        const content = document.getElementById('sessionDetailContent');

        content.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-lg">⏰</div>
              <div>
                <h3 class="text-lg font-bold">예정된 작업</h3>
                <p class="text-xs text-gray-400">${scheduledJobs.length}개 스케줄된 작업</p>
              </div>
            </div>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
          </div>

          <div class="space-y-3 max-h-[60vh] overflow-auto custom-scrollbar">
            ${jobsWithNext.slice(0, 10).map(j => `
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600/30 hover:bg-gray-700/70 transition-colors">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-medium">${j.name}</span>
                  <span class="text-xs px-2 py-1 bg-gray-600 rounded">${j.schedule}</span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                  ${j.nextRun ? `
                    <span class="text-blue-400">
                      ⏱ ${formatTimeUntil(j.nextRun)}
                    </span>
                    <span class="text-gray-500">
                      ${j.nextRun.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                    </span>
                  ` : '<span class="text-gray-500">스케줄 파싱 불가</span>'}
                </div>
                ${j.description ? `<p class="text-xs text-gray-400 mt-2">${j.description}</p>` : ''}
              </div>
            `).join('')}
          </div>

          <div class="mt-4 pt-4 border-t border-gray-700">
            <button onclick="showTab('jobs'); closeSessionModal();" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium">
              📋 전체 작업 목록 보기
            </button>
          </div>
        `;

        modal.style.display = 'flex';
      } catch (err) {
        showToast('작업 목록 로드 실패: ' + err.message, 'error');
      }
    }

    // 다음 크론 실행 시간 계산 (간단한 구현)
    function getNextCronTime(cronExpr) {
      if (!cronExpr) return null;

      try {
        const parts = cronExpr.split(' ');
        if (parts.length < 5) return null;

        const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;
        const now = new Date();

        // 간단한 케이스 처리 (매일, 매시간 등)
        let next = new Date(now);

        if (minute !== '*') {
          const m = parseInt(minute);
          if (!isNaN(m)) next.setMinutes(m);
        }

        if (hour !== '*') {
          const h = parseInt(hour);
          if (!isNaN(h)) next.setHours(h);
        }

        next.setSeconds(0);
        next.setMilliseconds(0);

        // 이미 지났으면 다음으로
        if (next <= now) {
          if (hour === '*') {
            next.setHours(next.getHours() + 1);
          } else {
            next.setDate(next.getDate() + 1);
          }
        }

        return next;
      } catch (e) {
        return null;
      }
    }

    // 시간 포맷팅
    function formatTimeUntil(date) {
      const now = new Date();
      const diff = date.getTime() - now.getTime();

      if (diff < 0) return '지남';

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}시간 ${minutes % 60}분 후`;
      }
      return `${minutes}분 후`;
    }

    // Init
    (async function init() {
      // 브라우저 알림 설정 로드 (서버 설정 로드 전에 localStorage에서)
      currentSettings.browserNotifications = localStorage.getItem('browserNotifications') === 'true';

      await loadJobs();
      populateCategorySelect();

      // Today's Summary 로드
      refreshTodaySummary();

      // 홈 대시보드 로드
      initHomeDate();
      loadHomeDashboard();

      // SSE 연결 초기화 (비동기 작업 시스템)
      initSSE();

      // URL 파라미터 처리
      handleUrlParams();
    })();

    // ============ Touch Interactions (Mobile) ============
    (function initTouchInteractions() {
      const TAB_ORDER = ['home', 'jobs', 'settings', 'sessions', 'notes', 'analysis'];
      let touchStartX = 0, touchStartY = 0, touchStartTime = 0;

      function getCurrentTabIndex() {
        return TAB_ORDER.findIndex(t => {
          const panel = document.getElementById(`panel-${t}`);
          return panel && !panel.classList.contains('hidden');
        });
      }

      // Swipe left/right → switch tabs
      document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        touchStartTime = Date.now();
      }, { passive: true });

      document.addEventListener('touchend', e => {
        // Ignore if touch was inside a scrollable widget, modal, or input
        if (e.target.closest('.modal[style*="flex"]') || e.target.closest('input, textarea, select, canvas, #timeRangeSlider')) return;

        const dx = e.changedTouches[0].screenX - touchStartX;
        const dy = e.changedTouches[0].screenY - touchStartY;
        const dt = Date.now() - touchStartTime;

        // Must be horizontal swipe: |dx| > 60, |dy| < 80, fast enough
        if (Math.abs(dx) < 60 || Math.abs(dy) > 80 || dt > 400) return;

        const idx = getCurrentTabIndex();
        if (dx < 0 && idx < TAB_ORDER.length - 1) {
          showTab(TAB_ORDER[idx + 1]);
        } else if (dx > 0 && idx > 0) {
          showTab(TAB_ORDER[idx - 1]);
        }
      }, { passive: true });

      // Pull-to-refresh
      let pullStartY = 0, isPulling = false;
      const indicator = document.getElementById('pullRefreshIndicator');

      document.addEventListener('touchstart', e => {
        if (window.scrollY <= 0 && !document.querySelector('.modal[style*="flex"]')) {
          pullStartY = e.touches[0].clientY;
          isPulling = true;
        }
      }, { passive: true });

      document.addEventListener('touchmove', e => {
        if (!isPulling) return;
        const pullDist = e.touches[0].clientY - pullStartY;
        if (pullDist > 30 && pullDist < 120) {
          indicator.classList.add('visible');
        }
      }, { passive: true });

      document.addEventListener('touchend', () => {
        if (!isPulling) return;
        isPulling = false;
        if (indicator.classList.contains('visible')) {
          indicator.classList.remove('visible');
          // Refresh current tab data
          const idx = getCurrentTabIndex();
          const tab = TAB_ORDER[idx];
          if (tab === 'home') loadHomeDashboard();
          else if (tab === 'jobs') loadJobs();
          else if (tab === 'sessions') initSessionsTab();
          else if (tab === 'notes') loadNotes();
          else if (tab === 'analysis') showAnalysisSubTab(currentAnalysisSubTab);
          showToast('새로고침됨', 'success');
        }
      }, { passive: true });
    })();

    // ============ Obsidian 경로 미리보기 ============
    function updateObsidianPreview() {
      try {
        const vaultPath = document.getElementById('settingsObsidianVaultPath')?.value?.trim();
        const noVault = !vaultPath;
        const base = noVault ? '(Vault 경로를 설정하세요)' : vaultPath;
        const el = id => document.getElementById(id);
        el('obsidianExportPreview').textContent = noVault ? base : `${base}/Claude Sessions/YYYY-MM/`;
        el('obsidianMorningPreview').textContent = noVault ? base : `${base}/${document.getElementById('settingsObsidianMorningFolder')?.value?.trim() || 'Morning Plans'}/`;
        el('obsidianReportPreview').textContent = noVault ? base : `${base}/${document.getElementById('settingsObsidianReportFolder')?.value?.trim() || 'Daily Reports'}/`;
        el('obsidianWeeklyPreview').textContent = noVault ? base : `${base}/${document.getElementById('settingsObsidianWeeklyFolder')?.value?.trim() || 'WEEKLY'}/`;
      } catch (e) { /* ignore */ }
    }

    // ============ Phase 4: AI Deep Integration ============

    let knowledgeNetwork = null;
    let knowledgeGraphData = null;

    // --- 4.1 세션 서브탭 ---
    function showSessionsSubTab(sub) {
      document.querySelectorAll('.sessions-sub-btn').forEach(btn => {
        btn.className = 'sessions-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white';
      });
      const activeBtn = document.getElementById(`sessionsSub-${sub}`);
      if (activeBtn) activeBtn.className = 'sessions-sub-btn px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white';

      ['list', 'graph', 'review'].forEach(s => {
        const panel = document.getElementById(`sessionsSubPanel-${s}`);
        if (panel) panel.classList.toggle('hidden', s !== sub);
      });

      if (sub === 'graph' && !knowledgeNetwork) {
        loadKnowledgeGraphUI();
      }
      if (sub === 'review') {
        loadReviewAnalysisCache();
      }
    }

    // --- 4.2 세션 인사이트 ---

    async function loadSessionInsightsTab(sessionId, projectPath) {
      if (insightsLoadedFor === sessionId) return;
      insightsLoadedFor = sessionId;

      const contentDiv = document.getElementById('sessionInsightsContent');
      if (!contentDiv) return;

      contentDiv.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-gray-500 py-8">
          <div class="w-4 h-4 border-2 border-gray-600 border-t-blue-400 rounded-full animate-spin"></div>
          <span>인사이트 로드 중...</span>
        </div>`;

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}/insights?project=${encodeURIComponent(projectPath)}`);
        const data = await res.json();

        if (data.cached || data.insights) {
          renderSessionInsights(data.insights);
        } else if (data.taskId) {
          contentDiv.innerHTML = `
            <div class="flex items-center justify-center gap-2 text-blue-400 py-8">
              <div class="w-4 h-4 border-2 border-gray-600 border-t-blue-400 rounded-full animate-spin"></div>
              <span>AI 분석 생성 중... (최대 1분)</span>
            </div>`;

          // 폴링
          const pollInterval = setInterval(async () => {
            try {
              const taskRes = await fetch(`${API_BASE}/api/tasks/${data.taskId}`);
              const task = await taskRes.json();
              if (task.status === 'completed' && task.result?.insights) {
                clearInterval(pollInterval);
                renderSessionInsights(task.result.insights);
              } else if (task.status === 'failed') {
                clearInterval(pollInterval);
                contentDiv.innerHTML = `<div class="text-center text-red-400 py-8">인사이트 생성 실패: ${escapeHtml(task.error || '알 수 없는 오류')}</div>`;
                insightsLoadedFor = null;
              }
            } catch { /* 무시 */ }
          }, 2000);

          setTimeout(() => {
            clearInterval(pollInterval);
            if (contentDiv.querySelector('.animate-spin')) {
              contentDiv.innerHTML = '<div class="text-center text-yellow-400 py-8">분석 시간 초과. 나중에 다시 시도해주세요.</div>';
              insightsLoadedFor = null;
            }
          }, 90000);
        }
      } catch (err) {
        contentDiv.innerHTML = `<div class="text-center text-red-400 py-8">로드 실패: ${escapeHtml(err.message)}</div>`;
        insightsLoadedFor = null;
      }
    }

    function renderSessionInsights(insights) {
      const contentDiv = document.getElementById('sessionInsightsContent');
      if (!contentDiv) return;

      const complexityColors = { low: 'text-green-400', medium: 'text-yellow-400', high: 'text-red-400' };
      const complexityIcons = { low: '🟢', medium: '🟡', high: '🔴' };

      contentDiv.innerHTML = `
        <!-- 요약 -->
        <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-lg p-4 border border-blue-500/30 mb-4">
          <div class="flex items-start gap-3">
            <div class="text-2xl">${complexityIcons[insights.complexity] || '⚪'}</div>
            <div>
              <div class="text-xs text-gray-400 mb-1">요약</div>
              <div class="text-sm font-medium">${escapeHtml(insights.summary || '요약 없음')}</div>
              <div class="text-xs text-gray-500 mt-1">복잡도: <span class="${complexityColors[insights.complexity] || ''}">${insights.complexity || 'unknown'}</span></div>
            </div>
          </div>
        </div>

        <!-- 토픽 & 기술 -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
            <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-3">📚 다룬 주제</h4>
            <div class="flex flex-wrap gap-2">
              ${(insights.topics || []).map(t => `<span class="inline-block px-2.5 py-1 rounded-full bg-blue-600/20 text-blue-300 text-xs border border-blue-500/30">${escapeHtml(t)}</span>`).join('') || '<span class="text-xs text-gray-500">없음</span>'}
            </div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
            <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-3">🔧 사용 기술</h4>
            <div class="flex flex-wrap gap-2">
              ${(insights.technologies || []).map(t => `<span class="inline-block px-2.5 py-1 rounded-full bg-green-600/20 text-green-300 text-xs border border-green-500/30">${escapeHtml(t)}</span>`).join('') || '<span class="text-xs text-gray-500">없음</span>'}
            </div>
          </div>
        </div>

        ${(insights.problems_solved?.length) ? `
        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50 mb-4">
          <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-3">✅ 해결한 문제</h4>
          <ul class="space-y-2">
            ${insights.problems_solved.map(p => `<li class="flex items-start gap-2 text-sm"><span class="text-green-400 flex-shrink-0 mt-0.5">•</span><span>${escapeHtml(p)}</span></li>`).join('')}
          </ul>
        </div>` : ''}

        ${(insights.key_decisions?.length) ? `
        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50 mb-4">
          <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-3">🎯 주요 결정</h4>
          <ul class="space-y-2">
            ${insights.key_decisions.map(d => `<li class="flex items-start gap-2 text-sm"><span class="text-yellow-400 flex-shrink-0 mt-0.5">•</span><span>${escapeHtml(d)}</span></li>`).join('')}
          </ul>
        </div>` : ''}

        ${(insights.files_modified?.length) ? `
        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
          <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-3">📁 주요 파일</h4>
          <div class="flex flex-wrap gap-2">
            ${insights.files_modified.slice(0, 15).map(f => `<span class="inline-block px-2 py-1 rounded bg-gray-700/70 text-gray-300 text-xs font-mono border border-gray-600/50">${escapeHtml(f)}</span>`).join('')}
          </div>
        </div>` : ''}
      `;
    }

    // --- 4.3 지식 그래프 ---
    async function loadKnowledgeGraphUI() {
      const minMentions = document.getElementById('graphMinMentions')?.value || '2';
      const container = document.getElementById('knowledgeGraphContainer');

      try {
        const res = await fetch(`${API_BASE}/api/knowledge-graph?minMentions=${minMentions}`);
        const data = await res.json();
        knowledgeGraphData = data;

        // 통계 표시
        const statsDiv = document.getElementById('knowledgeGraphStats');
        if (statsDiv) {
          statsDiv.innerHTML = `
            <span>노드: <strong class="text-gray-300">${data.nodes?.length || 0}</strong></span>
            <span>연결: <strong class="text-gray-300">${data.edges?.length || 0}</strong></span>
            ${data.metadata?.lastUpdated ? `<span>마지막 업데이트: <strong class="text-gray-300">${new Date(data.metadata.lastUpdated).toLocaleDateString('ko-KR')}</strong></span>` : ''}
          `;
        }

        if (!data.nodes || data.nodes.length === 0) {
          container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 text-sm">지식 그래프가 비어있습니다.<br>세션 인사이트를 생성하거나 메모를 추가해보세요.</div>';
          return;
        }

        renderKnowledgeGraphVis(data);
      } catch (err) {
        container.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">로드 실패: ${escapeHtml(err.message)}</div>`;
      }
    }

    function renderKnowledgeGraphVis(graphData) {
      const container = document.getElementById('knowledgeGraphContainer');
      container.innerHTML = '';

      const categoryColors = {
        work: { background: '#f59e0b', border: '#d97706' },
        learning: { background: '#3b82f6', border: '#2563eb' },
        idea: { background: '#8b5cf6', border: '#7c3aed' },
        issue: { background: '#ef4444', border: '#dc2626' },
        personal: { background: '#10b981', border: '#059669' },
        todo: { background: '#06b6d4', border: '#0891b2' },
        general: { background: '#6b7280', border: '#4b5563' }
      };

      const nodes = new vis.DataSet(
        graphData.nodes.map(n => ({
          id: n.id,
          label: n.label,
          value: n.mentions,
          color: categoryColors[n.category] || categoryColors.general,
          font: { color: '#f3f4f6', size: 14 },
          title: `<b>${n.label}</b><br>언급: ${n.mentions}회<br>마지막: ${n.lastSeen}<br>세션: ${n.sources?.sessions?.length || 0}개 | 메모: ${n.sources?.memos?.length || 0}개`
        }))
      );

      const edges = new vis.DataSet(
        graphData.edges.map((e, i) => ({
          id: `edge-${i}`,
          from: e.from,
          to: e.to,
          value: e.strength,
          color: { color: '#4b5563', highlight: '#9ca3af' },
          title: `${e.context}<br>강도: ${e.strength}`
        }))
      );

      const options = {
        nodes: {
          shape: 'dot',
          scaling: { min: 12, max: 40, label: { enabled: true, min: 12, max: 18 } }
        },
        edges: {
          width: 1,
          scaling: { min: 1, max: 5 },
          smooth: { type: 'continuous' }
        },
        physics: {
          barnesHut: { gravitationalConstant: -4000, centralGravity: 0.3, springLength: 120, springConstant: 0.04 },
          stabilization: { enabled: true, iterations: 200 }
        },
        interaction: {
          hover: true,
          tooltipDelay: 100,
          navigationButtons: true,
          keyboard: { enabled: false }
        }
      };

      if (knowledgeNetwork) knowledgeNetwork.destroy();
      knowledgeNetwork = new vis.Network(container, { nodes, edges }, options);

      knowledgeNetwork.on('click', (params) => {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = graphData.nodes.find(n => n.id === nodeId);
          if (node) showTopicDetail(node);
        }
      });

      knowledgeNetwork.on('doubleClick', (params) => {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = graphData.nodes.find(n => n.id === nodeId);
          if (node) showTopicRecommendations(node.label);
        }
      });
    }

    function showTopicDetail(node) {
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');

      content.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-lg">🔍</div>
            <div>
              <h3 class="text-lg font-bold">${escapeHtml(node.label)}</h3>
              <p class="text-xs text-gray-400">${node.mentions}회 언급 · 마지막: ${node.lastSeen}</p>
            </div>
          </div>
          <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-gray-700/30 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500 mb-1">관련 세션</div>
            <div class="text-2xl font-bold text-purple-400">${node.sources?.sessions?.length || 0}</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500 mb-1">관련 메모</div>
            <div class="text-2xl font-bold text-green-400">${node.sources?.memos?.length || 0}</div>
          </div>
        </div>

        <div class="flex gap-2">
          <button onclick="showTopicRecommendations('${escapeHtml(node.label)}')" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-sm font-medium transition-colors">
            💡 관련 추천 보기
          </button>
        </div>
      `;

      modal.style.display = 'flex';
    }

    async function showTopicRecommendations(topic) {
      try {
        const res = await fetch(`${API_BASE}/api/knowledge-graph/recommendations?topic=${encodeURIComponent(topic)}`);
        const data = await res.json();

        const modal = document.getElementById('sessionDetailModal');
        const content = document.getElementById('sessionDetailContent');

        content.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold">💡 "${escapeHtml(topic)}" 관련 추천</h3>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
          </div>

          ${data.related?.length > 0 ? `
          <div class="mb-6">
            <h4 class="text-sm font-semibold text-blue-400 mb-3">🔗 관련 주제</h4>
            <div class="space-y-2">
              ${data.related.map(r => `
                <div class="bg-gray-700/30 rounded-lg p-3 hover:bg-gray-700/50 transition-colors">
                  <div class="font-medium text-sm">${escapeHtml(r.topic)}</div>
                  <div class="text-xs text-gray-400 mt-0.5">${escapeHtml(r.reason)}</div>
                </div>
              `).join('')}
            </div>
          </div>` : '<div class="mb-6 text-gray-500 text-sm">관련 주제가 없습니다.</div>'}

          ${data.review_needed?.length > 0 ? `
          <div>
            <h4 class="text-sm font-semibold text-yellow-400 mb-3">📚 복습 추천</h4>
            <div class="space-y-2">
              ${data.review_needed.map(r => `
                <div class="bg-yellow-900/20 border border-yellow-700/30 rounded-lg p-3">
                  <div class="font-medium text-sm">${escapeHtml(r.topic)}</div>
                  <div class="text-xs text-gray-400 mt-0.5">${escapeHtml(r.reason)} · 마지막: ${r.lastSeen}</div>
                </div>
              `).join('')}
            </div>
          </div>` : ''}
        `;

        modal.style.display = 'flex';
      } catch (err) {
        showToast('추천 로드 실패: ' + err.message, 'error');
      }
    }

    async function rebuildKnowledgeGraphUI() {
      try {
        showToast('지식 그래프 재구성 중...', 'info');
        const res = await fetch(`${API_BASE}/api/knowledge-graph/rebuild`, { method: 'POST' });
        const data = await res.json();
        showToast(`재구성 완료: ${data.nodes}개 노드, ${data.edges}개 연결`, 'success');
        knowledgeNetwork = null;
        loadKnowledgeGraphUI();
      } catch (err) {
        showToast('재구성 실패: ' + err.message, 'error');
      }
    }

    // --- 4.4 코드 리뷰 분석 ---
    async function loadReviewAnalysisCache() {
      const container = document.getElementById('reviewAnalysisContent');
      try {
        const res = await fetch(`${API_BASE}/api/github/review-analysis`);
        const data = await res.json();
        if (data.analysis) {
          renderReviewAnalysis(data.analysis);
        }
      } catch { /* 캐시 없으면 무시 */ }
    }

    async function generateReviewAnalysis() {
      const container = document.getElementById('reviewAnalysisContent');
      const days = document.getElementById('reviewDays')?.value || '30';

      container.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-blue-400 py-12">
          <div class="w-5 h-5 border-2 border-gray-600 border-t-blue-400 rounded-full animate-spin"></div>
          <span>리뷰 분석 생성 중... (최대 2분)</span>
        </div>`;

      try {
        const res = await fetch(`${API_BASE}/api/github/review-analysis`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ days: parseInt(days) })
        });
        const data = await res.json();

        if (data.cached) {
          renderReviewAnalysis(data);
          return;
        }

        if (data.taskId) {
          const pollInterval = setInterval(async () => {
            try {
              const taskRes = await fetch(`${API_BASE}/api/tasks/${data.taskId}`);
              const task = await taskRes.json();
              if (task.status === 'completed' && task.result) {
                clearInterval(pollInterval);
                renderReviewAnalysis(task.result);
                showToast('리뷰 분석 완료', 'success');
              } else if (task.status === 'failed') {
                clearInterval(pollInterval);
                container.innerHTML = `<div class="text-center text-red-400 py-12">분석 실패: ${escapeHtml(task.error || '')}</div>`;
              }
            } catch { /* 무시 */ }
          }, 3000);

          setTimeout(() => { clearInterval(pollInterval); }, 180000);
        }
      } catch (err) {
        container.innerHTML = `<div class="text-center text-red-400 py-12">분석 실패: ${escapeHtml(err.message)}</div>`;
      }
    }

    function renderReviewAnalysis(data) {
      const container = document.getElementById('reviewAnalysisContent');
      const analysis = data.analysis || data;
      const checklistCategoryColors = {
        security: 'border-red-500/50 bg-red-900/20', performance: 'border-yellow-500/50 bg-yellow-900/20',
        style: 'border-blue-500/50 bg-blue-900/20', testing: 'border-green-500/50 bg-green-900/20'
      };

      container.innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-gray-700/30 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500 mb-1">분석 기간</div>
            <div class="text-lg font-bold text-gray-300">${escapeHtml(data.period || '')}</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500 mb-1">리뷰 수</div>
            <div class="text-lg font-bold text-purple-400">${data.reviewCount || 0}</div>
          </div>
          <div class="bg-gray-700/30 rounded-lg p-4 text-center">
            <div class="text-xs text-gray-500 mb-1">리뷰 스타일</div>
            <div class="text-sm text-gray-300">${escapeHtml(analysis.review_style || '-')}</div>
          </div>
        </div>

        ${analysis.summary ? `
        <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg p-4 border border-purple-500/30 mb-6">
          <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">요약</h4>
          <p class="text-sm">${escapeHtml(analysis.summary)}</p>
        </div>` : ''}

        ${analysis.common_patterns?.length ? `
        <div class="mb-6">
          <h4 class="text-sm font-semibold text-amber-400 mb-3">🔍 자주 지적하는 패턴</h4>
          <ul class="space-y-2">
            ${analysis.common_patterns.map(p => `<li class="flex items-start gap-2 text-sm"><span class="text-amber-400">•</span>${escapeHtml(p)}</li>`).join('')}
          </ul>
        </div>` : ''}

        ${analysis.suggestions?.length ? `
        <div class="mb-6">
          <h4 class="text-sm font-semibold text-blue-400 mb-3">💡 개선 제안</h4>
          <ul class="space-y-2">
            ${analysis.suggestions.map(s => `<li class="flex items-start gap-2 text-sm"><span class="text-blue-400">•</span>${escapeHtml(s)}</li>`).join('')}
          </ul>
        </div>` : ''}

        ${analysis.checklist?.length ? `
        <div>
          <h4 class="text-sm font-semibold text-green-400 mb-3">✅ 리뷰 체크리스트</h4>
          <div class="space-y-2">
            ${analysis.checklist.map(c => {
              const colors = checklistCategoryColors[c.category] || 'border-gray-500/50 bg-gray-900/20';
              return `<div class="flex items-start gap-3 p-3 rounded-lg border ${colors}">
                <span class="text-xs px-1.5 py-0.5 rounded ${colors} font-medium uppercase">${escapeHtml(c.category || '')}</span>
                <span class="text-sm">${escapeHtml(c.item)}</span>
              </div>`;
            }).join('')}
          </div>
        </div>` : ''}

        <div class="text-xs text-gray-600 mt-4 text-right">
          생성: ${data.createdAt ? new Date(data.createdAt).toLocaleDateString('ko-KR') : '-'}
        </div>
      `;
    }

  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('[SW] registered:', reg.scope))
          .catch(err => console.error('[SW] registration failed:', err));
      });
    }
  </script>
</body>
</html>
