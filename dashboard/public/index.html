<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Pipeline Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- vis-network for graph visualization -->
  <link href="https://unpkg.com/vis-network@9.1.9/styles/vis-network.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
  <!-- Chart.js for statistics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Marked.js for markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .job-card { transition: all 0.2s ease; }
    .job-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .modal { display: none; }
    .modal.active { display: flex; }
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    /* Line clamp */
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    /* Markdown content styles */
    .markdown-content h1 { font-size: 1.5em; font-weight: bold; margin: 1em 0 0.5em; color: #f3f4f6; border-bottom: 1px solid #374151; padding-bottom: 0.3em; }
    .markdown-content h2 { font-size: 1.25em; font-weight: bold; margin: 1em 0 0.5em; color: #e5e7eb; }
    .markdown-content h3 { font-size: 1.1em; font-weight: bold; margin: 0.8em 0 0.4em; color: #d1d5db; }
    .markdown-content p { margin: 0.5em 0; line-height: 1.6; }
    .markdown-content ul, .markdown-content ol { margin-left: 1.5em; margin-bottom: 0.5em; padding-left: 0.5em; }
    .markdown-content ul { list-style-type: disc; }
    .markdown-content ol { list-style-type: decimal; }
    .markdown-content li { margin-bottom: 0.25em; }
    .markdown-content code { background: #374151; padding: 0.1em 0.3em; border-radius: 3px; font-size: 0.9em; color: #fbbf24; }
    .markdown-content pre { background: #1f2937; padding: 1em; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
    .markdown-content pre code { background: transparent; padding: 0; color: #e5e7eb; }
    .markdown-content blockquote { border-left: 3px solid #6366f1; padding-left: 1em; margin: 0.5em 0; color: #9ca3af; }
    .markdown-content table { border-collapse: collapse; width: 100%; margin: 0.5em 0; }
    .markdown-content th, .markdown-content td { border: 1px solid #4b5563; padding: 0.5em 0.75em; text-align: left; }
    .markdown-content th { background: #374151; font-weight: 600; }
    .markdown-content hr { border: none; border-top: 1px solid #4b5563; margin: 1em 0; }
    .markdown-content a { color: #60a5fa; text-decoration: underline; }
    .markdown-content strong { color: #f3f4f6; }
    /* Morning preview compact styles */
    .morning-preview h1 { font-size: 1.2em; font-weight: bold; margin: 0 0 0.5em; color: #f3f4f6; }
    .morning-preview h2 { font-size: 1em; font-weight: bold; margin: 0.7em 0 0.3em; color: #e5e7eb; }
    .morning-preview ul, .morning-preview ol { margin: 0.2em 0 0.2em 1.2em; padding: 0; }
    .morning-preview li { margin-bottom: 0.1em; line-height: 1.5; }
    .morning-preview p { margin: 0.2em 0; line-height: 1.5; }
    .morning-preview hr { border: none; border-top: 1px solid #4b5563; margin: 0.5em 0; }
    .morning-preview strong { color: #f3f4f6; }
    .morning-preview input[type="checkbox"] { margin-right: 0.3em; }
    /* ì¸í„°ë™í‹°ë¸Œ ì²´í¬ë°•ìŠ¤ ì•„ì´í…œ */
    #morningMarkdownPreview li { padding: 0.3em 0.5em; border-radius: 0.375em; transition: background-color 0.15s; }
    #morningMarkdownPreview li:hover { background-color: rgba(251, 191, 36, 0.08); }
    #morningMarkdownPreview li label { display: inline-flex; align-items: flex-start; gap: 0.5em; cursor: pointer; width: 100%; }
    #morningMarkdownPreview li input[type="checkbox"] { accent-color: #f59e0b; width: 1.1em; height: 1.1em; margin-top: 0.15em; cursor: pointer; }
    /* Graph view styles */
    #graphView { display: none; }
    #graphView.active { display: block; }
    .view-btn.active { background-color: #3b82f6; }
    /* Context menu */
    .context-menu {
      position: absolute;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 4px 0;
      min-width: 150px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .context-menu-item {
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .context-menu-item:hover { background: #374151; }
    .context-menu-divider { border-top: 1px solid #374151; margin: 4px 0; }
    /* vis-network manipulation toolbar dark theme */
    div.vis-network div.vis-manipulation {
      background: #1f2937 !important;
      border-bottom: 1px solid #374151 !important;
      padding: 8px !important;
    }
    div.vis-network div.vis-manipulation div.vis-button,
    div.vis-network div.vis-edit-mode div.vis-button {
      color: #e5e7eb !important;
      background: #374151 !important;
      border: 1px solid #4b5563 !important;
      border-radius: 6px !important;
      padding: 6px 12px !important;
      margin: 0 4px !important;
    }
    div.vis-network div.vis-manipulation div.vis-button:hover,
    div.vis-network div.vis-edit-mode div.vis-button:hover {
      background: #4b5563 !important;
      box-shadow: none !important;
    }
    div.vis-network div.vis-manipulation div.vis-separator-line {
      background-color: #4b5563 !important;
    }
    /* Date input ë‹¤í¬ í…Œë§ˆ */
    input[type="date"] {
      color-scheme: dark;
    }
    /* í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ë¹„í™œì„±í™” */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* Graph controls */
    .graph-controls {
      position: absolute;
      top: 12px;
      left: 12px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .graph-control-btn {
      background: #374151;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }
    .graph-control-btn:hover {
      background: #4b5563;
    }
    /* Zoom controls */
    .zoom-controls {
      position: absolute;
      bottom: 12px;
      left: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      z-index: 10;
    }
    .zoom-btn {
      background: #374151;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      width: 36px;
      height: 36px;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .zoom-btn:hover {
      background: #4b5563;
    }
    /* Legend */
    .graph-legend {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 12px;
      font-size: 12px;
      z-index: 10;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .legend-item:last-child {
      margin-bottom: 0;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .legend-line {
      width: 24px;
      height: 2px;
    }
    /* Side panel */
    .graph-side-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: #1f2937;
      border-left: 1px solid #374151;
      padding: 16px;
      transform: translateX(100%);
      transition: transform 0.2s ease;
      z-index: 20;
      overflow-y: auto;
    }
    .graph-side-panel.open {
      transform: translateX(0);
    }
    .side-panel-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 20px;
      cursor: pointer;
    }
    .side-panel-close:hover {
      color: #fff;
    }
    /* Array input tags */
    .array-input-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px;
      background: #374151;
      border: 1px solid #4b5563;
      border-radius: 6px;
      min-height: 42px;
      align-items: center;
    }
    .array-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #4b5563;
      border: 1px solid #6b7280;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      max-width: 100%;
    }
    .array-tag span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .array-tag-remove {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      line-height: 1;
      flex-shrink: 0;
    }
    .array-tag-remove:hover {
      color: #ef4444;
    }
    .array-input {
      flex: 1;
      min-width: 120px;
      background: transparent;
      border: none;
      outline: none;
      color: #e5e7eb;
      font-size: 13px;
    }
    .array-input::placeholder {
      color: #6b7280;
    }
    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      pointer-events: auto;
      animation: toast-in 0.3s ease;
      max-width: 350px;
    }
    .toast.toast-out {
      animation: toast-out 0.3s ease forwards;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    .toast-success { background: #065f46; border: 1px solid #10b981; }
    .toast-error { background: #7f1d1d; border: 1px solid #ef4444; }
    .toast-info { background: #1e3a5f; border: 1px solid #3b82f6; }
    .toast-warning { background: #78350f; border: 1px solid #f59e0b; }
    .toast-icon { font-size: 18px; }
    .toast-message { flex: 1; font-size: 14px; }
    .toast-close {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      line-height: 1;
    }
    .toast-close:hover { color: #fff; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>
  <!-- Header -->
  <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ğŸ¤–</span>
        <h1 class="text-xl font-bold">AI Pipeline Dashboard</h1>
      </div>
      <div class="flex items-center gap-4">
        <span id="statusIndicator" class="flex items-center gap-2 text-sm text-gray-400">
          <span class="status-dot bg-green-500"></span>
          <span id="jobCount">0</span> jobs scheduled
        </span>
        <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium">
          + ì‘ì—… ì¶”ê°€
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6">
    <!-- Tabs -->
    <div class="flex gap-4 mb-6 border-b border-gray-700">
      <button onclick="showTab('home')" id="tab-home" class="tab-btn px-4 py-2 border-b-2 border-blue-500 text-blue-400 font-medium">
        ğŸ  í™ˆ
      </button>
      <button onclick="showTab('jobs')" id="tab-jobs" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        ğŸ“¦ ì‘ì—…
      </button>
      <button onclick="showTab('settings')" id="tab-settings" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        âš™ï¸ ì„¤ì •
      </button>
      <button onclick="showTab('sessions')" id="tab-sessions" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        ğŸ¤– ì„¸ì…˜
      </button>
      <button onclick="showTab('notes')" id="tab-notes" class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200">
        ğŸ“‹ ë…¸íŠ¸
      </button>
    </div>

    <!-- Home Dashboard -->
    <div id="panel-home">
      <!-- 4ì¹¸ ìš”ì•½ ì¹´ë“œ -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div onclick="showTab('jobs')" class="cursor-pointer bg-gradient-to-br from-blue-900/40 to-blue-800/20 border border-blue-800/30 rounded-xl p-5 hover:border-blue-600/50 hover:scale-[1.02] transition-all">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-400">ì‘ì—…</span>
            <span class="text-blue-400 text-lg">ğŸ“¦</span>
          </div>
          <div id="homeJobsActive" class="text-3xl font-bold">-</div>
          <div id="homeJobsDesc" class="text-xs text-gray-500 mt-1">í™œì„± ì‘ì—…</div>
        </div>
        <div onclick="showTab('jobs'); setTimeout(()=>showJobSubTab('history'),50)" class="cursor-pointer bg-gradient-to-br from-green-900/40 to-green-800/20 border border-green-800/30 rounded-xl p-5 hover:border-green-600/50 hover:scale-[1.02] transition-all">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-400">ì˜¤ëŠ˜ ì‹¤í–‰</span>
            <span class="text-green-400 text-lg">â–¶ï¸</span>
          </div>
          <div id="homeTodayRuns" class="text-3xl font-bold">-</div>
          <div id="homeTodayRate" class="text-xs text-gray-500 mt-1">ì„±ê³µë¥  -</div>
        </div>
        <div onclick="showTab('sessions')" class="cursor-pointer bg-gradient-to-br from-purple-900/40 to-purple-800/20 border border-purple-800/30 rounded-xl p-5 hover:border-purple-600/50 hover:scale-[1.02] transition-all">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-400">Claude ì„¸ì…˜</span>
            <span class="text-purple-400 text-lg">ğŸ¤–</span>
          </div>
          <div id="homeSessionsCount" class="text-3xl font-bold">-</div>
          <div class="text-xs text-gray-500 mt-1">ì˜¤ëŠ˜</div>
        </div>
        <div onclick="showTab('notes')" class="cursor-pointer bg-gradient-to-br from-amber-900/40 to-amber-800/20 border border-amber-800/30 rounded-xl p-5 hover:border-amber-600/50 hover:scale-[1.02] transition-all">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm text-gray-400">ë©”ëª¨ & ë°±ë¡œê·¸</span>
            <span class="text-amber-400 text-lg">ğŸ“‹</span>
          </div>
          <div id="homeNotesCount" class="text-3xl font-bold">-</div>
          <div id="homeBacklogCount" class="text-xs text-gray-500 mt-1">ë¯¸ì™„ë£Œ ë°±ë¡œê·¸ -</div>
        </div>
      </div>

      <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
      <div class="grid grid-cols-3 gap-3 mb-6">
        <button onclick="openQuickInput()" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-xl text-sm font-medium transition-colors">
          ğŸ“ ë¹ ë¥¸ ë©”ëª¨
        </button>
        <button onclick="openMorningStart()" class="px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-xl text-sm font-medium transition-all">
          â˜€ï¸ í•˜ë£¨ ì‹œì‘
        </button>
        <button onclick="generateTodayFullReport()" class="px-4 py-3 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-400 hover:to-pink-400 rounded-xl text-sm font-medium transition-all">
          ğŸ“Š ì˜¤ëŠ˜ ë³´ê³ ì„œ
        </button>
      </div>

      <!-- 2ì—´ ë ˆì´ì•„ì›ƒ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- ìµœê·¼ ì‹¤í–‰ ì´ë ¥ -->
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-gray-300">â–¶ï¸ ìµœê·¼ ì‹¤í–‰</h3>
            <button onclick="showTab('jobs'); setTimeout(()=>showJobSubTab('history'),50)" class="text-xs text-blue-400 hover:text-blue-300">ì „ì²´ ë³´ê¸° â†’</button>
          </div>
          <div id="homeRecentRuns" class="space-y-2 text-sm">
            <div class="text-gray-500 text-center py-4">ë¡œë”©ì¤‘...</div>
          </div>
        </div>
        <!-- ìµœê·¼ ë©”ëª¨ -->
        <div class="bg-gray-800/50 rounded-xl p-5 border border-gray-700/50">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-gray-300">ğŸ“ ìµœê·¼ ë©”ëª¨</h3>
            <button onclick="showTab('notes')" class="text-xs text-blue-400 hover:text-blue-300">ì „ì²´ ë³´ê¸° â†’</button>
          </div>
          <div id="homeRecentMemos" class="space-y-2 text-sm">
            <div class="text-gray-500 text-center py-4">ë¡œë”©ì¤‘...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Jobs Tab -->
    <div id="panel-jobs" class="hidden">
      <!-- Sub Tabs -->
      <div class="flex gap-2 mb-4 border-b border-gray-700/50 pb-2">
        <button onclick="showJobSubTab('list')" id="jobSub-list" class="job-sub-btn px-3 py-1.5 border-b-2 border-blue-500 text-blue-400 text-sm font-medium">
          ì‘ì—… ëª©ë¡
        </button>
        <button onclick="showJobSubTab('history')" id="jobSub-history" class="job-sub-btn px-3 py-1.5 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm font-medium">
          ì‹¤í–‰ ì´ë ¥
        </button>
        <button onclick="showJobSubTab('stats')" id="jobSub-stats" class="job-sub-btn px-3 py-1.5 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm font-medium">
          ğŸ“Š í†µê³„
        </button>
      </div>

      <!-- Job List Sub Panel -->
      <div id="jobSubPanel-list">
      <!-- Today's Summary Widget -->
      <div id="todaySummaryWidget" class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold flex items-center gap-2">
            ğŸ¤– <span>ì˜¤ëŠ˜ì˜ ìš”ì•½</span>
          </h3>
          <button onclick="refreshTodaySummary()" class="text-sm text-gray-400 hover:text-white">ğŸ”„</button>
        </div>

        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-sm text-gray-400 mb-1">Claude ì„¸ì…˜</div>
            <div id="todaySessionsCount" class="text-2xl font-bold">-</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-sm text-gray-400 mb-1">ì‘ì—… ì‹¤í–‰</div>
            <div id="todayJobsCount" class="text-2xl font-bold">-</div>
          </div>
          <div class="bg-gray-800/50 rounded-lg p-3 text-center">
            <div class="text-sm text-gray-400 mb-1">ì„±ê³µë¥ </div>
            <div id="todaySuccessRate" class="text-2xl font-bold">-</div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2">
          <button onclick="openQuickInput()" class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium transition-colors">
            ğŸ“ ë¹ ë¥¸ ë©”ëª¨
          </button>
          <button id="morningStartBtn" onclick="openMorningStart()" class="px-3 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-lg text-sm font-medium transition-all">
            â˜€ï¸ í•˜ë£¨ ì‹œì‘
          </button>
          <button onclick="generateTodayFullReport()" class="px-3 py-2 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-400 hover:to-pink-400 rounded-lg text-sm font-medium transition-all">
            ğŸ“Š ì˜¤ëŠ˜ ë³´ê³ ì„œ
          </button>
        </div>
      </div>

      <!-- View Toggle & Category Filter -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex gap-2" id="categoryFilter"></div>
        <div class="flex gap-1 bg-gray-800 rounded-lg p-1">
          <button onclick="setView('card')" id="viewBtn-card" class="view-btn active px-3 py-1.5 rounded text-sm font-medium">
            ğŸ“‹ ì¹´ë“œ
          </button>
          <button onclick="setView('graph')" id="viewBtn-graph" class="view-btn px-3 py-1.5 rounded text-sm font-medium text-gray-400 hover:text-white">
            ğŸ”— ê·¸ë˜í”„
          </button>
        </div>
      </div>

      <!-- Jobs Grid (Card View) -->
      <div id="jobsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Jobs will be loaded here -->
      </div>

      <!-- Graph View -->
      <div id="graphView" class="rounded-lg overflow-hidden relative" style="height: calc(100vh - 250px); background: #111827;">
        <!-- Graph Controls -->
        <div class="graph-controls">
          <button class="graph-control-btn" onclick="autoLayoutGraph()">
            ğŸ“ ìë™ ì •ë ¬
          </button>
          <button class="graph-control-btn" onclick="saveAllPositions()">
            ğŸ’¾ ìœ„ì¹˜ ì €ì¥
          </button>
        </div>

        <!-- Zoom Controls -->
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomGraph(1.2)" title="í™•ëŒ€">+</button>
          <button class="zoom-btn" onclick="zoomGraph(0.8)" title="ì¶•ì†Œ">âˆ’</button>
          <button class="zoom-btn" onclick="fitGraph()" title="ì „ì²´ ë³´ê¸°">âŠ¡</button>
        </div>

        <!-- Legend -->
        <div class="graph-legend">
          <div class="text-gray-400 text-xs mb-2 font-medium">ë²”ë¡€</div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #10b981;"></div>
            <span>í™œì„±í™”</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #6b7280;"></div>
            <span>ë¹„í™œì„±í™”</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #fbbf24;"></div>
            <span>ì‹¤í–‰ ì¤‘</span>
          </div>
          <div class="legend-item mt-2 pt-2 border-t border-gray-700">
            <div class="legend-line" style="background: #10b981;"></div>
            <span>íŠ¸ë¦¬ê±° ì—°ê²°</span>
          </div>
          <div class="legend-item">
            <div class="legend-line" style="background: #6b7280; border-top: 2px dashed #6b7280; height: 0;"></div>
            <span>ì‹œê°ì  ì—°ê²°</span>
          </div>
        </div>

        <!-- Graph Canvas -->
        <div id="graphCanvas" style="width: 100%; height: 100%;"></div>

        <!-- Side Panel -->
        <div id="graphSidePanel" class="graph-side-panel">
          <button class="side-panel-close" onclick="closeSidePanel()">&times;</button>
          <div id="sidePanelContent">
            <!-- ì„ íƒëœ ë…¸ë“œ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
          </div>
        </div>
      </div>
    </div> <!-- /jobSubPanel-list -->

      <!-- History Sub Panel -->
      <div id="jobSubPanel-history" class="hidden">
        <!-- í•„í„° ì˜ì—­ -->
        <div class="bg-gray-800 rounded-lg p-4 mb-4">
          <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm text-gray-400 mb-1">ê²€ìƒ‰</label>
              <input type="text" id="historySearch" placeholder="ì‘ì—…ëª… ê²€ìƒ‰..."
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onkeyup="debounceHistorySearch()">
            </div>
            <div class="w-32">
              <label class="block text-sm text-gray-400 mb-1">ìƒíƒœ</label>
              <select id="historyStatus"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onchange="loadHistoryFiltered()">
                <option value="">ì „ì²´</option>
                <option value="success">ì„±ê³µ</option>
                <option value="failed">ì‹¤íŒ¨</option>
                <option value="running">ì‹¤í–‰ì¤‘</option>
              </select>
            </div>
            <div class="w-40">
              <label class="block text-sm text-gray-400 mb-1">ì‹œì‘ì¼</label>
              <input type="date" id="historyStartDate"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onchange="loadHistoryFiltered()">
            </div>
            <div class="w-40">
              <label class="block text-sm text-gray-400 mb-1">ì¢…ë£Œì¼</label>
              <input type="date" id="historyEndDate"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                onchange="loadHistoryFiltered()">
            </div>
            <button onclick="resetHistoryFilters()"
              class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
              ì´ˆê¸°í™”
            </button>
          </div>
        </div>

        <div class="bg-gray-800 rounded-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-700">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-medium">ì‘ì—…</th>
                <th class="px-4 py-3 text-left text-sm font-medium">íŠ¸ë¦¬ê±°</th>
                <th class="px-4 py-3 text-left text-sm font-medium">ì‹œì‘ ì‹œê°„</th>
                <th class="px-4 py-3 text-left text-sm font-medium">ì†Œìš” ì‹œê°„</th>
                <th class="px-4 py-3 text-left text-sm font-medium">ìƒíƒœ</th>
                <th class="px-4 py-3 text-left text-sm font-medium">ìƒì„¸</th>
              </tr>
            </thead>
            <tbody id="historyTable" class="divide-y divide-gray-700"></tbody>
          </table>
        </div>

        <div id="historyPagination" class="flex items-center justify-between mt-4">
          <div id="historyInfo" class="text-sm text-gray-400"></div>
          <div class="flex gap-2">
            <button id="historyPrevBtn" onclick="loadHistoryPage('prev')"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              â† ì´ì „
            </button>
            <div id="historyPageNumbers" class="flex gap-1"></div>
            <button id="historyNextBtn" onclick="loadHistoryPage('next')"
              class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              ë‹¤ìŒ â†’
            </button>
          </div>
        </div>
      </div> <!-- /jobSubPanel-history -->

      <!-- Stats Sub Panel -->
      <div id="jobSubPanel-stats" class="hidden">
      <!-- ê¸°ê°„ ì„ íƒ -->
      <div class="flex items-center gap-4 mb-6">
        <span class="text-sm text-gray-400">ê¸°ê°„:</span>
        <div class="flex gap-1 bg-gray-800 rounded-lg p-1">
          <button onclick="setStatsPeriod(7)" id="statsBtn-7" class="stats-period-btn px-3 py-1.5 rounded text-sm font-medium bg-blue-600 text-white">
            7ì¼
          </button>
          <button onclick="setStatsPeriod(14)" id="statsBtn-14" class="stats-period-btn px-3 py-1.5 rounded text-sm font-medium text-gray-400 hover:text-white">
            14ì¼
          </button>
          <button onclick="setStatsPeriod(30)" id="statsBtn-30" class="stats-period-btn px-3 py-1.5 rounded text-sm font-medium text-gray-400 hover:text-white">
            30ì¼
          </button>
        </div>
        <button onclick="loadStats()" class="ml-auto px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      <!-- ìš”ì•½ ì¹´ë“œ -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">ì´ ì‹¤í–‰</div>
          <div id="statsTotalRuns" class="text-3xl font-bold mt-1">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">ì„±ê³µë¥ </div>
          <div id="statsSuccessRate" class="text-3xl font-bold mt-1 text-green-400">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">ì‹¤íŒ¨</div>
          <div id="statsFailedCount" class="text-3xl font-bold mt-1 text-red-400">-</div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4">
          <div class="text-sm text-gray-400">í‰ê·  ì†Œìš” ì‹œê°„</div>
          <div id="statsAvgDuration" class="text-3xl font-bold mt-1">-</div>
        </div>
      </div>

      <!-- ì°¨íŠ¸ ì˜ì—­ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- ì¼ë³„ íŠ¸ë Œë“œ ì°¨íŠ¸ -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ ì¼ë³„ ì‹¤í–‰ íŠ¸ë Œë“œ</h3>
          <div style="height: 250px;">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <!-- ì„±ê³µ/ì‹¤íŒ¨ íŒŒì´ ì°¨íŠ¸ -->
        <div class="bg-gray-800 rounded-lg p-4">
          <h3 class="text-lg font-semibold mb-4">ğŸ¯ ì‹¤í–‰ ê²°ê³¼ ë¶„í¬</h3>
          <div style="height: 250px;">
            <canvas id="resultChart"></canvas>
          </div>
        </div>
      </div>

      <!-- ì‘ì—…ë³„ í†µê³„ í…Œì´ë¸” -->
      <div class="bg-gray-800 rounded-lg overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-700">
          <h3 class="text-lg font-semibold">ğŸ“‹ ì‘ì—…ë³„ í†µê³„</h3>
        </div>
        <table class="w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium">ì‘ì—…</th>
              <th class="px-4 py-3 text-right text-sm font-medium">ì‹¤í–‰</th>
              <th class="px-4 py-3 text-right text-sm font-medium">ì„±ê³µ</th>
              <th class="px-4 py-3 text-right text-sm font-medium">ì‹¤íŒ¨</th>
              <th class="px-4 py-3 text-right text-sm font-medium">ì„±ê³µë¥ </th>
              <th class="px-4 py-3 text-right text-sm font-medium">í‰ê·  ì‹œê°„</th>
            </tr>
          </thead>
          <tbody id="statsJobsTable" class="divide-y divide-gray-700">
            <!-- ì‘ì—…ë³„ í†µê³„ ë¡œë“œë¨ -->
          </tbody>
        </table>
      </div>

      <!-- ì‹¤íŒ¨ TOP 5 -->
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <div class="px-4 py-3 border-b border-gray-700">
          <h3 class="text-lg font-semibold">âš ï¸ ê°€ì¥ ì‹¤íŒ¨ ë§ì€ ì‘ì—…</h3>
        </div>
        <div id="statsFailuresContainer" class="p-4">
          <!-- ì‹¤íŒ¨ ëª©ë¡ ë¡œë“œë¨ -->
        </div>
      </div>
      </div> <!-- /jobSubPanel-stats -->
    </div> <!-- /panel-jobs -->

    <!-- Context Menu (for graph nodes) -->
    <div id="contextMenu" class="context-menu hidden">
      <div class="context-menu-item" onclick="contextMenuAction('run')">â–¶ï¸ ì‹¤í–‰</div>
      <div class="context-menu-item" onclick="contextMenuAction('schedule')">â° ì˜ˆì•½ ì‹¤í–‰</div>
      <div class="context-menu-item" onclick="contextMenuAction('toggle')">â¸ï¸ í™œì„±í™”/ë¹„í™œì„±í™”</div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="contextMenuAction('duplicate')">ğŸ“‹ ë³µì œ</div>
      <div class="context-menu-item" onclick="contextMenuAction('edit')">âœï¸ í¸ì§‘</div>
      <div class="context-menu-item" onclick="contextMenuAction('delete')">ğŸ—‘ï¸ ì‚­ì œ</div>
    </div>

    <!-- Settings Tab -->
    <div id="panel-settings" class="hidden">
      <div class="max-w-2xl">
        <!-- ì•Œë¦¼ ì„¤ì • -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">ğŸ”” ì•Œë¦¼ ì„¤ì •</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Slack Webhook URL</label>
              <input type="password" id="settingsSlackWebhook" placeholder="https://hooks.slack.com/services/..."
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">ì™„ë£Œ/ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼ì„ ë³´ë‚¼ Webhook URL</p>
            </div>
            <div class="flex items-center gap-3">
              <input type="checkbox" id="settingsSlackEnabled" class="w-4 h-4 rounded bg-gray-600 border-gray-500">
              <label for="settingsSlackEnabled" class="text-sm">Slack ì•Œë¦¼ ê¸°ë³¸ í™œì„±í™”</label>
            </div>
            <div class="border-t border-gray-700 pt-4 mt-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <input type="checkbox" id="settingsBrowserNotifications" class="w-4 h-4 rounded bg-gray-600 border-gray-500"
                    onchange="onBrowserNotificationChange(this)">
                  <label for="settingsBrowserNotifications" class="text-sm">ë¸Œë¼ìš°ì € ì•Œë¦¼</label>
                </div>
                <span id="notificationStatus" class="text-xs text-gray-500"></span>
              </div>
              <p class="text-xs text-gray-500 mt-2">ì‘ì—… ì™„ë£Œ/ì‹¤íŒ¨ ì‹œ ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼</p>
            </div>
          </div>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ ì„¤ì • -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">ğŸ–¥ï¸ ëŒ€ì‹œë³´ë“œ ì„¤ì •</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">ëŒ€ì‹œë³´ë“œ URL</label>
              <input type="text" id="settingsDashboardUrl" placeholder="http://localhost:3030"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">Slack ì•Œë¦¼ì— í¬í•¨ë  ëŒ€ì‹œë³´ë“œ ë§í¬ ì£¼ì†Œ</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© (ì´ˆ)</label>
              <input type="number" id="settingsRefreshInterval" min="1" max="60" value="5"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">ì‘ì—… ëª©ë¡ ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© (1~60ì´ˆ)</p>
            </div>
          </div>
        </div>

        <!-- ì‹¤í–‰ ì„¤ì • -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">âš¡ ì‹¤í–‰ ì„¤ì •</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">ê¸°ë³¸ Timeout (ë¶„)</label>
              <input type="number" id="settingsDefaultTimeout" min="1" max="60" value="10"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">ì‘ì—… ì‹¤í–‰ ì œí•œ ì‹œê°„ (ê°œë³„ ì‘ì—…ì—ì„œ ì¬ì •ì˜ ê°€ëŠ¥)</p>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">ê¸°ë³¸ ì¬ì‹œë„ íšŸìˆ˜</label>
              <input type="number" id="settingsDefaultRetry" min="0" max="10" value="0"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ íšŸìˆ˜ (0 = ì¬ì‹œë„ ì•ˆí•¨)</p>
            </div>
          </div>
        </div>

        <!-- ìë™ ë³µêµ¬ ì„¤ì • -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">ğŸ”§ ìë™ ë³µêµ¬ (Auto-Fix)</h3>
          <p class="text-sm text-gray-400 mb-4">
            ì‘ì—… ì‹¤íŒ¨ ì‹œ íŠ¹ì • ì—ëŸ¬ íŒ¨í„´ì„ ê°ì§€í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ì • ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³  ì¬ì‹œë„í•©ë‹ˆë‹¤.
          </p>
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
              <div>
                <div class="font-medium text-sm">ğŸ Python íŒ¨í‚¤ì§€ ëˆ„ë½</div>
                <div class="text-xs text-gray-400">ModuleNotFoundError ê°ì§€ ì‹œ pip install ì‹¤í–‰</div>
              </div>
              <input type="checkbox" id="autoFixPip" checked class="w-4 h-4 rounded bg-gray-600 border-gray-500">
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-lg">
              <div>
                <div class="font-medium text-sm">ğŸ“¦ NPM íŒ¨í‚¤ì§€ ëˆ„ë½</div>
                <div class="text-xs text-gray-400">Cannot find module ê°ì§€ ì‹œ npm install ì‹¤í–‰</div>
              </div>
              <input type="checkbox" id="autoFixNpm" checked class="w-4 h-4 rounded bg-gray-600 border-gray-500">
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-3">* ìë™ ë³µêµ¬ëŠ” ì²« ë²ˆì§¸ ì‹¤íŒ¨ ì‹œì—ë§Œ ì‹œë„ë©ë‹ˆë‹¤</p>
        </div>

        <!-- ë°ì´í„° ê´€ë¦¬ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
          <div class="flex gap-4">
            <button onclick="exportJobs()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium">
              ğŸ“¤ ë‚´ë³´ë‚´ê¸°
            </button>
            <label class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-medium cursor-pointer">
              ğŸ“¥ ê°€ì ¸ì˜¤ê¸°
              <input type="file" accept=".json" onchange="importJobs(event)" class="hidden">
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-3">ëª¨ë“  ì‘ì—…, ì—£ì§€, ì¹´í…Œê³ ë¦¬, ì„¤ì •ì„ JSON íŒŒì¼ë¡œ ë°±ì—…/ë³µì›</p>
        </div>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div class="flex justify-end gap-3">
          <button onclick="loadSettings()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-medium">
            ğŸ”„ ë˜ëŒë¦¬ê¸°
          </button>
          <button onclick="saveSettings()" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm font-medium">
            ğŸ’¾ ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div id="panel-sessions" class="hidden">
      <!-- Sessions Filter -->
      <div class="flex items-center gap-4 mb-6 bg-gray-800 rounded-lg p-4">
        <div>
          <label class="text-sm text-gray-400 mr-2">ë‚ ì§œ:</label>
          <input type="date" id="sessionsDate"
            class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
            onchange="loadSessions()">
        </div>
        <div>
          <label class="text-sm text-gray-400 mr-2">í”„ë¡œì íŠ¸:</label>
          <select id="sessionsProject"
            class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm"
            onchange="loadSessions()">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="ml-auto flex gap-2">
          <button onclick="generateDailyReport()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg text-sm font-medium transition-all" title="Claudeê°€ ì˜¤ëŠ˜ ì„¸ì…˜ì„ ë¶„ì„í•˜ì—¬ ë³´ê³ ì„œ ìƒì„±">
            âœ¨ ì¼ì¼ ë³´ê³ ì„œ
          </button>
          <button onclick="exportAllSessionsToObsidian()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium transition-colors" title="ì„ íƒëœ ë‚ ì§œì˜ ëª¨ë“  ì„¸ì…˜ì„ ì˜µì‹œë””ì–¸ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°">
            ğŸ“ ì „ì²´ ë‚´ë³´ë‚´ê¸°
          </button>
          <button onclick="loadSessions()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>

      <!-- Sessions List -->
      <div id="sessionsList" class="grid gap-4">
        <div class="text-center text-gray-500 py-8">ì„¸ì…˜ì„ ë¡œë“œí•˜ë ¤ë©´ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      </div>

      <!-- Session Detail Modal -->
      <div id="sessionDetailModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div id="sessionDetailContent" class="bg-gray-800 rounded-xl p-6 w-full max-w-4xl mx-4 max-h-[85vh] overflow-auto">
          <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
      </div>
    </div>

    <!-- Notes Tab -->
    <div id="panel-notes" class="hidden">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <h2 class="text-xl font-bold">ğŸ“‹ ë…¸íŠ¸ & ë°±ë¡œê·¸</h2>
          <span id="notesCount" class="text-sm text-gray-400"></span>
        </div>
        <div class="flex items-center gap-3">
          <!-- Date Picker -->
          <div class="flex items-center gap-1 bg-gray-800 rounded-lg px-1 py-1">
            <button onclick="shiftNotesDate(-1)" class="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition-colors" title="ì´ì „ ë‚ ì§œ">â€¹</button>
            <button id="notesDateLabel" onclick="document.getElementById('notesDateInput').showPicker()" class="px-2 py-0.5 text-sm font-medium text-gray-300 hover:text-white rounded hover:bg-gray-700 cursor-pointer transition-colors whitespace-nowrap"></button>
            <input type="date" id="notesDateInput" class="sr-only" onchange="setNotesDate(this.value)">
            <button onclick="shiftNotesDate(1)" id="notesDateNext" class="w-7 h-7 flex items-center justify-center rounded hover:bg-gray-700 text-gray-400 hover:text-white transition-colors" title="ë‹¤ìŒ ë‚ ì§œ">â€º</button>
            <button onclick="setNotesToday()" class="px-2 py-0.5 text-xs rounded bg-gray-700 hover:bg-gray-600 text-gray-400 hover:text-white transition-colors" title="ì˜¤ëŠ˜ë¡œ ì´ë™">ì˜¤ëŠ˜</button>
          </div>
          <div class="flex gap-2">
            <button onclick="openQuickInput('memo')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-medium">
              ğŸ“ ë©”ëª¨ ì¶”ê°€
            </button>
            <button onclick="openQuickInput('backlog')" class="px-4 py-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-sm font-medium">
              ğŸ“‹ ë°±ë¡œê·¸ ì¶”ê°€
            </button>
          </div>
        </div>
      </div>

      <!-- Filter Tabs -->
      <div class="flex gap-2 mb-4">
        <button onclick="setNotesFilter('all')" id="noteFilter-all"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-600 text-white">ì „ì²´</button>
        <button onclick="setNotesFilter('backlog')" id="noteFilter-backlog"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">ğŸ“‹ ë°±ë¡œê·¸ <span id="backlogOpenCount" class="text-xs"></span></button>
        <button onclick="setNotesFilter('memo')" id="noteFilter-memo"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">ğŸ“ ë©”ëª¨</button>
        <button onclick="setNotesFilter('done')" id="noteFilter-done"
          class="note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white">âœ… ì™„ë£Œ</button>
      </div>

      <!-- Notes List -->
      <div id="notesList" class="space-y-2">
        <div class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </main>

  <!-- Add/Edit Job Modal -->
  <div id="jobModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-auto">
      <h2 id="modalTitle" class="text-xl font-bold mb-4">ì‘ì—… ì¶”ê°€</h2>

      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="flex gap-2 mb-4 border-b border-gray-700">
        <button type="button" onclick="showEditTab('basic')" id="editTab-basic"
          class="edit-tab-btn px-4 py-2 border-b-2 border-blue-500 text-blue-400 font-medium text-sm">
          ê¸°ë³¸ ì •ë³´
        </button>
        <button type="button" onclick="showEditTab('options')" id="editTab-options"
          class="edit-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm">
          ì‹¤í–‰ ì˜µì…˜
        </button>
        <button type="button" onclick="showEditTab('execution')" id="editTab-execution"
          class="edit-tab-btn px-4 py-2 border-b-2 border-transparent text-gray-400 hover:text-gray-200 text-sm">
          ì‹¤í–‰ ì œì–´
        </button>
      </div>

      <form id="jobForm">
        <input type="hidden" id="jobId">

        <!-- ê¸°ë³¸ ì •ë³´ íƒ­ -->
        <div id="editPanel-basic" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">ì‘ì—… ì´ë¦„ *</label>
            <input type="text" id="jobName" required
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">ì„¤ëª…</label>
            <input type="text" id="jobDescription"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">ëª…ë ¹ì–´ *</label>
            <textarea id="jobCommand" required rows="2"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono text-sm"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">
              Cron ìŠ¤ì¼€ì¤„ *
              <a href="https://crontab.guru" target="_blank" class="text-blue-400 text-xs ml-2">crontab.guru â†—</a>
            </label>
            <div class="flex gap-3 items-start">
              <input type="text" id="jobSchedule" required placeholder="0 9 * * *"
                class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 font-mono"
                oninput="updateCronDescription()">
              <div id="cronBubble" class="relative bg-gradient-to-r from-blue-600/30 to-purple-600/30 border border-blue-500/50 text-blue-200 text-xs px-3 py-2 rounded-lg min-w-[140px] hidden">
                <div class="absolute left-0 top-3 -translate-x-[7px]">
                  <div class="w-0 h-0 border-y-[6px] border-y-transparent border-r-[7px] border-r-blue-500/50"></div>
                </div>
                <div id="cronDescription" class="font-medium">-</div>
                <div id="cronNextRun" class="text-gray-400 mt-1 text-[10px]"></div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">ì¹´í…Œê³ ë¦¬</label>
            <select id="jobCategory"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">ë©”ëª¨</label>
            <textarea id="jobNotes" rows="2" placeholder="ë¹„í™œì„±í™” ì‚¬ìœ , ì£¼ì˜ì‚¬í•­ ë“±..."
              class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500 text-sm"></textarea>
            <p class="text-xs text-gray-500 mt-1">ì‘ì—…ì— ëŒ€í•œ ë©”ëª¨ë‚˜ ì£¼ì˜ì‚¬í•­ì„ ê¸°ë¡í•©ë‹ˆë‹¤</p>
          </div>

          <div class="flex items-center gap-2">
            <input type="checkbox" id="jobEnabled" class="w-4 h-4 rounded">
            <label for="jobEnabled" class="text-sm">í™œì„±í™” (ìŠ¤ì¼€ì¤„ ìë™ ì‹¤í–‰)</label>
          </div>
        </div>

        <!-- ì‹¤í–‰ ì˜µì…˜ íƒ­ -->
        <div id="editPanel-options" class="hidden space-y-4">
          <p class="text-sm text-gray-400 mb-4">
            ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ ì ìš©ë  ê¸°ë³¸ ì˜µì…˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
          </p>
          <div id="editOptionsContainer">
            <!-- ì˜µì…˜ë“¤ì´ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
          </div>
        </div>

        <!-- ì‹¤í–‰ ì œì–´ íƒ­ -->
        <div id="editPanel-execution" class="hidden space-y-4">
          <p class="text-sm text-gray-400 mb-4">
            ì‹¤í–‰ ì‹œê°„ ì œí•œê³¼ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ì •ì±…ì„ ì„¤ì •í•©ë‹ˆë‹¤.
          </p>

          <!-- Timeout ì„¤ì • -->
          <div class="bg-gray-700/50 p-4 rounded-lg">
            <h4 class="font-medium mb-3">â±ï¸ ì‹¤í–‰ ì‹œê°„ ì œí•œ</h4>
            <div>
              <label class="block text-sm text-gray-400 mb-1">Timeout (ë¶„)</label>
              <input type="number" id="jobTimeout" min="1" max="120" value="5"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
              <p class="text-xs text-gray-500 mt-1">ì§€ì •ëœ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì‘ì—…ì„ ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤ (1~120ë¶„)</p>
            </div>
          </div>

          <!-- ì¬ì‹œë„ ì„¤ì • -->
          <div class="bg-gray-700/50 p-4 rounded-lg">
            <h4 class="font-medium mb-3">ğŸ”„ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„</h4>
            <div class="space-y-3">
              <div>
                <label class="block text-sm text-gray-400 mb-1">ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜</label>
                <input type="number" id="jobMaxRetries" min="0" max="10" value="0"
                  class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì¬ì‹œë„í•  íšŸìˆ˜ (0 = ì¬ì‹œë„ ì•ˆí•¨)</p>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">ì¬ì‹œë„ ê°„ê²© (ì´ˆ)</label>
                <input type="number" id="jobRetryDelay" min="1" max="300" value="5"
                  class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">ì¬ì‹œë„ ì „ ëŒ€ê¸° ì‹œê°„ (1~300ì´ˆ)</p>
              </div>
              <div>
                <label class="block text-sm text-gray-400 mb-1">Backoff ì „ëµ</label>
                <select id="jobRetryBackoff"
                  class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm">
                  <option value="fixed">ê³ ì • (Fixed)</option>
                  <option value="linear">ì„ í˜• (Linear: delay * attempt)</option>
                  <option value="exponential">ì§€ìˆ˜ (Exponential: delay * 2^attempt)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="flex gap-3 pt-6 border-t border-gray-700 mt-6">
          <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
            ì €ì¥
          </button>
          <button type="button" onclick="closeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
            ì·¨ì†Œ
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Run Options Modal -->
  <div id="optionsModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">ì‹¤í–‰ ì˜µì…˜</h2>
        <button onclick="closeOptionsModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="optionsJobInfo" class="mb-4 pb-4 border-b border-gray-700">
        <h3 id="optionsJobName" class="font-semibold text-lg"></h3>
        <p id="optionsJobDesc" class="text-sm text-gray-400"></p>
      </div>
      <div id="optionsContainer" class="space-y-4 mb-6">
        <!-- Options will be rendered here -->
      </div>
      <div id="optionsCommand" class="mb-4 p-3 bg-gray-900 rounded-lg">
        <p class="text-xs text-gray-400 mb-1">ì‹¤í–‰ë  ëª…ë ¹ì–´:</p>
        <code id="optionsCommandPreview" class="text-sm text-green-400 break-all"></code>
      </div>
      <div class="flex gap-3">
        <button onclick="executeWithOptions()" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg font-medium">
          â–¶ ì‹¤í–‰
        </button>
        <button onclick="closeOptionsModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- Edge Type Modal -->
  <div id="edgeModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm mx-4">
      <h2 class="text-xl font-bold mb-4">ì—°ê²° íƒ€ì… ì„ íƒ</h2>
      <input type="hidden" id="edgeFrom">
      <input type="hidden" id="edgeTo">

      <div class="space-y-3 mb-6">
        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="visual" checked class="w-4 h-4">
          <div>
            <div class="font-medium">ì‹œê°ì  ì—°ê²°</div>
            <div class="text-sm text-gray-400">ê´€ê³„ í‘œì‹œë§Œ (ìë™ ì‹¤í–‰ ì•ˆí•¨)</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-success" class="w-4 h-4">
          <div>
            <div class="font-medium text-green-400">âœ“ ì„±ê³µ ì‹œ ì‹¤í–‰</div>
            <div class="text-sm text-gray-400">ì• ì‘ì—… ì„±ê³µí•˜ë©´ ë‹¤ìŒ ì‹¤í–‰</div>
          </div>
        </label>

        <label class="flex items-center gap-3 p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600">
          <input type="radio" name="edgeType" value="trigger-always" class="w-4 h-4">
          <div>
            <div class="font-medium text-yellow-400">âš¡ í•­ìƒ ì‹¤í–‰</div>
            <div class="text-sm text-gray-400">ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ë‹¤ìŒ ì‹¤í–‰</div>
          </div>
        </label>
      </div>

      <div class="flex gap-3">
        <button onclick="confirmEdgeCreate()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
          ì—°ê²°
        </button>
        <button onclick="closeEdgeModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- Schedule Run Modal -->
  <div id="scheduleModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">ì˜ˆì•½ ì‹¤í–‰</h2>
        <button onclick="closeScheduleModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="scheduleJobInfo" class="text-sm text-gray-400 mb-4"></div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">ì‹¤í–‰ ë‚ ì§œ/ì‹œê°„</label>
          <input type="datetime-local" id="scheduleDateTime"
            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:border-blue-500">
        </div>
        <p class="text-xs text-gray-500">ì§€ì •ëœ ì‹œê°„ì— 1íšŒë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
      </div>
      <div class="flex gap-3 mt-6">
        <button onclick="confirmScheduleRun()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg font-medium">
          ì˜ˆì•½
        </button>
        <button onclick="closeScheduleModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-2 rounded-lg font-medium">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- Log Detail Modal -->
  <div id="logModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-auto">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">ì‹¤í–‰ ë¡œê·¸</h2>
        <button onclick="closeLogModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="logContent" class="space-y-4">
        <div id="logCommandSection" class="hidden">
          <h3 class="text-sm font-medium text-gray-400 mb-1">ì‹¤í–‰ ëª…ë ¹ì–´</h3>
          <pre id="logCommand" class="bg-gray-900 p-3 rounded-lg text-sm overflow-auto whitespace-pre-wrap text-green-400"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-medium text-gray-400">stdout</h3>
            <button onclick="toggleLogExpand('logStdout')" class="text-xs text-blue-400 hover:text-blue-300">
              í™•ì¥/ì¶•ì†Œ
            </button>
          </div>
          <pre id="logStdout" class="bg-gray-900 p-3 rounded-lg text-sm overflow-auto max-h-64 whitespace-pre-wrap transition-all"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <h3 class="text-sm font-medium text-gray-400">stderr</h3>
            <button onclick="toggleLogExpand('logStderr')" class="text-xs text-blue-400 hover:text-blue-300">
              í™•ì¥/ì¶•ì†Œ
            </button>
          </div>
          <pre id="logStderr" class="bg-gray-900 p-3 rounded-lg text-sm overflow-auto max-h-64 whitespace-pre-wrap text-red-400 transition-all"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Panel (ì˜¤ë¥¸ìª½ í•˜ë‹¨ ê³ ì •) -->
  <div id="taskPanel" class="fixed bottom-4 right-4 w-80 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl hidden z-40 overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3 bg-gray-750 border-b border-gray-700">
      <h3 class="text-sm font-medium flex items-center gap-2">
        <span class="status-dot bg-blue-500 pulse w-2 h-2"></span>
        ì§„í–‰ ì¤‘ì¸ ì‘ì—…
        <span id="taskCount" class="bg-blue-600 px-2 py-0.5 rounded-full text-xs">0</span>
      </h3>
      <div class="flex items-center gap-1">
        <button onclick="clearCompletedTasks()" class="text-gray-400 hover:text-white text-xs px-2 py-1 hover:bg-gray-700 rounded" title="ì™„ë£Œëœ ì‘ì—… ì§€ìš°ê¸°">
          ì •ë¦¬
        </button>
        <button onclick="toggleTaskPanelCollapse()" class="text-gray-400 hover:text-white px-2 py-1 hover:bg-gray-700 rounded">
          <span id="taskPanelToggle">â–¼</span>
        </button>
      </div>
    </div>
    <div id="taskList" class="max-h-72 overflow-y-auto p-2 space-y-2 custom-scrollbar">
      <!-- ì‘ì—… í•­ëª©ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
    </div>
  </div>

  <!-- Rename Session Modal -->
  <div id="renameSessionModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-[60]" style="display:none">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-sm mx-4">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl">âœï¸</span>
        <span class="text-lg font-medium">ì„¸ì…˜ ì´ë¦„ ë³€ê²½</span>
        <button onclick="closeRenameSessionModal()" class="ml-auto text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <input id="renameSessionInput" type="text"
        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-blue-500"
        placeholder="ì„¸ì…˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ ì´ˆê¸°í™”)"
        onkeydown="if(event.key === 'Enter') submitSessionRename()">
      <p class="text-xs text-gray-500 mt-2">ë¹„ì›Œë‘ë©´ ê¸°ë³¸ í”„ë¡œì íŠ¸ ì´ë¦„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
      <div class="flex gap-2 mt-4">
        <button onclick="submitSessionRename()" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
          ì €ì¥
        </button>
        <button onclick="closeRenameSessionModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- Ask Claude Modal -->
  <div id="askModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg mx-4 max-h-[80vh] overflow-auto">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl" id="askModalEmoji">ğŸ¤–</span>
        <span class="text-lg font-medium">ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”</span>
        <button onclick="closeAskModal()" class="ml-auto text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <textarea id="askInput"
        class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 min-h-[100px] resize-none focus:outline-none focus:border-blue-500"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitQuestion(); }"></textarea>

      <div id="askResponse" class="hidden mt-4 bg-gray-700 rounded-lg p-4 max-h-60 overflow-auto custom-scrollbar">
        <div id="askResponseText" class="text-sm markdown-content"></div>
      </div>

      <div id="askLoading" class="hidden mt-4 text-center text-gray-400">
        <div class="inline-block w-6 h-6 border-2 border-gray-600 border-t-blue-500 rounded-full animate-spin mb-2"></div>
        <div>Claudeì—ê²Œ ì§ˆë¬¸ ì¤‘...</div>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="askSubmitBtn" onclick="submitQuestion()" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium transition-colors">
          ğŸ¤– ì§ˆë¬¸í•˜ê¸°
        </button>
        <button id="askCopyBtn" onclick="copyAskResponse()" class="hidden px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
          ğŸ“‹ ë³µì‚¬
        </button>
        <button onclick="closeAskModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition-colors">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Input Modal -->
  <div id="quickInputModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gradient-to-br from-purple-900 to-blue-900 rounded-xl p-6 w-full max-w-xl mx-4">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-3xl" id="quickInputIcon">ğŸ“</span>
        <span class="text-lg font-medium" id="quickInputTitle">ë¹ ë¥¸ ë©”ëª¨</span>
        <button onclick="closeQuickInputModal()" class="ml-auto text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- íƒ€ì… í† ê¸€: ë©”ëª¨ / ë°±ë¡œê·¸ -->
      <div class="flex bg-white/10 rounded-lg p-1 mb-4">
        <button onclick="setQuickInputType('memo')" id="qiTypeMemo"
          class="flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white/20 text-white">
          ğŸ“ ë©”ëª¨
        </button>
        <button onclick="setQuickInputType('backlog')" id="qiTypeBacklog"
          class="flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-white/60">
          ğŸ“‹ ë°±ë¡œê·¸
        </button>
      </div>

      <textarea id="quickInputText"
        class="w-full bg-white/10 border border-white/20 rounded-lg p-4 min-h-[160px] resize-y focus:outline-none focus:border-white/40 placeholder-white/50 text-sm leading-relaxed font-mono"
        placeholder="ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤...&#10;&#10;ì˜ˆì‹œ:&#10;- í•­ëª© 1&#10;- **ì¤‘ìš”í•œ ë‚´ìš©**&#10;- `ì½”ë“œ` ê´€ë ¨ ë©”ëª¨"
        oninput="updateQuickInputPreview()"
        onkeydown="if(event.key === 'Enter' && (event.metaKey || event.ctrlKey)) { event.preventDefault(); saveQuickInput(); }"></textarea>

      <!-- ë§ˆí¬ë‹¤ìš´ ë¯¸ë¦¬ë³´ê¸° í† ê¸€ -->
      <div class="flex items-center gap-2 mt-2 mb-1">
        <button onclick="toggleQuickInputPreview()" id="qiPreviewToggle"
          class="text-xs text-white/40 hover:text-white/70 transition-colors">
          ğŸ‘ ë¯¸ë¦¬ë³´ê¸°
        </button>
        <span class="text-xs text-white/30">ë§ˆí¬ë‹¤ìš´ ì§€ì› Â· âŒ˜+Enter ì €ì¥</span>
      </div>
      <div id="qiPreviewArea" class="hidden bg-white/5 border border-white/10 rounded-lg p-4 max-h-[120px] overflow-auto markdown-content text-sm"></div>

      <!-- ë°±ë¡œê·¸ ìš°ì„ ìˆœìœ„ (ë°±ë¡œê·¸ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ) -->
      <div id="backlogPriorityRow" class="hidden mt-3 flex items-center gap-2">
        <span class="text-xs text-white/60">ìš°ì„ ìˆœìœ„:</span>
        <button onclick="setBacklogPriority('high')" data-pri="high"
          class="backlog-pri-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-red-400 hover:text-red-400 transition-colors">ğŸ”´ ë†’ìŒ</button>
        <button onclick="setBacklogPriority('normal')" data-pri="normal"
          class="backlog-pri-btn px-2 py-1 rounded text-xs border border-white/30 bg-white/10 text-white transition-colors">ğŸŸ¡ ë³´í†µ</button>
        <button onclick="setBacklogPriority('low')" data-pri="low"
          class="backlog-pri-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 hover:border-blue-400 hover:text-blue-400 transition-colors">ğŸ”µ ë‚®ìŒ</button>
      </div>

      <div class="flex gap-2 mt-4">
        <button onclick="saveQuickInput()" id="quickInputSaveBtn" class="flex-1 px-4 py-2.5 bg-white/20 hover:bg-white/30 rounded-lg font-medium transition-colors">
          ğŸ’¾ ì €ì¥
        </button>
        <button onclick="closeQuickInputModal()" class="px-4 py-2.5 bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="taskDetailModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[85vh] flex flex-col">
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl" id="taskDetailEmoji">ğŸ”„</span>
        <div class="flex-1">
          <h3 class="text-lg font-medium" id="taskDetailTitle">ì‘ì—… ìƒì„¸</h3>
          <p class="text-sm text-gray-400" id="taskDetailStatus">ì§„í–‰ ì¤‘</p>
        </div>
        <button onclick="closeTaskDetailModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <div class="flex gap-2 mb-4">
        <button onclick="switchTaskTab('output')" id="taskTabOutput" class="px-3 py-1.5 rounded-lg text-sm bg-blue-600">ì¶œë ¥</button>
        <button onclick="switchTaskTab('logs')" id="taskTabLogs" class="px-3 py-1.5 rounded-lg text-sm bg-gray-700 hover:bg-gray-600">ë¡œê·¸</button>
      </div>

      <div id="taskDetailContent" class="flex-1 overflow-auto custom-scrollbar">
        <div id="taskOutputTab" class="bg-gray-900/50 rounded-lg p-4 text-sm max-h-[50vh] overflow-auto">
          ëŒ€ê¸° ì¤‘...
        </div>
        <div id="taskLogsTab" class="hidden bg-gray-900 rounded-lg p-4 font-mono text-xs max-h-[50vh] overflow-auto">
        </div>
      </div>

      <div class="flex gap-2 mt-4 pt-4 border-t border-gray-700">
        <button onclick="refreshTaskDetail()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
          ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
        <button onclick="closeTaskDetailModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm ml-auto">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- Day Wrap-up Wizard Modal -->
  <div id="dayWrapupModal" class="modal fixed inset-0 bg-black/60 items-center justify-center z-50 overflow-auto py-4">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl w-full max-w-3xl mx-4 shadow-2xl border border-gray-700/50">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-3xl">ğŸŒ™</span>
          <div>
            <h2 class="text-xl font-bold">í•˜ë£¨ ë§ˆë¬´ë¦¬</h2>
            <p class="text-sm text-gray-400" id="wrapupDate">ì˜¤ëŠ˜ì˜ í•˜ë£¨ë¥¼ ì˜ë¯¸ìˆê²Œ ì •ë¦¬í•´ë³´ì„¸ìš”</p>
          </div>
        </div>
        <button onclick="closeDayWrapupModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- Progress Steps -->
      <div class="px-6 py-3 border-b border-gray-700/30 bg-gray-800/30">
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center gap-2" id="step1Indicator">
            <span class="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold">1</span>
            <span class="text-gray-300">ì„¸ì…˜ ì„ íƒ</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="step2Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">2</span>
            <span class="text-gray-500">GitHub</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="step3Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">3</span>
            <span class="text-gray-500">ë©”ëª¨</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="step4Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">4</span>
            <span class="text-gray-500">íšŒê³ </span>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="p-6 max-h-[55vh] overflow-auto custom-scrollbar" id="wrapupContent">
        <!-- Step content will be rendered here -->
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-gray-700/50 flex items-center justify-between">
        <button onclick="prevWrapupStep()" id="wrapupPrevBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm hidden">
          â† ì´ì „
        </button>
        <div class="flex-1"></div>
        <button onclick="nextWrapupStep()" id="wrapupNextBtn" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium">
          ë‹¤ìŒ â†’
        </button>
        <button onclick="submitDayWrapup()" id="wrapupSubmitBtn" class="px-6 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 rounded-lg font-medium hidden">
          ğŸŒ™ í•˜ë£¨ ë§ˆë¬´ë¦¬ ìƒì„±
        </button>
      </div>
    </div>
  </div>

  <!-- Morning Start Wizard Modal -->
  <div id="morningStartModal" class="modal fixed inset-0 bg-black/60 items-center justify-center z-50 overflow-auto py-4">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl w-full max-w-3xl mx-4 shadow-2xl border border-gray-700/50">
      <!-- Header -->
      <div class="px-6 py-4 border-b border-gray-700/50 flex items-center justify-between bg-gradient-to-r from-amber-900/30 to-orange-900/30 rounded-t-2xl">
        <div class="flex items-center gap-3">
          <span class="text-3xl" id="morningHeaderIcon">â˜€ï¸</span>
          <div>
            <h2 class="text-xl font-bold" id="morningHeaderTitle">í•˜ë£¨ ì‹œì‘</h2>
            <p class="text-sm text-gray-400" id="morningDate">ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê³„íší•´ë³´ì„¸ìš”</p>
          </div>
        </div>
        <button onclick="closeMorningStartModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- Progress Steps (wizard mode only) -->
      <div id="morningStepBar" class="px-6 py-3 border-b border-gray-700/30 bg-gray-800/30">
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center gap-2" id="mStep1Indicator">
            <span class="w-6 h-6 rounded-full bg-amber-600 flex items-center justify-center text-xs font-bold">1</span>
            <span class="text-gray-300">ì—…ë¬´</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="mStep2Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">2</span>
            <span class="text-gray-500">ì¶”ê°€</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="mStep3Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">3</span>
            <span class="text-gray-500">ëª©í‘œ</span>
          </div>
          <div class="flex-1 h-0.5 bg-gray-700 mx-2"></div>
          <div class="flex items-center gap-2" id="mStep4Indicator">
            <span class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs">4</span>
            <span class="text-gray-500">í™•ì¸</span>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="p-6 max-h-[65vh] overflow-auto custom-scrollbar" id="morningContent">
      </div>

      <!-- Footer -->
      <div class="px-6 py-4 border-t border-gray-700/50 flex items-center justify-between" id="morningFooter">
        <button onclick="prevMorningStep()" id="morningPrevBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm hidden">
          â† ì´ì „
        </button>
        <div class="flex-1"></div>
        <button onclick="nextMorningStep()" id="morningNextBtn" class="px-6 py-2 bg-amber-600 hover:bg-amber-500 rounded-lg font-medium">
          ë‹¤ìŒ â†’
        </button>
        <button onclick="submitMorningPlan()" id="morningSubmitBtn" class="px-6 py-2 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-lg font-medium hidden">
          â˜€ï¸ í•˜ë£¨ ì‹œì‘!
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';

    // ============ ë¹„ë™ê¸° ì‘ì—… ì‹œìŠ¤í…œ ============
    let eventSource = null;
    let clientId = `client-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
    const activeTasks = new Map();

    // SSE ì—°ê²° ì´ˆê¸°í™”
    function initSSE() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`${API_BASE}/api/tasks/events?clientId=${clientId}`);

      eventSource.addEventListener('connected', (e) => {
        const data = JSON.parse(e.data);
        console.log('[SSE] ì—°ê²°ë¨:', data.clientId);
      });

      eventSource.addEventListener('task:started', (e) => {
        const data = JSON.parse(e.data);
        activeTasks.set(data.taskId, { type: data.type, status: 'running' });
        addTaskToPanel(data);
      });

      eventSource.addEventListener('task:progress', (e) => {
        const data = JSON.parse(e.data);
        updateTaskProgress(data);
      });

      eventSource.addEventListener('task:completed', (e) => {
        const data = JSON.parse(e.data);
        markTaskCompleted(data);
        handleTaskResult(data);
      });

      eventSource.addEventListener('task:failed', (e) => {
        const data = JSON.parse(e.data);
        markTaskFailed(data);
      });

      eventSource.addEventListener('task:deleted', (e) => {
        const data = JSON.parse(e.data);
        removeTaskFromPanel(data.taskId);
      });

      eventSource.onerror = () => {
        console.log('[SSE] ì—°ê²° ì˜¤ë¥˜, 5ì´ˆ í›„ ì¬ì—°ê²°...');
        setTimeout(initSSE, 5000);
      };
    }

    // ì‘ì—… íŒ¨ë„ì— í•­ëª© ì¶”ê°€
    function addTaskToPanel(data) {
      const panel = document.getElementById('taskPanel');
      const list = document.getElementById('taskList');

      panel.classList.remove('hidden');

      const taskEl = document.createElement('div');
      taskEl.id = `task-${data.taskId}`;
      taskEl.className = 'bg-gray-700 rounded-lg p-3 border border-gray-600 cursor-pointer hover:bg-gray-650 transition-colors';
      taskEl.setAttribute('data-task-id', data.taskId);
      taskEl.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium task-click-area" onclick="showTaskDetail('${data.taskId}')">${getTaskTypeName(data.type)}</span>
          <button onclick="event.stopPropagation(); cancelTask('${data.taskId}')" class="text-gray-400 hover:text-red-400 text-xs px-2 py-0.5 hover:bg-gray-600 rounded">
            ì·¨ì†Œ
          </button>
        </div>
        <div class="flex items-center gap-2 mb-1 task-click-area" onclick="showTaskDetail('${data.taskId}')">
          <div class="flex-1 bg-gray-600 rounded-full h-1.5">
            <div id="progress-${data.taskId}" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <span id="progress-text-${data.taskId}" class="text-xs text-gray-400 w-8 text-right">0%</span>
        </div>
        <div id="message-${data.taskId}" class="text-xs text-gray-400 truncate task-click-area" onclick="showTaskDetail('${data.taskId}')">ì‹œì‘ ì¤‘...</div>
      `;

      list.prepend(taskEl);
      updateTaskCount();
    }

    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    function updateTaskProgress(data) {
      const progressBar = document.getElementById(`progress-${data.taskId}`);
      const progressText = document.getElementById(`progress-text-${data.taskId}`);
      const message = document.getElementById(`message-${data.taskId}`);

      if (progressBar) {
        progressBar.style.width = `${data.progress}%`;
      }
      if (progressText) {
        progressText.textContent = `${data.progress}%`;
      }
      if (message && data.message) {
        message.textContent = data.message;
      }
    }

    // ì‘ì—… ì™„ë£Œ í‘œì‹œ
    function markTaskCompleted(data) {
      const taskEl = document.getElementById(`task-${data.taskId}`);
      if (taskEl) {
        taskEl.className = 'bg-green-900/30 rounded-lg p-3 border border-green-700/50';

        const progressBar = document.getElementById(`progress-${data.taskId}`);
        if (progressBar) {
          progressBar.style.width = '100%';
          progressBar.className = 'bg-green-500 h-1.5 rounded-full';
        }

        const progressText = document.getElementById(`progress-text-${data.taskId}`);
        if (progressText) {
          progressText.textContent = 'âœ“';
          progressText.className = 'text-xs text-green-400 w-8 text-right';
        }

        const message = document.getElementById(`message-${data.taskId}`);
        if (message) {
          message.innerHTML = `<button onclick="viewTaskResult('${data.taskId}')" class="text-green-400 hover:underline">ê²°ê³¼ ë³´ê¸°</button>`;
        }

        // ì·¨ì†Œ ë²„íŠ¼ ì œê±°
        const cancelBtn = taskEl.querySelector('button');
        if (cancelBtn) cancelBtn.remove();
      }

      activeTasks.set(data.taskId, { type: data.type, status: 'completed', result: data.result });
      showToast(`${getTaskTypeName(data.type)} ì™„ë£Œ!`, 'success');

      // 5ì´ˆ í›„ ìë™ ì œê±°
      setTimeout(() => {
        removeTaskFromPanel(data.taskId);
      }, 8000);
    }

    // ì‘ì—… ì‹¤íŒ¨ í‘œì‹œ
    function markTaskFailed(data) {
      const taskEl = document.getElementById(`task-${data.taskId}`);
      if (taskEl) {
        taskEl.className = 'bg-red-900/30 rounded-lg p-3 border border-red-700/50';

        const progressBar = document.getElementById(`progress-${data.taskId}`);
        if (progressBar) {
          progressBar.className = 'bg-red-500 h-1.5 rounded-full';
        }

        const progressText = document.getElementById(`progress-text-${data.taskId}`);
        if (progressText) {
          progressText.textContent = 'âœ—';
          progressText.className = 'text-xs text-red-400 w-8 text-right';
        }

        const message = document.getElementById(`message-${data.taskId}`);
        if (message) {
          message.textContent = data.error || 'ì‹¤íŒ¨';
          message.className = 'text-xs text-red-400 truncate';
        }

        const cancelBtn = taskEl.querySelector('button');
        if (cancelBtn) cancelBtn.remove();
      }

      activeTasks.set(data.taskId, { type: data.type, status: 'failed', error: data.error });
      showToast(`${getTaskTypeName(data.type)} ì‹¤íŒ¨: ${data.error}`, 'error');
    }

    // íŒ¨ë„ì—ì„œ ì‘ì—… ì œê±°
    function removeTaskFromPanel(taskId) {
      const taskEl = document.getElementById(`task-${taskId}`);
      if (taskEl) {
        taskEl.remove();
      }
      activeTasks.delete(taskId);
      updateTaskCount();

      // ì‘ì—…ì´ ì—†ìœ¼ë©´ íŒ¨ë„ ìˆ¨ê¸°ê¸°
      if (activeTasks.size === 0) {
        document.getElementById('taskPanel').classList.add('hidden');
      }
    }

    // ì‘ì—… ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function updateTaskCount() {
      const runningCount = Array.from(activeTasks.values()).filter(t => t.status === 'running').length;
      document.getElementById('taskCount').textContent = runningCount;
    }

    // ì‘ì—… íƒ€ì… ì´ë¦„
    function getTaskTypeName(type) {
      const names = {
        'ask': 'ğŸ¤– Claude ì§ˆë¬¸',
        'daily-report': 'ğŸ“Š ì¼ì¼ ë³´ê³ ì„œ',
        'session-summary': 'ğŸ“‹ ì„¸ì…˜ ìš”ì•½',
        'full-daily-report': 'ğŸ“Š ì¢…í•© ë³´ê³ ì„œ',
        'day-wrapup': 'ğŸŒ™ í•˜ë£¨ ë§ˆë¬´ë¦¬'
      };
      return names[type] || type;
    }

    // ì‘ì—… ì·¨ì†Œ
    async function cancelTask(taskId) {
      try {
        await fetch(`${API_BASE}/api/tasks/${taskId}`, { method: 'DELETE' });
        removeTaskFromPanel(taskId);
        showToast('ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
      } catch (err) {
        showToast('ì·¨ì†Œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ì™„ë£Œëœ ì‘ì—… ì •ë¦¬
    function clearCompletedTasks() {
      for (const [taskId, task] of activeTasks) {
        if (task.status === 'completed' || task.status === 'failed') {
          removeTaskFromPanel(taskId);
        }
      }
    }

    // íŒ¨ë„ ì ‘ê¸°/í¼ì¹˜ê¸°
    function toggleTaskPanelCollapse() {
      const list = document.getElementById('taskList');
      const toggle = document.getElementById('taskPanelToggle');

      if (list.classList.contains('hidden')) {
        list.classList.remove('hidden');
        toggle.textContent = 'â–¼';
      } else {
        list.classList.add('hidden');
        toggle.textContent = 'â–²';
      }
    }

    // ============ Task Detail Modal ============
    let currentTaskDetailId = null;
    let taskDetailRefreshInterval = null;

    async function showTaskDetail(taskId) {
      currentTaskDetailId = taskId;
      const modal = document.getElementById('taskDetailModal');
      modal.classList.add('active');
      modal.style.display = 'flex';

      await refreshTaskDetail();

      // ìë™ ìƒˆë¡œê³ ì¹¨ (2ì´ˆë§ˆë‹¤)
      taskDetailRefreshInterval = setInterval(async () => {
        const task = activeTasks.get(currentTaskDetailId);
        if (task && task.status === 'running') {
          await refreshTaskDetail();
        } else {
          clearInterval(taskDetailRefreshInterval);
        }
      }, 2000);
    }

    async function refreshTaskDetail() {
      if (!currentTaskDetailId) return;

      try {
        const res = await fetch(`${API_BASE}/api/tasks/${currentTaskDetailId}`);
        if (!res.ok) {
          document.getElementById('taskOutputTab').textContent = 'ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          return;
        }

        const task = await res.json();
        updateTaskDetailUI(task);
      } catch (err) {
        document.getElementById('taskOutputTab').textContent = 'ì˜¤ë¥˜: ' + err.message;
      }
    }

    function updateTaskDetailUI(task) {
      document.getElementById('taskDetailTitle').textContent = getTaskTypeName(task.type);

      const statusMap = {
        'pending': 'â³ ëŒ€ê¸° ì¤‘',
        'running': 'ğŸ”„ ì§„í–‰ ì¤‘',
        'completed': 'âœ… ì™„ë£Œ',
        'failed': 'âŒ ì‹¤íŒ¨'
      };
      document.getElementById('taskDetailStatus').textContent = statusMap[task.status] || task.status;

      const emojiMap = {
        'pending': 'â³',
        'running': 'ğŸ”„',
        'completed': 'âœ…',
        'failed': 'âŒ'
      };
      document.getElementById('taskDetailEmoji').textContent = emojiMap[task.status] || 'ğŸ”„';

      // ì¶œë ¥ íƒ­ - ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¸ UI í‘œì‹œ
      const outputTab = document.getElementById('taskOutputTab');

      if (task.status === 'pending') {
        outputTab.innerHTML = `
          <div class="flex flex-col items-center justify-center py-8 text-gray-400">
            <div class="text-4xl mb-4">â³</div>
            <div class="text-lg font-medium">ëŒ€ê¸° ì¤‘</div>
            <div class="text-sm mt-2">ì‘ì—…ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤...</div>
          </div>
        `;
      } else if (task.status === 'running') {
        const progress = task.progress || 0;
        const message = task.progressMessage || 'Claude ì²˜ë¦¬ ì¤‘...';
        const recentLogs = (task.logs || []).slice(-5);
        outputTab.innerHTML = `
          <div class="flex flex-col items-center justify-center py-4">
            <div class="relative w-16 h-16 mb-3">
              <svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="16" fill="none" stroke="#374151" stroke-width="3"></circle>
                <circle cx="18" cy="18" r="16" fill="none" stroke="#3b82f6" stroke-width="3"
                        stroke-dasharray="${progress}, 100" stroke-linecap="round"
                        class="transition-all duration-500"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center text-sm font-bold">${progress}%</div>
            </div>
            <div class="text-base font-medium text-gray-200 mb-1">${escapeHtml(message)}</div>
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
              <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
              ì²˜ë¦¬ ì¤‘...
            </div>
          </div>

          ${task.command ? `
            <div class="bg-gray-950 rounded-lg p-3 mb-3 border border-gray-800">
              <div class="text-xs text-gray-500 mb-1">ì‹¤í–‰ ëª…ë ¹ì–´:</div>
              <div class="text-xs font-mono text-green-400">${escapeHtml(task.command)}</div>
            </div>
          ` : ''}

          <div class="bg-gray-950 rounded-lg p-3 border border-gray-800">
            <div class="text-xs text-gray-500 mb-2">ìµœê·¼ ë¡œê·¸:</div>
            <div class="space-y-1 max-h-40 overflow-auto text-xs font-mono">
              ${recentLogs.length > 0 ? recentLogs.map(log => {
                const time = new Date(log.time).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const color = log.type === 'stderr' ? 'text-red-400' : log.type === 'cmd' ? 'text-yellow-400' : log.type === 'info' ? 'text-blue-400' : 'text-gray-400';
                return `<div class="${color}"><span class="text-gray-600">[${time}]</span> ${escapeHtml(log.text.substring(0, 200))}</div>`;
              }).join('') : '<div class="text-gray-600">ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>'}
            </div>
          </div>

          ${task.stdout ? `
            <div class="mt-3 bg-gray-950 rounded-lg p-3 border border-gray-800">
              <div class="text-xs text-gray-500 mb-2">ì‹¤ì‹œê°„ ì¶œë ¥ (${task.stdout.length}ì):</div>
              <div class="text-xs font-mono text-gray-400 max-h-32 overflow-auto whitespace-pre-wrap">${escapeHtml(task.stdout.slice(-500))}</div>
            </div>
          ` : ''}
        `;
      } else if (task.status === 'completed') {
        // ì™„ë£Œ ì‹œ ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ëœ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
        const preview = task.stdout ? task.stdout.substring(0, 1000) : 'ê²°ê³¼ ì—†ìŒ';
        outputTab.innerHTML = `
          <div class="flex flex-col items-center py-4 mb-4 border-b border-gray-700">
            <div class="text-4xl mb-2">âœ…</div>
            <div class="text-lg font-medium text-green-400">ì™„ë£Œ!</div>
          </div>
          <div class="markdown-content text-sm">${renderMarkdown(preview)}${task.stdout?.length > 1000 ? '<div class="text-gray-500 mt-2">...</div>' : ''}</div>
        `;
      } else if (task.status === 'failed') {
        outputTab.innerHTML = `
          <div class="flex flex-col items-center py-4 mb-4 border-b border-gray-700">
            <div class="text-4xl mb-2">âŒ</div>
            <div class="text-lg font-medium text-red-400">ì‹¤íŒ¨</div>
          </div>
          <div class="bg-red-900/20 border border-red-800/30 rounded-lg p-4">
            <div class="text-red-400 font-medium mb-2">ì˜¤ë¥˜ ë©”ì‹œì§€:</div>
            <div class="text-sm text-red-300">${escapeHtml(task.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')}</div>
          </div>
          ${task.stderr ? `
            <div class="mt-4 bg-gray-950 rounded-lg p-3 text-xs font-mono text-red-400 max-h-40 overflow-auto">
              <div class="text-gray-600 mb-1">stderr:</div>
              ${escapeHtml(task.stderr)}
            </div>
          ` : ''}
        `;
      } else {
        outputTab.innerHTML = '<div class="text-gray-500 text-center py-8">ì¶œë ¥ ì—†ìŒ</div>';
      }

      // logs íƒ­
      const logsTab = document.getElementById('taskLogsTab');
      if (task.logs && task.logs.length > 0) {
        logsTab.innerHTML = task.logs.map(log => {
          const time = new Date(log.time).toLocaleTimeString();
          const color = log.type === 'stderr' ? 'text-red-400' : 'text-green-400';
          return `<div class="mb-1"><span class="text-gray-500">[${time}]</span> <span class="${color}">${escapeHtml(log.text)}</span></div>`;
        }).join('');
        logsTab.scrollTop = logsTab.scrollHeight;
      } else {
        logsTab.innerHTML = '<div class="text-gray-500 text-center py-8">ë¡œê·¸ ì—†ìŒ</div>';
      }
    }

    function switchTaskTab(tab) {
      const outputTab = document.getElementById('taskOutputTab');
      const logsTab = document.getElementById('taskLogsTab');
      const outputBtn = document.getElementById('taskTabOutput');
      const logsBtn = document.getElementById('taskTabLogs');

      if (tab === 'output') {
        outputTab.classList.remove('hidden');
        logsTab.classList.add('hidden');
        outputBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-blue-600';
        logsBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-gray-700 hover:bg-gray-600';
      } else {
        outputTab.classList.add('hidden');
        logsTab.classList.remove('hidden');
        outputBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-gray-700 hover:bg-gray-600';
        logsBtn.className = 'px-3 py-1.5 rounded-lg text-sm bg-blue-600';
      }
    }

    function closeTaskDetailModal() {
      const modal = document.getElementById('taskDetailModal');
      modal.classList.remove('active');
      modal.style.display = 'none';
      currentTaskDetailId = null;
      if (taskDetailRefreshInterval) {
        clearInterval(taskDetailRefreshInterval);
        taskDetailRefreshInterval = null;
      }
    }

    // ============ ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ============
    function renderMarkdown(text) {
      if (typeof marked !== 'undefined') {
        // marked.jsê°€ ë¡œë“œë˜ì—ˆìœ¼ë©´ ì‚¬ìš©
        marked.setOptions({
          breaks: true,
          gfm: true
        });
        return marked.parse(text);
      }
      // í´ë°±: ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ ë³€í™˜
      return text
        .replace(/^### (.+)$/gm, '<h3 class="text-base font-bold mt-4 mb-2 text-gray-200">$1</h3>')
        .replace(/^## (.+)$/gm, '<h2 class="text-lg font-bold mt-5 mb-2 text-gray-100">$1</h2>')
        .replace(/^# (.+)$/gm, '<h1 class="text-xl font-bold mt-6 mb-3 text-white">$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code class="bg-gray-700 px-1.5 py-0.5 rounded text-sm">$1</code>')
        .replace(/^- (.+)$/gm, '<li class="ml-4">$1</li>')
        .replace(/^(\d+)\. (.+)$/gm, '<li class="ml-4">$1. $2</li>')
        .replace(/\n/g, '<br>');
    }

    // ì‘ì—… ê²°ê³¼ ë³´ê¸°
    function viewTaskResult(taskId) {
      const task = activeTasks.get(taskId);
      if (task && task.result) {
        handleTaskResult({ taskId, type: task.type, result: task.result });
      }
    }

    // ì‘ì—… ê²°ê³¼ ì²˜ë¦¬
    function handleTaskResult(data) {
      switch (data.type) {
        case 'ask':
          showAskResultModal(data.result);
          break;
        case 'daily-report':
        case 'full-daily-report':
          showFullReportModal(data.result);
          break;
        case 'session-summary':
          showSessionSummaryModal(data.result);
          break;
        case 'day-wrapup':
          showDayWrapupResult(data.result);
          break;
      }
    }

    // Claude ì§ˆë¬¸ ê²°ê³¼ ëª¨ë‹¬
    let currentAskResponse = '';

    function showAskResultModal(result) {
      const modal = document.getElementById('askModal');
      const responseDiv = document.getElementById('askResponse');
      const responseText = document.getElementById('askResponseText');
      const loadingDiv = document.getElementById('askLoading');
      const copyBtn = document.getElementById('askCopyBtn');

      loadingDiv.classList.add('hidden');
      currentAskResponse = result.response;
      responseText.innerHTML = renderMarkdown(result.response);
      responseDiv.classList.remove('hidden');
      copyBtn.classList.remove('hidden');
      document.getElementById('askModalEmoji').textContent = 'ğŸ˜Š';

      modal.style.display = 'flex';
    }

    // ì„¸ì…˜ ìš”ì•½ ëª¨ë‹¬
    // í˜„ì¬ ìš”ì•½ ë‚´ìš© ì €ì¥ (ë³µì‚¬ìš©)
    let currentSummaryContent = '';

    function showSessionSummaryModal(result) {
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');
      currentSummaryContent = result.summary;

      content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-lg">ğŸ“‹</div>
            <div>
              <h3 class="text-lg font-bold">ì„¸ì…˜ ìš”ì•½</h3>
              <p class="text-xs text-gray-400">${result.project}</p>
            </div>
          </div>
          <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>

        <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[65vh] overflow-auto custom-scrollbar">
          <div class="prose prose-invert prose-sm max-w-none markdown-content">${renderMarkdown(result.summary)}</div>
        </div>

        <div class="flex gap-2 mt-4">
          <button onclick="copySummary()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
            ğŸ“‹ ë³µì‚¬
          </button>
        </div>
      `;

      modal.style.display = 'flex';
    }

    function copySummary() {
      if (currentSummaryContent) {
        copyToClipboard(currentSummaryContent, 'ìš”ì•½ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    // ë¹„ë™ê¸° ì‘ì—… ì œì¶œ í—¬í¼
    async function submitTask(type, payload) {
      try {
        const res = await fetch(`${API_BASE}/api/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, payload, clientId })
        });

        const data = await res.json();

        if (data.success) {
          return data.taskId;
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        showToast('ì‘ì—… ì œì¶œ ì‹¤íŒ¨: ' + err.message, 'error');
        throw err;
      }
    }

    // ============ ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜ ============
    let categories = {};
    let currentFilter = 'all';
    let historyData = [];  // ì „ì—­ ë³€ìˆ˜ë¡œ ì´ë ¥ ì €ì¥
    let currentView = 'card';  // í˜„ì¬ ë·° (card/graph)
    let graphNetwork = null;  // vis.Network ì¸ìŠ¤í„´ìŠ¤
    let graphNodes = null;    // vis.DataSet for nodes
    let graphEdges = null;    // vis.DataSet for edges
    let allJobsData = [];     // ì „ì²´ ì‘ì—… ë°ì´í„° ìºì‹œ
    let allEdgesData = [];    // ì—°ê²°ì„  ë°ì´í„° ìºì‹œ
    let contextMenuNodeId = null;  // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ëŒ€ìƒ ë…¸ë“œ
    let historyPagination = { page: 1, totalPages: 1 };  // ì´ë ¥ í˜ì´ì§€ë„¤ì´ì…˜
    let historySearchTimeout = null;  // ê²€ìƒ‰ ë””ë°”ìš´ìŠ¤

    // Cron í‘œí˜„ì‹ í”„ë¦¬ì…‹ (ë¹ ë¥¸ ì°¸ì¡°ìš©)
    const cronPresets = {
      '0 * * * *': { desc: 'ë§¤ì‹œ ì •ê°', icon: 'ğŸ•' },
      '0 9 * * *': { desc: 'ë§¤ì¼ ì˜¤ì „ 9ì‹œ', icon: 'ğŸŒ…' },
      '0 9 * * 1-5': { desc: 'í‰ì¼ ì˜¤ì „ 9ì‹œ', icon: 'ğŸ’¼' },
      '0 18 * * *': { desc: 'ë§¤ì¼ ì˜¤í›„ 6ì‹œ', icon: 'ğŸŒ†' },
      '0 18 * * 1-5': { desc: 'í‰ì¼ ì˜¤í›„ 6ì‹œ', icon: 'ğŸ’¼' },
      '0 20 * * 1-5': { desc: 'í‰ì¼ ì˜¤í›„ 8ì‹œ', icon: 'ğŸŒ™' },
      '0 0 * * *': { desc: 'ë§¤ì¼ ìì •', icon: 'ğŸŒ™' },
      '0 8 * * 1-5': { desc: 'í‰ì¼ ì˜¤ì „ 8ì‹œ', icon: 'â˜€ï¸' },
      '*/5 * * * *': { desc: '5ë¶„ë§ˆë‹¤', icon: 'âš¡' },
      '*/30 * * * *': { desc: '30ë¶„ë§ˆë‹¤', icon: 'â±ï¸' },
      '0 */2 * * *': { desc: '2ì‹œê°„ë§ˆë‹¤', icon: 'ğŸ”„' },
      '0 0 * * 0': { desc: 'ë§¤ì£¼ ì¼ìš”ì¼ ìì •', icon: 'ğŸ“…' },
      '0 0 1 * *': { desc: 'ë§¤ì›” 1ì¼ ìì •', icon: 'ğŸ“†' },
    };

    // Load data
    async function loadJobs() {
      const res = await fetch(`${API_BASE}/api/jobs`);
      const data = await res.json();
      categories = data.categories;
      allJobsData = data.jobs;
      allEdgesData = data.edges || [];
      renderCategoryFilter();
      renderJobs(data.jobs);
      document.getElementById('jobCount').textContent = data.jobs.filter(j => j.enabled).length;

      // ë¸Œë¼ìš°ì € ì•Œë¦¼ ì²´í¬ (ì‘ì—… ì™„ë£Œ ê°ì§€)
      checkJobCompletion(data.jobs);

      // ê·¸ë˜í”„ ë·°ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ê·¸ë˜í”„ë„ ì—…ë°ì´íŠ¸
      if (currentView === 'graph') {
        updateGraphNodes(data.jobs);
      }
    }

    // ê²€ìƒ‰ ë””ë°”ìš´ìŠ¤
    function debounceHistorySearch() {
      clearTimeout(historySearchTimeout);
      historySearchTimeout = setTimeout(() => {
        loadHistoryFiltered();
      }, 300);
    }

    // í•„í„° ì ìš©í•˜ì—¬ ì´ë ¥ ë¡œë“œ
    async function loadHistoryFiltered(page = 1) {
      const search = document.getElementById('historySearch').value;
      const status = document.getElementById('historyStatus').value;
      const startDate = document.getElementById('historyStartDate').value;
      const endDate = document.getElementById('historyEndDate').value;

      const params = new URLSearchParams();
      params.set('page', page);
      params.set('limit', 10);
      if (search) params.set('search', search);
      if (status) params.set('status', status);
      if (startDate) params.set('startDate', startDate);
      if (endDate) params.set('endDate', endDate);

      const res = await fetch(`${API_BASE}/api/history?${params}`);
      const data = await res.json();

      historyData = data.items;
      historyPagination = data.pagination;

      renderHistory(historyData);
      renderHistoryPagination(data.pagination);
    }

    // ê¸°ì¡´ loadHistoryëŠ” loadHistoryFiltered í˜¸ì¶œ
    async function loadHistory() {
      return loadHistoryFiltered(1);
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderHistoryPagination(pagination) {
      const { page, totalPages, total, limit } = pagination;

      // ì •ë³´ í…ìŠ¤íŠ¸
      const start = total > 0 ? (page - 1) * limit + 1 : 0;
      const end = Math.min(page * limit, total);
      document.getElementById('historyInfo').textContent =
        total > 0 ? `${start}-${end} / ì´ ${total}ê±´` : 'ê²°ê³¼ ì—†ìŒ';

      // ì´ì „/ë‹¤ìŒ ë²„íŠ¼
      document.getElementById('historyPrevBtn').disabled = !pagination.hasPrev;
      document.getElementById('historyNextBtn').disabled = !pagination.hasNext;

      // í˜ì´ì§€ ë²ˆí˜¸
      const pageNumbers = document.getElementById('historyPageNumbers');
      pageNumbers.innerHTML = '';

      if (totalPages <= 1) return;

      // ìµœëŒ€ 5ê°œ í˜ì´ì§€ ë²ˆí˜¸ í‘œì‹œ
      let startPage = Math.max(1, page - 2);
      let endPage = Math.min(totalPages, startPage + 4);
      if (endPage - startPage < 4) {
        startPage = Math.max(1, endPage - 4);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded text-sm ${
          i === page
            ? 'bg-blue-600 text-white'
            : 'bg-gray-700 hover:bg-gray-600 text-gray-300'
        }`;
        btn.onclick = () => loadHistoryFiltered(i);
        pageNumbers.appendChild(btn);
      }
    }

    // í˜ì´ì§€ ì´ë™
    function loadHistoryPage(direction) {
      const newPage = direction === 'next'
        ? historyPagination.page + 1
        : historyPagination.page - 1;
      loadHistoryFiltered(newPage);
    }

    // í•„í„° ì´ˆê¸°í™”
    function resetHistoryFilters() {
      document.getElementById('historySearch').value = '';
      document.getElementById('historyStatus').value = '';
      document.getElementById('historyStartDate').value = '';
      document.getElementById('historyEndDate').value = '';
      loadHistoryFiltered(1);
    }

    // Render functions
    function renderCategoryFilter() {
      const container = document.getElementById('categoryFilter');
      container.innerHTML = `
        <button onclick="filterByCategory('all')" class="filter-btn px-3 py-1 rounded-full text-sm ${currentFilter === 'all' ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
          ì „ì²´
        </button>
        ${Object.entries(categories).map(([key, cat]) => `
          <button onclick="filterByCategory('${key}')" class="filter-btn px-3 py-1 rounded-full text-sm ${currentFilter === key ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
            ${cat.name}
          </button>
        `).join('')}
      `;
    }

    function renderJobs(jobs) {
      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.category === currentFilter);
      const container = document.getElementById('jobsGrid');

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-400">
            <p class="text-4xl mb-2">ğŸ“­</p>
            <p>ë“±ë¡ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(job => {
        const cat = categories[job.category] || { name: 'ê¸°íƒ€', color: '#6b7280' };
        const isRunning = job.isRunning;
        return `
          <div class="job-card bg-gray-800 rounded-xl p-4 border ${isRunning ? 'border-yellow-500' : 'border-gray-700'}">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-2">
                <span class="status-dot ${isRunning ? 'bg-yellow-500 pulse' : (job.enabled ? 'bg-green-500' : 'bg-gray-500')}"></span>
                <span class="text-sm px-2 py-0.5 rounded" style="background: ${cat.color}20; color: ${cat.color}">
                  ${cat.name}
                </span>
                ${isRunning ? '<span class="text-xs text-yellow-400 ml-1">ì‹¤í–‰ì¤‘</span>' : ''}
              </div>
              <div class="flex gap-1">
                <button onclick="duplicateJob('${job.id}')" class="p-1 hover:bg-gray-700 rounded" title="ë³µì œ">ğŸ“‹</button>
                <button onclick="editJob('${job.id}')" class="p-1 hover:bg-gray-700 rounded" title="í¸ì§‘">âœï¸</button>
                <button onclick="deleteJob('${job.id}')" class="p-1 hover:bg-gray-700 rounded" title="ì‚­ì œ">ğŸ—‘ï¸</button>
              </div>
            </div>

            <h3 class="font-semibold text-lg mb-1">${job.name}</h3>
            <p class="text-sm text-gray-400 mb-2">${job.description || 'ì„¤ëª… ì—†ìŒ'}</p>
            ${job.notes ? `<p class="text-xs text-yellow-500/80 bg-yellow-900/20 px-2 py-1 rounded mb-2">ğŸ“ ${job.notes}</p>` : ''}

            <div class="text-xs text-gray-500 mb-3 font-mono bg-gray-900 px-2 py-1 rounded">
              ${job.schedule} ${cronPresets[job.schedule] ? `(${cronPresets[job.schedule].desc})` : ''}
            </div>

            <div class="flex gap-2">
              ${isRunning ? `
                <button onclick="showLiveLog('${job.id}')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg text-sm font-medium">
                  ğŸ“‹ ë¡œê·¸ ë³´ê¸°
                </button>
              ` : `
                <button onclick="runJob('${job.id}')" class="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm font-medium">
                  â–¶ ì‹¤í–‰
                </button>
              `}
              <button onclick="toggleJob('${job.id}')" class="flex-1 ${job.enabled ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 hover:bg-gray-500'} py-2 rounded-lg text-sm font-medium" ${isRunning ? 'disabled' : ''}>
                ${job.enabled ? 'â¸ ë¹„í™œì„±í™”' : 'â–¶ í™œì„±í™”'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderHistory(history) {
      const container = document.getElementById('historyTable');

      if (history.length === 0) {
        container.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</td>
          </tr>
        `;
        return;
      }

      const triggerText = {
        manual: 'ìˆ˜ë™',
        scheduled: 'ìŠ¤ì¼€ì¤„',
        chained: 'â›“ï¸ ì²´ì¸',
        'auto-fix': 'ğŸ”§ ìë™ë³µêµ¬',
        'scheduled-once': 'â° ì˜ˆì•½',
        retry: 'ğŸ”„ ì¬ì‹œë„'
      };

      const statusColors = {
        success: 'bg-green-500',
        failed: 'bg-red-500',
        running: 'bg-yellow-500 pulse'
      };
      const statusText = {
        success: 'ì„±ê³µ',
        failed: 'ì‹¤íŒ¨',
        running: 'ì‹¤í–‰ì¤‘'
      };

      container.innerHTML = history.map((h) => {
        return `
          <tr class="hover:bg-gray-700/50">
            <td class="px-4 py-3 font-medium">${h.jobName}</td>
            <td class="px-4 py-3 text-sm text-gray-400">${triggerText[h.trigger] || h.trigger}</td>
            <td class="px-4 py-3 text-sm">${new Date(h.startTime).toLocaleString('ko-KR')}</td>
            <td class="px-4 py-3 text-sm">${h.duration ? `${(h.duration / 1000).toFixed(1)}ì´ˆ` : '-'}</td>
            <td class="px-4 py-3">
              <span class="flex items-center gap-2">
                <span class="status-dot ${statusColors[h.status]}"></span>
                ${statusText[h.status]}
              </span>
            </td>
            <td class="px-4 py-3">
              <button onclick="showLogById(${h.id})" class="text-blue-400 hover:underline text-sm">
                ìƒì„¸
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // IDë¡œ ë¡œê·¸ í‘œì‹œ
    function showLogById(logId) {
      const entry = historyData.find(h => h.id === logId);
      if (!entry) return;

      stopLiveLogPolling();

      // ëª…ë ¹ì–´ í‘œì‹œ
      const cmdSection = document.getElementById('logCommandSection');
      const cmdEl = document.getElementById('logCommand');
      if (entry.command) {
        cmdEl.textContent = entry.command;
        cmdSection.classList.remove('hidden');
      } else {
        cmdSection.classList.add('hidden');
      }

      document.getElementById('logStdout').textContent = entry.stdout || '(ì—†ìŒ)';
      document.getElementById('logStderr').textContent = entry.stderr || entry.error || '(ì—†ìŒ)';
      document.getElementById('logModal').classList.add('active');

      // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ (ì™„ë£Œëœ ë¡œê·¸ëŠ” ì²˜ìŒë¶€í„° ë³´ê¸°)
      setTimeout(() => {
        scrollLogToTop('logStdout');
        scrollLogToTop('logStderr');
      }, 50);
    }

    // Options Modal
    let currentJobForOptions = null;
    let allJobs = [];  // ì „ì²´ ì‘ì—… ëª©ë¡ ìºì‹œ

    async function runJob(id) {
      // ì‘ì—… ì •ë³´ ì¡°íšŒ
      const res = await fetch(`${API_BASE}/api/jobs/${id}`);
      const job = await res.json();

      // interactive ì‘ì—…ì€ ë¹ ë¥¸ ë©”ëª¨ ëª¨ë‹¬ë¡œ ì—°ê²°
      if (job.interactive) {
        openQuickInput('memo');
        return;
      }

      // ì˜µì…˜ì´ ìˆìœ¼ë©´ ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
      if (job.options && job.options.length > 0) {
        showOptionsModal(job);
      } else {
        // ì˜µì…˜ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹¤í–‰
        executeJob(id, {});
      }
    }

    function showOptionsModal(job) {
      currentJobForOptions = job;

      document.getElementById('optionsJobName').textContent = job.name;
      document.getElementById('optionsJobDesc').textContent = job.description || '';

      const container = document.getElementById('optionsContainer');

      const renderOption = (opt, idx, isSystem = false) => {
        const inputId = `opt-${idx}`;
        const bgClass = isSystem ? 'bg-blue-900/30 border border-blue-800/50' : 'bg-gray-700/50';

        if (opt.type === 'boolean') {
          return `
            <div class="flex items-start gap-3 p-3 ${bgClass} rounded-lg mb-2">
              <input type="checkbox" id="${inputId}"
                class="w-5 h-5 mt-0.5 rounded bg-gray-600 border-gray-500"
                data-flag="${opt.flag || ''}"
                data-type="boolean"
                data-system="${opt.system || false}"
                ${opt.default ? 'checked' : ''}
                onchange="updateCommandPreview()">
              <div>
                <label for="${inputId}" class="font-medium cursor-pointer">${opt.label}</label>
                <p class="text-sm text-gray-400">${opt.description}</p>
                ${!isSystem ? `<code class="text-xs text-blue-400">${opt.flag}</code>` : ''}
              </div>
            </div>
          `;
        } else if (opt.type === 'select') {
          const choices = opt.choices || [];
          const optionsHtml = choices.map(c =>
            `<option value="${c}" ${c === opt.default ? 'selected' : ''}>${c}</option>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <select id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="select"
                data-system="${opt.system || false}"
                onchange="updateCommandPreview()">
                ${optionsHtml}
              </select>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'string') {
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <input type="text" id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="string"
                data-system="${opt.system || false}"
                placeholder="${opt.placeholder || ''}"
                onkeyup="updateCommandPreview()">
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'array') {
          const defaultItems = opt.default || [];
          const tagsHtml = defaultItems.map(item =>
            `<div class="array-tag"><span title="${item}">${item}</span><button type="button" class="array-tag-remove" onclick="removeArrayTag(this, '${inputId}')">&times;</button></div>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <div id="${inputId}-container" class="array-input-container"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="array"
                data-system="${opt.system || false}">
                ${tagsHtml}
                <input type="text" class="array-input" placeholder="${opt.placeholder || 'Enter í‚¤ë¡œ ì¶”ê°€'}"
                  onkeydown="handleArrayInput(event, '${inputId}')">
              </div>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        }
        return '';
      };

      if (!job.options || job.options.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm">ì„¤ì • ê°€ëŠ¥í•œ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      } else {
        // ì¼ë°˜ ì˜µì…˜ê³¼ ì‹œìŠ¤í…œ ì˜µì…˜ ë¶„ë¦¬
        const normalOpts = job.options.filter(o => !o.system);
        const systemOpts = job.options.filter(o => o.system);

        let html = '';

        // ì¼ë°˜ ì˜µì…˜
        if (normalOpts.length > 0) {
          html += normalOpts.map((opt, idx) => renderOption(opt, idx)).join('');
        }

        // ì‹œìŠ¤í…œ ì˜µì…˜ (êµ¬ë¶„ì„  + ë‹¤ë¥¸ ìŠ¤íƒ€ì¼)
        if (systemOpts.length > 0) {
          html += `<div class="border-t border-gray-600 pt-4 mt-4">
            <p class="text-xs text-gray-500 mb-3 uppercase tracking-wider">ğŸ”” ì•Œë¦¼ ì„¤ì •</p>`;
          html += systemOpts.map((opt, idx) => renderOption(opt, normalOpts.length + idx, true)).join('');
          html += `</div>`;
        }

        container.innerHTML = html;
      }

      updateCommandPreview();
      document.getElementById('optionsModal').classList.add('active');
    }

    function updateCommandPreview() {
      if (!currentJobForOptions) return;

      let command = currentJobForOptions.command;
      const options = getSelectedOptions(false);  // system ì˜µì…˜ ì œì™¸
      const flags = [];
      const args = [];

      for (const [key, value] of Object.entries(options)) {
        if (typeof value === 'boolean' && value) {
          flags.push(key);
        } else if (typeof value === 'string' && value) {
          // keyê°€ --ë¡œ ì‹œì‘í•˜ë©´ flag=value í˜•ì‹, ì•„ë‹ˆë©´ ê·¸ëƒ¥ ê°’
          if (key.startsWith('--')) {
            flags.push(`${key} "${value}"`);
          } else {
            args.push(value);
          }
        }
      }

      // ëª…ë ¹ì–´ì— && ê°€ ìˆìœ¼ë©´ ê°ê°ì— í”Œë˜ê·¸ ì ìš©
      if (command.includes(' && ') && flags.length > 0) {
        const commands = command.split(' && ');
        const flagStr = flags.join(' ');
        command = commands.map(cmd => `${cmd} ${flagStr}`).join(' && ');
      } else {
        if (flags.length > 0) command += ' ' + flags.join(' ');
        if (args.length > 0) command += ' ' + args.join(' ');
      }

      document.getElementById('optionsCommandPreview').textContent = command;
    }

    function getSelectedOptions(includeSystem = true) {
      const options = {};
      const inputs = document.querySelectorAll('#optionsContainer input, #optionsContainer select');

      inputs.forEach(input => {
        const flag = input.dataset.flag;
        const arg = input.dataset.arg;
        const type = input.dataset.type;
        const isSystem = input.dataset.system === 'true';

        // system ì˜µì…˜ ì œì™¸ ì˜µì…˜
        if (!includeSystem && isSystem) return;

        if (type === 'boolean') {
          if (flag) options[flag] = input.checked;
        } else if (type === 'string' || type === 'select') {
          const value = input.value.trim();
          if (value) {
            if (flag) options[flag] = value;
            else if (arg) options[arg] = value;
          }
        }
      });

      // array íƒ€ì… ì²˜ë¦¬
      const arrayContainers = document.querySelectorAll('#optionsContainer .array-input-container');
      arrayContainers.forEach(container => {
        const flag = container.dataset.flag;
        const arg = container.dataset.arg;
        const isSystem = container.dataset.system === 'true';

        if (!includeSystem && isSystem) return;

        const tags = container.querySelectorAll('.array-tag span');
        const values = Array.from(tags).map(span => span.textContent);
        if (values.length > 0) {
          const joinedValue = values.join(',');
          if (flag) options[flag] = joinedValue;
          else if (arg) options[arg] = joinedValue;
        }
      });

      return options;
    }

    function closeOptionsModal() {
      document.getElementById('optionsModal').classList.remove('active');
      currentJobForOptions = null;
    }

    // Schedule Modal
    let currentScheduleJobId = null;

    async function showScheduleModal(jobId) {
      const res = await fetch(`${API_BASE}/api/jobs/${jobId}`);
      const job = await res.json();
      currentScheduleJobId = jobId;

      document.getElementById('scheduleJobInfo').textContent = job.name;

      // ê¸°ë³¸ê°’: í˜„ì¬ ì‹œê°„ + 5ë¶„
      const now = new Date();
      now.setMinutes(now.getMinutes() + 5);
      const defaultDateTime = now.toISOString().slice(0, 16);
      document.getElementById('scheduleDateTime').value = defaultDateTime;
      document.getElementById('scheduleDateTime').min = new Date().toISOString().slice(0, 16);

      document.getElementById('scheduleModal').classList.add('active');
    }

    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.remove('active');
      currentScheduleJobId = null;
    }

    async function confirmScheduleRun() {
      if (!currentScheduleJobId) return;

      const dateTimeStr = document.getElementById('scheduleDateTime').value;
      if (!dateTimeStr) {
        showToast('ì‹¤í–‰ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      const scheduledTime = new Date(dateTimeStr);
      if (scheduledTime <= new Date()) {
        showToast('í˜„ì¬ ì‹œê°„ ì´í›„ë¡œ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/jobs/${currentScheduleJobId}/schedule-once`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scheduledTime: scheduledTime.toISOString() })
        });

        const result = await res.json();
        if (result.success) {
          showToast(`${scheduledTime.toLocaleString()}ì— ì‹¤í–‰ ì˜ˆì•½ë¨`, 'success');
          closeScheduleModal();
        } else {
          showToast(result.error || 'ì˜ˆì•½ ì‹¤íŒ¨', 'error');
        }
      } catch (err) {
        console.error('Schedule error:', err);
        showToast('ì˜ˆì•½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
      }
    }

    // Array input í•¸ë“¤ëŸ¬
    function handleArrayInput(event, inputId) {
      if (event.key === 'Enter') {
        event.preventDefault();
        const input = event.target;
        const value = input.value.trim();
        if (!value) return;

        const container = document.getElementById(`${inputId}-container`);
        const tag = document.createElement('div');
        tag.className = 'array-tag';
        tag.innerHTML = `<span title="${value}">${value}</span><button type="button" class="array-tag-remove" onclick="removeArrayTag(this, '${inputId}')">&times;</button>`;
        container.insertBefore(tag, input);
        input.value = '';
        updateCommandPreview();
      }
    }

    function removeArrayTag(button, inputId) {
      const tag = button.parentElement;
      tag.remove();
      updateCommandPreview();
    }

    async function executeWithOptions() {
      if (!currentJobForOptions) return;

      const options = getSelectedOptions();
      const jobId = currentJobForOptions.id;

      closeOptionsModal();
      executeJob(jobId, options);
    }

    async function executeJob(id, options = {}) {
      // ì¦‰ì‹œ ì‹¤í–‰ ì‹œì‘ (ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ë¨)
      fetch(`${API_BASE}/api/jobs/${id}/run`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ options })
      })
        .then(res => res.json())
        .then(result => {
          loadJobs();
          loadHistory();
          if (!result.success) {
            console.error('Job failed:', result.error);
          }
        })
        .catch(err => console.error('Run error:', err));

      // ì•½ê°„ì˜ ì§€ì—° í›„ ìƒíƒœ ê°±ì‹  & ë¡œê·¸ ëª¨ë‹¬ í‘œì‹œ
      setTimeout(() => {
        loadJobs();
        showLiveLog(id);
      }, 300);
    }

    async function toggleJob(id) {
      await fetch(`${API_BASE}/api/jobs/${id}/toggle`, { method: 'POST' });
      loadJobs();
    }

    async function duplicateJob(id) {
      try {
        const res = await fetch(`${API_BASE}/api/jobs/${id}/duplicate`, { method: 'POST' });
        const result = await res.json();
        if (result.success) {
          showToast('ì‘ì—…ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadJobs();
          // ë³µì œëœ ì‘ì—… í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°
          editJob(result.newId);
        } else {
          showToast('ì‘ì—… ë³µì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (err) {
        console.error('Duplicate error:', err);
        showToast('ì‘ì—… ë³µì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    async function deleteJob(id) {
      if (!confirm('ì´ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      await fetch(`${API_BASE}/api/jobs/${id}`, { method: 'DELETE' });
      loadJobs();
    }

    let currentEditingJob = null;

    async function editJob(id) {
      const res = await fetch(`${API_BASE}/api/jobs/${id}`);
      const job = await res.json();
      currentEditingJob = job;

      document.getElementById('modalTitle').textContent = 'ì‘ì—… í¸ì§‘';
      document.getElementById('jobId').value = job.id;
      document.getElementById('jobName').value = job.name;
      document.getElementById('jobDescription').value = job.description || '';
      document.getElementById('jobCommand').value = job.command;
      document.getElementById('jobSchedule').value = job.schedule;
      populateCategorySelect();  // ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì±„ìš°ê¸°
      document.getElementById('jobCategory').value = job.category || '';
      document.getElementById('jobNotes').value = job.notes || '';
      document.getElementById('jobEnabled').checked = job.enabled;

      // ì˜µì…˜ íƒ­ ë Œë”ë§
      renderEditOptions(job);

      // ì‹¤í–‰ ì œì–´ íƒ­ ë Œë”ë§
      const exec = job.execution || {};
      document.getElementById('jobTimeout').value = Math.floor((exec.timeout || 300000) / 60000);  // ms to min
      document.getElementById('jobMaxRetries').value = exec.maxRetries || 0;
      document.getElementById('jobRetryDelay').value = Math.floor((exec.retryDelay || 5000) / 1000);  // ms to sec
      document.getElementById('jobRetryBackoff').value = exec.backoff || 'fixed';

      // Cron ì„¤ëª… ì—…ë°ì´íŠ¸
      updateCronDescription();

      // ê¸°ë³¸ íƒ­ìœ¼ë¡œ ì‹œì‘
      showEditTab('basic');

      document.getElementById('jobModal').classList.add('active');
    }

    function showEditTab(tab) {
      // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼
      document.querySelectorAll('.edit-tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      document.getElementById(`editTab-${tab}`).classList.add('border-blue-500', 'text-blue-400');
      document.getElementById(`editTab-${tab}`).classList.remove('border-transparent', 'text-gray-400');

      // íŒ¨ë„ í‘œì‹œ
      document.getElementById('editPanel-basic').classList.toggle('hidden', tab !== 'basic');
      document.getElementById('editPanel-options').classList.toggle('hidden', tab !== 'options');
      document.getElementById('editPanel-execution').classList.toggle('hidden', tab !== 'execution');
    }

    function renderEditOptions(job) {
      const container = document.getElementById('editOptionsContainer');

      if (!job.options || job.options.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">ì´ ì‘ì—…ì—ëŠ” ì„¤ì • ê°€ëŠ¥í•œ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      const renderEditOption = (opt, idx, isSystem = false) => {
        const inputId = `edit-opt-${idx}`;
        const bgClass = isSystem ? 'bg-blue-900/30 border border-blue-800/50' : 'bg-gray-700/50';

        if (opt.type === 'boolean') {
          return `
            <div class="flex items-start gap-3 p-3 ${bgClass} rounded-lg mb-2">
              <input type="checkbox" id="${inputId}"
                class="w-5 h-5 mt-0.5 rounded bg-gray-600 border-gray-500 edit-option-input"
                data-flag="${opt.flag || ''}"
                data-type="boolean"
                data-system="${opt.system || false}"
                ${opt.default ? 'checked' : ''}>
              <div>
                <label for="${inputId}" class="font-medium cursor-pointer">${opt.label}</label>
                <p class="text-sm text-gray-400">${opt.description}</p>
                ${!isSystem ? `<code class="text-xs text-blue-400">${opt.flag}</code>` : ''}
              </div>
            </div>
          `;
        } else if (opt.type === 'select') {
          const choices = opt.choices || [];
          const optionsHtml = choices.map(c =>
            `<option value="${c}" ${c === opt.default ? 'selected' : ''}>${c}</option>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <select id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm edit-option-input"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="select"
                data-system="${opt.system || false}">
                ${optionsHtml}
              </select>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'string') {
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <input type="text" id="${inputId}"
                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-sm edit-option-input"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="string"
                data-system="${opt.system || false}"
                placeholder="${opt.placeholder || ''}"
                value="${opt.default || ''}">
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        } else if (opt.type === 'array') {
          const defaultItems = opt.default || [];
          const tagsHtml = defaultItems.map(item =>
            `<div class="array-tag"><span title="${item}">${item}</span><button type="button" class="array-tag-remove" onclick="removeArrayTag(this, '${inputId}')">&times;</button></div>`
          ).join('');
          return `
            <div class="p-3 ${bgClass} rounded-lg mb-2">
              <label for="${inputId}" class="font-medium block mb-1">${opt.label}</label>
              <p class="text-sm text-gray-400 mb-2">${opt.description}</p>
              <div id="${inputId}-container" class="array-input-container edit-option-input"
                data-flag="${opt.flag || ''}"
                data-arg="${opt.arg || ''}"
                data-type="array"
                data-system="${opt.system || false}">
                ${tagsHtml}
                <input type="text" class="array-input" placeholder="${opt.placeholder || 'Enter í‚¤ë¡œ ì¶”ê°€'}"
                  onkeydown="handleArrayInput(event, '${inputId}')">
              </div>
              ${opt.flag && !isSystem ? `<code class="text-xs text-blue-400 mt-1 block">${opt.flag}</code>` : ''}
            </div>
          `;
        }
        return '';
      };

      // ì¼ë°˜ ì˜µì…˜ê³¼ ì‹œìŠ¤í…œ ì˜µì…˜ ë¶„ë¦¬
      const normalOpts = job.options.filter(o => !o.system);
      const systemOpts = job.options.filter(o => o.system);

      let html = '';

      // ì¼ë°˜ ì˜µì…˜
      if (normalOpts.length > 0) {
        html += '<p class="text-xs text-gray-500 mb-2 uppercase tracking-wider">ğŸ“‹ ì‹¤í–‰ ì˜µì…˜</p>';
        html += normalOpts.map((opt, idx) => renderEditOption(opt, idx)).join('');
      }

      // ì‹œìŠ¤í…œ ì˜µì…˜
      if (systemOpts.length > 0) {
        html += `<div class="border-t border-gray-600 pt-4 mt-4">
          <p class="text-xs text-gray-500 mb-2 uppercase tracking-wider">ğŸ”” ì•Œë¦¼ ì„¤ì •</p>`;
        html += systemOpts.map((opt, idx) => renderEditOption(opt, normalOpts.length + idx, true)).join('');
        html += `</div>`;
      }

      container.innerHTML = html;
    }

    function getEditOptions() {
      const options = [];
      if (!currentEditingJob || !currentEditingJob.options) return options;

      const inputs = document.querySelectorAll('.edit-option-input');
      const jobOpts = currentEditingJob.options;

      inputs.forEach((input, idx) => {
        if (idx >= jobOpts.length) return;

        const opt = { ...jobOpts[idx] };
        if (opt.type === 'boolean') {
          opt.default = input.checked;
        } else if (opt.type === 'string' || opt.type === 'select') {
          opt.default = input.value.trim();
        } else if (opt.type === 'array') {
          // array íƒ€ì…: íƒœê·¸ì—ì„œ ê°’ ì¶”ì¶œ
          const tags = input.querySelectorAll('.array-tag span');
          opt.default = Array.from(tags).map(span => span.textContent);
        }
        options.push(opt);
      });

      return options;
    }

    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'ì‘ì—… ì¶”ê°€';
      document.getElementById('jobForm').reset();
      document.getElementById('jobId').value = '';
      currentEditingJob = null;
      populateCategorySelect();

      // ì˜µì…˜ íƒ­ ë¹„ìš°ê¸° (ìƒˆ ì‘ì—…ì€ ì˜µì…˜ ì—†ìŒ)
      document.getElementById('editOptionsContainer').innerHTML =
        '<p class="text-gray-500 text-sm">ì‘ì—…ì„ ì €ì¥í•œ í›„ ì˜µì…˜ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';

      // ì‹¤í–‰ ì œì–´ ê¸°ë³¸ê°’ ì„¤ì •
      document.getElementById('jobTimeout').value = 5;
      document.getElementById('jobMaxRetries').value = 0;
      document.getElementById('jobRetryDelay').value = 5;
      document.getElementById('jobRetryBackoff').value = 'fixed';

      // ê¸°ë³¸ íƒ­ìœ¼ë¡œ ì‹œì‘
      showEditTab('basic');

      document.getElementById('jobModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('jobModal').classList.remove('active');
      currentEditingJob = null;
    }

    function populateCategorySelect() {
      const select = document.getElementById('jobCategory');
      select.innerHTML = Object.entries(categories).map(([key, cat]) =>
        `<option value="${key}">${cat.name}</option>`
      ).join('');
    }

    // Form submit
    document.getElementById('jobForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('jobId').value;
      const data = {
        name: document.getElementById('jobName').value,
        description: document.getElementById('jobDescription').value,
        command: document.getElementById('jobCommand').value,
        schedule: document.getElementById('jobSchedule').value,
        category: document.getElementById('jobCategory').value,
        notes: document.getElementById('jobNotes').value,
        enabled: document.getElementById('jobEnabled').checked,
        execution: {
          timeout: parseInt(document.getElementById('jobTimeout').value || 5) * 60000,  // min to ms
          maxRetries: parseInt(document.getElementById('jobMaxRetries').value || 0),
          retryDelay: parseInt(document.getElementById('jobRetryDelay').value || 5) * 1000,  // sec to ms
          backoff: document.getElementById('jobRetryBackoff').value || 'fixed'
        }
      };

      // í¸ì§‘ ëª¨ë“œì—ì„œ ì˜µì…˜ í¬í•¨
      if (id && currentEditingJob) {
        data.options = getEditOptions();
      }

      const method = id ? 'PUT' : 'POST';
      const url = id ? `${API_BASE}/api/jobs/${id}` : `${API_BASE}/api/jobs`;

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        closeModal();
        loadJobs();
      } else {
        const error = await res.json();
        alert('ì˜¤ë¥˜: ' + error.error);
      }
    });

    // Tab & Filter
    let currentJobSubTab = 'list';

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      document.getElementById(`tab-${tab}`).classList.add('border-blue-500', 'text-blue-400');
      document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-400');

      ['home', 'jobs', 'settings', 'sessions', 'notes'].forEach(p => {
        document.getElementById(`panel-${p}`).classList.toggle('hidden', tab !== p);
      });

      if (tab === 'home') loadHomeDashboard();
      if (tab === 'jobs') showJobSubTab(currentJobSubTab);
      if (tab === 'settings') loadSettings();
      if (tab === 'sessions') initSessionsTab();
      if (tab === 'notes') { initNotesDate(); loadNotes(); }
    }

    function showJobSubTab(sub) {
      currentJobSubTab = sub;
      document.querySelectorAll('.job-sub-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-400');
        btn.classList.add('border-transparent', 'text-gray-400');
      });
      const activeBtn = document.getElementById(`jobSub-${sub}`);
      if (activeBtn) {
        activeBtn.classList.add('border-blue-500', 'text-blue-400');
        activeBtn.classList.remove('border-transparent', 'text-gray-400');
      }

      document.getElementById('jobSubPanel-list').classList.toggle('hidden', sub !== 'list');
      document.getElementById('jobSubPanel-history').classList.toggle('hidden', sub !== 'history');
      document.getElementById('jobSubPanel-stats').classList.toggle('hidden', sub !== 'stats');

      if (sub === 'history') loadHistory();
      if (sub === 'stats') loadStats();
    }

    function filterByCategory(cat) {
      currentFilter = cat;
      loadJobs();
      // ê·¸ë˜í”„ ë·°ì—ì„œë„ í•„í„° ì ìš©
      if (currentView === 'graph' && graphNetwork) {
        updateGraphNodes(allJobsData);
      }
    }

    // ============ Graph View Functions ============

    // ë·° ì „í™˜
    function setView(view) {
      currentView = view;

      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('text-gray-400');
      });
      const activeBtn = document.getElementById(`viewBtn-${view}`);
      activeBtn.classList.add('active');
      activeBtn.classList.remove('text-gray-400');

      // ë·° ì»¨í…Œì´ë„ˆ ì „í™˜
      const jobsGrid = document.getElementById('jobsGrid');
      const graphView = document.getElementById('graphView');

      if (view === 'card') {
        jobsGrid.style.display = 'grid';
        graphView.classList.remove('active');
      } else {
        jobsGrid.style.display = 'none';
        graphView.classList.add('active');
        // ê·¸ë˜í”„ ì´ˆê¸°í™” (ì•„ì§ ì•ˆëìœ¼ë©´)
        if (!graphNetwork) {
          initGraph(allJobsData, allEdgesData);
        } else {
          updateGraphNodes(allJobsData);
        }
      }
    }

    // ë…¸ë“œ ìƒ‰ìƒ ê²°ì • (ìƒíƒœë³„)
    // ë…¸ë“œ ìƒ‰ìƒ ê²°ì • (ìƒíƒœ + ì¹´í…Œê³ ë¦¬)
    function getNodeColor(job) {
      // ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
      const cat = categories[job.category] || { color: '#6b7280' };
      const catColor = cat.color;

      if (job.isRunning) {
        // ì‹¤í–‰ ì¤‘: ë…¸ë€ìƒ‰ ë°°ê²½, ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ í…Œë‘ë¦¬
        return {
          background: '#fbbf24',
          border: catColor,
          highlight: { background: '#fcd34d', border: catColor }
        };
      } else if (job.enabled) {
        // í™œì„±í™”: ë…¹ìƒ‰ ë°°ê²½, ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ í…Œë‘ë¦¬
        return {
          background: '#10b981',
          border: catColor,
          highlight: { background: '#34d399', border: catColor }
        };
      } else {
        // ë¹„í™œì„±í™”: íšŒìƒ‰ ë°°ê²½, ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ í…Œë‘ë¦¬
        return {
          background: '#4b5563',
          border: catColor,
          highlight: { background: '#6b7280', border: catColor }
        };
      }
    }

    // ê·¸ë˜í”„ ì´ˆê¸°í™”
    function initGraph(jobs, edges = []) {
      const container = document.getElementById('graphCanvas');

      // í•„í„° ì ìš©
      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.category === currentFilter);

      // ë…¸ë“œ ë°ì´í„° ìƒì„±
      const nodeData = filtered.map((job, index) => {
        const cat = categories[job.category] || { name: 'ê¸°íƒ€', color: '#6b7280' };
        const position = job.position || { x: (index % 5) * 200 - 400, y: Math.floor(index / 5) * 150 - 200 };

        return {
          id: job.id,
          label: job.name,
          title: `${job.description || ''}\nğŸ“… ${job.schedule}${job.notes ? '\nğŸ“ ' + job.notes : ''}`,
          color: getNodeColor(job),
          font: { color: '#f3f4f6', size: 14 },
          shape: 'box',
          borderWidth: 4,
          borderWidthSelected: 5,
          x: position.x,
          y: position.y,
          shadow: true
        };
      });

      graphNodes = new vis.DataSet(nodeData);

      // Edge ë°ì´í„° (í•„í„°ëœ ë…¸ë“œì— ì—°ê²°ëœ ê²ƒë§Œ)
      const filteredNodeIds = new Set(filtered.map(j => j.id));
      const edgeData = edges.filter(e => filteredNodeIds.has(e.from) && filteredNodeIds.has(e.to)).map(e => {
        // trigger edgeëŠ” ë…¹ìƒ‰ ì‹¤ì„ , ì¼ë°˜ì€ íšŒìƒ‰ ì ì„ 
        const isTrigger = e.trigger === true;
        const label = isTrigger ? (e.onSuccess ? 'âœ“' : 'âš¡') : (e.label || '');

        return {
          id: e.id,
          from: e.from,
          to: e.to,
          label: label,
          arrows: 'to',
          color: isTrigger
            ? { color: '#10b981', highlight: '#34d399' }
            : { color: '#6b7280', highlight: '#9ca3af' },
          dashes: !isTrigger,
          width: isTrigger ? 2 : 1,
          font: { color: isTrigger ? '#10b981' : '#9ca3af', size: 12 },
          smooth: { type: 'curvedCW', roundness: 0.2 }
        };
      });

      graphEdges = new vis.DataSet(edgeData);

      const data = { nodes: graphNodes, edges: graphEdges };

      const options = {
        physics: {
          enabled: false  // ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë¹„í™œì„±í™” (ìœ„ì¹˜ ê³ ì •)
        },
        interaction: {
          hover: true,
          selectConnectedEdges: true,
          multiselect: true
        },
        manipulation: {
          enabled: true,
          addEdge: function(data, callback) {
            if (data.from !== data.to) {
              createEdge(data.from, data.to);
            }
            callback(null);  // vis.jsì—ì„œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ (ì„œë²„ì—ì„œ ì²˜ë¦¬)
          }
        },
        edges: {
          smooth: { type: 'curvedCW', roundness: 0.2 }
        },
        nodes: {
          margin: 10,
          shape: 'box',
          borderWidth: 2
        }
      };

      graphNetwork = new vis.Network(container, data, options);

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      graphNetwork.on('click', handleGraphClick);
      graphNetwork.on('doubleClick', handleGraphDoubleClick);
      graphNetwork.on('oncontext', handleGraphContext);
      graphNetwork.on('dragEnd', handleNodeDragEnd);

      // ì „ì—­ í´ë¦­ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‹«ê¸°
      document.addEventListener('click', () => hideContextMenu());
    }

    // ê·¸ë˜í”„ ë…¸ë“œ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„)
    function updateGraphNodes(jobs) {
      if (!graphNodes) return;

      const filtered = currentFilter === 'all' ? jobs : jobs.filter(j => j.category === currentFilter);
      const filteredIds = new Set(filtered.map(j => j.id));

      // ê¸°ì¡´ ë…¸ë“œ ì—…ë°ì´íŠ¸ ë˜ëŠ” ì œê±°
      graphNodes.forEach(node => {
        if (!filteredIds.has(node.id)) {
          graphNodes.remove(node.id);
        }
      });

      // ë…¸ë“œ ì—…ë°ì´íŠ¸ ë˜ëŠ” ì¶”ê°€
      filtered.forEach((job, index) => {
        const existingNode = graphNodes.get(job.id);
        const color = getNodeColor(job);

        if (existingNode) {
          graphNodes.update({ id: job.id, color: color });
        } else {
          const position = job.position || { x: (index % 5) * 200 - 400, y: Math.floor(index / 5) * 150 - 200 };
          graphNodes.add({
            id: job.id,
            label: job.name,
            title: `${job.description || ''}\nğŸ“… ${job.schedule}${job.notes ? '\nğŸ“ ' + job.notes : ''}`,
            color: color,
            font: { color: '#f3f4f6', size: 14 },
            shape: 'box',
            borderWidth: 4,
            borderWidthSelected: 5,
            x: position.x,
            y: position.y,
            shadow: true
          });
        }
      });

      // Edge ì—…ë°ì´íŠ¸
      if (allEdgesData && allEdgesData.length > 0) {
        const filteredEdges = allEdgesData.filter(e => filteredIds.has(e.from) && filteredIds.has(e.to));
        graphEdges.clear();
        graphEdges.add(filteredEdges.map(e => {
          const isTrigger = e.trigger === true;
          const label = isTrigger ? (e.onSuccess ? 'âœ“' : 'âš¡') : (e.label || '');

          return {
            id: e.id,
            from: e.from,
            to: e.to,
            label: label,
            arrows: 'to',
            color: isTrigger
              ? { color: '#10b981', highlight: '#34d399' }
              : { color: '#6b7280', highlight: '#9ca3af' },
            dashes: !isTrigger,
            width: isTrigger ? 2 : 1,
            font: { color: isTrigger ? '#10b981' : '#9ca3af', size: 12 },
            smooth: { type: 'curvedCW', roundness: 0.2 }
          };
        }));
      }
    }

    // ê·¸ë˜í”„ í´ë¦­ í•¸ë“¤ëŸ¬
    function handleGraphClick(params) {
      hideContextMenu();
      if (params.nodes.length > 0) {
        // ë…¸ë“œ í´ë¦­ - ì‚¬ì´ë“œ íŒ¨ë„ ì—´ê¸°
        const nodeId = params.nodes[0];
        openSidePanel(nodeId);
      } else if (params.edges.length > 0) {
        // Edge í´ë¦­ - ì‚­ì œ í™•ì¸
        closeSidePanel();
        const edgeId = params.edges[0];
        if (confirm('ì´ ì—°ê²°ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          deleteEdge(edgeId);
        }
      } else {
        // ë¹ˆ ê³µê°„ í´ë¦­ - ì‚¬ì´ë“œ íŒ¨ë„ ë‹«ê¸°
        closeSidePanel();
      }
    }

    // ë”ë¸”í´ë¦­ - í¸ì§‘ ëª¨ë‹¬
    function handleGraphDoubleClick(params) {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        editJob(nodeId);
      }
    }

    // ìš°í´ë¦­ - ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´
    function handleGraphContext(params) {
      params.event.preventDefault();
      const nodeId = graphNetwork.getNodeAt(params.pointer.DOM);

      if (nodeId) {
        contextMenuNodeId = nodeId;
        const job = allJobsData.find(j => j.id === nodeId);

        // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ë‚´ìš© ì—…ë°ì´íŠ¸
        const menu = document.getElementById('contextMenu');
        const toggleItem = menu.querySelector('[onclick*="toggle"]');
        if (job) {
          if (job.isRunning) {
            toggleItem.innerHTML = 'ğŸ“‹ ë¡œê·¸ ë³´ê¸°';
            toggleItem.onclick = () => contextMenuAction('log');
          } else {
            toggleItem.innerHTML = job.enabled ? 'â¸ï¸ ë¹„í™œì„±í™”' : 'â–¶ï¸ í™œì„±í™”';
            toggleItem.onclick = () => contextMenuAction('toggle');
          }
        }

        showContextMenu(params.event.pageX || params.pointer.DOM.x, params.event.pageY || params.pointer.DOM.y);
      }
    }

    // ë…¸ë“œ ë“œë˜ê·¸ ì¢…ë£Œ - ìœ„ì¹˜ ì €ì¥
    function handleNodeDragEnd(params) {
      if (params.nodes.length > 0) {
        const positions = graphNetwork.getPositions(params.nodes);
        const updates = params.nodes.map(id => ({
          id: id,
          position: { x: Math.round(positions[id].x), y: Math.round(positions[id].y) }
        }));
        saveNodePositions(updates);
      }
    }

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
    function showContextMenu(x, y) {
      const menu = document.getElementById('contextMenu');
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';
      menu.classList.remove('hidden');
    }

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
    function hideContextMenu() {
      document.getElementById('contextMenu').classList.add('hidden');
      contextMenuNodeId = null;
    }

    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì•¡ì…˜
    function contextMenuAction(action) {
      if (!contextMenuNodeId) return;
      hideContextMenu();

      switch (action) {
        case 'run':
          runJob(contextMenuNodeId);
          break;
        case 'schedule':
          showScheduleModal(contextMenuNodeId);
          break;
        case 'toggle':
          toggleJob(contextMenuNodeId);
          break;
        case 'duplicate':
          duplicateJob(contextMenuNodeId);
          break;
        case 'edit':
          editJob(contextMenuNodeId);
          break;
        case 'delete':
          deleteJob(contextMenuNodeId);
          break;
        case 'log':
          showLiveLog(contextMenuNodeId);
          break;
      }
    }

    // ë…¸ë“œ ìœ„ì¹˜ ì €ì¥
    async function saveNodePositions(updates) {
      try {
        await fetch(`${API_BASE}/api/jobs/positions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ positions: updates })
        });
      } catch (error) {
        console.error('Failed to save positions:', error);
      }
    }

    // Edge íƒ€ì… ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
    function showEdgeTypeModal(fromId, toId) {
      document.getElementById('edgeFrom').value = fromId;
      document.getElementById('edgeTo').value = toId;
      // ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
      document.querySelector('input[name="edgeType"][value="visual"]').checked = true;
      document.getElementById('edgeModal').classList.add('active');
    }

    function closeEdgeModal() {
      document.getElementById('edgeModal').classList.remove('active');
    }

    async function confirmEdgeCreate() {
      const from = document.getElementById('edgeFrom').value;
      const to = document.getElementById('edgeTo').value;
      const type = document.querySelector('input[name="edgeType"]:checked').value;

      let trigger = false;
      let onSuccess = true;

      if (type === 'trigger-success') {
        trigger = true;
        onSuccess = true;
      } else if (type === 'trigger-always') {
        trigger = true;
        onSuccess = false;
      }

      closeEdgeModal();

      try {
        const res = await fetch(`${API_BASE}/api/edges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ from, to, trigger, onSuccess })
        });
        if (res.ok) {
          loadJobs();  // ìƒˆë¡œê³ ì¹¨í•˜ì—¬ edge ë°˜ì˜
        }
      } catch (error) {
        console.error('Failed to create edge:', error);
      }
    }

    // Edge ìƒì„± (ëª¨ë‹¬ ì—´ê¸°)
    function createEdge(fromId, toId) {
      showEdgeTypeModal(fromId, toId);
    }

    // Edge ì‚­ì œ
    async function deleteEdge(edgeId) {
      try {
        const res = await fetch(`${API_BASE}/api/edges/${edgeId}`, {
          method: 'DELETE'
        });
        if (res.ok) {
          graphEdges.remove(edgeId);
          allEdgesData = allEdgesData.filter(e => e.id !== edgeId);
        }
      } catch (error) {
        console.error('Failed to delete edge:', error);
      }
    }

    // ============ Graph Controls ============

    // ìë™ ì •ë ¬ (ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ)
    function autoLayoutGraph() {
      if (!graphNetwork) return;

      // ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ ì˜µì…˜ìœ¼ë¡œ ì¬ì„¤ì •
      const options = {
        layout: {
          hierarchical: {
            enabled: true,
            direction: 'UD',  // Up-Down (ìœ„ì—ì„œ ì•„ë˜ë¡œ)
            sortMethod: 'directed',
            levelSeparation: 120,
            nodeSpacing: 150,
            treeSpacing: 200
          }
        },
        physics: {
          enabled: false
        }
      };

      graphNetwork.setOptions(options);

      // ë ˆì´ì•„ì›ƒ ì ìš© í›„ ìœ„ì¹˜ ì €ì¥ì„ ìœ„í•´ ì•½ê°„ ëŒ€ê¸°
      setTimeout(() => {
        // ê³„ì¸µí˜• ë ˆì´ì•„ì›ƒ ë¹„í™œì„±í™” (ìˆ˜ë™ ì´ë™ ê°€ëŠ¥í•˜ê²Œ)
        graphNetwork.setOptions({
          layout: { hierarchical: { enabled: false } }
        });
      }, 500);
    }

    // ëª¨ë“  ë…¸ë“œ ìœ„ì¹˜ ì €ì¥
    async function saveAllPositions() {
      if (!graphNetwork || !graphNodes) return;

      const positions = graphNetwork.getPositions();
      const updates = Object.entries(positions).map(([id, pos]) => ({
        id: id,
        position: { x: Math.round(pos.x), y: Math.round(pos.y) }
      }));

      try {
        await fetch(`${API_BASE}/api/jobs/positions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ positions: updates })
        });
        // ì„±ê³µ í”¼ë“œë°± (ê°„ë‹¨í•œ ì•Œë¦¼)
        const btn = document.querySelector('.graph-control-btn:nth-child(2)');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'âœ“ ì €ì¥ë¨';
        setTimeout(() => { btn.innerHTML = originalText; }, 1500);
      } catch (error) {
        console.error('Failed to save positions:', error);
      }
    }

    // ì¤Œ ì¡°ì ˆ
    function zoomGraph(scale) {
      if (!graphNetwork) return;
      const currentScale = graphNetwork.getScale();
      graphNetwork.moveTo({
        scale: currentScale * scale,
        animation: { duration: 200, easingFunction: 'easeInOutQuad' }
      });
    }

    // ì „ì²´ ë³´ê¸°
    function fitGraph() {
      if (!graphNetwork) return;
      graphNetwork.fit({
        animation: { duration: 300, easingFunction: 'easeInOutQuad' }
      });
    }

    // ============ Side Panel ============

    let selectedNodeId = null;

    function openSidePanel(jobId) {
      const job = allJobsData.find(j => j.id === jobId);
      if (!job) return;

      selectedNodeId = jobId;
      const cat = categories[job.category] || { name: 'ê¸°íƒ€', color: '#6b7280' };

      // ì—°ê²°ëœ edge ì •ë³´
      const incomingEdges = allEdgesData.filter(e => e.to === jobId);
      const outgoingEdges = allEdgesData.filter(e => e.from === jobId);

      const statusText = job.isRunning ? 'ğŸŸ¡ ì‹¤í–‰ ì¤‘' : (job.enabled ? 'ğŸŸ¢ í™œì„±í™”' : 'âšª ë¹„í™œì„±í™”');

      document.getElementById('sidePanelContent').innerHTML = `
        <div class="mb-4">
          <span class="text-xs px-2 py-1 rounded" style="background: ${cat.color}30; color: ${cat.color}; border: 1px solid ${cat.color}50;">
            ${cat.name}
          </span>
        </div>
        <h3 class="text-lg font-bold mb-2">${job.name}</h3>
        <p class="text-sm text-gray-400 mb-2">${job.description || 'ì„¤ëª… ì—†ìŒ'}</p>
        ${job.notes ? `<p class="text-xs text-yellow-500/80 bg-yellow-900/20 px-2 py-1 rounded mb-4">ğŸ“ ${job.notes}</p>` : '<div class="mb-4"></div>'}

        <div class="space-y-3 mb-6">
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">ìƒíƒœ</span>
            <span>${statusText}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">ìŠ¤ì¼€ì¤„</span>
            <span class="font-mono text-xs">${job.schedule}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">ì…ë ¥ ì—°ê²°</span>
            <span>${incomingEdges.length}ê°œ</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-400">ì¶œë ¥ ì—°ê²°</span>
            <span>${outgoingEdges.length}ê°œ</span>
          </div>
        </div>

        <div class="space-y-2">
          ${job.isRunning ? `
            <button onclick="showLiveLog('${job.id}'); closeSidePanel();"
              class="w-full bg-yellow-600 hover:bg-yellow-700 py-2 rounded-lg text-sm font-medium">
              ğŸ“‹ ë¡œê·¸ ë³´ê¸°
            </button>
          ` : `
            <button onclick="runJob('${job.id}'); closeSidePanel();"
              class="w-full bg-green-600 hover:bg-green-700 py-2 rounded-lg text-sm font-medium">
              â–¶ ì‹¤í–‰
            </button>
          `}
          <button onclick="editJob('${job.id}'); closeSidePanel();"
            class="w-full bg-gray-600 hover:bg-gray-500 py-2 rounded-lg text-sm font-medium">
            âœï¸ í¸ì§‘
          </button>
          <button onclick="toggleJob('${job.id}'); closeSidePanel();"
            class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm font-medium">
            ${job.enabled ? 'â¸ ë¹„í™œì„±í™”' : 'â–¶ í™œì„±í™”'}
          </button>
        </div>

        ${outgoingEdges.length > 0 ? `
          <div class="mt-6 pt-4 border-t border-gray-700">
            <h4 class="text-sm font-medium text-gray-400 mb-2">ì—°ê²°ëœ ë‹¤ìŒ ì‘ì—…</h4>
            <div class="space-y-2">
              ${outgoingEdges.map(e => {
                const targetJob = allJobsData.find(j => j.id === e.to);
                const edgeType = e.trigger ? (e.onSuccess ? 'âœ“ ì„±ê³µ ì‹œ' : 'âš¡ í•­ìƒ') : 'ì‹œê°ì ';
                return targetJob ? `
                  <div class="flex items-center justify-between text-sm bg-gray-800 p-2 rounded">
                    <span>${targetJob.name}</span>
                    <span class="text-xs text-gray-500">${edgeType}</span>
                  </div>
                ` : '';
              }).join('')}
            </div>
          </div>
        ` : ''}
      `;

      document.getElementById('graphSidePanel').classList.add('open');
    }

    function closeSidePanel() {
      document.getElementById('graphSidePanel').classList.remove('open');
      selectedNodeId = null;
    }

    // Log modal
    let liveLogInterval = null;
    let currentLiveJobId = null;

    function showLog(index) {
      const entry = historyData[index];
      if (!entry) return;
      stopLiveLogPolling();

      // ëª…ë ¹ì–´ í‘œì‹œ
      const cmdSection = document.getElementById('logCommandSection');
      const cmdEl = document.getElementById('logCommand');
      if (entry.command) {
        cmdEl.textContent = entry.command;
        cmdSection.classList.remove('hidden');
      } else {
        cmdSection.classList.add('hidden');
      }

      document.getElementById('logStdout').textContent = entry.stdout || '(ì—†ìŒ)';
      document.getElementById('logStderr').textContent = entry.stderr || entry.error || '(ì—†ìŒ)';
      document.getElementById('logModal').classList.add('active');

      // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
      setTimeout(() => {
        scrollLogToTop('logStdout');
        scrollLogToTop('logStderr');
      }, 50);
    }

    // ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…ì˜ ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸°
    async function showLiveLog(jobId) {
      currentLiveJobId = jobId;
      document.getElementById('logStdout').textContent = 'ë¡œë”© ì¤‘...';
      document.getElementById('logStderr').textContent = '';
      document.getElementById('logModal').classList.add('active');

      // ì¦‰ì‹œ í•œë²ˆ ì¡°íšŒ
      await fetchLiveLog(jobId);

      // 1ì´ˆë§ˆë‹¤ í´ë§
      liveLogInterval = setInterval(() => fetchLiveLog(jobId), 1000);
    }

    async function fetchLiveLog(jobId) {
      try {
        const res = await fetch(`${API_BASE}/api/jobs/${jobId}/live-log`);
        const data = await res.json();

        // ëª…ë ¹ì–´ í‘œì‹œ
        const cmdSection = document.getElementById('logCommandSection');
        const cmdEl = document.getElementById('logCommand');
        if (data.command) {
          cmdEl.textContent = data.command;
          cmdSection.classList.remove('hidden');
        } else {
          cmdSection.classList.add('hidden');
        }

        if (!data.running) {
          // ì‹¤í–‰ ì™„ë£Œë¨
          stopLiveLogPolling();

          // ìƒíƒœì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
          if (data.status === 'failed') {
            const duration = data.duration ? `${(data.duration / 1000).toFixed(1)}ì´ˆ` : '';
            document.getElementById('logStdout').textContent =
              `âŒ ì‹¤íŒ¨ ${duration ? `(${duration})` : ''}\n\n${data.stdout || '(ì¶œë ¥ ì—†ìŒ)'}`;
            document.getElementById('logStderr').textContent =
              data.stderr || data.error || '(ì—ëŸ¬ ì •ë³´ ì—†ìŒ)';
          } else if (data.status === 'success') {
            const duration = data.duration ? `${(data.duration / 1000).toFixed(1)}ì´ˆ` : '';
            document.getElementById('logStdout').textContent =
              `âœ… ì™„ë£Œ ${duration ? `(${duration})` : ''}\n\n${data.stdout || '(ì¶œë ¥ ì—†ìŒ)'}`;
            document.getElementById('logStderr').textContent = data.stderr || '';
          } else {
            document.getElementById('logStdout').textContent = data.stdout || '(ë¡œê·¸ ì—†ìŒ)';
            document.getElementById('logStderr').textContent = data.stderr || '';
          }

          // ì™„ë£Œ ì‹œ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
          setTimeout(() => {
            scrollLogToTop('logStdout');
            scrollLogToTop('logStderr');
          }, 50);

          loadJobs();  // ìƒíƒœ ê°±ì‹ 
          loadHistory();  // ì´ë ¥ ê°±ì‹ 
          return;
        }

        const elapsed = Math.round(data.elapsed / 1000);
        document.getElementById('logStdout').textContent =
          `â±ï¸ ì‹¤í–‰ ì¤‘... (${elapsed}ì´ˆ ê²½ê³¼)\n\n${data.stdout || '(ì¶œë ¥ ëŒ€ê¸° ì¤‘...)'}`;
        document.getElementById('logStderr').textContent = data.stderr || '';

        // ì‹¤ì‹œê°„ ë¡œê·¸ëŠ” ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ (ìµœì‹  ì¶œë ¥ ë³´ê¸°)
        scrollLogToBottom('logStdout');
        if (data.stderr) scrollLogToBottom('logStderr');
      } catch (error) {
        console.error('Live log error:', error);
      }
    }

    function stopLiveLogPolling() {
      if (liveLogInterval) {
        clearInterval(liveLogInterval);
        liveLogInterval = null;
      }
      currentLiveJobId = null;
    }

    // ë¡œê·¸ í™•ì¥/ì¶•ì†Œ í† ê¸€
    function toggleLogExpand(elementId) {
      const el = document.getElementById(elementId);
      if (el.classList.contains('max-h-64')) {
        el.classList.remove('max-h-64');
        el.classList.add('max-h-[70vh]');
      } else {
        el.classList.remove('max-h-[70vh]');
        el.classList.add('max-h-64');
      }
    }

    // ë¡œê·¸ ìŠ¤í¬ë¡¤ ì œì–´
    function scrollLogToTop(elementId) {
      const el = document.getElementById(elementId);
      if (el) el.scrollTop = 0;
    }

    function scrollLogToBottom(elementId) {
      const el = document.getElementById(elementId);
      if (el) el.scrollTop = el.scrollHeight;
    }

    function closeLogModal() {
      stopLiveLogPolling();
      document.getElementById('logModal').classList.remove('active');
    }

    // Cron í‘œí˜„ì‹ íŒŒì‹± ë° ì„¤ëª… ìƒì„±
    function parseCronExpression(cron) {
      if (!cron || cron.trim() === '') return null;

      // í”„ë¦¬ì…‹ í™•ì¸ (ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ë„ ê³„ì‚°)
      const preset = cronPresets[cron.trim()];
      if (preset) {
        // í”„ë¦¬ì…‹ë„ ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ê³„ì‚°ì„ ìœ„í•´ ê³„ì† ì§„í–‰
      }

      const parts = cron.trim().split(/\s+/);
      if (parts.length !== 5) return null;

      const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;

      // ìš”ì¼ ì´ë¦„
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

      let description = '';
      let timeDesc = '';

      // ì‹œê°„ ì„¤ëª…
      if (minute !== '*' && hour !== '*') {
        const h = parseInt(hour);
        const m = parseInt(minute);
        const period = h < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
        const displayHour = h === 0 ? 12 : (h > 12 ? h - 12 : h);
        timeDesc = `${period} ${displayHour}ì‹œ${m > 0 ? ` ${m}ë¶„` : ''}`;
      } else if (hour !== '*') {
        timeDesc = `${hour}ì‹œ`;
      } else if (minute.startsWith('*/')) {
        timeDesc = `${minute.slice(2)}ë¶„ë§ˆë‹¤`;
      } else if (hour === '*' && minute !== '*') {
        timeDesc = `ë§¤ì‹œ ${minute}ë¶„`;
      } else {
        timeDesc = 'ë§¤ë¶„';
      }

      // ìš”ì¼ ì„¤ëª…
      if (dayOfWeek !== '*') {
        if (dayOfWeek === '1-5') {
          description = `í‰ì¼ ${timeDesc}`;
        } else if (dayOfWeek === '0,6') {
          description = `ì£¼ë§ ${timeDesc}`;
        } else if (dayOfWeek.includes(',')) {
          const days = dayOfWeek.split(',').map(d => dayNames[parseInt(d)] || d).join(', ');
          description = `${days}ìš”ì¼ ${timeDesc}`;
        } else if (dayOfWeek.includes('-')) {
          const [start, end] = dayOfWeek.split('-').map(d => parseInt(d));
          description = `${dayNames[start]}~${dayNames[end]}ìš”ì¼ ${timeDesc}`;
        } else {
          const dayNum = parseInt(dayOfWeek);
          if (!isNaN(dayNum) && dayNum >= 0 && dayNum <= 6) {
            description = `${dayNames[dayNum]}ìš”ì¼ ${timeDesc}`;
          }
        }
      } else if (dayOfMonth !== '*') {
        if (dayOfMonth.includes(',')) {
          description = `ë§¤ì›” ${dayOfMonth}ì¼ ${timeDesc}`;
        } else {
          description = `ë§¤ì›” ${dayOfMonth}ì¼ ${timeDesc}`;
        }
      } else if (month !== '*') {
        description = `${monthNames[parseInt(month) - 1] || month} ${timeDesc}`;
      } else {
        description = `ë§¤ì¼ ${timeDesc}`;
      }

      // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ê³„ì‚° (ê°„ë‹¨í•œ ë²„ì „)
      let nextRun = '';
      try {
        const now = new Date();
        let next = new Date(now);

        if (minute !== '*' && hour !== '*') {
          next.setHours(parseInt(hour), parseInt(minute), 0, 0);
          if (next <= now) {
            next.setDate(next.getDate() + 1);
          }

          // ìš”ì¼ ì²´í¬
          if (dayOfWeek === '1-5') {
            while (next.getDay() === 0 || next.getDay() === 6) {
              next.setDate(next.getDate() + 1);
            }
          }

          const diffMs = next - now;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

          if (diffHours > 24) {
            const days = Math.floor(diffHours / 24);
            nextRun = `${days}ì¼ í›„`;
          } else if (diffHours > 0) {
            nextRun = `${diffHours}ì‹œê°„ ${diffMins}ë¶„ í›„`;
          } else {
            nextRun = `${diffMins}ë¶„ í›„`;
          }
        }
      } catch (e) {
        nextRun = '';
      }

      // í”„ë¦¬ì…‹ ì„¤ëª… ì‚¬ìš© (ìˆìœ¼ë©´)
      if (preset) {
        return { description: `${preset.icon} ${preset.desc}`, nextRun };
      }

      return { description, nextRun };
    }

    function updateCronDescription() {
      const input = document.getElementById('jobSchedule');
      const bubble = document.getElementById('cronBubble');
      const descEl = document.getElementById('cronDescription');
      const nextEl = document.getElementById('cronNextRun');

      const result = parseCronExpression(input.value);

      if (result && result.description) {
        descEl.textContent = result.description;
        nextEl.textContent = result.nextRun ? `â° ${result.nextRun}` : '';
        bubble.classList.remove('hidden');
      } else {
        bubble.classList.add('hidden');
      }
    }

    // Auto refresh (5ì´ˆë§ˆë‹¤ jobs ìƒíƒœ ê°±ì‹ )
    setInterval(() => {
      loadJobs();
    }, 5000);

    // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (Slack ë§í¬ ë“±)
    async function handleUrlParams() {
      const params = new URLSearchParams(window.location.search);
      const tab = params.get('tab');
      const logId = params.get('logId');

      if (tab === 'history') {
        showTab('jobs');
        showJobSubTab('history');

        if (logId) {
          // ì´ë ¥ ë¡œë“œ í›„ í•´ë‹¹ ë¡œê·¸ ì°¾ì•„ì„œ ëª¨ë‹¬ ì—´ê¸°
          await loadHistoryFiltered(1);

          // í•´ë‹¹ logIdë¥¼ í¬í•¨í•˜ëŠ” í˜ì´ì§€ë¥¼ ì°¾ì•„ì•¼ í•  ìˆ˜ë„ ìˆìŒ
          // ì¼ë‹¨ í˜„ì¬ í˜ì´ì§€ì—ì„œ ì°¾ê¸° ì‹œë„
          const entry = historyData.find(h => h.id === parseInt(logId));
          if (entry) {
            showLogById(parseInt(logId));
          } else {
            // ì „ì²´ì—ì„œ ê²€ìƒ‰ (limit ì—†ì´)
            const res = await fetch(`${API_BASE}/api/history?limit=100`);
            const data = await res.json();
            const found = data.items.find(h => h.id === parseInt(logId));
            if (found) {
              historyData = [found];  // ì„ì‹œë¡œ ì„¤ì •
              showLogById(parseInt(logId));
            }
          }
        }
        return true;
      }
      return false;
    }

    // ============ Statistics Functions ============

    let statsPeriod = 7;  // ê¸°ë³¸ 7ì¼
    let trendChart = null;
    let resultChart = null;

    function setStatsPeriod(days) {
      statsPeriod = days;
      // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.stats-period-btn').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('text-gray-400');
      });
      document.getElementById(`statsBtn-${days}`).classList.add('bg-blue-600', 'text-white');
      document.getElementById(`statsBtn-${days}`).classList.remove('text-gray-400');
      loadStats();
    }

    async function loadStats() {
      try {
        // ë³‘ë ¬ë¡œ ëª¨ë“  í†µê³„ API í˜¸ì¶œ
        const [summary, jobStats, trend, failures] = await Promise.all([
          fetch(`${API_BASE}/api/stats/summary?days=${statsPeriod}`).then(r => r.json()),
          fetch(`${API_BASE}/api/stats/jobs?days=${statsPeriod}`).then(r => r.json()),
          fetch(`${API_BASE}/api/stats/trend?days=${statsPeriod}`).then(r => r.json()),
          fetch(`${API_BASE}/api/stats/failures?days=${statsPeriod}`).then(r => r.json())
        ]);

        renderStatsSummary(summary);
        renderStatsJobsTable(jobStats);
        renderTrendChart(trend);
        renderResultChart(summary);
        renderFailures(failures);
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    function renderStatsSummary(summary) {
      document.getElementById('statsTotalRuns').textContent = summary.total;
      document.getElementById('statsSuccessRate').textContent = `${summary.successRate}%`;
      document.getElementById('statsFailedCount').textContent = summary.failed;
      document.getElementById('statsAvgDuration').textContent = summary.avgDurationFormatted;
    }

    function renderStatsJobsTable(jobStats) {
      const tbody = document.getElementById('statsJobsTable');

      if (jobStats.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-400">
              í•´ë‹¹ ê¸°ê°„ì— ì‹¤í–‰ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = jobStats.map(stat => {
        const successRateColor = stat.successRate >= 90 ? 'text-green-400' :
                                  stat.successRate >= 70 ? 'text-yellow-400' : 'text-red-400';
        const avgDuration = stat.avgDuration ? `${(stat.avgDuration / 1000).toFixed(1)}s` : '-';

        return `
          <tr class="hover:bg-gray-700/50">
            <td class="px-4 py-3">
              <div class="font-medium">${stat.jobName}</div>
              <div class="text-xs text-gray-400">${stat.jobId}</div>
            </td>
            <td class="px-4 py-3 text-right">${stat.total}</td>
            <td class="px-4 py-3 text-right text-green-400">${stat.success}</td>
            <td class="px-4 py-3 text-right text-red-400">${stat.failed}</td>
            <td class="px-4 py-3 text-right ${successRateColor} font-semibold">${stat.successRate}%</td>
            <td class="px-4 py-3 text-right text-gray-300">${avgDuration}</td>
          </tr>
        `;
      }).join('');
    }

    function renderTrendChart(trend) {
      const ctx = document.getElementById('trendChart').getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      if (trendChart) {
        trendChart.destroy();
      }

      trendChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: trend.map(d => d.date.slice(5)),  // MM-DD í˜•ì‹
          datasets: [
            {
              label: 'ì„±ê³µ',
              data: trend.map(d => d.success),
              backgroundColor: 'rgba(34, 197, 94, 0.8)',
              borderRadius: 4
            },
            {
              label: 'ì‹¤íŒ¨',
              data: trend.map(d => d.failed),
              backgroundColor: 'rgba(239, 68, 68, 0.8)',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#9ca3af' }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: { color: 'rgba(75, 85, 99, 0.3)' },
              ticks: { color: '#9ca3af' }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: { color: 'rgba(75, 85, 99, 0.3)' },
              ticks: { color: '#9ca3af', stepSize: 1 }
            }
          }
        }
      });
    }

    function renderResultChart(summary) {
      const ctx = document.getElementById('resultChart').getContext('2d');

      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      if (resultChart) {
        resultChart.destroy();
      }

      resultChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['ì„±ê³µ', 'ì‹¤íŒ¨', 'ì‹¤í–‰ì¤‘'],
          datasets: [{
            data: [summary.success, summary.failed, summary.running],
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',
              'rgba(239, 68, 68, 0.8)',
              'rgba(59, 130, 246, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#9ca3af', padding: 20 }
            }
          },
          cutout: '60%'
        }
      });
    }

    function renderFailures(failures) {
      const container = document.getElementById('statsFailuresContainer');

      if (failures.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-400 py-4">
            ğŸ‰ í•´ë‹¹ ê¸°ê°„ì— ì‹¤íŒ¨í•œ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤!
          </div>
        `;
        return;
      }

      container.innerHTML = failures.map((f, i) => {
        const timeAgo = f.lastFailure ? formatTimeAgo(new Date(f.lastFailure)) : '-';
        return `
          <div class="flex items-center justify-between py-3 ${i > 0 ? 'border-t border-gray-700' : ''}">
            <div class="flex items-center gap-3">
              <div class="text-2xl font-bold text-red-400">${i + 1}</div>
              <div>
                <div class="font-medium">${f.jobName}</div>
                <div class="text-xs text-gray-400">ë§ˆì§€ë§‰ ì‹¤íŒ¨: ${timeAgo}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-xl font-bold text-red-400">${f.count}íšŒ</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function formatTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}ì¼ ì „`;
      if (hours > 0) return `${hours}ì‹œê°„ ì „`;
      return 'ë°©ê¸ˆ ì „';
    }

    // ============ Export Functions ============

    function toggleExportMenu() {
      const menu = document.getElementById('exportMenu');
      if (menu) menu.classList.toggle('hidden');
    }

    function exportData(type, format) {
      const url = `${API_BASE}/api/export/${type}?days=${statsPeriod}&format=${format}`;
      window.open(url, '_blank');
      const menu = document.getElementById('exportMenu');
      if (menu) menu.classList.add('hidden');
    }

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('exportDropdown');
      const menu = document.getElementById('exportMenu');
      if (dropdown && menu && !dropdown.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });

    // ============ Browser Notifications ============

    let previousRunningJobs = new Set();

    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return false;
      }

      if (Notification.permission === 'granted') {
        return true;
      }

      if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
      }

      return false;
    }

    function sendBrowserNotification(title, options = {}) {
      if (Notification.permission !== 'granted') return;

      const notification = new Notification(title, {
        icon: options.icon || '/favicon.ico',
        body: options.body || '',
        tag: options.tag || 'ai-pipeline',
        requireInteraction: false
      });

      notification.onclick = () => {
        window.focus();
        if (options.onClick) options.onClick();
        notification.close();
      };

      // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«ê¸°
      setTimeout(() => notification.close(), 5000);
    }

    function checkJobCompletion(jobs) {
      if (!currentSettings.browserNotifications) return;

      const currentRunning = new Set(jobs.filter(j => j.isRunning).map(j => j.id));

      // ì´ì „ì— ì‹¤í–‰ ì¤‘ì´ì—ˆì§€ë§Œ ì§€ê¸ˆì€ ì•„ë‹Œ ì‘ì—… ì°¾ê¸°
      previousRunningJobs.forEach(jobId => {
        if (!currentRunning.has(jobId)) {
          // ì‘ì—…ì´ ì™„ë£Œë¨ - íˆìŠ¤í† ë¦¬ì—ì„œ ê²°ê³¼ í™•ì¸
          const job = jobs.find(j => j.id === jobId);
          if (job) {
            // ìµœê·¼ ì‹¤í–‰ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
            fetch(`${API_BASE}/api/history?limit=1&search=${encodeURIComponent(job.name)}`)
              .then(res => res.json())
              .then(data => {
                if (data.items && data.items.length > 0) {
                  const latest = data.items[0];
                  const isSuccess = latest.status === 'success';
                  sendBrowserNotification(
                    `${isSuccess ? 'âœ…' : 'âŒ'} ${job.name}`,
                    {
                      body: isSuccess ? 'ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                      tag: `job-${jobId}`,
                      onClick: () => { showTab('jobs'); showJobSubTab('history'); }
                    }
                  );
                }
              });
          }
        }
      });

      previousRunningJobs = currentRunning;
    }

    // ============ Settings Functions ============

    let currentSettings = {};

    async function loadSettings() {
      try {
        const res = await fetch(`${API_BASE}/api/settings`);
        currentSettings = await res.json();

        // localStorageì—ì„œ ë¸Œë¼ìš°ì € ì•Œë¦¼ ì„¤ì • ì½ê¸° (ë¡œì»¬ ì„¤ì •)
        currentSettings.browserNotifications = localStorage.getItem('browserNotifications') === 'true';

        // í¼ì— ê°’ ì±„ìš°ê¸°
        document.getElementById('settingsSlackWebhook').value = currentSettings.slackWebhookUrl || '';
        document.getElementById('settingsSlackEnabled').checked = currentSettings.slackEnabled || false;
        document.getElementById('settingsDashboardUrl').value = currentSettings.dashboardUrl || 'http://localhost:3030';
        document.getElementById('settingsRefreshInterval').value = currentSettings.refreshInterval || 5;
        document.getElementById('settingsDefaultTimeout').value = currentSettings.defaultTimeout || 10;
        document.getElementById('settingsDefaultRetry').value = currentSettings.defaultRetry || 0;
        document.getElementById('settingsBrowserNotifications').checked = currentSettings.browserNotifications;

        // ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ í‘œì‹œ
        updateNotificationStatus();
      } catch (err) {
        console.error('Settings load error:', err);
      }
    }

    function updateNotificationStatus() {
      const statusEl = document.getElementById('notificationStatus');
      if (!('Notification' in window)) {
        statusEl.textContent = 'ì§€ì› ì•ˆí•¨';
        statusEl.className = 'text-xs text-red-400';
      } else if (Notification.permission === 'granted') {
        statusEl.textContent = 'í—ˆìš©ë¨';
        statusEl.className = 'text-xs text-green-400';
      } else if (Notification.permission === 'denied') {
        statusEl.textContent = 'ì°¨ë‹¨ë¨';
        statusEl.className = 'text-xs text-red-400';
      } else {
        statusEl.textContent = 'ê¶Œí•œ í•„ìš”';
        statusEl.className = 'text-xs text-yellow-400';
      }
    }

    async function onBrowserNotificationChange(checkbox) {
      if (checkbox.checked) {
        const granted = await requestNotificationPermission();
        if (!granted) {
          checkbox.checked = false;
          showToast('ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
        }
      }
      updateNotificationStatus();
    }

    async function saveSettings() {
      const settings = {
        slackWebhookUrl: document.getElementById('settingsSlackWebhook').value.trim(),
        slackEnabled: document.getElementById('settingsSlackEnabled').checked,
        dashboardUrl: document.getElementById('settingsDashboardUrl').value.trim() || 'http://localhost:3030',
        refreshInterval: parseInt(document.getElementById('settingsRefreshInterval').value) || 5,
        defaultTimeout: parseInt(document.getElementById('settingsDefaultTimeout').value) || 10,
        defaultRetry: parseInt(document.getElementById('settingsDefaultRetry').value) || 0
      };

      // ë¸Œë¼ìš°ì € ì•Œë¦¼ ì„¤ì •ì€ localStorageì— ì €ì¥ (ë¸Œë¼ìš°ì €ë³„ ì„¤ì •)
      const browserNotifications = document.getElementById('settingsBrowserNotifications').checked;
      localStorage.setItem('browserNotifications', browserNotifications);
      currentSettings.browserNotifications = browserNotifications;

      try {
        const res = await fetch(`${API_BASE}/api/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (res.ok) {
          currentSettings = { ...currentSettings, ...settings };
          showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
          showToast('ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (err) {
        console.error('Settings save error:', err);
        showToast('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // Export/Import
    async function exportJobs() {
      try {
        const res = await fetch(`${API_BASE}/api/export`);
        const data = await res.json();

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ai-pipeline-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      } catch (err) {
        console.error('Export error:', err);
        showToast('ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    async function importJobs(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);

          if (confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ë°ì´í„°ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤)')) {
            const res = await fetch(`${API_BASE}/api/import`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });

            if (res.ok) {
              showToast('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...', 'success');
              setTimeout(() => location.reload(), 1000);
            } else {
              showToast('ë°ì´í„° ê°€ì ¸ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
          }
        } catch (err) {
          console.error('Import error:', err);
          showToast('ì˜ëª»ëœ JSON íŒŒì¼ì…ë‹ˆë‹¤.', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';  // Reset input
    }

    // Toast ì•Œë¦¼
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toastContainer');

      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        info: 'â„¹ï¸',
        warning: 'âš ï¸'
      };

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
      `;

      container.appendChild(toast);

      // ìë™ ì œê±°
      setTimeout(() => {
        toast.classList.add('toast-out');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ============ Keyboard Shortcuts ============

    document.addEventListener('keydown', (e) => {
      // ì…ë ¥ í•„ë“œì—ì„œëŠ” ë‹¨ì¶•í‚¤ ë¹„í™œì„±í™”
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        // EscëŠ” ì˜ˆì™¸ì ìœ¼ë¡œ ì²˜ë¦¬
        if (e.key === 'Escape') {
          e.target.blur();
        }
        return;
      }

      // ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œ Escë¡œ ë‹«ê¸°
      if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.modal.active');
        if (modals.length > 0) {
          modals.forEach(m => m.classList.remove('active'));
          currentEditingJob = null;
          currentJobForOptions = null;
          return;
        }
        // ì‚¬ì´ë“œ íŒ¨ë„ ë‹«ê¸°
        closeSidePanel();
        hideContextMenu();
        return;
      }

      // ë‹¨ì¶•í‚¤ ì²˜ë¦¬
      switch (e.key.toLowerCase()) {
        case 'n':  // ìƒˆ ì‘ì—… ì¶”ê°€
          e.preventDefault();
          openAddModal();
          break;
        case '/':  // ê²€ìƒ‰ í¬ì»¤ìŠ¤
          e.preventDefault();
          const searchInput = document.getElementById('historySearch');
          if (searchInput) {
            showTab('jobs');
            showJobSubTab('history');
            setTimeout(() => searchInput.focus(), 100);
          }
          break;
        case '1':  // í™ˆ íƒ­
          e.preventDefault();
          showTab('home');
          break;
        case '2':  // ì‘ì—… íƒ­
          e.preventDefault();
          showTab('jobs');
          break;
        case '3':  // ì„¤ì • íƒ­
          e.preventDefault();
          showTab('settings');
          break;
        case '4':  // ì„¸ì…˜ íƒ­
          e.preventDefault();
          showTab('sessions');
          break;
        case '5':  // ë…¸íŠ¸ íƒ­
          e.preventDefault();
          showTab('notes');
          break;
        case 'g':  // ê·¸ë˜í”„ ë·° í† ê¸€
          e.preventDefault();
          if (document.getElementById('panel-jobs').classList.contains('hidden')) return;
          setView(currentView === 'card' ? 'graph' : 'card');
          break;
        case 'r':  // ìƒˆë¡œê³ ì¹¨
          e.preventDefault();
          loadJobs();
          loadHistory();
          showToast('ìƒˆë¡œê³ ì¹¨ë¨', 'info');
          break;
        case '?':  // ë‹¨ì¶•í‚¤ ë„ì›€ë§
          e.preventDefault();
          showShortcutsHelp();
          break;
      }
    });

    function showShortcutsHelp() {
      const shortcuts = [
        { key: 'N', desc: 'ìƒˆ ì‘ì—… ì¶”ê°€' },
        { key: '/', desc: 'ê²€ìƒ‰' },
        { key: '1', desc: 'ì‘ì—… ëª©ë¡ íƒ­' },
        { key: '2', desc: 'ì‹¤í–‰ ì´ë ¥ íƒ­' },
        { key: '3', desc: 'í†µê³„ íƒ­' },
        { key: '4', desc: 'ì„¤ì • íƒ­' },
        { key: 'G', desc: 'ê·¸ë˜í”„ ë·° í† ê¸€' },
        { key: 'R', desc: 'ìƒˆë¡œê³ ì¹¨' },
        { key: 'Esc', desc: 'ëª¨ë‹¬/íŒ¨ë„ ë‹«ê¸°' },
        { key: '?', desc: 'ë‹¨ì¶•í‚¤ ë„ì›€ë§' }
      ];

      const html = shortcuts.map(s =>
        `<div class="flex justify-between py-1">
          <kbd class="px-2 py-0.5 bg-gray-600 rounded text-sm font-mono">${s.key}</kbd>
          <span class="text-gray-400">${s.desc}</span>
        </div>`
      ).join('');

      showToast('âŒ¨ï¸ ë‹¨ì¶•í‚¤: N(ìƒˆì‘ì—…) G(ê·¸ë˜í”„) 1-5(íƒ­) /(ê²€ìƒ‰) R(ìƒˆë¡œê³ ì¹¨)', 'info', 6000);
    }

    // ============ Sessions Tab Functions ============

    let sessionsInitialized = false;

    function initSessionsTab() {
      if (!sessionsInitialized) {
        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì´ˆê¸°í™”
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('sessionsDate').value = today;

        // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
        loadProjectsList();
        sessionsInitialized = true;
      }
      loadSessions();
    }

    async function loadProjectsList() {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/projects`);
        const data = await res.json();

        const select = document.getElementById('sessionsProject');
        select.innerHTML = '<option value="">ì „ì²´</option>';
        for (const project of data.projects) {
          select.innerHTML += `<option value="${project}">${project}</option>`;
        }
      } catch (err) {
        console.error('í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
      }
    }

    async function loadSessions() {
      const date = document.getElementById('sessionsDate').value ||
        new Date().toISOString().split('T')[0];
      const project = document.getElementById('sessionsProject').value;

      const params = new URLSearchParams({ date });
      if (project) params.append('project', project);

      try {
        const res = await fetch(`${API_BASE}/api/sessions?${params}`);
        const data = await res.json();
        renderSessions(data.sessions, data.date);
      } catch (err) {
        console.error('ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', err);
        document.getElementById('sessionsList').innerHTML =
          '<div class="text-center text-red-400 py-8">ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨</div>';
      }
    }

    function renderSessions(sessions, date) {
      const container = document.getElementById('sessionsList');

      if (!sessions || sessions.length === 0) {
        container.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            ${date} ë‚ ì§œì˜ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `;
        return;
      }

      container.innerHTML = sessions.map(s => `
        <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-750 transition-colors border border-gray-700/50 hover:border-gray-600 group">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2 cursor-pointer flex-1" onclick="showSessionDetail('${s.id}', '${s.projectPath}')">
              ${s.alias ? `
                <span class="font-medium text-blue-400">ğŸ“Œ ${escapeHtml(s.alias)}</span>
                <span class="text-xs text-gray-500">(${s.project})</span>
              ` : `
                <span class="font-medium">${s.project}</span>
              `}
              <span class="text-xs text-gray-500">ğŸ†” ${s.id.substring(0, 8)}...</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-gray-400">
                ${new Date(s.modifiedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
              </span>
              <button data-session-id="${s.id}" data-alias="${escapeHtml(s.alias || '').replace(/'/g, '&#39;')}"
                      onclick="event.stopPropagation(); editSessionAliasFromData(this)"
                      class="text-gray-600 hover:text-blue-400 p-1 rounded transition-all hover:bg-blue-400/10"
                      title="ì´ë¦„ í¸ì§‘">
                âœï¸
              </button>
              <button onclick="event.stopPropagation(); deleteSession('${s.id}', '${s.projectPath}', '${escapeHtml(s.project)}')"
                      class="text-gray-600 hover:text-red-400 p-1 rounded transition-all hover:bg-red-400/10"
                      title="ì„¸ì…˜ ì‚­ì œ">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
          <div class="cursor-pointer" onclick="showSessionDetail('${s.id}', '${s.projectPath}')">
            ${s.firstMessage ? `
              <div class="text-sm text-gray-300 mb-2 line-clamp-2 leading-relaxed">
                ğŸ’¬ ${escapeHtml(s.firstMessage)}${s.firstMessage.length >= 100 ? '...' : ''}
              </div>
            ` : ''}
            <div class="flex items-center gap-3 text-xs text-gray-500">
              <span>ğŸ“ ${formatFileSize(s.size)}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // í˜„ì¬ ì„¸ì…˜ ë°ì´í„° ì €ì¥ (ë‚´ë³´ë‚´ê¸°ìš©)
    let currentSessionData = null;

    // ì„¸ì…˜ ë³„ëª… í¸ì§‘ (data-* ì†ì„±ì—ì„œ ì½ê¸°)
    function editSessionAliasFromData(btn) {
      const sessionId = btn.dataset.sessionId;
      const currentAlias = btn.dataset.alias || '';
      editSessionAlias(sessionId, currentAlias);
    }

    // ì„¸ì…˜ ë³„ëª… í¸ì§‘ (ì¸ë¼ì¸ ëª¨ë‹¬)
    let _renameSessionId = null;
    async function editSessionAlias(sessionId, currentAlias) {
      _renameSessionId = sessionId;
      const modal = document.getElementById('renameSessionModal');
      const input = document.getElementById('renameSessionInput');
      input.value = currentAlias || '';
      modal.style.display = 'flex';
      setTimeout(() => { input.focus(); input.select(); }, 100);
    }

    async function submitSessionRename() {
      const newAlias = document.getElementById('renameSessionInput').value.trim();
      const sessionId = _renameSessionId;
      closeRenameSessionModal();
      if (!sessionId) return;

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}/alias`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ alias: newAlias })
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'ì €ì¥ ì‹¤íŒ¨');
        }

        showToast(newAlias ? `ì„¸ì…˜ ì´ë¦„ì´ "${newAlias}"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤` : 'ì„¸ì…˜ ì´ë¦„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        loadSessions();
        // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ì œëª©ë„ ì—…ë°ì´íŠ¸
        const modalTitle = document.querySelector('#sessionDetailModal .session-alias-display');
        if (modalTitle) {
          modalTitle.textContent = newAlias || '';
        }
      } catch (err) {
        showToast('ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    function closeRenameSessionModal() {
      document.getElementById('renameSessionModal').style.display = 'none';
      _renameSessionId = null;
    }

    // ëª¨ë‹¬ì—ì„œ ì„¸ì…˜ ë³„ëª… í¸ì§‘ (data-* ì†ì„±ì—ì„œ ì½ê¸°)
    function editSessionAliasFromModalData(btn) {
      const sessionId = btn.dataset.sessionId;
      const currentAlias = btn.dataset.alias || '';
      editSessionAliasFromModal(sessionId, currentAlias);
    }

    // ëª¨ë‹¬ì—ì„œ ì„¸ì…˜ ë³„ëª… í¸ì§‘
    async function editSessionAliasFromModal(sessionId, currentAlias) {
      editSessionAlias(sessionId, currentAlias);
    }

    // ì„¸ì…˜ ì‚­ì œ
    async function deleteSession(sessionId, projectPath, projectName) {
      if (!confirm(`ì •ë§ ì´ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní”„ë¡œì íŠ¸: ${projectName}\nì„¸ì…˜ ID: ${sessionId.substring(0, 8)}...\n\n(ì‚­ì œëœ ì„¸ì…˜ì€ ë°±ì—…ë©ë‹ˆë‹¤)`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}?project=${encodeURIComponent(projectPath)}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
        }

        showToast('ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        const dateInput = document.getElementById('sessionsDate');
        if (dateInput) {
          loadSessions(dateInput.value);
        }
      } catch (err) {
        showToast('ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ëª¨ë‹¬ì—ì„œ ì„¸ì…˜ ì‚­ì œ
    async function deleteSessionFromModal(sessionId, projectPath, projectName) {
      if (!confirm(`ì •ë§ ì´ ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní”„ë¡œì íŠ¸: ${projectName}\nì„¸ì…˜ ID: ${sessionId.substring(0, 8)}...\n\n(ì‚­ì œëœ ì„¸ì…˜ì€ ë°±ì—…ë©ë‹ˆë‹¤)`)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}?project=${encodeURIComponent(projectPath)}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          const data = await res.json();
          throw new Error(data.error || 'ì‚­ì œ ì‹¤íŒ¨');
        }

        showToast('ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        closeSessionModal();

        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        const dateInput = document.getElementById('sessionsDate');
        if (dateInput) {
          loadSessions(dateInput.value);
        }
      } catch (err) {
        showToast('ì„¸ì…˜ ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    async function showSessionDetail(sessionId, projectPath) {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/${sessionId}?project=${encodeURIComponent(projectPath)}`);
        const data = await res.json();
        currentSessionData = { ...data, sessionId, projectPath };

        const modal = document.getElementById('sessionDetailModal');
        const content = document.getElementById('sessionDetailContent');

        // ëŒ€í™” ë‚´ìš© ë Œë”ë§ (ê°œì„ ëœ UI)
        // ì—°ì†ëœ ë„êµ¬ ì „ìš© ë©”ì‹œì§€ ê·¸ë£¹í™”
        const groupedConversation = groupToolOnlyMessages(data.conversation || []);

        const conversationHtml = groupedConversation.map((msg, idx) => {
          const isUser = msg.role === 'user';
          const time = msg.timestamp ?
            new Date(msg.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) : '';

          // ê·¸ë£¹í™”ëœ ë„êµ¬ ë©”ì‹œì§€
          if (msg.isToolGroup) {
            const allTools = msg.groupedTools.flat();
            const uniqueTools = [...new Set(allTools)];
            return `
              <div class="pl-8 pr-0">
                <div class="tool-group-collapsed bg-gray-700/30 rounded-lg px-3 py-2 border border-gray-600/30 cursor-pointer hover:bg-gray-700/50 transition-colors"
                     onclick="toggleToolGroup(this)">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-400">ğŸ”§</span>
                    <span class="text-xs text-gray-400">${msg.groupCount}ê°œ ë„êµ¬ í˜¸ì¶œ</span>
                    <span class="text-xs text-gray-500">(${uniqueTools.slice(0, 3).join(', ')}${uniqueTools.length > 3 ? '...' : ''})</span>
                    <span class="tool-group-toggle text-xs text-gray-500 ml-auto">â–¼</span>
                  </div>
                  <div class="tool-group-details hidden mt-2 pt-2 border-t border-gray-600/50">
                    <div class="flex flex-wrap gap-1">
                      ${allTools.map(t => `<span class="px-2 py-0.5 bg-blue-900/30 text-blue-300 rounded text-xs font-mono">${t}</span>`).join('')}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }

          // ì¼ë°˜ ë©”ì‹œì§€ (ë„êµ¬ ì •ë³´ëŠ” í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œ)
          const hasContent = msg.content && msg.content.trim();
          const toolsInfo = (msg.tools?.length && hasContent) ?
            `<div class="flex flex-wrap gap-1 mt-2 pt-2 border-t border-gray-600/50">
              ${msg.tools.map(t => `<span class="px-2 py-0.5 bg-blue-900/30 text-blue-300 rounded text-xs font-mono">${t}</span>`).join('')}
            </div>` : '';

          // ë„êµ¬ë§Œ ì‚¬ìš©í•œ ë‹¨ì¼ ë©”ì‹œì§€ (ê·¸ë£¹í™” ì•ˆëœ ê²½ìš°)
          if (!isUser && !hasContent && msg.tools?.length) {
            return `
              <div class="pl-8 pr-0">
                <div class="flex items-center gap-2 text-xs text-gray-500 py-1">
                  <span>ğŸ”§</span>
                  <span>${msg.tools.join(', ')}</span>
                </div>
              </div>
            `;
          }

          return `
            <div class="group ${isUser ? 'pl-0 pr-8' : 'pl-8 pr-0'}">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${isUser ? 'bg-gradient-to-br from-purple-500 to-pink-500' : 'bg-gradient-to-br from-green-500 to-teal-500'}">
                  ${isUser ? 'U' : 'C'}
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs font-semibold ${isUser ? 'text-purple-400' : 'text-green-400'}">${isUser ? 'ì‚¬ìš©ì' : 'Claude'}</span>
                    ${time ? `<span class="text-xs text-gray-500">${time}</span>` : ''}
                  </div>
                  <div class="rounded-lg p-3 ${isUser ? 'bg-purple-900/20 border border-purple-800/30' : 'bg-gray-700/70 border border-gray-600/30'}">
                    <div class="text-sm break-words leading-relaxed ${isUser ? 'whitespace-pre-wrap' : 'markdown-content'}">${hasContent ? (isUser ? escapeHtml(msg.content) : renderMarkdown(msg.content)) : '<span class="text-gray-500 italic">(ì‘ë‹µ ì—†ìŒ)</span>'}</div>
                    ${toolsInfo}
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        content.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-lg">ğŸ¤–</div>
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="text-lg font-bold">${data.alias ? `<span class="text-blue-400">ğŸ“Œ ${escapeHtml(data.alias)}</span>` : data.project}</h3>
                  <button id="editAliasBtn" data-session-id="${sessionId}" data-alias="${escapeHtml(data.alias || '').replace(/'/g, '&#39;')}"
                          onclick="editSessionAliasFromModalData(this)"
                          class="text-gray-500 hover:text-blue-400 p-1 rounded hover:bg-gray-700 transition-colors"
                          title="ì´ë¦„ í¸ì§‘">
                    âœï¸
                  </button>
                </div>
                <p class="text-xs text-gray-400">${data.alias ? data.project + ' Â· ' : ''}${data.id.substring(0, 8)}... Â· ${data.messageCount} ë©”ì‹œì§€</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button onclick="deleteSessionFromModal('${sessionId}', '${projectPath}', '${data.project}')"
                      class="text-gray-500 hover:text-red-400 p-2 rounded-lg hover:bg-gray-700 transition-colors"
                      title="ì„¸ì…˜ ì‚­ì œ">
                ğŸ—‘ï¸
              </button>
              <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
          </div>

          <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
          <div class="flex items-center justify-between mb-4 border-b border-gray-700">
            <div class="flex gap-1">
              <button onclick="switchSessionTab('overview')" id="sessionTabOverview" class="px-4 py-2.5 text-sm font-medium border-b-2 border-blue-500 text-blue-400 -mb-px">
                ğŸ“Š ê°œìš”
              </button>
              <button onclick="switchSessionTab('conversation')" id="sessionTabConversation" class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white -mb-px">
                ğŸ’¬ ëŒ€í™” (${data.conversation?.length || 0})
              </button>
              <button onclick="switchSessionTab('summary')" id="sessionTabSummary" class="px-4 py-2.5 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white -mb-px">
                ğŸ“‹ ìš”ì•½
              </button>
            </div>
            <!-- ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ -->
            <div class="flex gap-2">
              <button onclick="downloadSessionMd()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium transition-colors" title="ë§ˆí¬ë‹¤ìš´ ë‹¤ìš´ë¡œë“œ">
                ğŸ“„ MD
              </button>
              <button onclick="exportToObsidian()" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium transition-colors" title="ì˜µì‹œë””ì–¸ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°">
                ğŸ“ ì˜µì‹œë””ì–¸
              </button>
            </div>
          </div>

          <!-- ê°œìš” íƒ­ -->
          <div id="sessionOverviewPane" class="space-y-4">
            ${data.firstMessage ? `
              <div>
                <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">ì²« ë©”ì‹œì§€</h4>
                <p class="bg-gray-700/50 rounded-lg p-3 text-sm border border-gray-600/30">${escapeHtml(data.firstMessage)}</p>
              </div>
            ` : ''}

            <div class="grid grid-cols-2 gap-3">
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600/30">
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">ë©”ì‹œì§€</div>
                <div class="text-2xl font-bold">${data.messageCount}</div>
              </div>
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600/30">
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-1">ë„êµ¬ ì‚¬ìš©</div>
                <div class="text-2xl font-bold">${data.toolsUsed.length}</div>
              </div>
            </div>

            ${data.toolsUsed.length ? `
              <div>
                <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">ì‚¬ìš©ëœ ë„êµ¬</h4>
                <div class="flex flex-wrap gap-1.5">
                  ${data.toolsUsed.map(t => `
                    <span class="px-2.5 py-1 bg-blue-900/30 text-blue-300 rounded-full text-xs font-medium border border-blue-800/30">${t}</span>
                  `).join('')}
                </div>
              </div>
            ` : ''}

            ${data.filesChanged.length ? `
              <div>
                <h4 class="text-xs text-gray-400 uppercase tracking-wide mb-2">ë³€ê²½ëœ íŒŒì¼ (${data.filesChanged.length})</h4>
                <div class="bg-gray-800/50 rounded-lg p-2 max-h-32 overflow-auto border border-gray-600/30">
                  ${data.filesChanged.map(f => `
                    <div class="text-xs font-mono py-1.5 px-2 hover:bg-gray-700/50 rounded">${f}</div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>

          <!-- ëŒ€í™” íƒ­ -->
          <div id="sessionConversationPane" class="hidden">
            ${conversationHtml ? `
              <div class="space-y-3 max-h-[55vh] overflow-auto pr-1 custom-scrollbar">
                ${conversationHtml}
              </div>
              ${data.conversation?.length >= 200 ? `
                <div class="text-center text-gray-500 text-xs mt-3 p-2 bg-gray-700/50 rounded border border-gray-600/30">
                  ìµœê·¼ 200ê°œ ë©”ì‹œì§€ë§Œ í‘œì‹œë©ë‹ˆë‹¤
                </div>
              ` : ''}
            ` : '<div class="text-center text-gray-500 py-8">ëŒ€í™” ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤</div>'}
          </div>

          <!-- ìš”ì•½ íƒ­ -->
          <div id="sessionSummaryPane" class="hidden">
            <div class="text-center py-8" id="sessionSummaryContent">
              <p class="text-gray-400 mb-4">Claudeê°€ ì´ ì„¸ì…˜ì˜ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
              <button onclick="generateSessionSummary()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-500 hover:to-teal-500 rounded-lg text-sm font-medium transition-all">
                âœ¨ ìš”ì•½ ìƒì„±í•˜ê¸°
              </button>
            </div>
          </div>
        `;

        modal.style.display = 'flex';
      } catch (err) {
        console.error('ì„¸ì…˜ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', err);
        showToast('ì„¸ì…˜ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨', 'error');
      }
    }

    function switchSessionTab(tab) {
      const tabs = ['overview', 'conversation', 'summary'];
      const tabElements = {
        overview: document.getElementById('sessionTabOverview'),
        conversation: document.getElementById('sessionTabConversation'),
        summary: document.getElementById('sessionTabSummary')
      };
      const paneElements = {
        overview: document.getElementById('sessionOverviewPane'),
        conversation: document.getElementById('sessionConversationPane'),
        summary: document.getElementById('sessionSummaryPane')
      };

      // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
      for (const t of tabs) {
        if (tabElements[t]) {
          tabElements[t].classList.remove('border-blue-500', 'text-blue-400');
          tabElements[t].classList.add('border-transparent', 'text-gray-400');
        }
        if (paneElements[t]) {
          paneElements[t].classList.add('hidden');
        }
      }

      // ì„ íƒëœ íƒ­ í™œì„±í™”
      if (tabElements[tab]) {
        tabElements[tab].classList.add('border-blue-500', 'text-blue-400');
        tabElements[tab].classList.remove('border-transparent', 'text-gray-400');
      }
      if (paneElements[tab]) {
        paneElements[tab].classList.remove('hidden');
      }
    }

    // ì„¸ì…˜ ìš”ì•½ ìƒì„±
    async function generateSessionSummary() {
      if (!currentSessionData) return;

      const contentDiv = document.getElementById('sessionSummaryContent');
      contentDiv.innerHTML = `
        <div class="flex items-center justify-center gap-2 text-gray-400">
          <div class="w-5 h-5 border-2 border-gray-600 border-t-blue-500 rounded-full animate-spin"></div>
          <span>ìš”ì•½ ìƒì„± ì¤‘... ì‘ì—… íŒ¨ë„ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.</span>
        </div>
      `;

      try {
        await submitTask('session-summary', {
          sessionId: currentSessionData.sessionId,
          projectPath: currentSessionData.projectPath
        });
      } catch (err) {
        contentDiv.innerHTML = `
          <p class="text-red-400 mb-4">ìš”ì•½ ìƒì„± ì‹¤íŒ¨: ${err.message}</p>
          <button onclick="generateSessionSummary()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">
            ë‹¤ì‹œ ì‹œë„
          </button>
        `;
      }
    }

    function closeSessionModal() {
      document.getElementById('sessionDetailModal').style.display = 'none';
      currentSessionData = null;
    }

    // ë§ˆí¬ë‹¤ìš´ ë‹¤ìš´ë¡œë“œ
    async function downloadSessionMd() {
      if (!currentSessionData) return;
      try {
        const url = `${API_BASE}/api/sessions/${currentSessionData.sessionId}/markdown?project=${encodeURIComponent(currentSessionData.projectPath)}&download=true`;
        window.open(url, '_blank');
        showToast('ë§ˆí¬ë‹¤ìš´ ë‹¤ìš´ë¡œë“œ ì‹œì‘', 'success');
      } catch (err) {
        showToast('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ì˜µì‹œë””ì–¸ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
    async function exportToObsidian() {
      if (!currentSessionData) return;
      try {
        const res = await fetch(
          `${API_BASE}/api/sessions/${currentSessionData.sessionId}/export-obsidian?project=${encodeURIComponent(currentSessionData.projectPath)}`,
          { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) }
        );
        const data = await res.json();
        if (data.success) {
          showToast(`ì˜µì‹œë””ì–¸ìœ¼ë¡œ ë‚´ë³´ëƒ„: ${data.relativePath}`, 'success');
        } else {
          showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ì¼ì¼ ë³´ê³ ì„œ ìƒì„± (Claude Codeë¡œ ë¶„ì„)
    async function generateDailyReport() {
      const date = document.getElementById('sessionsDate').value;
      if (!date) {
        showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      try {
        // ë¹„ë™ê¸° ì‘ì—… ì œì¶œ
        await submitTask('daily-report', { date });
        showToast('ì¼ì¼ ë³´ê³ ì„œ ìƒì„± ì¤‘... ì™„ë£Œë˜ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”!', 'info');
      } catch (err) {
        showToast('ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ============ Day Wrap-up Wizard ============
    let wrapupStep = 1;
    let wrapupData = {
      date: new Date().toISOString().split('T')[0],
      sessions: [],
      selectedSessions: [],
      githubActivity: null,
      memos: [],
      reflection: {
        learned: '',
        proud: '',
        improve: '',
        tomorrow: '',
        grateful: '',
        oneline: ''
      }
    };

    // ì˜¤ëŠ˜ ë³´ê³ ì„œ ë²„íŠ¼ í´ë¦­ â†’ Day Wrap-up ìœ„ì €ë“œ ì—´ê¸°
    async function generateTodayFullReport() {
      wrapupStep = 1;
      wrapupData = {
        date: new Date().toISOString().split('T')[0],
        sessions: [],
        selectedSessions: [],
        githubActivity: null,
        ghSelected: null,
        memos: [],
        morningPlan: null,
        reflection: {
          learned: '',
          proud: '',
          improve: '',
          tomorrow: '',
          grateful: '',
          oneline: ''
        }
      };

      document.getElementById('wrapupDate').textContent = wrapupData.date;
      document.getElementById('dayWrapupModal').style.display = 'flex';

      // ë°ì´í„° ë¡œë“œ
      await loadWrapupData();
      renderWrapupStep();
    }

    async function loadWrapupData() {
      const today = wrapupData.date;

      // 1. ì„¸ì…˜ ë¡œë“œ
      try {
        const res = await fetch(`${API_BASE}/api/sessions?date=${today}`);
        const data = await res.json();
        wrapupData.sessions = data.sessions || [];
      } catch (e) {
        console.error('ì„¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // 2. GitHub í™œë™ ë¡œë“œ
      try {
        const res = await fetch(`${API_BASE}/api/github/activity?date=${today}`);
        wrapupData.githubActivity = await res.json();
      } catch (e) {
        console.error('GitHub ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // 3. ë©”ëª¨ ë¡œë“œ (ëŒ€ì‹œë³´ë“œ + Obsidian)
      const allMemos = [];

      // 3-1. ëŒ€ì‹œë³´ë“œ ë©”ëª¨
      try {
        const res = await fetch(`${API_BASE}/api/quick-memos?date=${today}`);
        const data = await res.json();
        allMemos.push(...(data.memos || []).map(m => ({ ...m, source: 'dashboard' })));
      } catch (e) {
        console.error('ëŒ€ì‹œë³´ë“œ ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // 3-2. Obsidian Daily Note ë©”ëª¨
      try {
        const res = await fetch(`${API_BASE}/api/obsidian/daily-memos?date=${today}`);
        const data = await res.json();
        allMemos.push(...(data.memos || []));
      } catch (e) {
        console.error('Obsidian ë©”ëª¨ ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // ì‹œê°„ìˆœ ì •ë ¬
      wrapupData.memos = allMemos.sort((a, b) => {
        const timeA = a.timestamp || a.time || '';
        const timeB = b.timestamp || b.time || '';
        return timeB.localeCompare(timeA);
      });

      // 4. ëª¨ë‹ í”Œëœ ë¡œë“œ
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${today}`);
        const data = await res.json();
        wrapupData.morningPlan = data.plan || null;
      } catch (e) {
        console.error('ëª¨ë‹ í”Œëœ ë¡œë“œ ì‹¤íŒ¨:', e);
        wrapupData.morningPlan = null;
      }
    }

    function renderWrapupStep() {
      const content = document.getElementById('wrapupContent');
      const prevBtn = document.getElementById('wrapupPrevBtn');
      const nextBtn = document.getElementById('wrapupNextBtn');
      const submitBtn = document.getElementById('wrapupSubmitBtn');

      // ë²„íŠ¼ ìƒíƒœ
      prevBtn.classList.toggle('hidden', wrapupStep === 1);
      nextBtn.classList.toggle('hidden', wrapupStep === 4);
      submitBtn.classList.toggle('hidden', wrapupStep !== 4);

      // ìŠ¤í… ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
      for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step${i}Indicator`);
        const circle = indicator.querySelector('span');
        const label = indicator.querySelectorAll('span')[1];

        if (i < wrapupStep) {
          circle.className = 'w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = 'âœ“';
          label.className = 'text-green-400';
        } else if (i === wrapupStep) {
          circle.className = 'w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = i;
          label.className = 'text-gray-300';
        } else {
          circle.className = 'w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs';
          circle.textContent = i;
          label.className = 'text-gray-500';
        }
      }

      // ì»¨í…ì¸  ë Œë”ë§
      switch (wrapupStep) {
        case 1: renderStep1Sessions(content); break;
        case 2: renderStep2Github(content); break;
        case 3: renderStep3Memos(content); break;
        case 4: renderStep4Reflection(content); break;
      }
    }

    function renderStep1Sessions(content) {
      const sessions = wrapupData.sessions;
      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸ’» ì˜¤ëŠ˜ì˜ ì„¸ì…˜ ì„ íƒ</h3>
          <p class="text-sm text-gray-400 mb-4">ë³´ê³ ì„œì— í¬í•¨í•  ì„¸ì…˜ì„ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ì„¸ì…˜ì´ í¬í•¨ë©ë‹ˆë‹¤.</p>
        </div>
        ${sessions.length === 0 ? `
          <div class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-4 block">ğŸ“­</span>
            ì˜¤ëŠ˜ ì§„í–‰í•œ Claude ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        ` : `
          <div class="space-y-2">
            <label class="flex items-center gap-3 p-3 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-800 border border-gray-700/50">
              <input type="checkbox" id="selectAllSessions" onchange="toggleAllSessions(this.checked)" class="w-4 h-4 rounded bg-gray-700 border-gray-600">
              <span class="text-sm font-medium">ì „ì²´ ì„ íƒ (${sessions.length}ê°œ)</span>
            </label>
            <div class="space-y-2 max-h-64 overflow-auto custom-scrollbar">
              ${sessions.map((s, i) => `
                <label class="flex items-start gap-3 p-3 bg-gray-800/30 rounded-lg cursor-pointer hover:bg-gray-800/50 border border-gray-700/30">
                  <input type="checkbox" class="session-checkbox w-4 h-4 rounded bg-gray-700 border-gray-600 mt-1"
                         data-index="${i}" ${wrapupData.selectedSessions.find(ss => ss.id === s.id) ? 'checked' : ''}>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      ${s.alias
                        ? `<span class="font-medium text-sm text-blue-400">ğŸ“Œ ${escapeHtml(s.alias)}</span><span class="text-xs text-gray-500">(${s.project})</span>`
                        : `<span class="font-medium text-sm">${s.project}</span>`
                      }
                      <span class="text-xs text-gray-500">${new Date(s.modifiedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                    ${s.firstMessage ? `<div class="text-xs text-gray-400 mt-1 truncate">${escapeHtml(s.firstMessage)}</div>` : ''}
                  </div>
                </label>
              `).join('')}
            </div>
          </div>
        `}
      `;
    }

    function toggleAllSessions(checked) {
      document.querySelectorAll('.session-checkbox').forEach(cb => cb.checked = checked);
    }

    // ë ˆí¬ë³„ ê³ ìœ  ìƒ‰ìƒ ë§¤í•‘
    const _ghRepoColors = {};
    const _ghColorPalette = [
      { bg: 'rgba(59,130,246,0.15)', border: '#3b82f6', text: '#93c5fd' },   // blue
      { bg: 'rgba(168,85,247,0.15)', border: '#a855f7', text: '#d8b4fe' },   // purple
      { bg: 'rgba(236,72,153,0.15)', border: '#ec4899', text: '#f9a8d4' },   // pink
      { bg: 'rgba(20,184,166,0.15)', border: '#14b8a6', text: '#5eead4' },   // teal
      { bg: 'rgba(245,158,11,0.15)', border: '#f59e0b', text: '#fcd34d' },   // amber
      { bg: 'rgba(34,197,94,0.15)',  border: '#22c55e', text: '#86efac' },   // green
      { bg: 'rgba(239,68,68,0.15)',  border: '#ef4444', text: '#fca5a5' },   // red
      { bg: 'rgba(99,102,241,0.15)', border: '#6366f1', text: '#a5b4fc' },   // indigo
    ];
    function ghRepoColor(repo) {
      if (!_ghRepoColors[repo]) {
        const idx = Object.keys(_ghRepoColors).length % _ghColorPalette.length;
        _ghRepoColors[repo] = _ghColorPalette[idx];
      }
      return _ghRepoColors[repo];
    }
    function ghRepoBadge(repoShort, repo) {
      const c = ghRepoColor(repo || repoShort);
      return `<span style="background:${c.bg};border:1px solid ${c.border};color:${c.text}" class="px-1.5 py-0.5 rounded text-xs whitespace-nowrap flex-shrink-0">${repoShort}</span>`;
    }

    function renderStep2Github(content) {
      const gh = wrapupData.githubActivity;
      // ì²´í¬ ìƒíƒœ ì´ˆê¸°í™”
      if (!wrapupData.ghSelected) {
        wrapupData.ghSelected = { commits: {}, prs: {}, reviews: {}, comments: {} };
        // ê¸°ë³¸: ì „ì²´ ì„ íƒ
        (gh?.commits || []).forEach((_, i) => wrapupData.ghSelected.commits[i] = true);
        (gh?.prs || []).forEach((_, i) => wrapupData.ghSelected.prs[i] = true);
        (gh?.reviews || []).forEach((_, i) => wrapupData.ghSelected.reviews[i] = true);
        (gh?.comments || []).forEach((_, i) => wrapupData.ghSelected.comments[i] = true);
      }

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸ™ GitHub í™œë™</h3>
          <p class="text-sm text-gray-400 mb-2">ë³´ê³ ì„œì— í¬í•¨í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
          ${gh?.accounts?.length > 0 ? `
            <div class="flex flex-wrap gap-2 text-xs mb-3">
              ${gh.accounts.map(a => `<span class="px-2 py-1 rounded-full bg-gray-700/50 text-gray-300">ğŸ‘¤ ${a}</span>`).join('')}
              ${(gh.repos || []).map(r => {
                const short = r.split('/').pop();
                return ghRepoBadge(short, r);
              }).join('')}
            </div>
          ` : ''}
        </div>
        ${!gh ? `
          <div class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-4 block">ğŸ”—</span>
            GitHub ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
            <span class="text-xs">gh CLIê°€ ì„¤ì¹˜ë˜ì–´ ìˆê³  ì¸ì¦ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</span>
          </div>
        ` : `
          <div class="space-y-3 max-h-[55vh] overflow-auto custom-scrollbar pr-1">
            ${renderGhSection('ğŸ“', 'ì»¤ë°‹', gh.commits || [], 'commits', (c, i) => `
              <div class="flex items-start gap-2">
                ${ghRepoBadge(c.repoShort, c.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${c.account}</span>
                <span class="text-gray-300 text-sm">${(c.messages || []).slice(0, 2).map(m => escapeHtml(m.split('\\n')[0])).join(', ') || escapeHtml(c.branch)}</span>
              </div>
            `)}

            ${renderGhSection('ğŸ”€', 'Pull Requests', gh.prs || [], 'prs', (pr, i) => `
              <div class="flex items-start gap-2">
                <span class="px-1.5 py-0.5 rounded text-xs flex-shrink-0 font-medium ${
                  pr.action === 'opened' ? 'bg-green-900/50 text-green-400' :
                  pr.action === 'merged' ? 'bg-purple-900/50 text-purple-400' :
                  'bg-gray-700 text-gray-400'
                }">${pr.action || pr.state}</span>
                ${ghRepoBadge(pr.repoShort, pr.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${pr.account}</span>
                <a href="${pr.url || '#'}" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline text-sm truncate" title="${escapeHtml(pr.title)}">#${pr.number} ${escapeHtml(pr.title)}</a>
              </div>
            `)}

            ${renderGhSection('ğŸ‘€', 'ë¦¬ë·°', gh.reviews || [], 'reviews', (r, i) => `
              <div class="flex items-start gap-2">
                <span class="px-1.5 py-0.5 rounded text-xs flex-shrink-0 ${
                  r.state === 'approved' ? 'bg-green-900/50 text-green-400' :
                  r.state === 'changes_requested' ? 'bg-red-900/50 text-red-400' :
                  'bg-blue-900/50 text-blue-400'
                }">${r.state === 'approved' ? 'âœ…' : r.state === 'changes_requested' ? 'ğŸ”„' : 'ğŸ’¬'}</span>
                ${ghRepoBadge(r.repoShort, r.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${r.account}</span>
                <a href="${r.url || '#'}" target="_blank" class="text-blue-400 hover:text-blue-300 hover:underline text-sm truncate" title="${escapeHtml(r.prTitle)}">#${r.prNumber} ${escapeHtml(r.prTitle)}</a>
              </div>
            `)}

            ${renderGhSection('ğŸ’¬', 'ì½”ë©˜íŠ¸', gh.comments || [], 'comments', (c, i) => `
              <div class="flex items-start gap-2 flex-wrap">
                ${ghRepoBadge(c.repoShort, c.repo)}
                <span class="text-xs text-gray-500 flex-shrink-0 mt-0.5">${c.account}</span>
                ${c.url ? `<a href="${c.url}" target="_blank" class="text-blue-400 hover:underline text-xs flex-shrink-0 mt-0.5">#${c.prNumber || c.issueNumber}</a>` : ''}
                <span class="text-gray-400 text-sm basis-full mt-0.5 pl-1 border-l-2 border-gray-700">${escapeHtml(c.body || '(ë‚´ìš© ì—†ìŒ)')}</span>
              </div>
            `)}
          </div>
        `}
      `;
    }

    function renderGhSection(icon, title, items, category, renderItem) {
      if (items.length === 0) {
        return `<div class="bg-gray-800/50 rounded-lg p-3 border border-gray-700/50">
          <div class="flex items-center gap-2">
            <span class="text-lg">${icon}</span>
            <span class="font-medium text-sm">${title}</span>
            <span class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">0ê°œ</span>
          </div>
          <div class="text-sm text-gray-600 mt-2">ì—†ìŒ</div>
        </div>`;
      }
      const allChecked = items.every((_, i) => wrapupData.ghSelected[category][i]);
      return `<div class="bg-gray-800/50 rounded-lg p-4 border border-gray-700/50">
        <div class="flex items-center gap-2 mb-3">
          <input type="checkbox" ${allChecked ? 'checked' : ''} onchange="toggleGhAll('${category}', this.checked)"
            class="w-3.5 h-3.5 rounded accent-blue-500 cursor-pointer">
          <span class="text-lg">${icon}</span>
          <span class="font-medium text-sm">${title}</span>
          <span class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">${items.length}ê°œ</span>
        </div>
        <div class="space-y-2">
          ${items.slice(0, 10).map((item, i) => `
            <label class="flex items-start gap-2 cursor-pointer rounded-md p-1.5 -mx-1.5 hover:bg-white/5 transition-colors gh-item-${category}">
              <input type="checkbox" ${wrapupData.ghSelected[category][i] ? 'checked' : ''}
                onchange="wrapupData.ghSelected['${category}'][${i}] = this.checked"
                class="w-3.5 h-3.5 rounded accent-blue-500 cursor-pointer mt-1 flex-shrink-0">
              <div class="flex-1 min-w-0">${renderItem(item, i)}</div>
            </label>
          `).join('')}
        </div>
      </div>`;
    }

    function toggleGhAll(category, checked) {
      const gh = wrapupData.githubActivity;
      const items = gh?.[category] || [];
      items.forEach((_, i) => wrapupData.ghSelected[category][i] = checked);
      document.querySelectorAll(`.gh-item-${category} input[type="checkbox"]`).forEach(cb => cb.checked = checked);
    }

    function filterSelectedGithub() {
      const gh = wrapupData.githubActivity;
      if (!gh || !wrapupData.ghSelected) return gh;
      const sel = wrapupData.ghSelected;
      return {
        ...gh,
        commits: (gh.commits || []).filter((_, i) => sel.commits[i]),
        prs: (gh.prs || []).filter((_, i) => sel.prs[i]),
        reviews: (gh.reviews || []).filter((_, i) => sel.reviews[i]),
        comments: (gh.comments || []).filter((_, i) => sel.comments[i])
      };
    }

    function renderStep3Memos(content) {
      const memos = wrapupData.memos;
      const obsidianMemos = memos.filter(m => m.source === 'obsidian');
      const dashboardMemos = memos.filter(m => m.source === 'dashboard');

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸ“ ì˜¤ëŠ˜ì˜ ë©”ëª¨</h3>
          <p class="text-sm text-gray-400 mb-4">ëŒ€ì‹œë³´ë“œì™€ Obsidian Daily Noteì˜ ë©”ëª¨ê°€ í¬í•¨ë©ë‹ˆë‹¤.</p>
        </div>
        ${memos.length === 0 ? `
          <div class="text-center py-8 text-gray-500">
            <span class="text-4xl mb-4 block">ğŸ“</span>
            ì˜¤ëŠ˜ ì‘ì„±í•œ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>
        ` : `
          <div class="flex gap-2 mb-3 text-xs">
            <span class="px-2 py-1 rounded-full bg-purple-900/50 text-purple-300">ğŸ“± ëŒ€ì‹œë³´ë“œ ${dashboardMemos.length}ê°œ</span>
            <span class="px-2 py-1 rounded-full bg-green-900/50 text-green-300">ğŸ““ Obsidian ${obsidianMemos.length}ê°œ</span>
          </div>
          <div class="space-y-2 max-h-64 overflow-auto custom-scrollbar">
            ${memos.map((m, i) => `
              <div class="p-3 bg-gray-800/30 rounded-lg border border-gray-700/30 ${m.source === 'obsidian' ? 'border-l-2 border-l-green-500' : 'border-l-2 border-l-purple-500'}">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-xs ${m.source === 'obsidian' ? 'text-green-400' : 'text-purple-400'}">${m.source === 'obsidian' ? 'ğŸ““' : 'ğŸ“±'}</span>
                  <span class="text-xs text-gray-500">${m.time || new Date(m.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
                <div class="text-sm">${escapeHtml(m.content || m.text || '')}</div>
              </div>
            `).join('')}
          </div>
        `}
      `;
    }

    function renderStep4Reflection(content) {
      const r = wrapupData.reflection;
      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸª í•˜ë£¨ íšŒê³ </h3>
          <p class="text-sm text-gray-400 mb-4">ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©° ê°„ë‹¨íˆ ì ì–´ë³´ì„¸ìš”. (ì„ íƒì‚¬í•­)</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ’¡ ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ</label>
            <input type="text" id="reflectLearned" value="${escapeHtml(r.learned)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ì˜¤ëŠ˜ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ê²ƒì´ ìˆë‚˜ìš”?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">ğŸŒŸ ì˜í•œ ì </label>
            <input type="text" id="reflectProud" value="${escapeHtml(r.proud)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ì˜¤ëŠ˜ ìŠ¤ìŠ¤ë¡œ ì¹­ì°¬í•˜ê³  ì‹¶ì€ ì ì€?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ”§ ê°œì„ í•  ì </label>
            <input type="text" id="reflectImprove" value="${escapeHtml(r.improve)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ë‚´ì¼ ë” ë‚˜ì•„ì§ˆ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì€?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ¯ ë‚´ì¼ ëª©í‘œ</label>
            <input type="text" id="reflectTomorrow" value="${escapeHtml(r.tomorrow)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ë‚´ì¼ ê¼­ í•˜ê³  ì‹¶ì€ ì¼ì€?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ™ ê°ì‚¬í•œ ê²ƒ</label>
            <input type="text" id="reflectGrateful" value="${escapeHtml(r.grateful)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ì˜¤ëŠ˜ ê°ì‚¬í–ˆë˜ ìˆœê°„ì´ ìˆë‚˜ìš”?">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">âœ¨ ì˜¤ëŠ˜ì˜ í•œ ì¤„</label>
            <input type="text" id="reflectOneline" value="${escapeHtml(r.oneline)}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"
                   placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤ë©´?">
          </div>
        </div>
      `;
    }

    function prevWrapupStep() {
      saveCurrentStepData();
      if (wrapupStep > 1) {
        wrapupStep--;
        renderWrapupStep();
      }
    }

    function nextWrapupStep() {
      saveCurrentStepData();
      if (wrapupStep < 4) {
        wrapupStep++;
        renderWrapupStep();
      }
    }

    function saveCurrentStepData() {
      if (wrapupStep === 1) {
        // ì„ íƒëœ ì„¸ì…˜ ì €ì¥
        const checkboxes = document.querySelectorAll('.session-checkbox:checked');
        wrapupData.selectedSessions = Array.from(checkboxes).map(cb => {
          const idx = parseInt(cb.dataset.index);
          return wrapupData.sessions[idx];
        });
      } else if (wrapupStep === 4) {
        // íšŒê³  ë°ì´í„° ì €ì¥
        wrapupData.reflection = {
          learned: document.getElementById('reflectLearned')?.value || '',
          proud: document.getElementById('reflectProud')?.value || '',
          improve: document.getElementById('reflectImprove')?.value || '',
          tomorrow: document.getElementById('reflectTomorrow')?.value || '',
          grateful: document.getElementById('reflectGrateful')?.value || '',
          oneline: document.getElementById('reflectOneline')?.value || ''
        };
      }
    }

    async function submitDayWrapup() {
      saveCurrentStepData();

      // ì„ íƒëœ ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ì „ì²´ ì„¸ì…˜ ì‚¬ìš©
      const sessionsToUse = wrapupData.selectedSessions.length > 0
        ? wrapupData.selectedSessions
        : wrapupData.sessions;

      try {
        await submitTask('day-wrapup', {
          date: wrapupData.date,
          selectedSessions: sessionsToUse.map(s => ({ id: s.id, projectPath: s.projectPath, project: s.project, alias: s.alias || null })),
          githubActivity: filterSelectedGithub(),
          memos: wrapupData.memos,
          morningPlan: wrapupData.morningPlan,
          reflection: wrapupData.reflection
        });

        closeDayWrapupModal();
        showToast('ğŸŒ™ í•˜ë£¨ ë§ˆë¬´ë¦¬ ìƒì„± ì¤‘... ì™„ë£Œë˜ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”!', 'info');
      } catch (err) {
        showToast('í•˜ë£¨ ë§ˆë¬´ë¦¬ ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    function closeDayWrapupModal() {
      document.getElementById('dayWrapupModal').style.display = 'none';
    }

    // Day Wrap-up ê²°ê³¼ í‘œì‹œ
    function showDayWrapupResult(result) {
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');
      currentReportContent = result.report;

      content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-lg">ğŸŒ™</div>
            <div>
              <h3 class="text-lg font-bold">í•˜ë£¨ ë§ˆë¬´ë¦¬</h3>
              <p class="text-xs text-gray-400">${result.date} Â· ${result.sessionsCount}ê°œ ì„¸ì…˜ Â· ${result.memosCount}ê°œ ë©”ëª¨</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="copyCurrentReport()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              ğŸ“‹ ë³µì‚¬
            </button>
            <button onclick="downloadFullReport('${result.date}')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              ğŸ“„ ë‹¤ìš´ë¡œë“œ
            </button>
            <button onclick="saveFullReportToObsidian('${result.date}')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium">
              ğŸ“ ì˜µì‹œë””ì–¸
            </button>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none ml-2">&times;</button>
          </div>
        </div>

        <div class="prose prose-invert max-w-none">
          <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[65vh] overflow-auto custom-scrollbar">
            <div class="markdown-content text-sm leading-relaxed">${renderMarkdown(result.report)}</div>
          </div>
        </div>
      `;

      modal.style.display = 'flex';
    }

    // ì¢…í•© ë³´ê³ ì„œ ëª¨ë‹¬
    let currentReportContent = '';

    function showFullReportModal(reportData) {
      const modal = document.getElementById('sessionDetailModal');
      const content = document.getElementById('sessionDetailContent');
      currentReportContent = reportData.report;

      const stats = [];
      if (reportData.sessionsCount !== undefined) stats.push(`${reportData.sessionsCount}ê°œ ì„¸ì…˜`);
      if (reportData.jobsCount !== undefined) stats.push(`${reportData.jobsCount}ê°œ ì‘ì—…`);
      if (reportData.memosCount !== undefined) stats.push(`${reportData.memosCount}ê°œ ë©”ëª¨`);

      content.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-pink-600 flex items-center justify-center text-lg">ğŸ“Š</div>
            <div>
              <h3 class="text-lg font-bold">ì¢…í•© ì¼ì¼ ë³´ê³ ì„œ</h3>
              <p class="text-xs text-gray-400">${reportData.date} Â· ${stats.join(' Â· ')}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="copyCurrentReport()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              ğŸ“‹ ë³µì‚¬
            </button>
            <button onclick="downloadFullReport('${reportData.date}')" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 rounded text-xs font-medium">
              ğŸ“„ ë‹¤ìš´ë¡œë“œ
            </button>
            <button onclick="saveFullReportToObsidian('${reportData.date}')" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 rounded text-xs font-medium">
              ğŸ“ ì˜µì‹œë””ì–¸
            </button>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none ml-2">&times;</button>
          </div>
        </div>

        <div class="prose prose-invert max-w-none">
          <div class="bg-gray-700/30 rounded-lg p-4 border border-gray-600/30 max-h-[65vh] overflow-auto custom-scrollbar">
            <div class="markdown-content text-sm leading-relaxed">${renderMarkdown(reportData.report)}</div>
          </div>
        </div>
      `;

      modal.style.display = 'flex';
    }

    function copyCurrentReport() {
      if (currentReportContent) {
        copyToClipboard(currentReportContent, 'ë³´ê³ ì„œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }

    function downloadFullReport(date) {
      const blob = new Blob([currentReportContent], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `daily-report-${date}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
    }

    async function saveFullReportToObsidian(date) {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/daily-report/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, content: currentReportContent })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`ë³´ê³ ì„œ ì €ì¥ë¨: ${data.relativePath}`, 'success');
        } else {
          showToast('ì €ì¥ ì‹¤íŒ¨: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    function showReportModal(reportData) {
      // ê¸°ì¡´ ì¼ì¼ ë³´ê³ ì„œë„ ì¢…í•© ë³´ê³ ì„œ ëª¨ë‹¬ë¡œ í‘œì‹œ
      showFullReportModal(reportData);
    }

    // ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ
    async function downloadReport(date) {
      window.open(`${API_BASE}/api/sessions/daily-report/download?date=${date}`, '_blank');
    }

    // ë³´ê³ ì„œ ì˜µì‹œë””ì–¸ ì €ì¥
    async function saveReportToObsidian(date) {
      try {
        const res = await fetch(`${API_BASE}/api/sessions/daily-report/obsidian`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date })
        });
        const data = await res.json();
        if (data.success) {
          showToast(`ë³´ê³ ì„œ ì €ì¥ë¨: ${data.relativePath}`, 'success');
        } else {
          showToast('ì €ì¥ ì‹¤íŒ¨: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ì „ì²´ ì„¸ì…˜ ì˜µì‹œë””ì–¸ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
    async function exportAllSessionsToObsidian() {
      const date = document.getElementById('sessionsDate').value;
      if (!date) {
        showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      showToast('ì „ì²´ ì„¸ì…˜ ë‚´ë³´ë‚´ê¸° ì¤‘...', 'info');

      try {
        const res = await fetch(`${API_BASE}/api/sessions/export-all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date })
        });

        const data = await res.json();
        if (data.success) {
          showToast(`${data.exported}ê°œ ì„¸ì…˜ ë‚´ë³´ëƒ„`, 'success');
        } else {
          showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + data.error, 'error');
        }
      } catch (err) {
        showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ì—°ì†ëœ ë„êµ¬ ì „ìš© ë©”ì‹œì§€ë¥¼ ê·¸ë£¹í™”
    function groupToolOnlyMessages(conversation) {
      const result = [];
      let toolGroup = null;

      for (const msg of conversation) {
        const hasContent = msg.content && msg.content.trim();
        const isToolOnly = msg.role === 'assistant' && !hasContent && msg.tools?.length > 0;

        if (isToolOnly) {
          if (!toolGroup) {
            toolGroup = {
              isToolGroup: true,
              role: 'assistant',
              groupCount: 0,
              groupedTools: [],
              timestamp: msg.timestamp
            };
          }
          toolGroup.groupCount++;
          toolGroup.groupedTools.push(msg.tools);
        } else {
          // í˜„ì¬ ê·¸ë£¹ ì €ì¥ (2ê°œ ì´ìƒì¼ ë•Œë§Œ ê·¸ë£¹í™”)
          if (toolGroup) {
            if (toolGroup.groupCount >= 2) {
              result.push(toolGroup);
            } else {
              // 1ê°œë©´ ê·¸ëƒ¥ ì¼ë°˜ ë©”ì‹œì§€ë¡œ í‘œì‹œ
              result.push({
                role: 'assistant',
                content: '',
                tools: toolGroup.groupedTools[0],
                timestamp: toolGroup.timestamp
              });
            }
            toolGroup = null;
          }
          result.push(msg);
        }
      }

      // ë§ˆì§€ë§‰ ê·¸ë£¹ ì²˜ë¦¬
      if (toolGroup) {
        if (toolGroup.groupCount >= 2) {
          result.push(toolGroup);
        } else {
          result.push({
            role: 'assistant',
            content: '',
            tools: toolGroup.groupedTools[0],
            timestamp: toolGroup.timestamp
          });
        }
      }

      return result;
    }

    // ë„êµ¬ ê·¸ë£¹ í¼ì¹˜ê¸°/ì ‘ê¸°
    function toggleToolGroup(element) {
      const details = element.querySelector('.tool-group-details');
      const toggle = element.querySelector('.tool-group-toggle');

      if (details.classList.contains('hidden')) {
        details.classList.remove('hidden');
        toggle.textContent = 'â–²';
      } else {
        details.classList.add('hidden');
        toggle.textContent = 'â–¼';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // í´ë¦½ë³´ë“œ ë³µì‚¬
    function copyToClipboard(text, message = 'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤') {
      navigator.clipboard.writeText(text).then(() => {
        showToast(message, 'success');
      }).catch(err => {
        showToast('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message, 'error');
      });
    }

    // ============ Today's Summary & Ask Modal Functions ============

    async function refreshTodaySummary() {
      try {
        const res = await fetch(`${API_BASE}/api/today/summary`);
        const data = await res.json();

        document.getElementById('todaySessionsCount').textContent = data.sessionsCount;
        document.getElementById('todayJobsCount').textContent = data.jobsCount;

        const successRate = data.jobsCount > 0
          ? Math.round((data.successCount / data.jobsCount) * 100) + '%'
          : '-';
        document.getElementById('todaySuccessRate').textContent = successRate;
      } catch (err) {
        console.error('ì˜¤ëŠ˜ ìš”ì•½ ë¡œë“œ ì‹¤íŒ¨:', err);
      }

      // ëª¨ë‹ í”Œëœ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      checkMorningPlanExists();
    }

    async function loadHomeDashboard() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const [summaryRes, jobsRes, historyRes, memosRes, backlogsRes, obsidianRes] = await Promise.all([
          fetch(`${API_BASE}/api/today/summary`).catch(() => null),
          fetch(`${API_BASE}/api/jobs`).catch(() => null),
          fetch(`${API_BASE}/api/history?limit=5`).catch(() => null),
          fetch(`${API_BASE}/api/quick-memos?date=${today}`).catch(() => null),
          fetch(`${API_BASE}/api/backlogs`).catch(() => null),
          fetch(`${API_BASE}/api/obsidian/daily-memos?date=${today}`).catch(() => null)
        ]);

        // ìš”ì•½ ì¹´ë“œ
        if (summaryRes) {
          const summary = await summaryRes.json();
          document.getElementById('homeSessionsCount').textContent = summary.sessionsCount || 0;
          document.getElementById('homeTodayRuns').textContent = summary.jobsCount || 0;
          const rate = summary.jobsCount > 0
            ? Math.round((summary.successCount / summary.jobsCount) * 100) + '%'
            : '-';
          document.getElementById('homeTodayRate').textContent = `ì„±ê³µë¥  ${rate}`;
        }

        // í™œì„± ì‘ì—… ìˆ˜
        if (jobsRes) {
          const jobsData = await jobsRes.json();
          const jobs = jobsData.jobs || jobsData || [];
          const enabledCount = jobs.filter(j => j.enabled !== false).length;
          document.getElementById('homeJobsActive').textContent = enabledCount;
          document.getElementById('homeJobsDesc').textContent = `${jobs.length}ê°œ ì¤‘ ${enabledCount}ê°œ í™œì„±`;
        }

        // ë©”ëª¨ + ë°±ë¡œê·¸ ìˆ˜
        if (memosRes || backlogsRes) {
          const memos = memosRes ? await memosRes.json() : { memos: [] };
          const backlogs = backlogsRes ? await backlogsRes.json() : { backlogs: [] };
          const obsidian = obsidianRes ? await obsidianRes.json() : { memos: [] };
          const totalMemos = (memos.memos || []).length + (obsidian.memos || []).filter(m => m.content?.trim()).length;
          const openBacklogs = (backlogs.backlogs || []).filter(b => !b.done).length;
          document.getElementById('homeNotesCount').textContent = totalMemos;
          document.getElementById('homeBacklogCount').textContent = `ë¯¸ì™„ë£Œ ë°±ë¡œê·¸ ${openBacklogs}ê°œ`;

          // ìµœê·¼ ë©”ëª¨ ë Œë”ë§
          const allMemos = [
            ...(memos.memos || []).map(m => ({ ...m, _source: 'dashboard' })),
            ...(obsidian.memos || []).filter(m => m.content?.trim()).map(m => ({ ...m, _source: 'obsidian' }))
          ].slice(0, 5);
          const memosContainer = document.getElementById('homeRecentMemos');
          if (allMemos.length === 0) {
            memosContainer.innerHTML = '<div class="text-gray-500 text-center py-4">ì˜¤ëŠ˜ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          } else {
            memosContainer.innerHTML = allMemos.map(m => {
              const content = (m.content || m.text || '').substring(0, 80);
              const timeStr = (m.timestamp || m.createdAt)
                ? new Date(m.timestamp || m.createdAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                : (m.time || '');
              const icon = m._source === 'obsidian' ? 'ğŸ““' : 'ğŸ“';
              return `<div class="flex items-center gap-2 p-2 rounded-lg bg-gray-800/50 hover:bg-gray-700/50 transition-colors">
                <span class="flex-shrink-0">${icon}</span>
                <span class="flex-1 truncate text-gray-300">${escapeHtml(content)}</span>
                <span class="text-xs text-gray-600 flex-shrink-0">${timeStr}</span>
              </div>`;
            }).join('');
          }
        }

        // ìµœê·¼ ì‹¤í–‰ ì´ë ¥
        if (historyRes) {
          const historyData = await historyRes.json();
          const runs = historyData.items || historyData.history || [];
          const container = document.getElementById('homeRecentRuns');
          if (runs.length === 0) {
            container.innerHTML = '<div class="text-gray-500 text-center py-4">ì‹¤í–‰ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          } else {
            container.innerHTML = runs.slice(0, 5).map(r => {
              const statusIcon = r.status === 'success' ? 'âœ…' : r.status === 'failed' ? 'âŒ' : 'â³';
              const statusColor = r.status === 'success' ? 'text-green-400' : r.status === 'failed' ? 'text-red-400' : 'text-yellow-400';
              const timeStr = r.startedAt
                ? new Date(r.startedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                : '';
              const duration = r.duration ? `${(r.duration / 1000).toFixed(1)}s` : '';
              return `<div class="flex items-center gap-2 p-2 rounded-lg bg-gray-800/50 hover:bg-gray-700/50 transition-colors">
                <span class="flex-shrink-0">${statusIcon}</span>
                <span class="flex-1 truncate ${statusColor}">${escapeHtml(r.jobName || r.jobId || '')}</span>
                <span class="text-xs text-gray-600 flex-shrink-0">${duration}</span>
                <span class="text-xs text-gray-600 flex-shrink-0">${timeStr}</span>
              </div>`;
            }).join('');
          }
        }
      } catch (err) {
        console.error('í™ˆ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', err);
      }
    }

    function openAskModal() {
      const modal = document.getElementById('askModal');
      modal.style.display = 'flex';

      // ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById('askInput').value = '';
      document.getElementById('askResponse').classList.add('hidden');
      document.getElementById('askLoading').classList.add('hidden');
      document.getElementById('askSubmitBtn').classList.remove('hidden');
      document.getElementById('askCopyBtn').classList.add('hidden');
      document.getElementById('askModalEmoji').textContent = 'ğŸ¤–';

      setTimeout(() => document.getElementById('askInput').focus(), 100);
    }

    function closeAskModal() {
      document.getElementById('askModal').style.display = 'none';
    }

    async function submitQuestion() {
      const input = document.getElementById('askInput');
      const prompt = input.value.trim();
      if (!prompt) return;

      try {
        // ë¹„ë™ê¸° ì‘ì—… ì œì¶œ
        await submitTask('ask', { prompt });

        // ëª¨ë‹¬ ë‹«ê¸° (ê²°ê³¼ëŠ” ì‘ì—… íŒ¨ë„ì—ì„œ í™•ì¸)
        closeAskModal();
        showToast('ì§ˆë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì™„ë£Œë˜ë©´ ì•Œë ¤ë“œë¦´ê²Œìš”!', 'info');

      } catch (err) {
        showToast('ì§ˆë¬¸ ì œì¶œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    function copyAskResponse() {
      if (currentAskResponse) {
        navigator.clipboard.writeText(currentAskResponse).then(() => {
          showToast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        });
      }
    }

    let quickInputType = 'memo'; // 'memo' | 'backlog'
    let backlogPriority = 'normal';

    function openQuickInput(type) {
      quickInputType = type || 'memo';
      backlogPriority = 'normal';
      const modal = document.getElementById('quickInputModal');
      modal.style.display = 'flex';

      document.getElementById('quickInputText').value = '';
      setQuickInputType(quickInputType);
      setTimeout(() => document.getElementById('quickInputText').focus(), 100);
    }

    function setQuickInputType(type) {
      quickInputType = type;
      const memoBtn = document.getElementById('qiTypeMemo');
      const backlogBtn = document.getElementById('qiTypeBacklog');
      const priRow = document.getElementById('backlogPriorityRow');
      const textarea = document.getElementById('quickInputText');
      const icon = document.getElementById('quickInputIcon');
      const title = document.getElementById('quickInputTitle');
      const saveBtn = document.getElementById('quickInputSaveBtn');

      if (type === 'memo') {
        memoBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white/20 text-white';
        backlogBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-white/60';
        priRow.classList.add('hidden');
        textarea.placeholder = 'ì§€ê¸ˆ í•˜ê³  ìˆëŠ” ì¼, ìƒê°, ë©”ëª¨...';
        icon.textContent = 'ğŸ“';
        title.textContent = 'ë¹ ë¥¸ ë©”ëª¨';
        saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥';
      } else {
        backlogBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all bg-white/20 text-white';
        memoBtn.className = 'flex-1 px-3 py-1.5 rounded-md text-sm font-medium transition-all text-white/60';
        priRow.classList.remove('hidden');
        textarea.placeholder = 'ë‚˜ì¤‘ì— í•  ì¼, ì•„ì´ë””ì–´, TODO...';
        icon.textContent = 'ğŸ“‹';
        title.textContent = 'ë°±ë¡œê·¸ ì¶”ê°€';
        saveBtn.innerHTML = 'ğŸ“‹ ì¶”ê°€';
        setBacklogPriority('normal');
      }
    }

    function setBacklogPriority(pri) {
      backlogPriority = pri;
      document.querySelectorAll('.backlog-pri-btn').forEach(btn => {
        if (btn.dataset.pri === pri) {
          btn.className = 'backlog-pri-btn px-2 py-1 rounded text-xs border border-white/30 bg-white/10 text-white transition-colors';
        } else {
          btn.className = 'backlog-pri-btn px-2 py-1 rounded text-xs border border-white/20 text-white/60 transition-colors';
        }
      });
    }

    function toggleQuickInputPreview() {
      const preview = document.getElementById('qiPreviewArea');
      const btn = document.getElementById('qiPreviewToggle');
      if (preview.classList.contains('hidden')) {
        const text = document.getElementById('quickInputText').value;
        preview.innerHTML = text ? marked.parse(text) : '<span class="text-gray-500">ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</span>';
        preview.classList.remove('hidden');
        btn.textContent = 'ğŸ‘ ë¯¸ë¦¬ë³´ê¸° ë‹«ê¸°';
      } else {
        preview.classList.add('hidden');
        btn.textContent = 'ğŸ‘ ë¯¸ë¦¬ë³´ê¸°';
      }
    }

    function updateQuickInputPreview() {
      const preview = document.getElementById('qiPreviewArea');
      if (!preview.classList.contains('hidden')) {
        const text = document.getElementById('quickInputText').value;
        preview.innerHTML = text ? marked.parse(text) : '<span class="text-gray-500">ë‚´ìš©ì„ ì…ë ¥í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ í‘œì‹œë©ë‹ˆë‹¤</span>';
      }
    }

    function closeQuickInputModal() {
      document.getElementById('quickInputModal').style.display = 'none';
      document.getElementById('qiPreviewArea').classList.add('hidden');
      document.getElementById('qiPreviewToggle').textContent = 'ğŸ‘ ë¯¸ë¦¬ë³´ê¸°';
    }

    async function saveQuickInput() {
      const text = document.getElementById('quickInputText').value.trim();
      if (!text) return;

      try {
        if (quickInputType === 'backlog') {
          const res = await fetch(`${API_BASE}/api/backlogs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: text, priority: backlogPriority })
          });
          if (!res.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');
          showToast('ë°±ë¡œê·¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ“‹', 'success');
        } else {
          const res = await fetch(`${API_BASE}/api/quick-memos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: text })
          });
          if (!res.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');
          showToast('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ“', 'success');
        }

        document.getElementById('quickInputText').value = '';
        closeQuickInputModal();
        refreshTodaySummary();

        // ë…¸íŠ¸ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ìƒˆë¡œê³ ì¹¨
        if (!document.getElementById('panel-notes').classList.contains('hidden')) {
          loadNotes();
        }
      } catch (err) {
        showToast('ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // í•˜ìœ„ í˜¸í™˜ - ê¸°ì¡´ saveQuickMemo í˜¸ì¶œ ì§€ì›
    async function saveQuickMemo() { return saveQuickInput(); }

    // ============ ë…¸íŠ¸ & ë°±ë¡œê·¸ íƒ­ ============
    let notesFilter = 'all';
    let notesData = { memos: [], backlogs: [] };
    let notesDate = new Date().toISOString().split('T')[0]; // ì˜¤ëŠ˜

    function initNotesDate() {
      if (!notesDate) notesDate = new Date().toISOString().split('T')[0];
      updateNotesDateUI();
    }

    function updateNotesDateUI() {
      const today = new Date().toISOString().split('T')[0];
      const d = new Date(notesDate + 'T00:00:00');
      const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      const isToday = notesDate === today;
      const label = document.getElementById('notesDateLabel');
      const input = document.getElementById('notesDateInput');
      const nextBtn = document.getElementById('notesDateNext');

      if (label) {
        const m = d.getMonth() + 1;
        const day = d.getDate();
        const wd = weekdays[d.getDay()];
        label.textContent = isToday ? `ğŸ“… ì˜¤ëŠ˜ (${m}/${day} ${wd})` : `ğŸ“… ${m}/${day} (${wd})`;
        label.title = notesDate;
      }
      if (input) input.value = notesDate;
      // ë¯¸ë˜ ë‚ ì§œ ë¹„í™œì„±í™”
      if (nextBtn) {
        nextBtn.disabled = notesDate >= today;
        nextBtn.style.opacity = notesDate >= today ? '0.3' : '1';
      }
    }

    function setNotesDate(dateStr) {
      const today = new Date().toISOString().split('T')[0];
      if (dateStr > today) dateStr = today;
      notesDate = dateStr;
      updateNotesDateUI();
      loadNotes();
    }

    function shiftNotesDate(delta) {
      const d = new Date(notesDate + 'T00:00:00');
      d.setDate(d.getDate() + delta);
      setNotesDate(d.toISOString().split('T')[0]);
    }

    function setNotesToday() {
      setNotesDate(new Date().toISOString().split('T')[0]);
    }

    function setNotesFilter(filter) {
      notesFilter = filter;
      document.querySelectorAll('.note-filter-btn').forEach(btn => {
        btn.className = 'note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 hover:text-white';
      });
      const activeBtn = document.getElementById(`noteFilter-${filter}`);
      if (activeBtn) activeBtn.className = 'note-filter-btn px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-600 text-white';
      renderNotesList();
    }

    async function loadNotes() {
      try {
        const targetDate = notesDate || new Date().toISOString().split('T')[0];
        const [memosRes, backlogsRes, obsidianRes] = await Promise.all([
          fetch(`${API_BASE}/api/quick-memos?date=${targetDate}`),
          fetch(`${API_BASE}/api/backlogs`),
          fetch(`${API_BASE}/api/obsidian/daily-memos?date=${targetDate}`).catch(() => ({ json: () => ({ memos: [] }) }))
        ]);
        const memosData = await memosRes.json();
        const backlogsData = await backlogsRes.json();
        const obsidianData = await obsidianRes.json();

        // ëŒ€ì‹œë³´ë“œ ë©”ëª¨ (ë‚ ì§œ í•„í„°ë§ë¨)
        const dashMemos = (memosData.memos || []).map(m => ({ ...m, _type: 'memo', _source: 'dashboard' }));

        // Obsidian ì‹œê°„ë³„ ë©”ëª¨ (ëŒ€ì‹œë³´ë“œ ë©”ëª¨ì™€ ì¤‘ë³µ ì œê±° - ë‚´ìš©ìœ¼ë¡œ ë¹„êµ)
        const dashContents = new Set(dashMemos.map(m => m.content?.trim()));
        const obsidianMemos = (obsidianData.memos || [])
          .filter(m => m.content?.trim() && !dashContents.has(m.content?.trim()))
          .map(m => ({ ...m, _type: 'memo', _source: 'obsidian' }));

        notesData.memos = [...dashMemos, ...obsidianMemos];
        notesData.backlogs = (backlogsData.backlogs || []).map(b => ({ ...b, _type: 'backlog' }));

        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        const openCount = notesData.backlogs.filter(b => !b.done).length;
        document.getElementById('backlogOpenCount').textContent = openCount > 0 ? `(${openCount})` : '';
        document.getElementById('notesCount').textContent =
          `ë©”ëª¨ ${notesData.memos.length}ê°œ Â· ë°±ë¡œê·¸ ${notesData.backlogs.length}ê°œ (ë¯¸ì™„ë£Œ ${openCount})`;

        renderNotesList();
      } catch (err) {
        console.error('ë…¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
        document.getElementById('notesList').innerHTML =
          '<div class="text-center text-red-400 py-8">ë¡œë“œ ì‹¤íŒ¨: ' + err.message + '</div>';
      }
    }

    function renderNotesList() {
      const container = document.getElementById('notesList');
      let items = [];

      if (notesFilter === 'all') {
        items = [
          ...notesData.backlogs.filter(b => !b.done).map(b => ({ ...b, _type: 'backlog' })),
          ...notesData.memos.map(m => ({ ...m, _type: 'memo' }))
        ];
      } else if (notesFilter === 'backlog') {
        items = notesData.backlogs.filter(b => !b.done);
      } else if (notesFilter === 'memo') {
        items = notesData.memos;
      } else if (notesFilter === 'done') {
        items = notesData.backlogs.filter(b => b.done);
      }

      // ì‹œê°„ìˆœ ì •ë ¬ (ìµœì‹  ë¨¼ì €) - ë‹¨ "all" í•„í„°ì—ì„œ ë°±ë¡œê·¸ëŠ” ìƒë‹¨
      if (notesFilter !== 'all') {
        items.sort((a, b) => (b.createdAt || b.timestamp || '').localeCompare(a.createdAt || a.timestamp || ''));
      }

      if (items.length === 0) {
        const emptyMsg = {
          all: 'ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ëª¨ë‚˜ ë°±ë¡œê·¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!',
          backlog: 'ë¯¸ì™„ë£Œ ë°±ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.',
          memo: 'ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.',
          done: 'ì™„ë£Œëœ ë°±ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.'
        };
        container.innerHTML = `<div class="text-center text-gray-500 py-12">${emptyMsg[notesFilter]}</div>`;
        return;
      }

      // "all" í•„í„°: ë°±ë¡œê·¸ì™€ ë©”ëª¨ë¥¼ ì„¹ì…˜ìœ¼ë¡œ ë‚˜ëˆ  í‘œì‹œ
      if (notesFilter === 'all') {
        const openBacklogs = notesData.backlogs.filter(b => !b.done);
        const recentMemos = notesData.memos.slice(0, 20);

        let html = '';

        if (openBacklogs.length > 0) {
          html += `<div class="mb-8">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-sm font-bold text-amber-400">ğŸ“‹ ë°±ë¡œê·¸</span>
              <span class="text-xs text-gray-500">${openBacklogs.length}ê°œ ë¯¸ì™„ë£Œ</span>
            </div>
            <div class="space-y-2">
              ${openBacklogs.map(b => renderBacklogItem(b)).join('')}
            </div>
          </div>`;
        }

        if (recentMemos.length > 0) {
          const today = new Date().toISOString().split('T')[0];
          const memoLabel = notesDate === today ? 'ğŸ“ ìµœê·¼ ë©”ëª¨' : `ğŸ“ ${notesDate} ë©”ëª¨`;
          html += `<div>
            <div class="flex items-center gap-2 mb-3">
              <span class="text-sm font-bold text-purple-400">${memoLabel}</span>
              <span class="text-xs text-gray-500">${notesData.memos.length}ê°œ</span>
            </div>
            <div class="space-y-2">
              ${recentMemos.map(m => renderMemoItem(m)).join('')}
            </div>
          </div>`;
        }

        container.innerHTML = html;
        return;
      }

      // ê°œë³„ í•„í„°
      container.innerHTML = `<div class="space-y-2">
        ${items.map(item => item._type === 'backlog' ? renderBacklogItem(item) : renderMemoItem(item)).join('')}
      </div>`;
    }

    function renderBacklogItem(b) {
      const priColors = {
        high: 'border-l-red-500 bg-red-900/10',
        normal: 'border-l-amber-500 bg-amber-900/10',
        low: 'border-l-blue-500 bg-blue-900/10'
      };
      const priIcons = { high: 'ğŸ”´', normal: 'ğŸŸ¡', low: 'ğŸ”µ' };
      const colorClass = priColors[b.priority] || priColors.normal;
      const timeStr = b.createdAt ? new Date(b.createdAt).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }) : '';
      const rawContent = b.content || '';
      const hasMarkdown = /[*_`#\-\[\]]/.test(rawContent);
      const renderedContent = hasMarkdown && !b.done
        ? `<div class="markdown-content text-sm">${marked.parse(rawContent)}</div>`
        : `<span class="text-sm ${b.done ? 'line-through text-gray-500' : ''}">${escapeHtml(rawContent)}</span>`;

      return `
        <div class="flex items-start gap-3 p-4 rounded-lg border border-gray-700/50 border-l-2 ${colorClass} hover:bg-gray-800/50 transition-colors group ${b.done ? 'opacity-50' : ''}">
          <input type="checkbox" ${b.done ? 'checked' : ''}
            onchange="toggleBacklog('${b.id}', this.checked)"
            class="w-4 h-4 rounded accent-amber-500 cursor-pointer flex-shrink-0 mt-1">
          <div class="flex-1 min-w-0">${renderedContent}</div>
          <div class="flex items-center gap-2 flex-shrink-0 mt-0.5">
            <span class="text-xs text-gray-600">${priIcons[b.priority] || ''}</span>
            <span class="text-xs text-gray-600 whitespace-nowrap">${timeStr}</span>
            <button onclick="deleteBacklog('${b.id}')"
              class="w-7 h-7 flex items-center justify-center rounded-full text-gray-500 hover:text-red-400 hover:bg-red-400/10 transition-all text-lg" title="ì‚­ì œ">&times;</button>
          </div>
        </div>
      `;
    }

    function renderMemoItem(m) {
      const timeStr = (m.timestamp || m.createdAt) ?
        new Date(m.timestamp || m.createdAt).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
        : (m.time || '');
      const isObsidian = m._source === 'obsidian';
      const borderColor = isObsidian ? 'border-l-green-500 bg-green-900/10' : 'border-l-purple-500 bg-purple-900/10';
      const icon = isObsidian ? 'ğŸ““' : 'ğŸ“';
      const rawContent = m.content || m.text || '';
      const hasMultiline = rawContent.includes('\n');
      const hasMarkdown = /[*_`#\[\]]/.test(rawContent) || hasMultiline;
      const renderedContent = hasMarkdown
        ? `<div class="markdown-content text-sm">${marked.parse(rawContent)}</div>`
        : `<span class="text-sm">${escapeHtml(rawContent)}</span>`;
      const deleteBtn = m.id && !isObsidian
        ? `<button onclick="deleteMemo('${m.id}')" class="flex-shrink-0 w-7 h-7 flex items-center justify-center rounded-full text-gray-500 hover:text-red-400 hover:bg-red-400/10 transition-all text-lg" title="ì‚­ì œ">&times;</button>`
        : '';

      return `
        <div class="flex items-start gap-3 p-4 rounded-lg border border-gray-700/50 border-l-2 ${borderColor} hover:bg-gray-800/50 transition-colors group">
          <span class="flex-shrink-0 mt-0.5">${icon}</span>
          <div class="flex-1 min-w-0">${renderedContent}</div>
          <div class="flex items-center gap-2 flex-shrink-0 mt-0.5">
            ${isObsidian ? '<span class="text-xs text-green-600 whitespace-nowrap">Obsidian</span>' : ''}
            <span class="text-xs text-gray-600 whitespace-nowrap">${timeStr}</span>
            ${deleteBtn}
          </div>
        </div>
      `;
    }

    async function toggleBacklog(id, done) {
      try {
        await fetch(`${API_BASE}/api/backlogs/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ done })
        });
        showToast(done ? 'âœ… ì™„ë£Œ!' : 'â†©ï¸ ë¯¸ì™„ë£Œë¡œ ë³€ê²½', 'success');
        loadNotes();
      } catch (err) {
        showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    async function deleteBacklog(id) {
      try {
        await fetch(`${API_BASE}/api/backlogs/${id}`, { method: 'DELETE' });
        showToast('ë°±ë¡œê·¸ ì‚­ì œë¨', 'success');
        loadNotes();
      } catch (err) {
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    async function deleteMemo(id) {
      try {
        await fetch(`${API_BASE}/api/quick-memos/${id}`, { method: 'DELETE' });
        showToast('ë©”ëª¨ ì‚­ì œë¨', 'success');
        loadNotes();
      } catch (err) {
        showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ============ í•˜ë£¨ ì‹œì‘ (Morning Start) ============
    let morningStep = 1;
    let morningEditMode = false; // true = í•œ í™”ë©´ í¸ì§‘, false = ìœ„ì €ë“œ
    let morningData = {
      date: '',
      tasks: [],
      additionalTasks: [],
      goals: [],
      focusTime: '',
      motto: '',
      markdown: ''
    };
    let hasMorningPlan = false; // ì˜¤ëŠ˜ í”Œëœ ì¡´ì¬ ì—¬ë¶€

    // í˜ì´ì§€ ë¡œë“œ ì‹œ & ì €ì¥ í›„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    async function checkMorningPlanExists() {
      const today = new Date().toISOString().split('T')[0];
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${today}`);
        const data = await res.json();
        hasMorningPlan = !!data.plan;
        const btn = document.getElementById('morningStartBtn');
        if (btn) {
          btn.innerHTML = hasMorningPlan ? 'âœï¸ í•˜ë£¨ ìˆ˜ì •' : 'â˜€ï¸ í•˜ë£¨ ì‹œì‘';
        }
      } catch (e) { /* ignore */ }
    }

    async function openMorningStart() {
      const today = new Date().toISOString().split('T')[0];
      morningData = {
        date: today,
        tasks: [],
        additionalTasks: [],
        goals: [],
        focusTime: '',
        motto: '',
        markdown: ''
      };

      document.getElementById('morningDate').textContent = today;

      // ê¸°ì¡´ í”Œëœì´ ìˆìœ¼ë©´ ë¡œë“œ
      let existingPlan = false;
      try {
        const res = await fetch(`${API_BASE}/api/morning-plan?date=${today}`);
        const data = await res.json();
        if (data.plan) {
          morningData = { ...morningData, ...data.plan };
          existingPlan = true;
        }
      } catch (e) {
        console.error('ëª¨ë‹ í”Œëœ ë¡œë“œ ì‹¤íŒ¨:', e);
      }

      // ê¸°ì¡´ í”Œëœ ìˆìœ¼ë©´ â†’ í•œ í™”ë©´ í¸ì§‘ ëª¨ë“œ, ì—†ìœ¼ë©´ â†’ ìœ„ì €ë“œ ëª¨ë“œ
      morningEditMode = existingPlan;

      if (morningEditMode) {
        document.getElementById('morningHeaderIcon').textContent = 'âœï¸';
        document.getElementById('morningHeaderTitle').textContent = 'í•˜ë£¨ ê³„íš ìˆ˜ì •';
        document.getElementById('morningStepBar').classList.add('hidden');
        document.getElementById('morningPrevBtn').classList.add('hidden');
        document.getElementById('morningNextBtn').classList.add('hidden');
        document.getElementById('morningSubmitBtn').classList.remove('hidden');
        document.getElementById('morningSubmitBtn').innerHTML = 'ğŸ’¾ ì €ì¥';
        renderMorningEditAll();
      } else {
        morningStep = 1;
        document.getElementById('morningHeaderIcon').textContent = 'â˜€ï¸';
        document.getElementById('morningHeaderTitle').textContent = 'í•˜ë£¨ ì‹œì‘';
        document.getElementById('morningStepBar').classList.remove('hidden');
        document.getElementById('morningSubmitBtn').innerHTML = 'â˜€ï¸ í•˜ë£¨ ì‹œì‘!';
        renderMorningStep();
      }

      document.getElementById('morningStartModal').style.display = 'flex';
    }

    function closeMorningStartModal() {
      document.getElementById('morningStartModal').style.display = 'none';
    }

    // ---- í•œ í™”ë©´ í¸ì§‘ ëª¨ë“œ ----
    function renderMorningEditAll() {
      const content = document.getElementById('morningContent');
      const tasksText = morningData.tasks.length > 0 ? morningData.tasks.join('\n') : '';
      const existingItems = morningData.additionalTasks || [];
      const g = morningData.goals || [];
      const focusLabels = { morning: 'ì˜¤ì „', afternoon: 'ì˜¤í›„', evening: 'ì €ë…', 'all-day': 'í•˜ë£¨ ì¢…ì¼' };
      const focusOptions = [
        { value: 'morning', label: 'ì˜¤ì „', icon: 'ğŸŒ…' },
        { value: 'afternoon', label: 'ì˜¤í›„', icon: 'â˜€ï¸' },
        { value: 'evening', label: 'ì €ë…', icon: 'ğŸŒ™' },
        { value: 'all-day', label: 'í•˜ë£¨ ì¢…ì¼', icon: 'â°' }
      ];
      const categories = ['íšŒì˜', 'ë¦¬ë·°', 'í•™ìŠµ', 'ìš´ë™', 'ê°œì¸', 'ê¸°íƒ€'];

      content.innerHTML = `
        <div class="flex gap-2 mb-4">
          <button onclick="switchMorningEditTab('form')" id="morningFormTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300">
            ğŸ“ í¼ í¸ì§‘
          </button>
          <button onclick="switchMorningEditTab('preview')" id="morningPvTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500">
            ğŸ‘ ë§ˆí¬ë‹¤ìš´
          </button>
          <button onclick="switchMorningEditTab('markdown')" id="morningMdTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500">
            âœï¸ ì›ë³¸ í¸ì§‘
          </button>
        </div>

        <!-- í¼ í¸ì§‘ íƒ­ -->
        <div id="morningFormArea">
          <!-- ì—…ë¬´ -->
          <div class="mb-5">
            <label class="block text-sm font-medium mb-2">ğŸ“‹ ì˜¤ëŠ˜ì˜ ì—…ë¬´</label>
            <textarea id="morningTasks"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 min-h-[100px] resize-none focus:outline-none focus:border-amber-500 text-sm leading-relaxed"
              placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥"
            >${escapeHtml(tasksText)}</textarea>
          </div>

          <!-- ì¶”ê°€ í•  ì¼ -->
          <div class="mb-5">
            <label class="block text-sm font-medium mb-2">â• ì¶”ê°€ í•  ì¼</label>
            <div class="flex flex-wrap gap-1.5 mb-3" id="additionalCategoryTags">
              ${categories.map(cat => `
                <button onclick="selectAdditionalCategory('${cat}')"
                  class="additional-cat-btn px-2.5 py-1 rounded-full text-xs font-medium border transition-colors
                    ${existingItems.some(i => i.category === cat) ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500 hover:text-amber-300'}"
                  data-category="${cat}">${cat}</button>
              `).join('')}
            </div>
            <div id="additionalTasksList" class="space-y-2">
              ${existingItems.map(item => `
                <div class="flex items-center gap-2 additional-task-row">
                  <span class="px-2 py-1 bg-amber-900/30 text-amber-300 rounded text-xs min-w-[40px] text-center">${escapeHtml(item.category)}</span>
                  <input type="text" value="${escapeHtml(item.content)}"
                    class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
                    data-category="${escapeHtml(item.category)}" placeholder="${escapeHtml(item.category)} ë‚´ìš© ì…ë ¥...">
                  <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400">Ã—</button>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- ëª©í‘œ -->
          <div class="mb-5">
            <label class="block text-sm font-medium mb-2">ğŸ¯ í•µì‹¬ ëª©í‘œ</label>
            <div class="space-y-2" id="morningGoalsList">
              ${[0, 1, 2].map(i => `
                <input type="text" id="morningGoal${i}" value="${escapeHtml(g[i] || '')}"
                  class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
                  placeholder="${i === 0 ? 'ê°€ì¥ ì¤‘ìš”í•œ ëª©í‘œ' : i === 1 ? 'ë‘ ë²ˆì§¸ ëª©í‘œ (ì„ íƒ)' : 'ì„¸ ë²ˆì§¸ ëª©í‘œ (ì„ íƒ)'}">
              `).join('')}
            </div>
          </div>

          <!-- ì§‘ì¤‘ ì‹œê°„ & ë‹¤ì§ -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">â° ì§‘ì¤‘ ì‹œê°„</label>
            <div class="grid grid-cols-4 gap-2">
              ${focusOptions.map(opt => `
                <button onclick="selectFocusTime('${opt.value}')"
                  class="focus-time-btn px-2 py-2 rounded-lg text-xs font-medium border transition-all text-center
                    ${morningData.focusTime === opt.value ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500'}"
                  data-value="${opt.value}">
                  ${opt.icon} ${opt.label}
                </button>
              `).join('')}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">ğŸ’ª ì˜¤ëŠ˜ì˜ ë‹¤ì§</label>
            <input type="text" id="morningMotto" value="${escapeHtml(morningData.motto)}"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
              placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì´ëŒì–´ê°ˆ í•œë§ˆë””!">
          </div>
        </div>

        <!-- ë§ˆí¬ë‹¤ìš´ ë·° íƒ­ (ë Œë”ë§ + ì¸í„°ë™í‹°ë¸Œ ì²´í¬ë°•ìŠ¤) -->
        <div id="morningPvArea" class="hidden">
          <div id="morningMarkdownPreview"
            class="morning-preview bg-gray-800/50 border border-gray-700 rounded-lg p-5 min-h-[400px] text-sm markdown-content">
          </div>
        </div>

        <!-- ì›ë³¸ í¸ì§‘ íƒ­ -->
        <div id="morningMdArea" class="hidden">
          <textarea id="morningMarkdownEditor"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[400px] resize-none focus:outline-none focus:border-amber-500 text-sm font-mono leading-relaxed"
            oninput="morningData.markdown = this.value"
          ></textarea>
        </div>
      `;
    }

    function switchMorningEditTab(tab) {
      const formArea = document.getElementById('morningFormArea');
      const mdArea = document.getElementById('morningMdArea');
      const pvArea = document.getElementById('morningPvArea');
      const formTab = document.getElementById('morningFormTab');
      const mdTab = document.getElementById('morningMdTab');
      const pvTab = document.getElementById('morningPvTab');

      const activeClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300';
      const inactiveClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500';

      [formArea, mdArea, pvArea].forEach(el => el.classList.add('hidden'));
      [formTab, mdTab, pvTab].forEach(el => el.className = inactiveClass);

      if (tab === 'form') {
        formArea.classList.remove('hidden');
        formTab.className = activeClass;
      } else if (tab === 'preview') {
        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ë·° (ì¸í„°ë™í‹°ë¸Œ ì²´í¬ë°•ìŠ¤)
        collectFormData();
        morningData.markdown = document.getElementById('morningMarkdownEditor')?.value || generateMorningMarkdown();
        renderMorningInteractiveView();
        pvArea.classList.remove('hidden');
        pvTab.className = activeClass;
      } else if (tab === 'markdown') {
        // ì›ë³¸ í¸ì§‘
        collectFormData();
        if (!morningData.markdown || !document.getElementById('morningMarkdownEditor')?.value) {
          morningData.markdown = generateMorningMarkdown();
        }
        const editor = document.getElementById('morningMarkdownEditor');
        if (editor) editor.value = morningData.markdown;
        mdArea.classList.remove('hidden');
        mdTab.className = activeClass;
      }
    }

    // ë§ˆí¬ë‹¤ìš´ ë·° ë Œë”ë§ (ì²´í¬ë°•ìŠ¤ ì¸í„°ë™í‹°ë¸Œ)
    function renderMorningInteractiveView() {
      const preview = document.getElementById('morningMarkdownPreview');
      const md = morningData.markdown || generateMorningMarkdown();

      // ë§ˆí¬ë‹¤ìš´ì„ ë¨¼ì € ë Œë”ë§ ì „ì— ì²´í¬ë°•ìŠ¤ ë§ˆì»¤ë¥¼ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ ë³€í™˜
      let checkIdx = 0;
      const processedMd = md.replace(/^(\s*-\s*)\[( |x)\]\s*(.+)$/gim, (match, prefix, checked, text) => {
        const idx = checkIdx++;
        const isChecked = checked.toLowerCase() === 'x';
        return `${prefix}|||CB:${idx}:${isChecked ? '1' : '0'}|||${text}`;
      });

      let html = renderMarkdown(processedMd);

      // í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì¸í„°ë™í‹°ë¸Œ ì²´í¬ë°•ìŠ¤ HTMLë¡œ ë³€í™˜
      html = html.replace(/\|\|\|CB:(\d+):([01])\|\|\|/g, (match, idx, checked) => {
        const isChecked = checked === '1';
        return `<label class="inline-flex items-start gap-2 cursor-pointer" onclick="event.preventDefault(); toggleMorningCheckbox(${idx})">
          <input type="checkbox" ${isChecked ? 'checked' : ''} class="mt-0.5 w-4 h-4 accent-amber-500 cursor-pointer flex-shrink-0">
          <span class="${isChecked ? 'line-through text-gray-500' : ''}">` ;
      });

      // ì²´í¬ë°•ìŠ¤ê°€ ìˆëŠ” liì˜ ë‹«ëŠ” íƒœê·¸ì— span ë‹«ê¸° ì¶”ê°€
      const temp = document.createElement('div');
      temp.innerHTML = html;
      temp.querySelectorAll('li').forEach(li => {
        const label = li.querySelector('label[onclick*="toggleMorningCheckbox"]');
        if (label) {
          li.style.listStyle = 'none';
          li.style.marginLeft = '-1em';
          // label ë‚´ì˜ spanì´ ë‚˜ë¨¸ì§€ í…ìŠ¤íŠ¸ë¥¼ ê°ì‹¸ë„ë¡
          const span = label.querySelector('span');
          if (span) {
            // label ë’¤ì˜ ë‚˜ë¨¸ì§€ í…ìŠ¤íŠ¸ë¥¼ span ì•ˆìœ¼ë¡œ ì´ë™
            let next = label.nextSibling;
            while (next) {
              const toMove = next;
              next = next.nextSibling;
              span.appendChild(toMove);
            }
          }
        }
      });

      preview.innerHTML = temp.innerHTML;
    }

    // ì²´í¬ë°•ìŠ¤ í† ê¸€
    let morningAutoSaveTimer = null;
    function toggleMorningCheckbox(idx) {
      const lines = morningData.markdown.split('\n');
      let checkCount = 0;
      let toggledText = '';
      let wasChecked = false;
      for (let i = 0; i < lines.length; i++) {
        const match = lines[i].match(/^(\s*-\s*)\[( |x)\](\s*.*)$/i);
        if (match) {
          if (checkCount === idx) {
            wasChecked = match[2].toLowerCase() === 'x';
            lines[i] = `${match[1]}[${wasChecked ? ' ' : 'x'}]${match[3]}`;
            toggledText = match[3].trim();
            break;
          }
          checkCount++;
        }
      }
      morningData.markdown = lines.join('\n');

      // í¼ ë°ì´í„°ë„ ë™ê¸°í™”
      syncMarkdownToFormData();

      // ë·° ë‹¤ì‹œ ë Œë”ë§
      renderMorningInteractiveView();

      // ì›ë³¸ í¸ì§‘ ì—ë””í„°ë„ ì—…ë°ì´íŠ¸
      const editor = document.getElementById('morningMarkdownEditor');
      if (editor) editor.value = morningData.markdown;

      // ìë™ ì €ì¥ (ë””ë°”ìš´ìŠ¤ 1ì´ˆ)
      if (morningAutoSaveTimer) clearTimeout(morningAutoSaveTimer);
      morningAutoSaveTimer = setTimeout(() => autoSaveMorningPlan(), 1000);
    }

    // ì²´í¬ë°•ìŠ¤ í† ê¸€ ì‹œ ìë™ ì €ì¥
    async function autoSaveMorningPlan() {
      try {
        await fetch(`${API_BASE}/api/morning-plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tasks: morningData.tasks,
            additionalTasks: morningData.additionalTasks,
            goals: morningData.goals,
            focusTime: morningData.focusTime,
            motto: morningData.motto,
            markdown: morningData.markdown
          })
        });
      } catch (err) {
        console.error('ìë™ ì €ì¥ ì‹¤íŒ¨:', err);
      }
    }

    // ë§ˆí¬ë‹¤ìš´ì—ì„œ í¼ ë°ì´í„°ë¡œ ì—­ë™ê¸°í™”
    function syncMarkdownToFormData() {
      const lines = morningData.markdown.split('\n');
      const tasks = [];
      let inTasksSection = false;

      for (const line of lines) {
        if (line.startsWith('## ğŸ“‹')) { inTasksSection = true; continue; }
        if (line.startsWith('## ')) { inTasksSection = false; continue; }
        if (inTasksSection) {
          const m = line.match(/^-\s*\[([ x])\]\s*(.+)$/i);
          if (m) tasks.push(m[2].trim());
        }
      }
      if (tasks.length > 0) morningData.tasks = tasks;
    }

    // í¼ì—ì„œ morningDataë¡œ ë°ì´í„° ìˆ˜ì§‘
    function collectFormData() {
      const tasksEl = document.getElementById('morningTasks');
      if (tasksEl) {
        morningData.tasks = tasksEl.value.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      }
      const rows = document.querySelectorAll('.additional-task-row');
      if (rows.length > 0) {
        morningData.additionalTasks = Array.from(rows)
          .map(row => ({
            category: row.querySelector('input')?.dataset.category || 'ê¸°íƒ€',
            content: row.querySelector('input')?.value?.trim() || ''
          }))
          .filter(t => t.content.length > 0);
      }
      morningData.goals = [0, 1, 2].map(i =>
        document.getElementById(`morningGoal${i}`)?.value?.trim() || ''
      ).filter(g => g.length > 0);
      const mottoEl = document.getElementById('morningMotto');
      if (mottoEl) morningData.motto = mottoEl.value.trim();
    }

    // ---- ìœ„ì €ë“œ ëª¨ë“œ ----
    function renderMorningStep() {
      const content = document.getElementById('morningContent');
      const prevBtn = document.getElementById('morningPrevBtn');
      const nextBtn = document.getElementById('morningNextBtn');
      const submitBtn = document.getElementById('morningSubmitBtn');

      prevBtn.classList.toggle('hidden', morningStep === 1);
      nextBtn.classList.toggle('hidden', morningStep === 4);
      submitBtn.classList.toggle('hidden', morningStep !== 4);

      for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`mStep${i}Indicator`);
        const circle = indicator.querySelector('span');
        const label = indicator.querySelectorAll('span')[1];

        if (i < morningStep) {
          circle.className = 'w-6 h-6 rounded-full bg-green-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = 'âœ“';
          label.className = 'text-green-400';
        } else if (i === morningStep) {
          circle.className = 'w-6 h-6 rounded-full bg-amber-600 flex items-center justify-center text-xs font-bold';
          circle.textContent = i;
          label.className = 'text-gray-300';
        } else {
          circle.className = 'w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-xs';
          circle.textContent = i;
          label.className = 'text-gray-500';
        }
      }

      switch (morningStep) {
        case 1: renderMorningStep1(content); break;
        case 2: renderMorningStep2(content); break;
        case 3: renderMorningStep3(content); break;
        case 4: renderMorningStep4(content); break;
      }
    }

    function renderMorningStep1(content) {
      const tasksText = morningData.tasks.length > 0 ? morningData.tasks.join('\n') : '';
      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸ“‹ ì˜¤ëŠ˜ì˜ ì—…ë¬´</h3>
          <p class="text-sm text-gray-400 mb-4">ì˜¤ëŠ˜ í•´ì•¼ í•  ì£¼ìš” ì—…ë¬´ë¥¼ ì ì–´ë³´ì„¸ìš”. í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.</p>
        </div>
        <textarea id="morningTasks"
          class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[200px] resize-none focus:outline-none focus:border-amber-500 text-sm leading-relaxed"
          placeholder="ì˜ˆì‹œ:\nPR ë¦¬ë·° - frontend íŒ€\nAPI ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„\në²„ê·¸ ìˆ˜ì • #234\në¬¸ì„œ ì—…ë°ì´íŠ¸"
        >${escapeHtml(tasksText)}</textarea>
        <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
          <span class="px-2 py-1 bg-gray-800 rounded">ğŸ’¡</span>
          <span>Enterë¡œ ì¤„ë°”ê¿ˆí•˜ë©´ ê°ê° ë³„ë„ ì—…ë¬´ë¡œ ë“±ë¡ë©ë‹ˆë‹¤</span>
        </div>
      `;
      setTimeout(() => document.getElementById('morningTasks')?.focus(), 100);
    }

    function renderMorningStep2(content) {
      const categories = ['íšŒì˜', 'ë¦¬ë·°', 'í•™ìŠµ', 'ìš´ë™', 'ê°œì¸', 'ê¸°íƒ€'];
      const existingItems = morningData.additionalTasks || [];

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">â• ì¶”ê°€ í•  ì¼</h3>
          <p class="text-sm text-gray-400 mb-4">ì—…ë¬´ ì™¸ì— ì¶”ê°€ë¡œ í•´ì•¼ í•  ì¼ì´ ìˆë‚˜ìš”?</p>
        </div>
        <div class="flex flex-wrap gap-1.5 mb-3" id="additionalCategoryTags">
          ${categories.map(cat => `
            <button onclick="selectAdditionalCategory('${cat}')"
              class="additional-cat-btn px-2.5 py-1 rounded-full text-xs font-medium border transition-colors
                ${existingItems.some(i => i.category === cat) ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500 hover:text-amber-300'}"
              data-category="${cat}">${cat}</button>
          `).join('')}
        </div>
        <div id="additionalTasksList" class="space-y-2">
          ${existingItems.map(item => `
            <div class="flex items-center gap-2 additional-task-row">
              <span class="px-2 py-1 bg-amber-900/30 text-amber-300 rounded text-xs min-w-[40px] text-center">${escapeHtml(item.category)}</span>
              <input type="text" value="${escapeHtml(item.content)}"
                class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
                data-category="${escapeHtml(item.category)}" placeholder="${escapeHtml(item.category)} ë‚´ìš© ì…ë ¥...">
              <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400">Ã—</button>
            </div>
          `).join('')}
        </div>
        <div class="mt-3 text-center">
          <button onclick="addAdditionalTaskRow('ê¸°íƒ€')" class="text-sm text-gray-500 hover:text-amber-400">+ ì§ì ‘ ì¶”ê°€</button>
        </div>
      `;
    }

    function selectAdditionalCategory(category) {
      addAdditionalTaskRow(category);
      document.querySelectorAll('.additional-cat-btn').forEach(btn => {
        if (btn.dataset.category === category) {
          btn.className = btn.className.replace('bg-gray-800 border-gray-700 text-gray-400', 'bg-amber-600/30 border-amber-500 text-amber-300');
        }
      });
    }

    function addAdditionalTaskRow(category) {
      const list = document.getElementById('additionalTasksList');
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2 additional-task-row';
      row.innerHTML = `
        <span class="px-2 py-1 bg-amber-900/30 text-amber-300 rounded text-xs min-w-[40px] text-center">${escapeHtml(category)}</span>
        <input type="text"
          class="flex-1 bg-gray-800 border border-gray-700 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:border-amber-500"
          data-category="${escapeHtml(category)}" placeholder="${escapeHtml(category)} ë‚´ìš© ì…ë ¥..." autofocus>
        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-red-400">Ã—</button>
      `;
      list.appendChild(row);
      row.querySelector('input')?.focus();
    }

    function renderMorningStep3(content) {
      const g = morningData.goals || [];
      const focusOptions = [
        { value: 'morning', label: 'ì˜¤ì „', icon: 'ğŸŒ…' },
        { value: 'afternoon', label: 'ì˜¤í›„', icon: 'â˜€ï¸' },
        { value: 'evening', label: 'ì €ë…', icon: 'ğŸŒ™' },
        { value: 'all-day', label: 'í•˜ë£¨ ì¢…ì¼', icon: 'â°' }
      ];

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸ¯ ëª©í‘œ & ë‹¤ì§</h3>
          <p class="text-sm text-gray-400 mb-4">ì˜¤ëŠ˜ì˜ í•µì‹¬ ëª©í‘œì™€ ë‹¤ì§ì„ ì •í•´ë³´ì„¸ìš”.</p>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ¯ í•µì‹¬ ëª©í‘œ (ìµœëŒ€ 3ê°œ)</label>
            <div class="space-y-2" id="morningGoalsList">
              ${[0, 1, 2].map(i => `
                <input type="text" id="morningGoal${i}" value="${escapeHtml(g[i] || '')}"
                  class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-amber-500"
                  placeholder="${i === 0 ? 'ê°€ì¥ ì¤‘ìš”í•œ ëª©í‘œ' : i === 1 ? 'ë‘ ë²ˆì§¸ ëª©í‘œ (ì„ íƒ)' : 'ì„¸ ë²ˆì§¸ ëª©í‘œ (ì„ íƒ)'}">
              `).join('')}
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">â° ì§‘ì¤‘í•  ì‹œê°„ëŒ€</label>
            <div class="grid grid-cols-4 gap-2">
              ${focusOptions.map(opt => `
                <button onclick="selectFocusTime('${opt.value}')"
                  class="focus-time-btn px-3 py-2.5 rounded-lg text-sm font-medium border transition-all text-center
                    ${morningData.focusTime === opt.value ? 'bg-amber-600/30 border-amber-500 text-amber-300' : 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500'}"
                  data-value="${opt.value}">
                  <div class="text-lg mb-1">${opt.icon}</div>
                  ${opt.label}
                </button>
              `).join('')}
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ’ª ì˜¤ëŠ˜ì˜ í•œ ì¤„ ë‹¤ì§</label>
            <input type="text" id="morningMotto" value="${escapeHtml(morningData.motto)}"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-amber-500"
              placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ì´ëŒì–´ê°ˆ í•œë§ˆë””!">
          </div>
        </div>
      `;
    }

    function selectFocusTime(value) {
      morningData.focusTime = value;
      document.querySelectorAll('.focus-time-btn').forEach(btn => {
        if (btn.dataset.value === value) {
          btn.className = btn.className
            .replace('bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500', 'bg-amber-600/30 border-amber-500 text-amber-300');
        } else {
          btn.className = btn.className
            .replace('bg-amber-600/30 border-amber-500 text-amber-300', 'bg-gray-800 border-gray-700 text-gray-400 hover:border-amber-500');
        }
      });
    }

    function generateMorningMarkdown() {
      const today = morningData.date;
      const focusLabels = { morning: 'ì˜¤ì „', afternoon: 'ì˜¤í›„', evening: 'ì €ë…', 'all-day': 'í•˜ë£¨ ì¢…ì¼' };
      let md = `# â˜€ï¸ ${today} í•˜ë£¨ ì‹œì‘\n\n`;

      if (morningData.tasks.length > 0) {
        md += `## ğŸ“‹ ì˜¤ëŠ˜ì˜ ì—…ë¬´\n`;
        morningData.tasks.forEach(t => { md += `- [ ] ${t}\n`; });
        md += '\n';
      }

      if (morningData.additionalTasks.length > 0) {
        md += `## â• ì¶”ê°€ í•  ì¼\n`;
        morningData.additionalTasks.forEach(t => {
          md += `- [ ] **${t.category}**: ${t.content}\n`;
        });
        md += '\n';
      }

      const goals = morningData.goals.filter(g => g.trim());
      if (goals.length > 0) {
        md += `## ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œ\n`;
        goals.forEach((g, i) => { md += `${i + 1}. ${g}\n`; });
        md += '\n';
      }

      if (morningData.focusTime || morningData.motto) {
        md += `---\n`;
        if (morningData.focusTime) md += `**â° ì§‘ì¤‘ ì‹œê°„**: ${focusLabels[morningData.focusTime] || morningData.focusTime}\n`;
        if (morningData.motto) md += `**ğŸ’ª ì˜¤ëŠ˜ì˜ ë‹¤ì§**: ${morningData.motto}\n`;
      }

      return md;
    }

    function renderMorningStep4(content) {
      morningData.markdown = generateMorningMarkdown();

      content.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-bold mb-2">ğŸ“ ë¯¸ë¦¬ë³´ê¸° & í¸ì§‘</h3>
          <p class="text-sm text-gray-400 mb-3">ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì™„ë£Œ í‘œì‹œí•˜ê±°ë‚˜, ì›ë³¸ì„ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="flex gap-2 mb-3">
          <button onclick="switchMorningPreviewTab('preview')" id="morningPreviewTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300">
            ğŸ‘ ë§ˆí¬ë‹¤ìš´
          </button>
          <button onclick="switchMorningPreviewTab('edit')" id="morningEditTab"
            class="px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500">
            âœï¸ ì›ë³¸ í¸ì§‘
          </button>
        </div>
        <div id="morningPreviewArea">
          <div id="morningMarkdownPreview"
            class="morning-preview markdown-content bg-gray-800/50 border border-gray-700 rounded-lg p-5 min-h-[300px] text-sm">
          </div>
        </div>
        <div id="morningEditArea" class="hidden">
          <textarea id="morningMarkdownEditor"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg p-4 min-h-[300px] resize-none focus:outline-none focus:border-amber-500 text-sm font-mono leading-relaxed"
            oninput="morningData.markdown = this.value"
          >${escapeHtml(morningData.markdown)}</textarea>
        </div>
      `;
      // ê¸°ë³¸ì ìœ¼ë¡œ ì¸í„°ë™í‹°ë¸Œ ë·° í‘œì‹œ
      renderMorningInteractiveView();
    }

    function switchMorningPreviewTab(tab) {
      const editArea = document.getElementById('morningEditArea');
      const previewArea = document.getElementById('morningPreviewArea');
      const editTab = document.getElementById('morningEditTab');
      const previewTab = document.getElementById('morningPreviewTab');

      const activeClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-amber-600/30 border border-amber-500 text-amber-300';
      const inactiveClass = 'px-3 py-1.5 rounded-lg text-xs font-medium bg-gray-800 border border-gray-700 text-gray-400 hover:border-amber-500';

      if (tab === 'edit') {
        // ì›ë³¸ í¸ì§‘ (textarea)
        const editor = document.getElementById('morningMarkdownEditor');
        if (editor) editor.value = morningData.markdown;
        editArea.classList.remove('hidden');
        previewArea.classList.add('hidden');
        editTab.className = activeClass;
        previewTab.className = inactiveClass;
      } else {
        // ì¸í„°ë™í‹°ë¸Œ ë§ˆí¬ë‹¤ìš´ ë·°
        const editor = document.getElementById('morningMarkdownEditor');
        if (editor?.value) morningData.markdown = editor.value;
        editArea.classList.add('hidden');
        previewArea.classList.remove('hidden');
        previewTab.className = activeClass;
        editTab.className = inactiveClass;
        renderMorningInteractiveView();
      }
    }

    function saveMorningStepData() {
      if (morningStep === 1) {
        const text = document.getElementById('morningTasks')?.value || '';
        morningData.tasks = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      } else if (morningStep === 2) {
        const rows = document.querySelectorAll('.additional-task-row');
        morningData.additionalTasks = Array.from(rows)
          .map(row => ({
            category: row.querySelector('input')?.dataset.category || 'ê¸°íƒ€',
            content: row.querySelector('input')?.value?.trim() || ''
          }))
          .filter(t => t.content.length > 0);
      } else if (morningStep === 3) {
        morningData.goals = [0, 1, 2].map(i =>
          document.getElementById(`morningGoal${i}`)?.value?.trim() || ''
        ).filter(g => g.length > 0);
        morningData.motto = document.getElementById('morningMotto')?.value?.trim() || '';
      } else if (morningStep === 4) {
        morningData.markdown = document.getElementById('morningMarkdownEditor')?.value || morningData.markdown;
      }
    }

    function prevMorningStep() {
      saveMorningStepData();
      if (morningStep > 1) {
        morningStep--;
        renderMorningStep();
      }
    }

    function nextMorningStep() {
      saveMorningStepData();
      if (morningStep < 4) {
        morningStep++;
        renderMorningStep();
      }
    }

    async function submitMorningPlan() {
      // í¸ì§‘ ëª¨ë“œë©´ í¼ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
      if (morningEditMode) {
        collectFormData();
        // ë§ˆí¬ë‹¤ìš´ ì—ë””í„°ê°€ ì—´ë ¤ìˆìœ¼ë©´ ê·¸ ë‚´ìš© ì‚¬ìš©
        const mdEditor = document.getElementById('morningMarkdownEditor');
        morningData.markdown = mdEditor?.value || generateMorningMarkdown();
      } else {
        saveMorningStepData();
      }

      try {
        const res = await fetch(`${API_BASE}/api/morning-plan`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tasks: morningData.tasks,
            additionalTasks: morningData.additionalTasks,
            goals: morningData.goals,
            focusTime: morningData.focusTime,
            motto: morningData.motto,
            markdown: morningData.markdown || generateMorningMarkdown()
          })
        });

        const data = await res.json();
        if (data.success) {
          closeMorningStartModal();
          showToast(morningEditMode ? 'ğŸ’¾ ê³„íšì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'â˜€ï¸ ì˜¤ëŠ˜ì˜ ê³„íšì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!', 'success');
          checkMorningPlanExists();
          refreshTodaySummary();
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        showToast('ê³„íš ì €ì¥ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ë‹¤ìŒ ì˜ˆì •ëœ ì‘ì—… í‘œì‹œ
    async function showNextJobs() {
      try {
        const res = await fetch(`${API_BASE}/api/jobs`);
        const data = await res.json();

        // ìŠ¤ì¼€ì¤„ì´ ìˆëŠ” ì‘ì—…ë§Œ í•„í„°ë§
        const scheduledJobs = data.jobs.filter(j => j.schedule && j.schedule.trim());

        if (scheduledJobs.length === 0) {
          showToast('ì˜ˆì •ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
          return;
        }

        // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
        const now = new Date();
        const jobsWithNext = scheduledJobs.map(j => {
          const next = getNextCronTime(j.schedule);
          return { ...j, nextRun: next };
        }).sort((a, b) => (a.nextRun?.getTime() || Infinity) - (b.nextRun?.getTime() || Infinity));

        // ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('sessionDetailModal');
        const content = document.getElementById('sessionDetailContent');

        content.innerHTML = `
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-cyan-600 flex items-center justify-center text-lg">â°</div>
              <div>
                <h3 class="text-lg font-bold">ì˜ˆì •ëœ ì‘ì—…</h3>
                <p class="text-xs text-gray-400">${scheduledJobs.length}ê°œ ìŠ¤ì¼€ì¤„ëœ ì‘ì—…</p>
              </div>
            </div>
            <button onclick="closeSessionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
          </div>

          <div class="space-y-3 max-h-[60vh] overflow-auto custom-scrollbar">
            ${jobsWithNext.slice(0, 10).map(j => `
              <div class="bg-gray-700/50 rounded-lg p-4 border border-gray-600/30 hover:bg-gray-700/70 transition-colors">
                <div class="flex items-center justify-between mb-2">
                  <span class="font-medium">${j.name}</span>
                  <span class="text-xs px-2 py-1 bg-gray-600 rounded">${j.schedule}</span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                  ${j.nextRun ? `
                    <span class="text-blue-400">
                      â± ${formatTimeUntil(j.nextRun)}
                    </span>
                    <span class="text-gray-500">
                      ${j.nextRun.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}
                    </span>
                  ` : '<span class="text-gray-500">ìŠ¤ì¼€ì¤„ íŒŒì‹± ë¶ˆê°€</span>'}
                </div>
                ${j.description ? `<p class="text-xs text-gray-400 mt-2">${j.description}</p>` : ''}
              </div>
            `).join('')}
          </div>

          <div class="mt-4 pt-4 border-t border-gray-700">
            <button onclick="showTab('jobs'); closeSessionModal();" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-medium">
              ğŸ“‹ ì „ì²´ ì‘ì—… ëª©ë¡ ë³´ê¸°
            </button>
          </div>
        `;

        modal.style.display = 'flex';
      } catch (err) {
        showToast('ì‘ì—… ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + err.message, 'error');
      }
    }

    // ë‹¤ìŒ í¬ë¡  ì‹¤í–‰ ì‹œê°„ ê³„ì‚° (ê°„ë‹¨í•œ êµ¬í˜„)
    function getNextCronTime(cronExpr) {
      if (!cronExpr) return null;

      try {
        const parts = cronExpr.split(' ');
        if (parts.length < 5) return null;

        const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;
        const now = new Date();

        // ê°„ë‹¨í•œ ì¼€ì´ìŠ¤ ì²˜ë¦¬ (ë§¤ì¼, ë§¤ì‹œê°„ ë“±)
        let next = new Date(now);

        if (minute !== '*') {
          const m = parseInt(minute);
          if (!isNaN(m)) next.setMinutes(m);
        }

        if (hour !== '*') {
          const h = parseInt(hour);
          if (!isNaN(h)) next.setHours(h);
        }

        next.setSeconds(0);
        next.setMilliseconds(0);

        // ì´ë¯¸ ì§€ë‚¬ìœ¼ë©´ ë‹¤ìŒìœ¼ë¡œ
        if (next <= now) {
          if (hour === '*') {
            next.setHours(next.getHours() + 1);
          } else {
            next.setDate(next.getDate() + 1);
          }
        }

        return next;
      } catch (e) {
        return null;
      }
    }

    // ì‹œê°„ í¬ë§·íŒ…
    function formatTimeUntil(date) {
      const now = new Date();
      const diff = date.getTime() - now.getTime();

      if (diff < 0) return 'ì§€ë‚¨';

      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);

      if (hours > 0) {
        return `${hours}ì‹œê°„ ${minutes % 60}ë¶„ í›„`;
      }
      return `${minutes}ë¶„ í›„`;
    }

    // Init
    (async function init() {
      // ë¸Œë¼ìš°ì € ì•Œë¦¼ ì„¤ì • ë¡œë“œ (ì„œë²„ ì„¤ì • ë¡œë“œ ì „ì— localStorageì—ì„œ)
      currentSettings.browserNotifications = localStorage.getItem('browserNotifications') === 'true';

      await loadJobs();
      populateCategorySelect();

      // Today's Summary ë¡œë“œ
      refreshTodaySummary();

      // í™ˆ ëŒ€ì‹œë³´ë“œ ë¡œë“œ
      loadHomeDashboard();

      // SSE ì—°ê²° ì´ˆê¸°í™” (ë¹„ë™ê¸° ì‘ì—… ì‹œìŠ¤í…œ)
      initSSE();

      // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
      handleUrlParams();
    })();
  </script>
</body>
</html>
